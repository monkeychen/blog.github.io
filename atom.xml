<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Simiam</title>
  
  <subtitle>求知若渴，虚怀若谷</subtitle>
  <link href="http://cloudnoter.com/atom.xml" rel="self"/>
  
  <link href="http://cloudnoter.com/"/>
  <updated>2021-10-08T03:49:08.627Z</updated>
  <id>http://cloudnoter.com/</id>
  
  <author>
    <name>simiam</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>python踩坑点滴</title>
    <link href="http://cloudnoter.com/2021/09/17/Python%E8%B8%A9%E5%9D%91%E7%82%B9%E6%BB%B4/"/>
    <id>http://cloudnoter.com/2021/09/17/Python%E8%B8%A9%E5%9D%91%E7%82%B9%E6%BB%B4/</id>
    <published>2021-09-17T08:52:05.000Z</published>
    <updated>2021-10-08T03:49:08.627Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>转载请注明出处：<a href="http://simiam.com/">simiam.com</a></p></blockquote><h1 id="安利一下：py-awesome-kit"><a href="#安利一下：py-awesome-kit" class="headerlink" title="安利一下：py-awesome-kit"></a>安利一下：py-awesome-kit</h1><p><code>py-awesome-kit</code>是本人最近在折腾的一个python工具箱，它提供了大数据开发与数据分析工作过程中常用的功能，希望后续能慢慢丰富与完善。<br>项目地址：<a href="https://github.com/monkeychen/py-awesome-kit">https://github.com/monkeychen/py-awesome-kit</a></p><h2 id="1-安装Python3"><a href="#1-安装Python3" class="headerlink" title="1. 安装Python3"></a>1. 安装Python3</h2><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 备份已安装python库</span></span><br><span class="line">pip3 freeze &gt; python3-installed-libs.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除已安装的python</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Linux依赖包下载地址：https://vault.centos.org/7.3.1611/os/x86_64/Packages/</span></span><br><span class="line">mkdir /env/python3.7</span><br><span class="line">cd /env/Python-3.7.9</span><br><span class="line">./configure --prefix=/env/python3.7 --enable-shared --enable-optimizations</span><br><span class="line">make&amp;&amp;make install</span><br><span class="line"></span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="2-利用pip下载第三方包及其依赖"><a href="#2-利用pip下载第三方包及其依赖" class="headerlink" title="2. 利用pip下载第三方包及其依赖"></a>2. 利用pip下载第三方包及其依赖</h2><ul><li>以安装jupyterlab为例<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir jupyterlab</span><br><span class="line">cd jupyterlab</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line">pip3 download jupyterlab -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">cd ..</span><br><span class="line">pip3 install jupyterlab/jupyterlab-3.0.1-py3-none-any.whl --no-index --find-links=./jupyterlab</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h2 id="3-从源码构建并安装py-awesome-kit"><a href="#3-从源码构建并安装py-awesome-kit" class="headerlink" title="3. 从源码构建并安装py-awesome-kit"></a>3. 从源码构建并安装py-awesome-kit</h2><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入项目根目录</span></span><br><span class="line">cd &lt;project_root&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建/打包</span></span><br><span class="line">python3 setup.py bdist_wheel</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装至python库</span></span><br><span class="line">pip install dist/py-awesome-kit-&lt;version&gt;-py3-none-any.whl</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 应用开发过程中会频繁变更，每次安装都需要先卸载旧版本很麻烦。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 develop 开发模式安装的话，实际代码不会拷贝到 site-packages 下，而是除一个指向当前应用的链接（*.egg-link）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这样当前位置的源码改动就会马上反映到 site-packages。使用如下：</span></span><br><span class="line">pip install -e .  # 或者 python setup.py develop</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如需卸载，使用如下命令：</span></span><br><span class="line">pip uninstall fmcc-awesome-kit</span><br></pre></td></tr></table></figure><h2 id="附录：Linux常用命令"><a href="#附录：Linux常用命令" class="headerlink" title="附录：Linux常用命令"></a>附录：Linux常用命令</h2><h3 id="yum安装rpm包及依赖包相关命令"><a href="#yum安装rpm包及依赖包相关命令" class="headerlink" title="yum安装rpm包及依赖包相关命令"></a>yum安装rpm包及依赖包相关命令</h3><ul><li><p>查看依赖包: 可以使用<code>yum deplist</code>命令来查找rpm包的依赖列表。例如，要查找<code>git</code>的rpm依赖包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum deplist git</span><br></pre></td></tr></table></figure></li><li><p>方案一（推荐）：<code>repotrack</code>命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装yum-utils</span></span><br><span class="line">yum -y install yum-utils</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载 git 全量依赖包</span></span><br><span class="line">repotrack git</span><br></pre></td></tr></table></figure></li><li><p>方案二：<code>yumdownloader</code>命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装yum-utils</span></span><br><span class="line">yum -y install yum-utils</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载 git 依赖包</span></span><br><span class="line">yumdownloader --resolve --destdir=/tmp git</span><br></pre></td></tr></table></figure><blockquote><p>参数说明：</p><p>–destdir：指定 rpm 包下载目录（不指定时，默认为当前目录）</p><p>–resolve：下载依赖的 rpm 包。</p><p>注意：仅会将主软件包和基于你现在的操作系统所缺少的依赖关系包一并下载。</p></blockquote></li><li><p>方案三：yum 的<code>downloadonly</code>插件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载 git 依赖包</span></span><br><span class="line">yum -y install git --downloadonly --downloaddir=/tmp</span><br></pre></td></tr></table></figure><blockquote><p>注意：与 yumdownloader 命令一样，也是仅会将主软件包和基于你现在的操作系统所缺少的依赖关系包一并下载。</p></blockquote></li><li><p>离线安装所有下载的rpm包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh --force --nodeps *.rpm</span><br></pre></td></tr></table></figure></li><li><p>其他命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repoquery git</span><br><span class="line"></span><br><span class="line">yum provides git</span><br></pre></td></tr></table></figure></li></ul><h3 id="git使用相关"><a href="#git使用相关" class="headerlink" title="git使用相关"></a>git使用相关</h3><ul><li>项目之前是基于https克隆，现在通过配置SSH-KEY后想变更为用ssh方式提交<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">之前已经是https的链接，现在想要用SSH提交怎么办？</span><br><span class="line">直接修改项目目录下 .git文件夹下的config文件，将地址修改一下就好了。</span><br></pre></td></tr></table></figure></li></ul><h3 id="常见系统配置问题"><a href="#常见系统配置问题" class="headerlink" title="常见系统配置问题"></a>常见系统配置问题</h3><h4 id="1-编写shell脚本后，在bash下单独执行没有问题，但在crontab中无法执行后报错"><a href="#1-编写shell脚本后，在bash下单独执行没有问题，但在crontab中无法执行后报错" class="headerlink" title="1. 编写shell脚本后，在bash下单独执行没有问题，但在crontab中无法执行后报错"></a>1. 编写shell脚本后，在bash下单独执行没有问题，但在crontab中无法执行后报错</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 问题：编写shell脚本后，在bash下单独执行没有问题，但在crontab中无法执行后报如下错误信息：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> [psql: error <span class="keyword">while</span> loading shared libraries: libpq.so.5: cannot open shared object file: No such file or directory]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 原因剖析：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> crontab有一个坏毛病，就是它总是不会缺省的从用户profile文件中读取环境变量参数，经常导致在手工执行某个 脚本时是成功的，但是到crontab中试图让它定期执行时就是会出错。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决方案一（推荐）：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ------------------------------</span></span><br><span class="line">sudo cp ./bin/greenplum-x86_64.conf /etc/ld.so.conf.d/greenplum-x86_64.conf</span><br><span class="line">sudo ldconfig</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用以下命令检查是否生效</span></span><br><span class="line">ldconfig -p | grep green</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决方案二：通过在每个被crontab调用的shell文件前手动设置LD_LIBRARY_PATH环境变量。</span></span><br><span class="line">export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;</span><br><span class="line">source /env/greenplum/clients/greenplum_clients_path.sh</span><br><span class="line">source /env/greenplum/loaders/greenplum_loaders_path.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-未设置PYTHONPATH环境变量导致的问题"><a href="#2-未设置PYTHONPATH环境变量导致的问题" class="headerlink" title="2. 未设置PYTHONPATH环境变量导致的问题"></a>2. 未设置<code>PYTHONPATH</code>环境变量导致的问题</h4><p>如果系统中未设置<code>PYTHONPATH</code>环境变量，将导致<code>python some_module.py</code> 启动时会无法当前目录添加到<code>sys.path</code>中，<br>最终导致<code>import</code>项目中其他目录下的模块报错：未发现指定模块。</p><p>解决办法如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim ~/.bashrc  或 vim ~/.bash_profile 或 sudo vim /etc/profile</span></span><br><span class="line">export PYTHONPATH=&quot;:$PYTHONPATH&quot;</span><br></pre></td></tr></table></figure><p>PS：就算已设置<code>PYTHONPATH</code>，如果在crontab中通过shell调用python脚本，仍然会发现当前目录未添加进<code>sys.path</code>中，导致模块加载报错。</p><p>原因为：crontab启动时是不会执行<code>~/.bashrc 或 ~/.bash_profile 或 /etc/profile</code>三个文件中的任何一个文件的，<br>这将导致crontab的执行上下文中并不存在中<code>PYTHONPATH</code>，即本质原因仍然是<code>PYTHONPATH</code>未设置问题。<br>解决办法多种：</p><ol><li>在crontab执行的shell中设置<code>PYTHONPATH</code>。</li><li>修改crontab的全局配置文件（不建议）。</li></ol>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;转载请注明出处：&lt;a href=&quot;http://simiam.com/&quot;&gt;simiam.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;安利一下：py-awesome-kit&quot;&gt;&lt;a href=&quot;#安利一下：py-awesome-kit&quot; class=&quot;headerlink&quot; title=&quot;安利一下：py-awesome-kit&quot;&gt;&lt;/a&gt;安利一下：py-awesome-kit&lt;/h1&gt;&lt;p&gt;&lt;code&gt;py-awesome-kit&lt;/code&gt;是本人最近在折腾的一个python工具箱，它提供了大数据开发与数据分析工作过程中常用的功能，希望后续能慢慢丰富与完善。&lt;br&gt;项目地址：&lt;a href=&quot;https://github.com/monkeychen/py-awesome-kit&quot;&gt;https://github.com/monkeychen/py-awesome-kit&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-安装Python3&quot;&gt;&lt;a href=&quot;#1-安装Python3&quot; class=&quot;headerlink&quot; title=&quot;1. 安装Python3&quot;&gt;&lt;/a&gt;1. 安装Python3&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;figcaption&gt;&lt;span&gt;script&lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; 备份已安装python库&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pip3 freeze &amp;gt; python3-installed-libs.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; 删除已安装的python&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; Linux依赖包下载地址：https://vault.centos.org/7.3.1611/os/x86_64/Packages/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mkdir /env/python3.7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cd /env/Python-3.7.9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./configure --prefix=/env/python3.7 --enable-shared --enable-optimizations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make&amp;amp;&amp;amp;make install&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Python" scheme="http://cloudnoter.com/categories/Python/"/>
    
    
    <category term="python" scheme="http://cloudnoter.com/tags/python/"/>
    
    <category term="awesome" scheme="http://cloudnoter.com/tags/awesome/"/>
    
  </entry>
  
  <entry>
    <title>VUE学习笔记：环境准备</title>
    <link href="http://cloudnoter.com/2019/04/15/VUE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9A%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/"/>
    <id>http://cloudnoter.com/2019/04/15/VUE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9A%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/</id>
    <published>2019-04-15T09:39:43.000Z</published>
    <updated>2019-04-19T03:13:56.779Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>转载请注明出处：<a href="http://simiam.com/">simiam.com</a></p></blockquote><h1 id="1-Node"><a href="#1-Node" class="headerlink" title="1. Node"></a>1. Node</h1><p>Node是JavaScript语言的服务器运行环境。</p><p>所谓“运行环境”有两层意思：首先，JavaScript语言通过Node在服务器运行，在这个意义上，Node有点像JavaScript虚拟机；其次，Node提供大量工具库，使得JavaScript语言与操作系统互动（比如读写文件、新建子进程），在这个意义上，Node又是JavaScript的工具库。</p><p>Node内部采用Google公司的V8引擎，作为JavaScript语言解释器；通过自行开发的libuv库，调用操作系统资源。</p><h2 id="1-1-安装与更新"><a href="#1-1-安装与更新" class="headerlink" title="1.1. 安装与更新"></a>1.1. 安装与更新</h2><ul><li>安装方式一：访问官方网站<a href="https://nodejs.org/en/">nodejs.org</a>或者<a href="https://github.com/nodesource/distributions">github.com/nodesource/distributions</a>，查看Node的最新版本和安装方法。</li><li>安装方式二：通过官方网站提供编译好的各平台下的二进制包，可以把它们解压到/usr/local/lib/nodejs目录下面，具体过程如下：</li></ul><span id="more"></span><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如macOS下的二进制包</span></span><br><span class="line">sudo mkdir -p <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>nodejs</span><br><span class="line">sudo cd <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>nodejs</span><br><span class="line">sudo wget https:<span class="regexp">//</span>nodejs.org<span class="regexp">/dist/</span>v10.<span class="number">15.3</span>/node-v10.<span class="number">15.3</span>-darwin-x64.tar.gz</span><br><span class="line">sudo tar -zxvf node-v10.<span class="number">15.3</span>-darwin-x64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量，如在~/.profile文件末尾增加如下内容：</span></span><br><span class="line">export PATH=<span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>nodejs<span class="regexp">/node-v10.15.3-darwin-x64/</span>bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行如下命令使配置生效：</span></span><br><span class="line">. ~/.profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试安装是否成功</span></span><br><span class="line">node -v</span><br><span class="line">npm version</span><br><span class="line">npx -v</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>更新方式：更新node.js版本，可以通过node.js的n模块完成，具体过程如下：</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过npm安装n模块</span></span><br><span class="line"><span class="attribute">sudo</span> npm install n -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过n模块，将node.js更新为最新发布的稳定版</span></span><br><span class="line"><span class="attribute">sudo</span> n stable</span><br><span class="line"></span><br><span class="line"><span class="comment"># n模块也可以指定安装特定版本的node</span></span><br><span class="line"><span class="attribute">sudo</span> n <span class="number">10</span>.<span class="number">10</span>.<span class="number">21</span></span><br></pre></td></tr></table></figure><h2 id="1-2-基本用法"><a href="#1-2-基本用法" class="headerlink" title="1.2. 基本用法"></a>1.2. 基本用法</h2><ul><li>安装环境搭建完成后，运行node.js程序，其实就是使用node命令读取解析执行JavaScript脚本。比如当前目录存在一个<code>demo.js</code>脚本文件，可以这样执行：</li></ul><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">node</span> <span class="title">demo</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">$ <span class="keyword">node</span> <span class="title">demo</span>.js</span><br></pre></td></tr></table></figure><ul><li>使用<code>-e</code>参数，可以执行代码字符串：</li></ul><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">node</span> <span class="title">-e</span> &#x27;console.log(<span class="string">&quot;Hello World&quot;</span>)&#x27;</span><br><span class="line"><span class="comment"># 执行输出结果为：Hello World</span></span><br></pre></td></tr></table></figure><h2 id="1-3-REPL环境"><a href="#1-3-REPL环境" class="headerlink" title="1.3. REPL环境"></a>1.3. REPL环境</h2><blockquote><p>REPL是Node.js与用户互动的shell，各种基本的shell功能都可以在里面使用，比如使用上下方向键遍历曾经使用过的命令。</p></blockquote><p>在命令行键入node命令，后面没有文件名，就进入一个Node.js的REPL环境（Read–eval–print loop，”读取-求值-输出”循环），可以直接运行各种JavaScript命令：</p><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ node</span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript"><span class="number">1</span>+<span class="number">1</span></span></span><br><span class="line">2</span><br><span class="line"><span class="meta">&gt;</span></span><br><span class="line"></span><br><span class="line"># 特殊变量下划线（_）表示上一个命令的返回结果</span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">_ + <span class="number">1</span></span></span><br><span class="line">3</span><br><span class="line"></span><br><span class="line"># 在REPL中，如果运行一个表达式，会直接在命令行返回结果。如果运行一条语句，就不会有任何输出，因为语句没有返回值。</span><br><span class="line"># 如下面代码的第二条命令，没有显示任何结果。因为这是一条语句，不是表达式，所以没有返回值</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript">x = <span class="number">1</span></span></span><br><span class="line">1</span><br><span class="line"><span class="meta">&gt;</span> <span class="javascript"><span class="keyword">var</span> x = <span class="number">1</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="2-模块包管理器npm"><a href="#2-模块包管理器npm" class="headerlink" title="2. 模块包管理器npm"></a>2. 模块包管理器npm</h1><p>npm是Node的模块管理器，功能极其强大，它是Node获得成功的重要原因之一。npm是随node一起发布安装的，不需要单独安装。正因为有了npm，我们只要使用如下一行命令，就能安装或更新别人写好的模块。</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装新模块</span></span><br><span class="line">sudo <span class="built_in">npm</span> install module_name@version [-g]</span><br><span class="line"><span class="comment"># 更新新模块</span></span><br><span class="line">sudo <span class="built_in">npm</span> update module_name@version [-g]</span><br></pre></td></tr></table></figure><p>参数选项<code>-g</code>代表是全局安装，即会安装到<code>/usr/local/lib/node_modules</code>目录下，如果不加则为本地安装，会将模块安装在当前目录的<code>node_modules</code>目录下。</p><h2 id="2-1-npm自身版本更新"><a href="#2-1-npm自身版本更新" class="headerlink" title="2.1. npm自身版本更新"></a>2.1. npm自身版本更新</h2><p>因为在安装Node的时候，会连带一起安装npm。但是Node附带的npm可能不是最新版本，最好用下面的命令，更新到最新版本。</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">npm</span> install <span class="built_in">npm</span>@latest -g</span><br></pre></td></tr></table></figure><p>上面的命令中，@latest表示最新版本，-g表示全局安装。所以，命令的主干是npm install npm，也就是使用npm安装自己。之所以可以这样，是因为npm本身与Node的其他模块没有区别，其本质上也是一个node模块，因此可以通过npm命令来进行版本更新。</p><p>然后，运行下面的命令，查看各种信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看 npm 命令列表</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm <span class="built_in">help</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看各个命令的简单用法</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm -l</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 npm 的版本</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm -v</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 npm 的配置</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm config list -l</span></span><br></pre></td></tr></table></figure><h2 id="2-2-cnpm工具"><a href="#2-2-cnpm工具" class="headerlink" title="2.2. cnpm工具"></a>2.2. cnpm工具</h2><p>由于众所周知的原因，我们被墙的厉害，所以使用npm下载模块时候会发现效率真的很慢，所以推荐<a href="https://npm.taobao.org/">淘宝的NPM镜像</a>。</p><blockquote><p><a href="https://npm.taobao.org/">淘宝的NPM镜像</a>是一个完整<code>npmjs.org</code>镜像，你可以用此代替官方版本（只读），同步频率目前为10分钟一次以保证尽量与官方服务同步。</p></blockquote><p><strong>使用方式1</strong>：在使用npm命令时指定<code>registry</code>参数值为<code>https://registry.npm.taobao.org</code></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 通过在使用npm命令时指定`registry`参数值为`https:<span class="comment">//registry.npm.taobao.org`</span></span></span><br><span class="line">npm install <span class="params">&lt;module_name&gt;</span> --registry=https:<span class="comment">//registry.npm.taobao.org</span></span><br></pre></td></tr></table></figure><p><strong>使用方式2</strong>：以linux系统为例，在<code>用户目录</code>或<code>工程项目根目录</code>下创建文件<code>.npmrc</code>，并添加如下内容：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry=https:<span class="regexp">//</span>registry.npm.taobao.org/</span><br></pre></td></tr></table></figure><ul><li>此后使用npm命令就不需要指定<code>registry</code>参数了，因为npm会优先从项目根目录或用户目录下的<code>.npmrc</code>文件中获取<code>registry</code>值。</li><li>当前用户目录与项目根目录下的<code>.npmrc</code>文件的<code>registry</code>值可以设置成不同的URL。</li><li>在执行npm命令时，如果当前目录是项目目录，则项目根目录中的<code>.npmrc</code>文件的优先级更高。</li></ul><p><strong>使用方式3</strong>：我们可能通过安装<code>cnpm</code>模块来使用淘宝的NPM镜像，安装命令如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https:<span class="regexp">//</span>registry.npm.taobao.org</span><br></pre></td></tr></table></figure><p>cnpm安装成功以后，就可以直接使用cnpm来安装模块，简单便捷。</p><h2 id="2-3-npm私有仓库"><a href="#2-3-npm私有仓库" class="headerlink" title="2.3. npm私有仓库"></a>2.3. npm私有仓库</h2><p>在企业内部，为了使前端组件化开发更高效，搭建NPM私有仓库是一个不错的选择。安装教程网上很多，本文不再详情介绍，请参考如下文章：</p><blockquote><p>npm私有仓库安装指南：<a href="https://www.jianshu.com/p/9085f47726a2">Nexus上搭建npm本地服务器</a></p></blockquote><h1 id="3-版本管理工具nvm"><a href="#3-版本管理工具nvm" class="headerlink" title="3. 版本管理工具nvm"></a>3. 版本管理工具nvm</h1><p>如果想在同一台机器，同时安装多个版本的node.js，就需要用到版本管理工具nvm。</p><h2 id="3-1-安装与更新"><a href="#3-1-安装与更新" class="headerlink" title="3.1. 安装与更新"></a>3.1. 安装与更新</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/creationix/</span>nvm.git ~/.nvm</span><br><span class="line">$ source ~<span class="regexp">/.nvm/</span>nvm.sh</span><br></pre></td></tr></table></figure><p>安装以后，nvm的执行脚本，每次使用前都要激活，建议将其加入<code>~/.bashrc</code>文件（假定使用Bash）。激活后，就可以安装指定版本的Node，命令如下：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装最新版本</span></span><br><span class="line"><span class="variable">$ </span>nvm install node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本</span></span><br><span class="line"><span class="variable">$ </span>nvm install 0.<span class="number">12.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用已安装的最新版本</span></span><br><span class="line"><span class="variable">$ </span>nvm <span class="keyword">use</span> node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用指定版本的node</span></span><br><span class="line"><span class="variable">$ </span>nvm <span class="keyword">use</span> 0.<span class="number">12</span></span><br></pre></td></tr></table></figure><p>nvm也允许进入指定版本的<code>REPL</code>环境（Read–eval–print loop，”读取-求值-输出”循环）：</p><blockquote><p>REPL是Node.js与用户互动的shell，各种基本的shell功能都可以在里面使用，比如使用上下方向键遍历曾经使用过的命令。</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nvm <span class="builtin-name">run</span> 0.12</span><br></pre></td></tr></table></figure><p>如果在项目根目录下新建一个<code>.nvmrc</code>文件，将版本号写入其中，就只输入<code>nvm use</code>命令即可，不再需要附加版本号。</p><p>下面是其他经常用到的nvm使用命令：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看本地安装的所有版本</span></span><br><span class="line"><span class="variable">$</span> nvm <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务器上所有可供安装的版本。</span></span><br><span class="line"><span class="variable">$</span> nvm <span class="built_in">ls</span><span class="literal">-remote</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出已经激活的nvm，使用deactivate命令。</span></span><br><span class="line"><span class="variable">$</span> nvm deactivate</span><br></pre></td></tr></table></figure><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul><li><a href="http://javascript.ruanyifeng.com/nodejs/npm.html">npm模块管理器</a></li><li><a href="http://www.ruanyifeng.com/blog/2016/01/npm-install.html">npm模块安装机制简介</a></li><li><a href="http://www.ruanyifeng.com/blog/2019/02/npx.html">npx使用教程</a></li></ul><blockquote><p>转载请注明出处：<a href="http://simiam.com/">simiam.com</a></p></blockquote><hr><p><strong>广告</strong>：</p><ul><li>分享一个人工智能教程。零基础！通俗易懂！风趣幽默！希望你也加入到人工智能的队伍中来！<a href="http://www.captainbed.net/blog-free">点击浏览教程</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;转载请注明出处：&lt;a href=&quot;http://simiam.com/&quot;&gt;simiam.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;1-Node&quot;&gt;&lt;a href=&quot;#1-Node&quot; class=&quot;headerlink&quot; title=&quot;1. Node&quot;&gt;&lt;/a&gt;1. Node&lt;/h1&gt;&lt;p&gt;Node是JavaScript语言的服务器运行环境。&lt;/p&gt;
&lt;p&gt;所谓“运行环境”有两层意思：首先，JavaScript语言通过Node在服务器运行，在这个意义上，Node有点像JavaScript虚拟机；其次，Node提供大量工具库，使得JavaScript语言与操作系统互动（比如读写文件、新建子进程），在这个意义上，Node又是JavaScript的工具库。&lt;/p&gt;
&lt;p&gt;Node内部采用Google公司的V8引擎，作为JavaScript语言解释器；通过自行开发的libuv库，调用操作系统资源。&lt;/p&gt;
&lt;h2 id=&quot;1-1-安装与更新&quot;&gt;&lt;a href=&quot;#1-1-安装与更新&quot; class=&quot;headerlink&quot; title=&quot;1.1. 安装与更新&quot;&gt;&lt;/a&gt;1.1. 安装与更新&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;安装方式一：访问官方网站&lt;a href=&quot;https://nodejs.org/en/&quot;&gt;nodejs.org&lt;/a&gt;或者&lt;a href=&quot;https://github.com/nodesource/distributions&quot;&gt;github.com/nodesource/distributions&lt;/a&gt;，查看Node的最新版本和安装方法。&lt;/li&gt;
&lt;li&gt;安装方式二：通过官方网站提供编译好的各平台下的二进制包，可以把它们解压到/usr/local/lib/nodejs目录下面，具体过程如下：&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="前端" scheme="http://cloudnoter.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="vue" scheme="http://cloudnoter.com/tags/vue/"/>
    
    <category term="npm" scheme="http://cloudnoter.com/tags/npm/"/>
    
  </entry>
  
  <entry>
    <title>Maven学习笔记</title>
    <link href="http://cloudnoter.com/2018/10/11/Maven%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"/>
    <id>http://cloudnoter.com/2018/10/11/Maven%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/</id>
    <published>2018-10-11T09:51:31.000Z</published>
    <updated>2018-10-16T07:32:14.881Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Maven学习笔记"><a href="#Maven学习笔记" class="headerlink" title="Maven学习笔记"></a>Maven学习笔记</h1><blockquote><p>转载请注明出处：<a href="https://simiam.com/">simiam.com</a></p></blockquote><p>本文主要是对Maven学习与使用过程中的一些经验的总结，不是Maven的入门教程，如需要系统学习Maven，您可以看一下<a href="https://www.amazon.cn/dp/B009WMAZX4">《Maven实战》</a>这本书，或看下以下几个在线教程：</p><ul><li><a href="http://www.infoq.com/cn/maven-practice">InfoQ上与Maven有关的内容</a></li><li><a href="http://wiki.jikexueyuan.com/project/maven/">极客学院的Maven教程</a></li><li><a href="https://www.jianshu.com/p/fd43b3d0fdb0">Maven生命周期介绍</a></li></ul><h2 id="1-依赖声明中scope的使用"><a href="#1-依赖声明中scope的使用" class="headerlink" title="1. 依赖声明中scope的使用"></a>1. 依赖声明中scope的使用</h2><blockquote><p>网络上有太多的文章介绍，但个人还是推荐直接看<a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html">官方文档</a>，英文不好的朋友可以看<a href="http://tangyanbo.iteye.com/blog/1503957">这篇有点老的文章</a>。</p></blockquote><p>除了掌握基本内容外，还需要特别关注以下几个内容：</p><ul><li>provided与runtime的区别，system知道下有这个东西就行。</li><li>import这个scope是后面引入的新scope，其只能用于<code>&lt;dependencyManagement&gt;</code>中且类型为pom的依赖项，个人感觉其主要作用在于对依赖版本进行分类管理。</li><li>Maven依赖冲突的解决策略，可以参考<a href="https://www.jianshu.com/p/f6ca45865025">这里</a></li></ul><span id="more"></span><h2 id="2-Maven构建配置"><a href="#2-Maven构建配置" class="headerlink" title="2. Maven构建配置"></a>2. Maven构建配置</h2><h3 id="2-1-Maven项目的标准目录结构"><a href="#2-1-Maven项目的标准目录结构" class="headerlink" title="2.1. Maven项目的标准目录结构"></a>2.1. Maven项目的标准目录结构</h3><ul><li>src<ul><li>main<ul><li>java — 源文件 </li><li>resources — 资源文件</li><li>filters — 资源过滤文件</li><li>config — 配置文件</li><li>scripts — 脚本文件</li><li>webapp — web应用文件</li></ul></li><li>test<ul><li>java — 测试源文件</li><li>resources — 测试资源文件</li><li>filters — 测试资源过滤文件</li></ul></li><li>it — 集成测试</li><li>assembly — assembly descriptors</li><li>site — Site</li></ul></li><li>target<ul><li>generated-sources</li><li>classes</li><li>generated-test-sources</li><li>test-classes</li><li>xxx.jar</li></ul></li><li>pom.xml</li><li>LICENSE.txt</li><li>NOTICE.txt</li><li>README.txt</li></ul><h3 id="2-2-资源处理相关配置"><a href="#2-2-资源处理相关配置" class="headerlink" title="2.2. 资源处理相关配置"></a>2.2. 资源处理相关配置</h3><p>构建Maven项目的时候，如果没有进行特殊的配置，Maven会按照标准的目录结构查找和处理各种类型文件。</p><blockquote><p><strong>src/main/java和src/test/java</strong></p><p>这两个目录中的所有<code>*.java</code>文件会分别在<code>comile</code>和<code>test-comiple</code>阶段被编译，编译结果分别放到了<code>target/classes</code>和<code>targe/test-classes</code>目录中，但是这两个目录中的其他文件都会被忽略掉。</p><p><strong>src/main/resources和src/test/resources</strong></p><p>这两个目录中的文件也会分别被复制到<code>target/classes</code>和<code>target/test-classes</code>目录中。</p><p><strong>target/classes</strong></p><p>打包插件默认会把这个目录中的所有内容打入到<code>jar</code>包或者<code>war</code>包中。</p></blockquote><p>资源文件是Java代码中要使用的文件。代码在执行的时候会到指定位置去查找这些文件。前面已经说了Maven默认的处理方式，但是有时候我们需要进行自定义的配置，比如下面两种情况：</p><ul><li>有的时候有些配置文件通常与<code>.java</code>文件一起放在<code>src/main/java</code>目录（如mybatis或hibernate的表映射文件）。</li><li>有的时候还希望把其他目录中的资源也复制到<code>classes</code>目录中。这些情况下就需要在<code>pom.xml</code>文件中修改配置了。</li></ul><p>目前主要有如下两种方法修改配置：</p><ul><li>一种是在<code>&lt;build&gt;</code>元素下添加<code>&lt;resources&gt;</code>进行配置。</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    ......</span><br><span class="line">      <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    ......</span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>另一种是在<code>&lt;build&gt;</code>的<code>&lt;plugins&gt;</code>子元素中配置<code>maven-resources-plugin</code>等处理资源文件的插件。</li></ul><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-xmls<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>process-sources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$</span><span class="template-variable">&#123;basedir&#125;</span><span class="xml">/target/classes<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$</span><span class="template-variable">&#123;basedir&#125;</span><span class="xml">/src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><code>resources</code>元素与<code>maven-resources-plugin</code>插件一般都是搭配在一起使用实现复杂的资源文件处理逻辑。</p><p>默认情况下，Maven会从项目的<code>src/main/resources</code>目录下查找资源。如果你的资源不在此目录下，可以用<code>&lt;resources&gt;</code>标签指定，同时也支持多个目录，也支持<code>&lt;include&gt;,&lt;exclude&gt;</code>之类的精细化配置。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;resources&gt;</span></span><br><span class="line"><span class="params">&lt;resource&gt;</span></span><br><span class="line"><span class="params">&lt;directory&gt;</span>src<span class="meta-keyword">/main/</span>resources1<span class="params">&lt;/directory&gt;</span></span><br><span class="line"><span class="params">&lt;/resource&gt;</span></span><br><span class="line"><span class="params">&lt;resource&gt;</span></span><br><span class="line"><span class="params">&lt;directory&gt;</span>src<span class="meta-keyword">/main/</span>resources2<span class="params">&lt;/directory&gt;</span></span><br><span class="line"><span class="params">&lt;/resource&gt;</span></span><br><span class="line"><span class="params">&lt;/resources&gt;</span></span><br></pre></td></tr></table></figure><p>有的时候，资源文件中存在变量引用，可以使用<code>&lt;filtering&gt;</code>标签指定是否替换资源中的变量。变量的来源默认为pom文件中的<code>&lt;project&gt;根元素下的&lt;properties&gt;</code>标签或<code>&lt;profile&gt;下的&lt;properties&gt;</code>标签中定义的变量；当然也可以在<code>&lt;build&gt;</code>中定义过滤器资源。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">     ......</span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 自定义过滤器资源文件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filters</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">filter</span>&gt;</span>filter-values.properties<span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">filters</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            ......</span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果资源中本来存在不需要被替换的<code>$&#123;&#125;</code>字符，则可以在<code>$</code>前加<code>\</code>，同时在<code>maven-resources-plugin</code>插件配置的<code>&lt;configuration&gt;</code>中使用<code>&lt;escapeString&gt;</code>；若目录下存在二进制文件，则需要通过以下的后缀名来排除。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 配置资源文件中的转义字符 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">escapeString</span>&gt;</span>\<span class="tag">&lt;/<span class="name">escapeString</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 如目录下存在二进制文件，则需要通过以下的后缀名来排除 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nonFilteredFileExtensions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nonFilteredFileExtension</span>&gt;</span>pdf<span class="tag">&lt;/<span class="name">nonFilteredFileExtension</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nonFilteredFileExtension</span>&gt;</span>swf<span class="tag">&lt;/<span class="name">nonFilteredFileExtension</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nonFilteredFileExtensions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果你需要在其他阶段拷贝资源文件，可以使用插件目标copy-resources，类似配置如下：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;plugin&gt;</span></span><br><span class="line">    <span class="params">&lt;artifactId&gt;</span>maven-resources-plugin<span class="params">&lt;/artifactId&gt;</span></span><br><span class="line">    <span class="params">&lt;version&gt;</span><span class="number">3.0</span><span class="number">.2</span><span class="params">&lt;/version&gt;</span></span><br><span class="line">    <span class="params">&lt;executions&gt;</span></span><br><span class="line">      <span class="params">&lt;execution&gt;</span></span><br><span class="line">        <span class="params">&lt;id&gt;</span>copy-resources<span class="params">&lt;/id&gt;</span></span><br><span class="line">        <span class="params">&lt;phase&gt;</span>validate<span class="params">&lt;/phase&gt;</span></span><br><span class="line">        <span class="params">&lt;goals&gt;</span></span><br><span class="line">            <span class="params">&lt;goal&gt;</span>copy-resources<span class="params">&lt;/goal&gt;</span></span><br><span class="line">        <span class="params">&lt;/goals&gt;</span></span><br><span class="line">        <span class="params">&lt;configuration&gt;</span></span><br><span class="line">            <span class="params">&lt;outputDirectory&gt;</span>$&#123;basedir&#125;<span class="meta-keyword">/target/</span>extra-resources<span class="params">&lt;/outputDirectory&gt;</span></span><br><span class="line">            <span class="params">&lt;resources&gt;</span>          </span><br><span class="line">                <span class="params">&lt;resource&gt;</span></span><br><span class="line">                    <span class="params">&lt;directory&gt;</span>src/non-packaged-resources<span class="params">&lt;/directory&gt;</span></span><br><span class="line">                    <span class="params">&lt;filtering&gt;</span>true<span class="params">&lt;/filtering&gt;</span></span><br><span class="line">                <span class="params">&lt;/resource&gt;</span></span><br><span class="line">            <span class="params">&lt;/resources&gt;</span>              </span><br><span class="line">        <span class="params">&lt;/configuration&gt;</span>            </span><br><span class="line">      <span class="params">&lt;/execution&gt;</span></span><br><span class="line">    <span class="params">&lt;/executions&gt;</span></span><br><span class="line"><span class="params">&lt;/plugin&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>更详细的配置请参考<a href="http://maven.apache.org/plugins/maven-resources-plugin/"><code>maven-resources-plugin</code>插件官网</a></p></blockquote><p>简单总结：resources及其对应的插件的作用就是用于资源文件的处理（变量替换、编译时资源文件复制等），为后续的项目打包阶段作准备。</p><blockquote><p>一定要注意与<code>maven-assemble-plugin</code>插件区别开来，因为<code>assemble</code>也涉及到配置文件的拷贝。</p></blockquote><h3 id="2-3-测试相关插件配置"><a href="#2-3-测试相关插件配置" class="headerlink" title="2.3. 测试相关插件配置"></a>2.3. 测试相关插件配置</h3><p>本文章所讲的测试主要是指单元测试与集成测试：</p><ul><li>Maven通过<code>maven-surefire-plugin</code>插件执行单元测试</li><li>Maven通过<code>maven-failsafe-plugin</code>插件执行集成测试</li></ul><h4 id="2-3-1-单元测试配置"><a href="#2-3-1-单元测试配置" class="headerlink" title="2.3.1. 单元测试配置"></a>2.3.1. 单元测试配置</h4><p>在pom.xml中配置JUnit，TestNG测试框架的依赖，即可自动识别和运行<code>src/test/Java</code>目录下利用该框架编写的测试用例。常用配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.18.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 在构建过程中如需要跳过单元测试阶段，则将skipTests节点值设置为true --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 忽略测试失败以继续构建项目，不推荐 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">testFailureIgnore</span>&gt;</span>true<span class="tag">&lt;/<span class="name">testFailureIgnore</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>想跳过单元测试还可以使用如下方式：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式一：不执行测试用例，但编译测试用例类生成相应的class文件至target/test-classes下</span></span><br><span class="line">mvn <span class="keyword">install</span> -DskipTests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：不执行测试用例，也不编译测试用例类</span></span><br><span class="line">mvn <span class="keyword">install</span> -Dmaven.<span class="keyword">test</span>.skip=<span class="keyword">true</span></span><br></pre></td></tr></table></figure><p>当然，如果你明确用的是<code>JUnit4.7</code>及以上版本，可以明确声明：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.surefire<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>surefire-junit47<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>surefire默认的查找测试类的模式如下：</p><ul><li><code>**/Test*.java</code></li><li><code>**/*Test.java</code></li><li><code>**/*TestCase.java</code></li></ul><p>如果由于历史原因，测试类不符合默认的三种命名模式，可以通过pom.xml设置<code>maven-surefire-plugin</code>插件添加命名模式或排除一些命名模式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*Tests.java<span class="tag">&lt;/<span class="name">include</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/*ServiceTest.java<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/TempDaoTest.java<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>更详细的配置可直接参考<a href="http://maven.apache.org/surefire/maven-surefire-plugin/">surefire插件官网</a></p></blockquote><h4 id="2-3-2-集成测试配置"><a href="#2-3-2-集成测试配置" class="headerlink" title="2.3.2. 集成测试配置"></a>2.3.2. 集成测试配置</h4><p>集成测试过程涉及运行环境准备，如启动tomcat容器等。而单元测试插件有一个特征是如果有一个单元测试用例失败，则会中止整个Maven构建过程，此时会导致之前创建的集成测试环境如tomcat容器未能及时关闭，因此便有了failsafe的用武之地。</p><p>Maven构建生命周期中有四个阶段与集成测试有关:</p><ul><li>pre-integration-test：准备集成测试环境</li><li>integration-test：进行正式的集成测试</li><li>post-integration-test：清理集成测试环境</li><li>verify：检查集成测试结果</li></ul><p>当failsafe插件在构建过程的<code>integration-test</code>或<code>verify</code>阶段被调用而进行集成测试时，测试用例执行过程中就算失败也不会中止构建过程，而会继续执行<code>post-integration-test</code>阶段以进行环境清理操作。</p><p><code>maven-failsafe-plugin</code>插件需要与各种容器插件搭配使用，常用的容器类插件有：tomcat，jetty或者更高级的cargo等。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--指定单元测试不执行 否则先执行单元测试 地址不通--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--集成测试的插件配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-failsafe-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.19.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">suiteXmlFiles</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--指定配置文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">suiteXmlFile</span>&gt;</span>testng.xml<span class="tag">&lt;/<span class="name">suiteXmlFile</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">suiteXmlFiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>integration-tests<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goal</span>&gt;</span>integration-test<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goal</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--tomcat插件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--部署的端口和配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--什么时候启动 什么时候终止--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>tomcat-run<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goal</span>&gt;</span>run-war-only<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>pre-integration-test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>tomcat-shutdown<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shutdown<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>post-integration-test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>更详细的配置可直接参考<a href="https://maven.apache.org/surefire/maven-failsafe-plugin/index.html">failsafe插件官网</a></p></blockquote><h3 id="2-4-打包相关配置"><a href="#2-4-打包相关配置" class="headerlink" title="2.4. 打包相关配置"></a>2.4. 打包相关配置</h3><p>Maven中的打包类型有：jar包、war包以及zip等方便部署的压缩包。</p><h4 id="2-4-1-打Jar包相关配置"><a href="#2-4-1-打Jar包相关配置" class="headerlink" title="2.4.1. 打Jar包相关配置"></a>2.4.1. 打Jar包相关配置</h4><p>Jar包又可分为普通的jar包、可执行jar包。前者通过<code>maven-jar-plugin</code>插件就能搞定。对于打可执行的jar包有多种方式：</p><ul><li>使用<code>maven-jar-plugin</code>和<code>maven-dependency-plugin</code>插件打包</li></ul><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">archive</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- 在MANIFEST.MF加上Class-Path项并配置依赖包 --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!-- 指定依赖包所在目录 --&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.simiam.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!-- 将当前目录也加入到classpath中 --&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Class-Path</span>&gt;</span>./<span class="tag">&lt;/<span class="name">Class-Path</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$</span><span class="template-variable">&#123;project.build.directory&#125;</span><span class="xml">/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>上述配置所生成的MANIFEST.MF文件中将包含如下内容：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Class</span>-Path: lib/commons-logging-<span class="number">1</span>.<span class="number">2</span>.jar lib/commons-io-<span class="number">2</span>.<span class="number">4</span>.jar</span><br><span class="line"><span class="attribute">Main</span>-Class: com.simiam.Main</span><br></pre></td></tr></table></figure><p><code>maven-jar-plugin</code>插件只是生成MANIFEST.MF文件，<code>maven-dependency-plugin</code>插件用于将依赖包拷贝到<code>&lt;outputDirectory&gt;$&#123;project.build.directory&#125;/lib&lt;/outputDirectory&gt;</code>指定的位置，即<code>target/lib</code>目录下。</p><p>这种打包方式可以实现依赖的jar包与自研jar包分开，但配置相关的资源文件也被打进jar包中，后续想修改配置信息将很头痛，同时这种打包方式无法解决部署文件目录结构复杂的场景。</p><blockquote><p>延伸阅读：<code>configuration</code>下的<code>classifier</code>节点的作用是什么？在以前的插件版本中会存在<code>excludes</code>配置项不生效的问题，目前这个问题已不存在；如果出现这个问题，那一般是默认的执行目标不对导致（<code>mvn package的运行日志中maven-jar-plugin会执行两次，但目标不一样，分别为default-jar, default</code>）。</p></blockquote><ul><li>使用<code>maven-assembly-plugin</code>插件打包</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.simiam.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这种打包方式会将所有依赖的jar包中的内容抽取出来，并与自研的代码合在一起打在同一个Jar包中。不过，如果项目使用了SPI机制，且多个依赖中都有SPI实现类，则用这种方式打出来的包会因为相互覆盖问题导致运行时的不确定性甚至出错。比如项目中用到了<code>Spring Framework</code>，将依赖打到一个jar包中，运行时会出现读取<code>XML schema</code>文件出错。原因是<code>Spring Framework</code>的多个jar包中包含相同的文件<code>spring.handlers</code>和<code>spring.schemas</code>，如果生成一个jar包会互相覆盖。此时可以借助<code>maven-shade-plugin</code>插件来解决这个问题。</p><p>使用<code>maven-shade-plugin</code>插件解决Spring应用打包覆盖问题的配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.simiam.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resource</span>&gt;</span>META-INF/spring.handlers<span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resource</span>&gt;</span>META-INF/spring.schemas<span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>使用<code>maven-jar-plugin</code>和<code>maven-assembly-plugin</code>插件打包</li></ul><p>之前有提过，用<code>maven-jar-plugin</code>与<code>maven-dependences-plugin</code>插件打包时，配置相关的资源文件也被打进jar包中，后续想修改配置信息将很头痛，同时这种打包方式无法解决部署文件目录结构复杂的场景。因此就有了使用<code>maven-jar-plugin</code>和<code>maven-assembly-plugin</code>插件打包的方式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.simiam.HttpIpv6StatisticTaskLauncher<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Class-Path</span>&gt;</span>.<span class="tag">&lt;/<span class="name">Class-Path</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- **表示0到N级目录，即包括conf目录 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>conf/**/*.properties<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appendAssemblyId</span>&gt;</span>false<span class="tag">&lt;/<span class="name">appendAssemblyId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">descriptors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/main/assembly/package.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">descriptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>里面的关键就是<code>package.xml</code>这个文件了，它告诉插件具体应该如何组织打包等。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>package<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">formats</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span>&gt;</span>zip<span class="tag">&lt;/<span class="name">format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">includeBaseDirectory</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeBaseDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fileSets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileSet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>/<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>*.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">fileSet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fileSets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencySets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- &lt;exclude&gt;$&#123;project.name&#125;-$&#123;project.version&#125;&lt;/exclude&gt; --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>$&#123;groupId&#125;:$&#123;artifactId&#125;<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencySet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencySets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><code>maven-assembly-plugin</code>插件的详细介绍见<a href="http://maven.apache.org/plugins/maven-assembly-plugin/">官网</a>。</p></blockquote><ul><li>使用<code>maven-assembly-plugin</code>插件和shell脚本打包</li></ul><p>当然借助<code>maven-assembly-plugin</code>插件与shell脚本配合也可以实现上面的功能，但相对复杂一些；能用上一种方式解决的就不要用shell在代替<code>maven-jar-plugin</code>插件的功能。这里简单提供示例的shell脚本与bat脚本。</p><blockquote><p>脚本来源：<code>~/workspace/Java/news-recommend/recommend-sys/news-recommend/recommend-osf</code></p></blockquote><p><strong>shell脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</span><br><span class="line">BIN_DIR=`<span class="built_in">pwd</span>`</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">DEPLOY_DIR=`<span class="built_in">pwd</span>`</span><br><span class="line">LOGS_DIR=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$LOGS_FILE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    LOGS_DIR=`dirname <span class="variable">$LOGS_FILE</span>`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    LOGS_DIR=<span class="variable">$DEPLOY_DIR</span>/logs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$LOGS_DIR</span> ]; <span class="keyword">then</span></span><br><span class="line">    mkdir <span class="variable">$LOGS_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">STDOUT_FILE=<span class="variable">$LOGS_DIR</span>/stdout.log</span><br><span class="line">JVM_ERR_FILE=<span class="string">&quot; -XX:ErrorFile=<span class="variable">$DEPLOY_DIR</span>/hs_err_pid%p.log &quot;</span></span><br><span class="line"></span><br><span class="line">CONF_DIR=<span class="variable">$DEPLOY_DIR</span>/conf</span><br><span class="line">LIB_DIR=<span class="variable">$DEPLOY_DIR</span>/lib</span><br><span class="line">LIB_JARS=`ls <span class="variable">$LIB_DIR</span>|grep .jar|awk <span class="string">&#x27;&#123;print &quot;&#x27;</span><span class="variable">$LIB_DIR</span><span class="string">&#x27;/&quot;$0&#125;&#x27;</span>|tr <span class="string">&quot;\n&quot;</span> <span class="string">&quot;:&quot;</span>`</span><br><span class="line"></span><br><span class="line">JAVA_DEBUG_OPTS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;debug&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JAVA_DEBUG_OPTS=<span class="string">&quot; -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,address=8787,server=y,suspend=n &quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">JAVA_JMX_OPTS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;jmx&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JAVA_JMX_OPTS=<span class="string">&quot; -Dcom.sun.management.jmxremote -Djava.rmi.server.hostname=localhost -Dcom.sun.management.jmxremote.port=1099 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false &quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">JAVA_MEM_OPTS=<span class="string">&quot;&quot;</span></span><br><span class="line">BITS=`java -version 2&gt;&amp;1 | grep -i 64-bit`</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$BITS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    JAVA_MEM_OPTS=<span class="string">&quot; -server -Xmx4g -Xms4g -XX:NewRatio=1 -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m -Xss256k -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/wwwroot/news-recommend-osf/ &quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    JAVA_MEM_OPTS=<span class="string">&quot; -server -Xms1g -Xmx1g -XX:PermSize=128m -XX:SurvivorRatio=2 -XX:+UseParallelGC &quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$BIN_DIR</span></span><br><span class="line"></span><br><span class="line">nohup java <span class="variable">$JAVA_OPTS</span> <span class="variable">$JAVA_MEM_OPTS</span> <span class="variable">$JVM_ERR_FILE</span> <span class="variable">$JAVA_DEBUG_OPTS</span> <span class="variable">$JAVA_JMX_OPTS</span> -classpath <span class="variable">$BIN_DIR</span>:<span class="variable">$CONF_DIR</span>:<span class="variable">$LIB_JARS</span> com.simiam.recommend.osf.RecommendOsfLauncher &gt; <span class="variable">$STDOUT_FILE</span> 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;JAVA_JMX_OPTS: <span class="variable">$JAVA_JMX_OPTS</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OK!&quot;</span></span><br><span class="line">PIDS=`ps -f | grep java | grep <span class="string">&quot;<span class="variable">$DEPLOY_DIR</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PID: <span class="variable">$PIDS</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;STDOUT: <span class="variable">$STDOUT_FILE</span>&quot;</span></span><br></pre></td></tr></table></figure><p><strong>bat脚本</strong></p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off &amp; <span class="built_in">setlocal</span> enabledelayedexpansion</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> LIB_JARS=&quot;&quot;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ..\lib</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%i</span> <span class="keyword">in</span> (*) <span class="keyword">do</span> <span class="built_in">set</span> LIB_JARS=<span class="variable">!LIB_JARS!</span>;..\lib\<span class="variable">%%i</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ..\bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> &quot;&quot;%<span class="number">1</span>&quot;&quot; == &quot;&quot;debug&quot;&quot; <span class="keyword">goto</span> debug</span><br><span class="line"><span class="keyword">if</span> &quot;&quot;%<span class="number">1</span>&quot;&quot; == &quot;&quot;jmx&quot;&quot; <span class="keyword">goto</span> jmx</span><br><span class="line"></span><br><span class="line">java -Xms64m -Xmx1024m -XX:MaxPermSize=<span class="number">64</span>M -cp ..\conf;<span class="variable">%LIB_JARS%</span> com.simiam.recommend.osf.RecommendOsfLauncher</span><br><span class="line"><span class="keyword">goto</span> end</span><br><span class="line"></span><br><span class="line">:debug</span><br><span class="line">java -Xms64m -Xmx1024m -XX:MaxPermSize=<span class="number">64</span>M -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,address=<span class="number">8787</span>,server=y,suspend=n -cp ..\conf;<span class="variable">%LIB_JARS%</span> com.simiam.recommend.osf.RecommendOsfLauncher</span><br><span class="line"><span class="keyword">goto</span> end</span><br><span class="line"></span><br><span class="line">:jmx</span><br><span class="line">java -Xms64m -Xmx1024m -XX:MaxPermSize=<span class="number">64</span>M -Dcom.sun.management.jmxremote.port=<span class="number">1099</span> -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -cp ..\conf;<span class="variable">%LIB_JARS%</span> com.simiam.recommend.osf.RecommendOsfLauncher</span><br><span class="line"><span class="keyword">goto</span> end</span><br><span class="line"></span><br><span class="line">:end</span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure><h4 id="2-4-2-打War包相关配置"><a href="#2-4-2-打War包相关配置" class="headerlink" title="2.4.2. 打War包相关配置"></a>2.4.2. 打War包相关配置</h4><p>打war包的核心插件为<code>maven-war-plugin</code>，因为war包不涉及配置文件独立配置问题，同时其目录结构需要符合servlet规范，因此其打包方式相对简单，基本上只要参考<a href="https://maven.apache.org/plugins/maven-war-plugin/">官网</a>即可。如果说非要注意的无非就以下一点：</p><ul><li>由于<code>servlet3.0</code>及以上版本的来说，工程中可以不提供web.xml文件，如果用<code>maven-war-plugin</code>插件的旧版本（3.0.0版本以下）在打包时会报找不到web.xml文件而中止打包，在这种情况下需要在插件配置节点中设置<code>&lt;failOnMissingWebXml&gt;false&lt;/failOnMissingWebXml&gt;</code>，举例如下：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">failOnMissingWebXml</span>&gt;</span>false<span class="tag">&lt;/<span class="name">failOnMissingWebXml</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用web.xml文件路径 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">webXml</span>&gt;</span>src/config/dev/web.xml<span class="tag">&lt;/<span class="name">webXml</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 将某些需要的文件拷贝到WEB-INF下 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">webResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/config/dev<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>WEB-INF<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">webResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-5-依赖分析相关配置"><a href="#2-5-依赖分析相关配置" class="headerlink" title="2.5.. 依赖分析相关配置"></a>2.5.. 依赖分析相关配置</h3><p>我们会经常碰到这样的问题，在pom中引入了一个jar，里面默认依赖了其他的jar包。jar包一多的时候，我们很难确认哪些jar是我们需要的，哪些jar是冲突的。此时会出现很多莫名其妙的问题，什么类找不到啦，方法找不到啦，这种可能的原因就是jar的版本不是我们所设想的版本，但是我们也不知道低版本的jar是从哪里引入的。此时就出现<code>maven-enforcer-plugin</code>插件，其正是用于排查及解决此问题的有力工具。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-enforcer-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>enforce<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependencyConvergence</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>enforce<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在进行mvn clean package的时候，会在console中打印出来冲突的jar版本和其父pom，如下：</p><figure class="highlight profile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Dependency convergence error for org.slf4j:slf4j-api1.6.1 paths to dependency are:</span><br><span class="line"> </span><br><span class="line">[ERROR]</span><br><span class="line">Dependency convergence error for org.slf4j:slf4j-api:<span class="number">1.6</span><span class="number">.1</span> paths to dependency are:</span><br><span class="line">+-org.myorg:my-project:<span class="number">1.0</span><span class="number">.0</span>-SNAPSHOT</span><br><span class="line">  +-org.slf4j:slf4j-jdk14:<span class="number">1.6</span><span class="number">.1</span></span><br><span class="line">    +-org.slf4j:slf4j-api:<span class="number">1.6</span><span class="number">.1</span></span><br><span class="line">and</span><br><span class="line">+-org.myorg:my-project:<span class="number">1.0</span><span class="number">.0</span>-SNAPSHOT</span><br><span class="line">  +-org.slf4j:slf4j-nop:<span class="number">1.6</span><span class="number">.0</span></span><br><span class="line">    +-org.slf4j:slf4j-api:<span class="number">1.6</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><p>这个时候，我们看一眼就知道应该把哪个<code>dependency</code>中的哪个jar进行<code>exclude</code>。</p><blockquote><p>插件详细配置说明见<a href="http://maven.apache.org/enforcer/enforcer-rules/index.html">插件官网</a></p></blockquote><h3 id="2-6-SpringBoot插件配置"><a href="#2-6-SpringBoot插件配置" class="headerlink" title="2.6. SpringBoot插件配置"></a>2.6. SpringBoot插件配置</h3><p>因为<code>spring-boot-maven-plugin</code>插件已经为我们准备了一切，如果无特别需求，我们基本只需要简单引入即可：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.simiam.PerfHttpIpv6App<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 因为spring-boot-maven-plugin未提供源码打包插件，所以我们需要自己添加 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-sources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-7-小结"><a href="#2-7-小结" class="headerlink" title="2.7. 小结"></a>2.7. 小结</h3><p>还有非常多的插件，就不在这里一一介绍了，各位可以直接看<a href="https://maven.apache.org/plugins/index.html">官网</a></p><ul><li>maven-shade-plugin</li><li>maven-dependences-plugin</li><li>exec-maven-plugin</li><li>……</li></ul><h2 id="3-profile配置"><a href="#3-profile配置" class="headerlink" title="3. profile配置"></a>3. profile配置</h2><blockquote><p>通过profile中定义的property，基于工程中的properties模板生成最终的properties文件。<br><a href="https://blog.csdn.net/DERRANTCM/article/details/71600274">利用profile实现多环境配置文件打包问题</a></p></blockquote><h3 id="什么是profile配置？"><a href="#什么是profile配置？" class="headerlink" title="什么是profile配置？"></a>什么是profile配置？</h3><p>profile是一组配置的集合，用来设置或者覆盖Maven构建的默认配置。通过profile配置，可以为不同的环境定制构建过程，例如<code>Producation</code>和<code>Development</code>环境。</p><p>Profile在pom.xml中使用<code>activeProfiles或profiles</code>元素指定，并且可以用很多方式触发。Profile 在构建时修改POM，并且为变量设置不同的目标环境（例如，在开发、测试和产品环境中的数据库服务器路径）。</p><h3 id="Profile目前主要有三种类型："><a href="#Profile目前主要有三种类型：" class="headerlink" title="Profile目前主要有三种类型："></a>Profile目前主要有三种类型：</h3><table><thead><tr><th>类型</th><th>在哪里定义</th></tr></thead><tbody><tr><td>Per Project</td><td>定义在工程pom.xml中</td></tr><tr><td>Per User</td><td>定义在Maven设置xml文件中（%USER_HOME%/.m2/settings.xml）</td></tr><tr><td>Global</td><td>定义在Maven全局配置xml文件中（%M2_HOME%/conf/settings.xml）</td></tr></tbody></table><h3 id="Profile激活方式"><a href="#Profile激活方式" class="headerlink" title="Profile激活方式"></a>Profile激活方式</h3><p>Maven的Profile能够通过几种不同的方式激活：</p><ul><li>显式使用命令控制台输入</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dev是profile的ID</span></span><br><span class="line">mvn install -Pdev </span><br></pre></td></tr></table></figure><ul><li>通过maven设置</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在setting.xml文件中添加如下信息，setting.xml位于上节介绍的三种profile类型的相应位置下。</span><br><span class="line"><span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以下三种激活方式不常用，这里不作进一步介绍，有需要的请直接参考<a href="http://wiki.jikexueyuan.com/project/maven/build-profiles.html">这里</a>。</p><ul><li>基于环境变量（用户/系统变量）</li><li>操作系统配置（例如，Windows family）</li><li>现存/缺失文件</li></ul><blockquote><p><strong>注意：</strong>profile节点下定义的元素都会覆盖其所在Pom文件中定义的同名的节点，如同名plugin，properties中的同名属性等。</p></blockquote><h3 id="Spring框架的profile机制与Maven的profile机制的区别"><a href="#Spring框架的profile机制与Maven的profile机制的区别" class="headerlink" title="Spring框架的profile机制与Maven的profile机制的区别"></a>Spring框架的profile机制与Maven的profile机制的区别</h3><ul><li>Spring框架提供的profile机制主要作用于运行时，即应用程序在运行时使用spring提供的profile相关机制来决定应用程序的各种动态行为。</li><li>Maven的profile机制则作用于构建时期，其通常用于生成各种环境（开发、测试、生产）下的与配置相关的资源文件，而这些生成的不同环境的配置文件在应用程序在相应环境下运行时所需要的。</li><li>这两个Profile机制是可以配合使用以实现不同环境下从构建到部署的全程控制。</li></ul><p>比如对于springboot项目来说，可通过maven的profile中添加env属性：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">env</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">env</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当运行<code>mvn install -Pdev</code>时，会复制<code>src/main/resources/application.yml</code>模板文件复制至目标目录下，并将其中的<code>spring.profiles.active: $&#123;env&#125;</code> 配置项的<code>$&#123;env&#125;</code>占位符替换成<code>dev</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/perf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">$&#123;env&#125;</span>  <span class="comment"># 将被替换成目标profile的env属性值</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">perf-ds</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">filters:</span> <span class="string">stat</span></span><br><span class="line">      <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">initialSize:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxWait:</span> <span class="number">60000</span></span><br><span class="line">      <span class="attr">minIdle:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">      <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span></span><br><span class="line">      <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">testOnBorrow:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">poolPreparedStatements:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">maxOpenPreparedStatements:</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapping/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.simiam.http.entity</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">  <span class="attr">helperDialect:</span> <span class="string">postgresql</span></span><br><span class="line">  <span class="attr">reasonable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">supportMethodsArguments:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">params:</span> <span class="string">count=countSql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:postgresql://localhost:5432/perf?currentSchema=dev</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">*****</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">*****</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">prod</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:postgresql://localhost:5432/perf?currentSchema=prod</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">*****</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">*****</span></span><br></pre></td></tr></table></figure><p>最终生成的<code>application.yml</code>将被springboot应用程序使用，其会根据激活的profile选择对应的配置项，连接对应的数据库实例。</p><h2 id="4-其它常见问题汇总"><a href="#4-其它常见问题汇总" class="headerlink" title="4. 其它常见问题汇总"></a>4. 其它常见问题汇总</h2><blockquote><p>本节主要记录日常开发工作中使用maven所挖过、踩过、填过的坑。（不断更新）</p></blockquote><ul><li>使用<code>import scope</code>引入<code>spring-boot-dependencies</code>时无法引用POM中定义的property、pluginManagement等一系列<a href="https://stackoverflow.com/questions/40606267/how-does-importing-maven-dependencies-impact-plugin-management">问题</a></li></ul><blockquote><p>转载请注明出处：<a href="https://simiam.com/">simiam.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Maven学习笔记&quot;&gt;&lt;a href=&quot;#Maven学习笔记&quot; class=&quot;headerlink&quot; title=&quot;Maven学习笔记&quot;&gt;&lt;/a&gt;Maven学习笔记&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;转载请注明出处：&lt;a href=&quot;https://simiam.com/&quot;&gt;simiam.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;本文主要是对Maven学习与使用过程中的一些经验的总结，不是Maven的入门教程，如需要系统学习Maven，您可以看一下&lt;a href=&quot;https://www.amazon.cn/dp/B009WMAZX4&quot;&gt;《Maven实战》&lt;/a&gt;这本书，或看下以下几个在线教程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.infoq.com/cn/maven-practice&quot;&gt;InfoQ上与Maven有关的内容&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://wiki.jikexueyuan.com/project/maven/&quot;&gt;极客学院的Maven教程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/fd43b3d0fdb0&quot;&gt;Maven生命周期介绍&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;1-依赖声明中scope的使用&quot;&gt;&lt;a href=&quot;#1-依赖声明中scope的使用&quot; class=&quot;headerlink&quot; title=&quot;1. 依赖声明中scope的使用&quot;&gt;&lt;/a&gt;1. 依赖声明中scope的使用&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;网络上有太多的文章介绍，但个人还是推荐直接看&lt;a href=&quot;https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html&quot;&gt;官方文档&lt;/a&gt;，英文不好的朋友可以看&lt;a href=&quot;http://tangyanbo.iteye.com/blog/1503957&quot;&gt;这篇有点老的文章&lt;/a&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;除了掌握基本内容外，还需要特别关注以下几个内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;provided与runtime的区别，system知道下有这个东西就行。&lt;/li&gt;
&lt;li&gt;import这个scope是后面引入的新scope，其只能用于&lt;code&gt;&amp;lt;dependencyManagement&amp;gt;&lt;/code&gt;中且类型为pom的依赖项，个人感觉其主要作用在于对依赖版本进行分类管理。&lt;/li&gt;
&lt;li&gt;Maven依赖冲突的解决策略，可以参考&lt;a href=&quot;https://www.jianshu.com/p/f6ca45865025&quot;&gt;这里&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Java" scheme="http://cloudnoter.com/categories/Java/"/>
    
    
    <category term="SpringBoot" scheme="http://cloudnoter.com/tags/SpringBoot/"/>
    
    <category term="Maven" scheme="http://cloudnoter.com/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>学习便签</title>
    <link href="http://cloudnoter.com/2018/08/17/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"/>
    <id>http://cloudnoter.com/2018/08/17/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/</id>
    <published>2018-08-17T09:39:43.000Z</published>
    <updated>2019-11-14T06:56:55.406Z</updated>
    
    <content type="html"><![CDATA[<h1 id="学习便签"><a href="#学习便签" class="headerlink" title="学习便签"></a>学习便签</h1><blockquote><p>转载请注明出处：<a href="http://simiam.com/">simiam.com</a></p></blockquote><h2 id="HUE"><a href="#HUE" class="headerlink" title="HUE"></a>HUE</h2><p>本地源码构建安装：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &lt;hue_dir_path&gt;</span><br><span class="line">export LDFLAGS=-L<span class="regexp">/usr/</span>local<span class="regexp">/opt/</span>openssl/lib</span><br><span class="line">export CPPFLAGS=-I<span class="regexp">/usr/</span>local<span class="regexp">/opt/</span>openssl/<span class="keyword">include</span></span><br><span class="line">make clean</span><br><span class="line">make apps</span><br><span class="line">.<span class="regexp">/build/</span>env<span class="regexp">/bin/</span>supervisor</span><br><span class="line">登录默认用户名密码：admin/admin</span><br></pre></td></tr></table></figure><blockquote><p>转载请注明出处：<a href="http://simiam.com/">simiam.com</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;学习便签&quot;&gt;&lt;a href=&quot;#学习便签&quot; class=&quot;headerlink&quot; title=&quot;学习便签&quot;&gt;&lt;/a&gt;学习便签&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;转载请注明出处：&lt;a href=&quot;http://simiam.com/&quot;&gt;simiam.com&lt;/</summary>
      
    
    
    
    <category term="Java" scheme="http://cloudnoter.com/categories/Java/"/>
    
    
    <category term="Java" scheme="http://cloudnoter.com/tags/Java/"/>
    
    <category term="JVM" scheme="http://cloudnoter.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>CI/CD方案分析</title>
    <link href="http://cloudnoter.com/2018/07/13/CI-CD%E6%96%B9%E6%A1%88%E5%88%86%E6%9E%90/"/>
    <id>http://cloudnoter.com/2018/07/13/CI-CD%E6%96%B9%E6%A1%88%E5%88%86%E6%9E%90/</id>
    <published>2018-07-13T09:56:59.000Z</published>
    <updated>2018-10-31T03:37:54.063Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CI-CD方案分析"><a href="#CI-CD方案分析" class="headerlink" title="CI/CD方案分析"></a>CI/CD方案分析</h1><h2 id="1-DevOps介绍"><a href="#1-DevOps介绍" class="headerlink" title="1. DevOps介绍"></a>1. DevOps介绍</h2><p>随着软件发布迭代的频率越来越高，传统的“瀑布型”（开发—测试—发布）模式已经不能满足快速交付的需求。2009年左右DevOps（Development和Operations的组合）应运而生，简单地来说，就是更好的优化开发(DEV)、测试(QA)、运维(OPS)的流程，开发运维一体化，通过高度自动化工具与流程来使得软件构建、测试、发布更加快捷、频繁和可靠。</p><p><img src="http://img.simiam.com/what-is-devops.jpg" alt="DevOps的组成"></p><p>DevOps出现以前，开发与运维对于生产环境上出现的问题是这样处理的：</p><span id="more"></span><p>运维人员：</p><p><img src="http://img.simiam.com/devops-ops-say.png" alt="It&#39;s not my machine"></p><p>开发人员：</p><p><img src="http://img.simiam.com/devops-dev-say.png" alt="It&#39;s not my code"></p><p>处理问题的模式：（未进行有效沟通，而是相互责备、报怨，在经过长时间的各种扯皮后把问题解决了）</p><p><img src="http://img.simiam.com/before-devops.png" alt="Before apply DevOps"></p><p>DevOps出现以后，开发与运维的关系转变为：</p><p><img src="http://img.simiam.com/devops-love.png" alt="Think for peer"></p><p>因此，他们对于生产环境上出现的问题是这样处理的：</p><p><img src="http://img.simiam.com/devops-together.png" alt="Think for peer"></p><p>处理问题的模式变为：（相互理解，充分沟通并最终快速解决问题）</p><p><img src="http://img.simiam.com/after-devops.png" alt="After apply DevOps"></p><h3 id="1-1-DevOps生命周期"><a href="#1-1-DevOps生命周期" class="headerlink" title="1.1. DevOps生命周期"></a>1.1. DevOps生命周期</h3><p>DevOps集文化理念、实践和工具于一身，可以提高组织高速交付应用程序和服务的能力，与使用传统软件开发和基础设施管理流程相比，能够帮助组织更快地发展和改进产品。这种速度使组织能够更好地服务其客户，并在市场上更高效地参与竞争。</p><p>DevOps是一个完整的面向IT运维的工作流，以IT自动化以及持续集成（CI）、持续部署（CD）为基础，来优化程式开发、测试、系统运维等所有环节，其典型的运作流程如下：</p><p><img src="http://img.simiam.com/devops-lifecycle.png" alt="DevOps-lifecycle"></p><p>上图中的<code>Build, Test, Release</code>对应的CI/CD平台中的构建、测试、交付（部署）这几个概念，也就是说CI/CD是实施DevOps的基础，除此之外还会涉及源码质量管理平台（静态代码分析、潜在BUG分析、单元测试覆盖报表等）。</p><p>实施DevOps前，软件开发管理生命周期如下：</p><p><img src="http://img.simiam.com/devops-old-way.png" alt="before apply devops"></p><p>实施DevOps后，软件开发管理生命周期如下：</p><p><img src="http://img.simiam.com/devops-new-way.png" alt="after apply devops"></p><h3 id="1-2-适用场景"><a href="#1-2-适用场景" class="headerlink" title="1.2. 适用场景"></a>1.2. 适用场景</h3><p>到底DevOps能给企业带来什么样的业务价值呢？DevOps平台的理念固然是将软件研发的全生命周期管理起来，但是并不意味着一定要做到全生命周期的管理，落实到企业内部，终究还是要结合企业的现状和实际的需求，有选择性有目标的去建设。对于企业而言，不管是提升IT的运营效率70%，还是做到开发测试环境的持续集成、自动化测试、自动化部署，亦或是一天部署10次这种DevOps最初的目标，最重要的还是要结合现状，先认清DevOps能给企业带来什么样的业务价值。</p><p>DevOps涉及到源码质量管理、持续集成、持续交付、持续部署、运维管理等多个系统平台，其天然适合那些主要提供线上服务的互联网团队（特别是基于微服务架构的团队）。而对于非互联网企业（主要是传统软件厂商）来说，其主要是为用户提交软件产品，基本不存在运维管理的需求。同时，传统软件厂商的软件开发管理生命周期中，其对源码质量管理、持续集成、持续交付的需求比较强烈，而持续部署主要是为了解决开发与测试环境自动化搭建问题。</p><p>企业引入DevOps也可能需要对企业组织架构进行调整，以解决部门墙问题。</p><blockquote><p>很显然，我们暂时不需要引入DevOps这种软件开发模式。</p></blockquote><h2 id="2-持续集成、持续交付与持续部署"><a href="#2-持续集成、持续交付与持续部署" class="headerlink" title="2. 持续集成、持续交付与持续部署"></a>2. 持续集成、持续交付与持续部署</h2><blockquote><p>持续交付依赖持续集成，而持续部署依赖持续交付，因此我们将这三者放在同一章节里介绍。</p></blockquote><h3 id="2-1-概念介绍"><a href="#2-1-概念介绍" class="headerlink" title="2.1. 概念介绍"></a>2.1. 概念介绍</h3><h4 id="2-1-1-持续集成（Continuous-Integration，简称CI）"><a href="#2-1-1-持续集成（Continuous-Integration，简称CI）" class="headerlink" title="2.1.1. 持续集成（Continuous Integration，简称CI）"></a>2.1.1. 持续集成（Continuous Integration，简称CI）</h4><blockquote><p>持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通过每个成员每天至少集成一次，也就意味着每天可能会发生多次集成。每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，从而尽早地发现集成错误。</p><p>   — 摘自<code>Martin Fowler</code>的文章：<a href="https://www.martinfowler.com/articles/continuousIntegration.html">Continuous Integration</a></p></blockquote><p>传统软件开发模式下，通常情况下是在每个项目成员完成他们各自的任务后才开始进行系统集成。整个集成过程一般会长达数周甚至几个月的时间，在此期间经常出现让所有相关人员都十分痛苦的事情。而持续集成（CI）则将传统软件开发过程中的集成阶段大大提前了，只要有代码提交至源码库（如Git）就会触发构建（包括代码分析）、测试等任务，通过这种频繁的集成来防止传统模式下因集成问题堆积而导致”集成地狱（Integration Hell）“。</p><p>简单讲，持续集成就是不断对合并项目主干的源码进行相应的检查、构建、测试，通常每天至少进行一次；持续集成不是为了避免软件开发过程中的各种问题，而是为了尽量早的发现问题。</p><p>引入CI意味着：在家里远程办公的开发人员A与在公司办公的开发人员B可以很方便的在同一个项目中进行协同办公，而不需要担心源码合并问题，因为他们的每次源码提交操作都会触发CI进行构建、测试以验证他们的代码是否能正常工作。</p><p>开发人员通常会使用CI服务器来进行源码构建与集成，为了让持续集成流程有效的运行起来，项目组的所有开发人员都需要编写单元测试代码以保证其提交的代码能按预期的目标执行，同时不会影响其他人的工作成果。当所有的单元测试用例都执行通过后，这些集成后的代码还不能马上交付或部署至生产环境，因为在交付前还需要在集成测试环境（准生产环境）进行集成测试、验收测试（Acceptance Testing），这部分内容属于持续交付的范畴，下节将会详细介绍。</p><p>下图为持续集成的主要流程：</p><p><img src="http://img.simiam.com/continuous-integration-flow.png" alt="Continuous Integration"></p><p>引入持续集成的好处：</p><ul><li>集成频率高，至少每天一次，集成时间可预期可控。</li><li>可快速暴露问题，加速问题定位</li></ul><h4 id="2-1-2-持续交付"><a href="#2-1-2-持续交付" class="headerlink" title="2.1.2. 持续交付"></a>2.1.2. 持续交付</h4><p>持续交付(Continuous Delivery)是指在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的“准生产环境”（production-like）中。 比如，我们完成单元测试后，可以把代码部署到连接数据库的Staging环境中进行更多的测试。如果代码没有问题，可以继续手动部署到生产环境中。</p><p><img src="http://img.simiam.com/continuous-delivery-flow.png" alt="Continuous Delivery"></p><p>由上图可知，从开发一直到项目可交付整个过程中涉及的环境可能有：开发环境、测试环境（包括压测环境）、准生产环境，生产环境，这整个过程也常被称为部署管道（Deployment Pipeline），每个环境所执行的测试用例也将不一样，只有前一个环境的测试用例全部通过才能继续进入下一个环境（即自动部署新环境 + 执行适合该环境的测试用例）；同时每个环境的执行结果都会及时反馈给相应的开发人员，如果环境部署异常或用例执行失败他们就能更容易更及时的解决问题。</p><p>整个过程基本按“部署环境 -&gt; 执行测试用例 -&gt; … -&gt; 部署环境 -&gt; 执行测试用例”这一模式不断重复，因此为了实现自动化的持续交付，“自动化部署”、“可自动化执行的测试用例”是关键的前提条件。</p><blockquote><p>有一点需要注意，对于提供线上服务的团队，当功能代码可交付时，还需要将相关代码部署至生产环境，但这一部署过程是纯手工的。这也是持续交付与持续部署的区别。</p></blockquote><h4 id="2-1-3-持续部署"><a href="#2-1-3-持续部署" class="headerlink" title="2.1.3. 持续部署"></a>2.1.3. 持续部署</h4><p>持续部署(Continuous Deploy)是在持续交付的基础上，把部署到生产环境的过程自动化。持续部署和持续交付的区别就是最终部署到生产环境是自动化的。</p><p><img src="http://img.simiam.com/continuous-deployment-flow.png" alt="Continuous Deployment"></p><p>这里大家也许有个疑问：在生产环境是否需要执行测试用例，如果需要执行，那会否影响系统性能或产生脏数据？</p><p>这个问题不好简单的回答是或否，从我自己的经验来讲：</p><ul><li>对于线上服务（应用）一般会采用灰度发布，同时只执行关键的验收测试用例，且这些用例所产生的数据会被认定为合法的生产环境数据，不做任何回滚，最多只做备注；</li><li>而对于非线上服务（传统的软件交付方式），则技术支持人员在帮客户安装或升级软件后，也会对关键功能做验证（常见的方式为一键体检之类的工具或自动化脚本）。</li></ul><h2 id="3-可选的工具链"><a href="#3-可选的工具链" class="headerlink" title="3. 可选的工具链"></a>3. 可选的工具链</h2><p>一个项目要引入CI/CD（持续集成与持续交付），一般情况下需要具备以下几个条件：</p><ul><li>源码管理仓库：可以是类似分布式的Git、集中式的SVN。</li><li>搭建CI平台：使用业界流行的CI软件（如Jenkins，Gitlab CI）搭建的CI系统平台。</li><li>源码质量管理平台：主要是指静态代码分析与测试覆盖统计，如业务比较流行的SonarQube，CheckStyle，FindBug等。</li><li>单元测试：项目组的每个成员都需要编写单元测试代码，并严格遵守约定的单元测试相关规范。</li><li>集成测试：包括可自动化执行的测试用例管理（编写、归档等），集成测试环境自动化搭建。</li><li>测试环境搭建自动化：主要是指可以自动化的部署集成测试环境，为集成测试、验收测试准备可用的测试环境。</li><li>软件发布平台：为可交付的软件提供对外发行及展示的平台，如基于Nexus的maven仓库、用于托管docker镜像的镜像仓库、NPM私有仓库等。</li></ul><h3 id="3-1-CI-CD平台分析"><a href="#3-1-CI-CD平台分析" class="headerlink" title="3.1. CI/CD平台分析"></a>3.1. CI/CD平台分析</h3><p>通用指标分析结果：</p><p><img src="http://img.simiam.com/ci-platform-compare.png" alt="CI/CD平台比对"></p><p>上面的分析结果中，排除掉非开源与收费版的，就只剩下Jenkins，Gitlab CI，Go CD，Flow CI四个版本，而flow.ci为国内开源项目，根据国内开源项目的尿性（基本都是先开源后收费），个人认为也不适合使用Flow CI。那么就只剩下三个可选方案了。</p><h4 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h4><p>Jenkins是一款用Java编写的开源的跨平台的CI工具，同时可以通过插件扩展功能。Jenkins插件非常好用，我们可以容易地添加自己的插件。除了它的扩展性之外，Jenkins还有另一个非常好的功能——它可以在多台机器上进行分布式地构建和负载测试。Jenkins是根据MIT许可协议发布的，因此可以自由地使用和分发。</p><p>总的来说：Jenkins是最好的持续集成工具之一，它既强大又灵活。但其UI比较古老，同时学习它可能要花费一些时间，如果你需要一个灵活的持续集成解决方案，那么学习如何使用它将是非常值得的。</p><h4 id="Gitlab-CI"><a href="#Gitlab-CI" class="headerlink" title="Gitlab CI"></a>Gitlab CI</h4><p>GitLab CI是GitLab的一个组成部分，GitLab CI能与GitLab完全集成，可以通过使用GitLab API轻松地作为项目的钩子。GitLab的执行部分（流程构建）使用Go语言编写，可以运行在Windows，Linux，OSX，FreeBSD和Docker上。</p><p>官方的Go Runner可以同时运行多个作业，并具有内置的Docker支持。对基于Gitlab找寻私有源码仓库的公司来说，可以考虑使用Gitlab CI作为其CI/CD平台。</p><h4 id="Go-CD"><a href="#Go-CD" class="headerlink" title="Go CD"></a>Go CD</h4><p>Go CD是ThoughtWorks公司Cruise Control的化身。让Go CD脱颖而出的是它的流水线概念，使复杂的构建流程变得简单。关于流水线概念是如何帮助持续交付，以及如何与Jenkins的流水线流程进行比较，可以参考<a href="https://highops.com/insights/continuous-delivery-pipelines-gocd-vs-jenkins">这里</a>。它最初在设计时就支持流水线概念，消除了构建过程的瓶颈，并能够并行地执行任务。</p><blockquote><p>Jenkins也可以通过plugins机制引入流水线功能。</p></blockquote><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>本文章只提供三个可选方案，每个方案各有其优势：</p><ul><li>Jenkins拥有广泛的群众基础，社区活跃，插件丰富，同时还有Jenkins Job Builder这种美妙的Job自动化插件，很多开源项目都使用Jenkins作为其CI平台。</li><li>GitLab CI能与GitLab完全集成是其一个非常重要的优势，同时其GoRunner机制相当灵活，最新版本引入DevOps流程，同时支持K8S。</li><li>Go CD脱颖而出的是它的流水线概念，使复杂的构建流程变得简单。</li></ul><p>但具体选择哪一款，还是得根据项目团队的实际需要来定。对于我们组来讲，Jenkins基本能满足需求，个人认为可优先使用Jenkins并收集使用过程中碰到的问题与新需求；同时，在资源允许的情况下可事先安排人员深入分析这三个平台以后需。</p><h3 id="3-2-代码质量管理平台"><a href="#3-2-代码质量管理平台" class="headerlink" title="3.2. 代码质量管理平台"></a>3.2. 代码质量管理平台</h3><h4 id="SonarQube"><a href="#SonarQube" class="headerlink" title="SonarQube"></a>SonarQube</h4><p>随着IT行业中软件产品的推陈出新，客户对于软件产品的要求也越来越高，因此如何高质量的管理软件代码，及时地对代码质量进行分析并给出合理的解决方案就成为了当下必须要解决的一个问题。与当今众多的代码质量管理工具相比，SonarQube更具有特色和竞争力，其优势主要体现为：它是一个开源的代码质量管理系统，支持25+种语言，可以通过使用插件机制与eclipse、JIRA、Jenkins等其他外部工具集成，从而实现了对代码质量的全面自动化分析和管理。</p><p>SonarQube既可以本地安装也可以选择托管在云端，云端托管地址为：<a href="https://sonarcloud.io/">https://sonarcloud.io/</a>。</p><p>可用的SonarQube管理平台：<a href="http://172.21.192.216:9000/">SonarQube Demo</a></p><p><img src="http://img.simiam.com/sonarqube-demo.png" alt="SonarQube截图"></p><h4 id="Jenkins-CheckStyle-FindBug"><a href="#Jenkins-CheckStyle-FindBug" class="headerlink" title="Jenkins + CheckStyle + FindBug"></a>Jenkins + CheckStyle + FindBug</h4><p>Jenkins，CheckStyle，FindBug三者配合起来能够实现最基本代码分析需求，但其分析结果展现还需要再配合其他插件来实现，同时其展示界面比较古老，本质上讲该功能是依附于Jenkins的，并不是一个独立的代码质量管理平台。</p><h3 id="3-3-自动化测试工具"><a href="#3-3-自动化测试工具" class="headerlink" title="3.3. 自动化测试工具"></a>3.3. 自动化测试工具</h3><h4 id="3-3-1-支持BDD-行为驱动开发-的自动化测试框架分析"><a href="#3-3-1-支持BDD-行为驱动开发-的自动化测试框架分析" class="headerlink" title="3.3.1. 支持BDD(行为驱动开发)的自动化测试框架分析"></a>3.3.1. 支持BDD(行为驱动开发)的自动化测试框架分析</h4><p>自动化测试可以快速自动完成大量测试用例，节约巨大的人工测试成本；同时它需要拥有专业开发技能的人才能完成开发，且需要大量时间进行维护（在需求经常变化的情况下），所以大部分具有很好开发技能的人员不是很愿意编写自动化用例。但由于软件规模的高速增长，人力资源的逐步稀缺，自动化测试已是势在必行。</p><p>对于自动化测试首先需要保证其功能是对客户有价值的和正确可用的。而这一切的基础就是用例要能测试客户的需求，期望，最好能让客户参与到测试用例的开发过程中来或让客户评审测试用例，因此出现了ATDD、BDD等各种理论方法来支撑这一行为。现有很多自动化测试工具可支持ATDD、BDD等，比如Cucumber、RobotFramework、SpecFlow、JBehave、Fitness、Concordion、Guage等，其中Cucumber和RobotFramework是最流行的两个框架，本文将简单分析这两个框架（想要完全搞懂这两个框架还是需要安排相关资源投入分析）：</p><p><img src="http://img.simiam.com/cucumber-robot-compare.png" alt="Cucumber VS RobotFramework"></p><h4 id="3-3-2-单元测试Mock框架"><a href="#3-3-2-单元测试Mock框架" class="headerlink" title="3.3.2. 单元测试Mock框架"></a>3.3.2. 单元测试Mock框架</h4><p>单元测试的思路是在不涉及依赖关系的情况下测试代码（隔离性），所以测试代码与其他类或者系统的关系应该尽量被消除。一个可行的消除方法是替换掉依赖类（测试替换），也就是说我们可以使用替身来替换掉真正的依赖对象。</p><p>常见的测试模拟类的分类如下：</p><ul><li><code>dummy object</code>：其作为参数传递给方法但是绝对不会被使用。比如说，这种测试类内部的方法不会被调用，或者是用来填充某个方法的参数。</li><li><code>Fake</code>：它是真正接口或抽象类的实现类，但其对象内部实现很简单。比如说，它存在内存中而不是数据库中。（即：Fake实现了真正的逻辑，但它的存在只是为了测试，而不适合于用在产品中。）</li><li><code>stub</code>：Stub类是依赖类的部分方法实现，而这些方法在进行类和接口的测试时会被用到，也就是说stub类在测试中会被实例化。stub类会回应任何外部调用。stub类有时候还会记录调用的一些信息。</li><li><code>mock object</code>：其是指类或者接口的模拟实现，我们可以自定义这个对象中某个方法的输出结果；Stub和Mock虽然都是模拟外部依赖，但Stub是完全模拟一个外部依赖， 而Mock还可以用来判断测试通过还是失败。</li></ul><p>我们可以手动创建一个Mock对象或者使用Mock框架来模拟这些类，Mock框架允许你在运行时创建Mock对象并且定义它的行为。</p><p>一个典型的例子是把Mock对象模拟成数据的提供者。在正式的生产环境中它会被实现用来连接数据源。但是我们在测试的时候Mock对象将会模拟成数据提供者来确保我们的测试环境始终是相同的。</p><p>通过Mock对象或者Mock框架，我们可以测试代码中期望的行为。</p><h5 id="Mockito-EasyMock-PowerMock"><a href="#Mockito-EasyMock-PowerMock" class="headerlink" title="Mockito, EasyMock, PowerMock"></a>Mockito, EasyMock, PowerMock</h5><ul><li>EasyMock是相对比较早出现的Mock框架，现在流行度不如Mockito。</li><li>Mockito是一个流行Mock框架，它刚开始基本只是对EasyMock的增强，但后面基本重写了，其整个风格与EasyMock基本不一样了。它可以和JUnit/TestNG结合起来使用。Mockito允许你创建和配置Mock对象。使用Mockito可以明显的简化对外部依赖的测试类的开发。</li><li>PowerMock也是一个单元测试模拟框架，它是在EasyMock和Mockito框架的基础上做出的扩展。通过提供定制的类加载器以及一些字节码篡改技巧的应用，PowerMock实现了对静态方法、构造方法、私有方法以及Final方法的模拟支持等强大的功能（即对于<code>静态方法、构造方法、私有方法以及Final方法</code>来说，EasyMock与Mockito都无能为力，需要结合PowerMock来搞定）。</li></ul><blockquote><p>Mockito与EasyMock的比较可参考：<a href="https://github.com/mockito/mockito/wiki/Mockito-vs-EasyMock">https://github.com/mockito/mockito/wiki/Mockito-vs-EasyMock</a></p></blockquote><h3 id="3-4-自动化部署工具"><a href="#3-4-自动化部署工具" class="headerlink" title="3.4. 自动化部署工具"></a>3.4. 自动化部署工具</h3><h4 id="Foreman"><a href="#Foreman" class="headerlink" title="Foreman"></a>Foreman</h4><p>在介绍Foreman之前，我们先介绍下<code>[Bare Metal Provisioning]</code>这个术语（英语不好，暂且翻译为“裸机供应”）。所谓<code>Bare Metal Provisioning</code>是指为一台服务器（物理机或虚拟机）安装指定的操作系统的过程。通常情况下，有两种办法为服务器安装操作系统：</p><ul><li>使用DVD等存储媒介人工一台一台安装</li><li>使用软件工具自动化的批量安装，<code>Foreman</code>就是这样的软件工具，类似的还有<code>Razor, Cobbler, RackHD</code>。</li></ul><p>当然Foreman除了“裸机供应”能力外，它还有提供了其它服务，如与<code>Puppet, Chef</code>配合实现自动化配置与管理，它还提供了一个可视化的管理平台。更详细的信息还请直接访问<a href="https://www.theforeman.org/">官网</a>。</p><blockquote><p>Foreman是用Ruby语言开发的。</p></blockquote><h4 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a>Ansible</h4><p><a href="https://www.ansible.com/">Ansilbe</a>是一个部署一群远程主机的工具。远程的主机可以是远程虚拟机或物理机， 也可以是本地主机。</p><blockquote><p>Ansible与Open Source Puppet一样，不具备“裸机供应”能力，其也需要与Foreman或<a href="https://github.com/sergevs/ansible-os-autoinstall">ansible-os-autoinstall</a>等工具配合使用。</p></blockquote><p>Ansible最初是作为自动化工具（如PupPET和Chef）的轻量级替代而开发的；但是它是用Python编写的（而不是Ruby），并且采用了一个基于SSH的无代理的架构（即不是采用Puppet的C/S架构，在被管理节点上不需要安装任何特殊软件）。</p><p>Ansilbe通过SSH协议实现远程节点和管理节点之间的通信，但是SSH必须配置为公钥认证登录方式，而非密码认证。理论上说，只要管理员通过ssh登录到一台远程主机上能做的操作，Ansible都可以做到。包括：</p><ul><li>拷贝文件</li><li>安装软件包</li><li>启动服务</li><li>……</li></ul><p>总得来说，Ansible有如下特点：</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</span><br><span class="line"><span class="number">2</span>、默认使用SSH协议对设备进行管理；</span><br><span class="line"><span class="number">3</span>、有大量常规运维操作模块，可实现日常绝大部分操作。</span><br><span class="line"><span class="number">4</span>、配置简单、功能强大、扩展性强；</span><br><span class="line"><span class="number">5</span>、支持API及自定义模块，可通过Python轻松扩展；</span><br><span class="line"><span class="number">6</span>、通过Playbooks来定制强大的配置、状态管理；</span><br><span class="line"><span class="number">7</span>、轻量级，无需在客户端安装<span class="built_in">agent</span>，更新时，只需在操作机上进行一次更新即可；</span><br><span class="line"><span class="number">8</span>、提供一个功能强大、操作性强的Web管理界面和REST API接口——AWX平台。</span><br></pre></td></tr></table></figure><blockquote><p>Ansible是用Python开发的，它目前已被Redhat收购，是自动化运维工具中认可度最高的。oVirt的很多自动化部署子项目都是用Ansible开发的。</p></blockquote><h4 id="Puppet"><a href="#Puppet" class="headerlink" title="Puppet"></a>Puppet</h4><p><a href="https://puppet.com/">Puppet</a>是开源的系统配置管理工具，基于C/S的部署架构。是一个为实现数据中心自动化管理而设计的配置管理软件，它使用跨平台语言规范，管理配置文件、用户、软件包、系统服务等。Puppet开源项目创建之初主要是为了解决配置管理自动化的相关问题，该项目目前存在两种形态：</p><ul><li>Open Source Puppet：仍然是提供配置管理自动化方案，其通常是与Foreman配合完成数据中心服务器从OS安装到网络配置、应用配置等一系列自动化配置管理操作。</li><li>Puppet Enterprise：收费版本，其不需要借助Foreman等第三方服务就可完成服务器OS安装配置管理，即提供了一站式的解决方案。</li></ul><blockquote><p>Puppet也是用Ruby语言开发的。</p></blockquote><p>由于Ansible与Puppet属于同一类型的工具，使用哪一种则由团队成员的技能储备决定，就我们组来说，个人觉得Ansible更合适：a.团队有python储备；b.被管节点不需要安装代理。 </p><h4 id="其它工具"><a href="#其它工具" class="headerlink" title="其它工具"></a>其它工具</h4><ul><li>Jenkins Job Builder: 它是由openstack-infra团队开发的，项目地址：<a href="https://github.com/openstack-infra/jenkins-job-builder">Jenkins Job Builder Github</a>，详细信息请直接参考<a href="https://docs.openstack.org/infra/jenkins-job-builder/">文档</a></li></ul><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文主要介绍了CI/CD方案的常见流程及相关的工具集，但对于大部分工具并未进行深入的学习与分析，因此接下来需要安排专门的资源深入学习，特别是自动化测试相关框架的学习。</p><h3 id="4-1-技术分析专项"><a href="#4-1-技术分析专项" class="headerlink" title="4.1. 技术分析专项"></a>4.1. 技术分析专项</h3><ul><li>深入研究Jenkins、Gitlab CI、Go CD三个平台：易用性、可扩展性、社区活跃度，与我们团队的CI/CD目标的契合度</li><li>深入研究RobotFramework与Cucumber这两个自动化测试框架：基本原理、测试用例编写规则、常用的测试库、与CI/CD平台协作方法、分析实现自动化测试的流程</li><li>深入学习单元测试Mock框架：Mockito与Powermock</li><li>深入研究自动化部署工具：Foreman与Ansible，结合我们组的实际需求梳理出可行的自动化部署方案</li><li>深入学习Jenkins Job Builder，实现Jenkins任务管理自动化与脚本化</li></ul><hr><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="https://www.atlassian.com/devops">什么是DevOps – atlassian</a></li><li><a href="https://www.redhat.com/en/topics/devops#">什么是DevOps – Redhat</a></li><li><a href="https://insights.thoughtworks.cn/automated-testing-framework/">自动化测试框架分类与思考</a></li><li><a href="https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks">部分自动化测试框架列表</a></li><li><a href="https://www.martinfowler.com/articles/continuousIntegration.html">Martin Fowler’s easy to read guide on CI</a></li><li><a href="http://docs.cucumber.io/guides/10-minute-tutorial/">Cucumber快速入门-Java版</a></li><li><a href="https://docs.gocd.org/current/">GoCD</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;CI-CD方案分析&quot;&gt;&lt;a href=&quot;#CI-CD方案分析&quot; class=&quot;headerlink&quot; title=&quot;CI/CD方案分析&quot;&gt;&lt;/a&gt;CI/CD方案分析&lt;/h1&gt;&lt;h2 id=&quot;1-DevOps介绍&quot;&gt;&lt;a href=&quot;#1-DevOps介绍&quot; class=&quot;headerlink&quot; title=&quot;1. DevOps介绍&quot;&gt;&lt;/a&gt;1. DevOps介绍&lt;/h2&gt;&lt;p&gt;随着软件发布迭代的频率越来越高，传统的“瀑布型”（开发—测试—发布）模式已经不能满足快速交付的需求。2009年左右DevOps（Development和Operations的组合）应运而生，简单地来说，就是更好的优化开发(DEV)、测试(QA)、运维(OPS)的流程，开发运维一体化，通过高度自动化工具与流程来使得软件构建、测试、发布更加快捷、频繁和可靠。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.simiam.com/what-is-devops.jpg&quot; alt=&quot;DevOps的组成&quot;&gt;&lt;/p&gt;
&lt;p&gt;DevOps出现以前，开发与运维对于生产环境上出现的问题是这样处理的：&lt;/p&gt;</summary>
    
    
    
    <category term="devops" scheme="http://cloudnoter.com/categories/devops/"/>
    
    <category term="CI" scheme="http://cloudnoter.com/categories/devops/CI/"/>
    
    <category term="CD" scheme="http://cloudnoter.com/categories/devops/CI/CD/"/>
    
    <category term="持续集成" scheme="http://cloudnoter.com/categories/devops/CI/CD/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
    <category term="持续交付" scheme="http://cloudnoter.com/categories/devops/CI/CD/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98/"/>
    
    <category term="持续部署" scheme="http://cloudnoter.com/categories/devops/CI/CD/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98/%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/"/>
    
    
    <category term="devops" scheme="http://cloudnoter.com/tags/devops/"/>
    
    <category term="CI" scheme="http://cloudnoter.com/tags/CI/"/>
    
    <category term="CD" scheme="http://cloudnoter.com/tags/CD/"/>
    
    <category term="持续集成" scheme="http://cloudnoter.com/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
    <category term="持续交付" scheme="http://cloudnoter.com/tags/%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98/"/>
    
    <category term="持续部署" scheme="http://cloudnoter.com/tags/%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/"/>
    
  </entry>
  
  <entry>
    <title>oVirt虚拟化关键概念、组件与技术原理</title>
    <link href="http://cloudnoter.com/2018/07/11/oVirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E3%80%81%E7%BB%84%E4%BB%B6%E4%B8%8E%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86/"/>
    <id>http://cloudnoter.com/2018/07/11/oVirt%E8%99%9A%E6%8B%9F%E5%8C%96%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E3%80%81%E7%BB%84%E4%BB%B6%E4%B8%8E%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86/</id>
    <published>2018-07-10T16:24:40.000Z</published>
    <updated>2018-10-31T03:38:52.221Z</updated>
    
    <content type="html"><![CDATA[<h1 id="oVirt虚拟化关键概念、组件与技术原理"><a href="#oVirt虚拟化关键概念、组件与技术原理" class="headerlink" title="oVirt虚拟化关键概念、组件与技术原理"></a>oVirt虚拟化关键概念、组件与技术原理</h1><h4 id="云管理平台组-陈志安"><a href="#云管理平台组-陈志安" class="headerlink" title="云管理平台组-陈志安"></a>云管理平台组-陈志安</h4><hr><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><h3 id="1-1-ovirt-engine"><a href="#1-1-ovirt-engine" class="headerlink" title="1.1. ovirt-engine"></a>1.1. ovirt-engine</h3><p>ovirt-engine为虚拟化环境提供了一个集中管理的平台，用户可以根据具体的需求选择使用不同的方式来访问ovirt-engine。</p><p>ovirt-engine架构图如下：</p><p><img src="http://img.simiam.com/ovirt-engine-infra.png" alt="ovirt-engine架构图"></p><ul><li>应用服务器（ovirt-Wildfly）</li></ul><p>Wildfly是一个JavaEE应用服务器，但是需要注意的是部署ovirt-engine所需要的wildfly是特殊定制过的，因此您不能将其它应用部署在这个为ovirt-engine专门定制的wildfly上，为了便于与通用版本区分开来，本文档后续将定制版本统称为ovirt-wildfly。</p><ul><li>用户门户（User Portal）</li></ul><p>桌面系统虚拟化为用户提供了一个近似于物理PC的桌面系统。用户可以使用网络浏览器来访问用户门户，并通过用户门户来访问分配给他们的虚拟桌面资源（SPICE/VNC）。系统管理员需要为每个用户设定他们可能访问的资源及相关权限。User Portal的用户有两种类型：标准用户、高级用户。标准用户可以启动、停止和使用分配给他们的虚拟桌面（无法编辑虚拟机配置），而高级用户则还可以执行一些额外的管理任务（如创建、删除、编辑虚拟机，管理虚拟磁盘和网络接口等）。</p><ul><li>管理门户（Admin Portal）</li></ul><p>管理门户是ovirt-engine的一个图形管理界面。管理员可以通过该管理界面来监控、创建并维护整个ovirt虚拟环境中的所有资源（计算、网络、存储）。通过管理门户可执行如下操作：</p><blockquote><ul><li>创建和管理虚拟基础架构（网络、存储域）</li><li>创建和管理虚拟机</li><li>创建和管理逻辑项（数据中心、集群）</li><li>安装和管理计算节点（虚拟主机）</li><li>用户权限管理</li></ul></blockquote><p>详细的使用文档请查阅<a href="https://www.ovirt.org/documentation/admin-guide/administration-guide/">官方文档</a>。</p><span id="more"></span><ul><li>目录服务（Directory Service）</li></ul><p>目录服务提供了一个基于网络的、集中存储的用户与机构信息。这些信息包括应用程序的设置、用户档案资料、用户组数据、策略信息和访问控制信息。ovirt-engine支持Active Directory，Identity Management，OpenLDAP和Red Hat Directory Server 9所提供的目录服务。另外它还包括了一个本地内部域（internal），这个域只被用来进行系统管理，并只包含一个用户：admin。</p><ul><li>报表</li></ul><p>ovirt-engine在安装时会同时安装一个数据仓库，它被用来收集监控主机、虚拟机和存储所产生的数据。ovirt-engine预先提供了一组报表，用户也可以使用任何支持SQL查询的工具来创建新的报表。</p><p>ovirt-engine在安装过程中会在Postgres数据库服务器上创建两个数据库：engine与ovirt_engine_history。</p><p>engine：它是ovirt-engine用来保存数据的主数据库，它保存了与虚拟环境相关的数据（如虚拟环境的状态、配置等数据）。</p><p>ovirt_engine_history：该数据库保存了配置信息和各种性能统计数据，这些数据是根据不同时从engine数据库中收集来的。系统在每分钟都会检查engine数据库中的配置，任何改变都会被记录在ovirt_engine_history数据库中。这些信息可以用来帮助管理员分析和提高ovirt虚拟化环境的性能及协助管理员解决存在的问题。</p><blockquote><p>ovirt-engine的报表功能是通过ovirt-engine-dwhd服务实现的。</p></blockquote><ul><li>API</li></ul><p>管理员除了通过管理门户来管理维护虚拟化环境外，还可以通过CLI-API或REST-API来与外部管理系统做进一步的整合：</p><blockquote><ul><li>把虚拟环境集成到IT环境中</li><li>与第三方虚拟化软件集成</li><li>自动化维护和错误检查任务</li><li>使用脚本执行重复性操作</li></ul></blockquote><h3 id="1-2-ovirt-node"><a href="#1-2-ovirt-node" class="headerlink" title="1.2. ovirt-node"></a>1.2. ovirt-node</h3><p>一个ovirt虚拟化环境包括一个或多个用于运行虚拟机的计算节点（我们通常称为虚拟主机、物理主机、主机或计算节点）。一个普通的物理主机要成为ovirt虚拟化环境的计算节点有如下两种办法：</p><ul><li>安装专门定制的操作系统：使用官方提供的安装镜像文件（ovirt-node-os.iso）</li><li>在Redhat Enterprise Linux，Centos等操作系统上根据官方文档提示安装ovirt-node相关的组件包。</li></ul><blockquote><p>具体安装配置文件请参考<a href="https://www.ovirt.org/documentation/quickstart/quickstart-guide/#install-hosts">官方文档</a></p></blockquote><p>ovirt-node的主机核心架构图如下：</p><p><img src="http://img.simiam.com/ovirt-node-infra.png" alt="ovirt-node架构图"></p><ul><li>KVM(Kernel-based Virtual Machine)</li></ul><p>KVM是一个可加载的内核模块，它通过使用Inter-VT或AMD-V等硬件虚拟化扩展技术来提供虚拟化功能。KVM本身运行于内核空间，而在它上面运行的虚拟机服务会作为独立的QEMU进程在用户空间中运行。KVM允许主机把它的物理硬件资源分配给虚拟机。</p><ul><li>QEMU</li></ul><p>QEMU是一个多平台的，提供全仿真功能的仿真器（emulator），它会仿真包括一个或多个处理器以及外设在内的整个系统。QEMU、KVM及带有虚拟化功能扩展的处理器组合在一起就可以提供虚拟化功能。</p><ul><li>VDSM(Virtual Desktop Server Manager)</li></ul><p>VDSM相当于ovirt-engine在ovirt-node上的一个代理服务进程。ovirt-engine通过VDSM暴露的API来管理ovirt虚拟化环境下的所有资源（计算、网络、存储），执行相关的监控配置任务、数据统计、日志收集。每个计算节点上都会运行一个VDSM服务（监听端口号默认为54321）来接收ovirt-engine发出的管理命令。</p><ul><li>libvirt</li></ul><p>libvirt是一个底层工具库，它被用来协调虚拟机及其相关虚拟设备的管理。即当ovirt-engine发出一个操作虚拟机相关的命令时（如启动虚拟机、停止虚拟机），VDSM会调用目标计算节点上的libvirt的相应指令来执行这个操作。</p><ul><li>SPM(Storage Pool Manager)</li></ul><p>SPM即存储池管理器，它是ovirt虚拟化环境中与存储管理相关的重要概念。SPM是分配给一个数据中心中某个主机（计算节点）角色，即一个数据中心中的所有主机中，具有SPM角色的主机只能有一个，我们称其为SPM主机。SPM主机全权负责数据中心中所有与存储、存储域管理相关的业务。SPM角色可以在同一个数据中心中的不同主机间进行迁移，同一个数据中心中的所有主机都必须能访问这个数据中心中定义的所有存储域。ovirt-engine会确保SPM一直处于有效的状态，如果SPM所在的主机出现问题，ovirt-engine会重新发起SPM选举确定新的SPM主机。</p><blockquote><p>“数据中心”是ovirt虚拟化环境的重要概念，一个ovirt虚拟化环境中可以有多个数据中心。“存储域”则是ovirt虚拟化环境中存储资源管理的核心概念，下文会有专门的章节介绍。</p></blockquote><h3 id="1-3-数据中心"><a href="#1-3-数据中心" class="headerlink" title="1.3. 数据中心"></a>1.3. 数据中心</h3><p>数据中心是ovirt虚拟化环境中的根容器（最高一级的逻辑项），它包括以下三个子容器（子项）：</p><ul><li>集群容器</li></ul><p>集群容器用来保存与集群相关的信息。集群由一个至多个计算节点（主机）组成，这些主机具有相互兼容处理器内核。一个集群组成了一个虚拟机的迁移域，虚拟机可以被实时迁移到同一集群中的其它主机上。一个数据中心可以包括多个集群，一个集群可以包括多个主机。</p><ul><li>存储容器</li></ul><p>存储容器用来保存存储类型、存储域的信息，以及存储域间的连接信息。存储域在数据中心一级上定义，并可以被数据中心的所有集群使用（即可以被集群中的所有主机挂载）。</p><ul><li>网络容器</li></ul><p>网络容器用来保存与数据中心中的逻辑网络相关的信息，如网络地址、VLAN标签等信息。逻辑网络在数据中心一级上定义，并可以在集群一级上使用。</p><h3 id="1-4-存储简介"><a href="#1-4-存储简介" class="headerlink" title="1.4. 存储简介"></a>1.4. 存储简介</h3><p>ovirt虚拟化平台使用一个集中的存储系统来保存虚拟磁盘镜像、模板、快照和ISO文件。存储被分为由各个存储域组成的存储池，一个数据中心只有一个存储池。存储域由一组存储空间和代表这些存储空间内部结构的元数据所组成。目前有三种存储域类型：数据存储域，导出存储域，ISO存储域，三种存储域的介绍见后续章节。</p><p>每个数据中心都必须包括一个数据存储域，而每个数据存储域也只能关联一个数据中心。存储域是用于提供资源共享的，因此数据中心的所有主机都必须能访问所有存储域。</p><h3 id="1-5-网络简介"><a href="#1-5-网络简介" class="headerlink" title="1.5. 网络简介"></a>1.5. 网络简介</h3><p>ovirt虚拟化环境的网络架构提供该环境中不同对象间的网络连接，同时它还可以用来实现网络隔离。其网络架构图如下：</p><p><img src="http://img.simiam.com/ovirt-engine-network.png" alt="ovirt网络架构图"></p><p>用来处理虚拟机间网络连接的逻辑网络是通过计算节点上的基于软件的网桥实现的。在默认情况 下，ovirt-engine在安装过程中会创建一个名为“ovirtmgmt管理网络”的逻辑网络。此外系统管理员还可以添加专用的存储逻辑网络和专用的显示逻辑网络。</p><h2 id="2-存储"><a href="#2-存储" class="headerlink" title="2. 存储"></a>2. 存储</h2><p>在介绍ovirt虚拟化环境的存储相关内容前，我们需要简单了解下几种常见的存储服务类型：块存储，文件存储，对象存储。</p><p>下图是常见存储服务类型的系统层级分布图：</p><p><img src="http://img.simiam.com/storage-service-type.jpg" alt="存储类型系统层级分布图"></p><p>我们从底层往上看，最底层就是硬盘，多个硬盘可以做成RAID组，无论是单个硬盘还是RAID组，都可以做成PV，多个PV物理卷捏在一起构成卷组（VG）。接下来可以从卷组上切出很多个逻辑卷（LV）。到LV这一层为止，数据一直都是以块（Block）的形式存在的，这时候提供出来的服务就是块存储服务。你可以通过FC协议或者iSCSI协议访问LV，映射到主机端本地，成为一个裸设备。在主机端可以直接在上面安装数据库，也可以格式化成文件系统后交给应用程序使用，这时候就是一个标准的SAN存储设备的访问模式，<strong>网络间传送的是块</strong>。</p><p>如果不急着访问，也可以在本地做文件系统，之后以NFS/CIFS协议挂载，映射到本地目录，直接以文件形式访问，这就成了NAS访问的模式，<strong>在网络间传送的是文件</strong>。</p><p>如果不走NAS，在本地文件系统上面部署OSD服务端，把整个设备做成一个OSD，这样的节点多来几个，再加上必要的MDS节点，互联网另一端的应用程序再通过HTTP协议直接进行访问，这就变成了对象存储的访问模式。当然对象存储通常不需要专业的存储设备，前面那些LV/VG/PV层也可以统统不要，直接在硬盘上做本地文件系统，之后再做成OSD，这种才是对象存储的标准模式，对象存储的硬件设备通常就用大盘位的服务器。</p><blockquote><p>物理卷（PV）、卷组（VG）、逻辑卷（LV）及LVM相关的介绍请查阅<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/logical_volume_manager_administration/index">LVM文档</a>。</p></blockquote><h3 id="2-1-什么是存储域"><a href="#2-1-什么是存储域" class="headerlink" title="2.1. 什么是存储域"></a>2.1. 什么是存储域</h3><p>存储域就是一系列具有公共存储接口的镜像的集合，存储域中包括了虚拟机模板、快照、数据镜像、ISO文件以及存储域本身的元数据。一个存储域可以由块设备（块存储）组成，也可以由文件系统（文件存储）组成。</p><ul><li>文件存储：所有的NAS（NFS, GlusterFS, 或其它POSIX兼容的文件系统, 主机的本地存储）都属于文件存储，如果存储域由文件存储组成，则其上的虚拟磁盘、模板、快照都是文件。</li></ul><p>一般情况下，ovirt虚拟化环境并不直接管理基于文件的存储（它们都由外部系统负责管理），如NFS存储由NFS服务器或其它第三方网络存储服务器来管理。主机则可以管理它自身的本地文件存储系统。</p><ul><li>块存储：在SAN（iSCSI, FCP）中的存储都属于块存储，如果存储域由块存储组成，则其上的虚拟磁盘、模板、快照都是一个逻辑卷（LV）。</li></ul><p>块存储使用未格式化的块设备，这些块设备（相当于PV）被LVM合并为卷组，VDSM会通过扫描卷组来在LVM之上添加集群逻辑。当VDSM发现卷组变化时，它会通知相应的主机来更新它们的卷组信息。主机会把卷组分为不同的逻辑卷（LV），并在磁盘上保存逻辑卷的元数据。当在已存在的存储域中添加新的存储空间时，ovirt-engine会通知每台主机上的VDSM来更新卷组信息。</p><p>SPM主机上的LVM会处理块存储环境中发生的变化（如创建逻辑卷、扩展或删除逻辑卷、添加新的 LUN），然后SPM主机上的VDSM会将这些变化信息（元数据）同步至集群中的所有主机。</p><h3 id="2-2-存储域类型"><a href="#2-2-存储域类型" class="headerlink" title="2.2. 存储域类型"></a>2.2. 存储域类型</h3><p>ovirt虚拟化平台支持的存储域可以被分为以下几类:</p><ul><li><p>数据（Data）存储域：保存ovirt虚拟化环境中的所有虚拟机的磁盘镜像。这些磁盘镜像包括安装的操作系统，或由虚拟机产生或保存的数据。数据存储域支持NFS、iSCSI、FCP、GlusterFS或POSIX兼容的存储系统。</p></li><li><p>导出（Export）存储域：它可以在不同数据中心间转移磁盘镜像和虚拟机模板提供一个中间存储，并可以用来保存虚拟机的备份。导出存储域支持NFS存储。一个导出域可以被多个不同的数据中心访问，但它同时只能被一个数据中心使用。</p></li><li><p>ISO存储域：用来存储ISO文件（也称为镜像，它是物理的CD或DVD的代表）。在ovirt虚拟化环境中，ISO文件通常代表了操作系统的安装介质、应用程序安装介质和guest代理安装介质。这些镜像会被附加到虚拟机上，并象使用物理安装介质一样启动系统。ISO存储域为数据中心中的所 有主机提供了一组共享的ISO文件，这样所有的主机就不再需要物理的安装介质了。</p></li></ul><blockquote><p>“导出存储域”在以后的版本中将可能被弃用，因为最新版本的ovirt虚拟化平台的“数据存储域”已经具备导出存储域的功能了（从一个数据中心移除并挂载到另一个数据中心）。</p></blockquote><h3 id="2-3-虚拟磁盘镜像"><a href="#2-3-虚拟磁盘镜像" class="headerlink" title="2.3. 虚拟磁盘镜像"></a>2.3. 虚拟磁盘镜像</h3><h4 id="2-3-1-虚拟磁盘格式"><a href="#2-3-1-虚拟磁盘格式" class="headerlink" title="2.3.1. 虚拟磁盘格式"></a>2.3.1. 虚拟磁盘格式</h4><ul><li>QCOW2(QEMU copy on write V2)</li></ul><p>QCOW2是虚拟磁盘镜像的一种存储格式，使用QCOW2格式可以把物理存储层和逻辑存储层分隔开。QCOW2为逻辑块和物理块之间创建了一个映射，每个逻辑块都会被映射到相应的物理块上；另外，QCOW2可以只保存物理存储上变化的数据。因为这个特性是存储空间“over-commitment”功能和虚拟机快照功能得以实现的基础。</p><p>初始的映射信息会把所有的逻辑块与物理文件系统或卷中对应的块相关联。在创建虚拟机快照后， 如果这个虚拟机需要向QCOW2卷写数据，系统会根据映射信息在物理存储中找到相应的块，并把新数据写到块中，然后只在新的快照QCOW2卷中记录数据的变化，并更新相应的映射信息。</p><ul><li>RAW</li></ul><p>当虚拟磁盘的镜像是RAW格式时，它上面的数据将没有特定的格式，对虚拟磁盘的操作也不需要主机进行特殊处理，因此使用RAW格式的虚拟机磁盘会比使用QCOW2格式的虚拟磁盘有更好的性能。当虚拟机向虚拟磁盘写数据时，I/O系统会在物理存储和逻辑卷中写相同的数据。RAW格式的虚拟磁盘在创建时就会被分配和所定义的镜像大小相同的存储空间（预先分配）。RAW镜像文件有很多优点，但它的一个非常大的缺陷就是不支持快照。</p><h4 id="2-3-2-磁盘镜像存储分配策略"><a href="#2-3-2-磁盘镜像存储分配策略" class="headerlink" title="2.3.2. 磁盘镜像存储分配策略"></a>2.3.2. 磁盘镜像存储分配策略</h4><ul><li>预分配存储（Preallocated Storage）</li></ul><p>虚拟磁盘镜像所需要的所有存储空间在虚拟机创建前就需要被完全分配。如果虚拟机需要一个20GB的磁盘镜像，存储域中的20GB的存储空间就会被占用。因为在进行写操作时不需要进行磁盘空间分配的动作，所以预分配存储策略有更好的写性能。但是，预分配存储的大小不能被扩展，这就失去了一些灵活性。另外，它也会降低ovirt-engine进行存储“over-commitment”的能力。预分配存储策略适用于需要大量I/O操作（特别是写操作比较频繁时），并对存储速率有较高要求的虚拟机，一般情况下，作为应用服务器的虚拟机推荐使用预分配存储策略。</p><ul><li>稀疏分配存储（Sparsely Allocated Storage）</li></ul><p>这种存储分配策略也叫存储精简配置策略。在创建虚拟机的时候，为虚拟磁盘镜像设定一个存储空间上限，而磁盘镜像在开始时并不使用任何 存储域中的存储空间。当虚拟机需要向磁盘中写数据时，磁盘会从存储域中获得一定的存储空间（默认为1G），当磁盘数据量达到所设置的磁盘空间上限时将不会再为虚拟磁盘增加容量。</p><blockquote><p>如果ovirt环境底层的存储设备提供了精简分配(thin provisioning)功能，则我们创建虚拟磁盘时应该首选使用底层存储设备所提供的能力来实现精简配置。我们通过图形用户界面为虚拟机配置存储时，应该选择“预分配存储策略”，底层存储自己会实现精简配置的功能。</p></blockquote><h3 id="2-4-存储元数据"><a href="#2-4-存储元数据" class="headerlink" title="2.4. 存储元数据"></a>2.4. 存储元数据</h3><p>存储元数据包括：存储域元数据，存储池信息，模板与虚拟机镜像元数据。</p><h4 id="2-4-1-元数据版本"><a href="#2-4-1-元数据版本" class="headerlink" title="2.4.1. 元数据版本"></a>2.4.1. 元数据版本</h4><p>ovirt虚拟化平台存储域元数据模型目录有三个版本（V1, V2, V3），当前使用的是V3版本。<br>元数据不同版本间的区别主要是：元数据格式，存储方式的变更。</p><ul><li>V1元数据(ovirt-engine-2.x)</li></ul><p>每个存储域的元数据包括：存储域本身的结构、所有被虚拟磁盘镜像使用的物理卷的名字。</p><p>主存储域（Master Storage Domain）的元数据还额外包括了存储池中的所有域和物理卷的名字。因为这个元数据的大小不能超过2KB，所以它限制了一个池中所能包括的存储域的数量。</p><p>模板和虚拟机的基本数据镜像是只读的。</p><p>V1元数据适用于NFS、iSCSI和FC存储域。</p><ul><li>V2元数据(ovirt-engine-3.0)</li></ul><p>所有存储域和池的元数据以逻辑卷标签的形式保存(不再被写到一个逻辑卷上)。而虚拟磁盘卷的元数据仍然以一个逻辑卷的形式保存在存储域中。元数据将不再包括物理卷名。</p><p>模板和虚拟机的基本数据镜像是只读的。</p><p>V2元数据适用于iSCSI和FC存储域。</p><ul><li>V3元数据(ovirt-engine-3.1+)</li></ul><p>所有存储域和池的元数据以逻辑卷标签的形式保存(不再被写到一个逻辑卷上)。而虚拟磁盘卷的元数据仍然以一个逻辑卷的形式保存在存储域中。</p><p>虚拟机和模板的基本镜像数据不再是只读的了。这使实时快照、实时存储迁移和快照克隆成为可能，支持unicode元数据，这样它就可支持非英文的卷名。</p><p>V3元数据适用于NFS、GlusterFS、POSIX、iSCSI和FC存储域。</p><h4 id="2-4-2-元数据存储目录结构"><a href="#2-4-2-元数据存储目录结构" class="headerlink" title="2.4.2. 元数据存储目录结构"></a>2.4.2. 元数据存储目录结构</h4><p>ovirt-engine在启动时会将每个数据中心中的存储域配置信息下发给各个主机上的VDSM实例，VDSM分根据接收到的存储域配置信息将相关存储域挂载至主机。挂载成功后，你将可以在每个主机的如下目录查看到存储域的相关信息（包括元数据）：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 元数据存储目录</span></span><br><span class="line"><span class="regexp">/rhev/</span>data-center/&lt;storage_pool_uuid&gt;</span><br></pre></td></tr></table></figure><p>下图是V3版元数据存储目录结构示意图：</p><p><img src="http://img.simiam.com/storage-metadata-tree-descr.png" alt="V3版元数据存储目录结构示意图"></p><p><strong>注意：</strong> 文件存储类型的存储域与块设备类型的存储域的元数据存储位置是不同的，块设备类型存储域的元数据是存放在主存储域（马上到！）对应的卷组（VG）的标签（Tag）中，而不是dom_md目录下的metadata文件中。dom_md/metadata存放的是该存储域下虚拟机磁盘镜像（LV）的元数据集，每个虚拟机磁盘镜像（LV）的元数据存放在metadata块设备存储空间的某一个索引位置上，该索引位置信息则保存在虚拟机磁盘镜像所在的逻辑卷（LV）的标签（Tag）上。</p><blockquote><p>相关查询命令：<code>vgs, lvs</code>等，块设备存储域元数据的具体细节由VDSM负责维护，本文档不深入介绍。</p></blockquote><h3 id="2-5-存储域自动恢复（激活）机制"><a href="#2-5-存储域自动恢复（激活）机制" class="headerlink" title="2.5. 存储域自动恢复（激活）机制"></a>2.5. 存储域自动恢复（激活）机制</h3><p>主机根据其所在数据中心中的存储域元数据信息来监测存储域，当该数据中心中的所有主机都报告某个存储域无法访问时，这个存储域会被认定为“不活跃”。</p><p>但ovirt-engine监测到某个存储域不活跃时并不会断开与它的连接，而是会认为这可能是一个临时的网络故障导致的，engine会每隔5分钟尝试重新激活任何不活跃的存储域。</p><blockquote><p>虽然系统管理员可能需要人为排除存储域连接问题的故障，但ovirt-engine会在连接问题解决后自动重新激活存储域。</p></blockquote><h3 id="2-6-SPM-Storage-Pool-Manager"><a href="#2-6-SPM-Storage-Pool-Manager" class="headerlink" title="2.6. SPM(Storage Pool Manager)"></a>2.6. SPM(Storage Pool Manager)</h3><h4 id="2-6-1-SPM简介"><a href="#2-6-1-SPM简介" class="headerlink" title="2.6.1. SPM简介"></a>2.6.1. SPM简介</h4><p>ovirt虚拟化平台使用元数据来描述存储域的内部结构。结构元数据会被写到每个存储域的一个数据段中，它被用来记录镜像和快照的创建删除，以及卷和域的扩展操作。所有主机会使用“一人写，多人读”的机制来处理存储域元数据。这个能修改存储域元数据的主机就是SPM主机（后面简称SPM）。</p><p>下图是存储域元数据读写数据流示意图：</p><p><img src="http://img.simiam.com/storage-metadata-io.png" alt="存储域元数据读写数据流示意图"></p><p>SPM负责协调数据中心内所有存储域元数据的变更操作，比如创建删除磁盘镜像、创建合并快照、在存储域之间复制镜像、创建虚拟机模板、块设备存储分配等。一个数据中心只能有一个SPM主机，数据中心中的其它主机对存储域元数据信息只有读权限。</p><p>一个主机（计算节点）有两种方式升级为SPM主机：</p><ul><li>人为通过管理门户直接将某主机设置为SPM（底层也是通过ovirt-engine下发命令）</li><li>由ovirt-engine根据SPM选举机制确定SPM</li></ul><p>当ovirt-engine通过上述任意一种方式设置某一主机为SPM时，ovirt-engine将向该主机上的VDSM发送一个<code>spmStart</code>的命令，其将尝试获取一个叫<code>storage-centric</code>的租约。如果成功获取到租约，则该主机就升级为SPM主机并一直持有该storage-centric租约，直到失去SPM角色或该SPM主机因为异常被ovirt-engine移出集群或数据中心。</p><p>拥有storage-centric租约的主机（肯定是SPM主机）对存储域元数据具有”写“权限。</p><p>该租约之所以被命名为<code>storage-centric</code>是因为该租约是直接被写入到主存储域（Master Storage Domain）上的一个特殊的名字叫<code>leases</code>的逻辑卷上（假设底层存储为块存储，文件存储则是写到一个名为<code>leases</code>的文件）。</p><blockquote><p>主存储域（Master Storage Domain）简称马上到！，VDSM会把数据中心中第一个被创建的存储域（SD）作为马上到！。对于块存储来讲，磁盘镜像等虚拟机相关的元数据都存放在马上到！上。</p></blockquote><h4 id="2-6-2-SPM主机选举机制"><a href="#2-6-2-SPM主机选举机制" class="headerlink" title="2.6.2. SPM主机选举机制"></a>2.6.2. SPM主机选举机制</h4><p>当出现以下几种情况时，ovirt-engine将会发起新一轮的SPM主机选举：</p><ul><li>SPM主机无法访问除了主存储域（马上到！）之外的其它存储域（SD）。</li><li>SPM主机无法连接至存储域导致租约更新失败。</li><li>租约所在的LV空间满导致无法进行任何写操作。</li><li>SPM主机宕机。</li><li>当前的SPM主机没有响应或无法完成正常的任务时。</li></ul><p>如果没有主机被手工指定为SPM且出现上述任意一种情况时，ovirt-engine将会启动SPM选举过程：</p><p><strong>Step 1：</strong> ovirt-engine会要求VDSM确认哪个主机已经拥有“storage-centric租約”。</p><p><strong>Step 2：</strong> ovirt-engine会跟踪从存储域创建以来的SPM分配记录，并根据如下三个方面来判断主机是否可以作为SPM:</p><ul><li>“getSPMstatus” 命令：ovirt-engine通过VDSM检查主机的SPM状态。它会返回以下3个状态之一：”SPM”、”Contending”、”Free”。</li><li>存储域的元数据卷中包括了最后一个具有SPM身份的主机信息。</li><li>存储域的元数据卷中包括了最后一个具有SPM身份的主机版本信息。</li></ul><p><strong>Step 3：</strong> 如果当前的SPM主机可以正常工作，这个主机就会继续持有“storage-centric租約”，同时ovirt-engine把这个主机标识为SPM，并退出选举过程。</p><p><strong>Step 4：</strong> 如果当前的SPM主机没有响应，则它会被认为处于“无响应”状态。如果那个主机已经配置了电源管理功能，它会被自动隔离(fence)。如果自动隔离失败，就需要手工隔离；在当前的SPM被隔离前，SPM的角色不能分配给其它主机；如果隔离成功则进行下一步。</p><p><strong>Step 5：</strong> 当SPM角色和storage-centric租約都空闲时，ovirt-engine会把它们分配给数据中心中的一个SPM权重高的主机，如果所有候选主机的SPM权重都一样，则会随机选取一个主机。分配成功后ovirt-engine会将该该主机标记为SPM并退出选举过程；否则进行下一步。</p><p><strong>Step 6：</strong> 如果为一个新主机分配SPM角色的操作失败，ovirt-engine会把这个主机加入到一个列表（该列表包括了所有分配SPM角色失败的主机，这个列表中的主机被标记为本轮选举无法成为SPM。这个列表中的内容会在开始下一次进行SPM选举的过程前被清除，从而使这个列表中的主机又有机会成为SPM）。ovirt-engine会一直尝试把SPM角色和storage-centric租約分配给一个主机，直到有一个主机被成功选举为SPM。</p><h3 id="2-7-排他性资源与Sanlock"><a href="#2-7-排他性资源与Sanlock" class="headerlink" title="2.7. 排他性资源与Sanlock"></a>2.7. 排他性资源与Sanlock</h3><p>ovirt虚拟化环境中的一些资源具有排它性，每个排它性资源同时只能被一个线程访问。比如SPM就是一个具有排它性的资源。在一个数据中心中，同时只能有一个主机具有SPM角色，如果数据中心中存在多个具有SPM角色的主机，就会出现同一份数据同时被不同的主机修改的情况，从而造成数据被破坏（脏数据）。</p><p>在ovirt-v3.1之前，SPM的排它性是通过VDSM中的一个名为safelease的功能来实现的。这个租約被写到数据中心中的所有存储域中的一个特殊区域中，而数据中心中的所有主机都可以通过它来检查SPM的状态。VDSM的“safelease”的唯一功能就是来维持SPM的排它性。在3.1版本之后ovirt引入了<a href="https://www.ibm.com/developerworks/cn/linux/1404_zhouzs_sanlock/index.html">Sanlock</a>来实现资源互斥访问功能，它除了可以锁定SPM外，还可以“锁定”其它资源。因此，Sanlock具有更高的灵活性。</p><p>需要进行资源锁定的应用程序可以在Sanlock中进行注册，已经注册的应用程序可以请求Sanlock锁定某个资源，从而使其它程序无法访问被锁定的资源。例如，VDSM可以请求Sanlock锁定SPM资源，而不需要自己锁定它。</p><p>每个存储域都有一个lockspace区，锁定状态被记录在lockspace的磁盘中。因为SPM资源只能分配给一个“活跃的”主机，因此Sanlock就需要检查SPM主机是否是“活跃的”。当SPM主机连接到存储域时，它会更新从ovirt-engine获得的hostid，并且会定期在lockspace 中写一个时间戳(timestamp)。ids逻辑卷会记录每个hostid，并在每个主机更新它的hostid时进行相应的更新。Sanlock会根据主机的hostid和时间戳来决定它是否处于“活跃”状态。</p><p>资源的使用情况被记录在leases逻辑卷的磁盘中。当磁盘中代表某个资源的数据被更新为带有某个进程的id时，系统就认为该资源被这个进程所占用。具体到SPM角色资源，当它被占用时，它的数据会被更新为SPM主机的hostid。</p><p>每个主机上的Sanlock只需要检查资源一次来决定它们是否被占用。在初始的检查后，Sanlock只需要监测lockspaces中的相应主机的时间戳的状态。Sanlock需要监测使用资源的应用程序。对于VDSM，它会监测SPM的状态和hostid。如果主机无法从ovirt-engine重复获得它的 hostid，这个主机就会失去它所占有的、在lockspace中记录的所有资源的排它性。 Sanlock会更新相应的资源记录来标识这些资源不再被占用。</p><p>当SPM主机在一定的时间内无法更新存储域的lockspace中的时间戳时，这个主机上的Sanlock会要求VDSM进程释放它所占用的资源。</p><p>如果VDSM进程接受了这个请求，它将释放它所占用的资源（即lockspace中的SPM资源就可以被其它主机使用）。</p><p>如果SPM主机上的VDSM无法接受释放资源的请求，主机上的Sanlock就会使用<code>kill</code>命令来终止VDSM进程。如果<code>kill</code>命令运行失败，Sanlock会使用<code>sigkill</code>命令来终止VDSM进程。如果<code>sigkill</code>命令仍然无法终止进程，Sanlock将会通过<code>watchdog</code>守护进程来重启Sanlock所在的主机。</p><p>每次当主机的VDSM更新它的hostid并更新lockspace中的时间戳时，<code>watchdog</code>守护进程都会收到一个<code>pet</code>。 当VDSM不能进行这些操作时，<code>watchdog</code>守护进程将无法收到pet。如果<code>watchdog</code>守护进程在一定时间内仍然没有收到<code>pet</code>，它将会重启主机。这将保证SPM资源可以被释放，从而可以被其它主机使用。</p><blockquote><p>有关Sanlock的详细原理请参考<a href="https://www.ibm.com/developerworks/cn/linux/1404_zhouzs_sanlock/index.html">这里</a>。</p></blockquote><h2 id="3-网络"><a href="#3-网络" class="headerlink" title="3. 网络"></a>3. 网络</h2><p>ovirt虚拟化平台的网络可以从3个方面介绍：基本网络、集群网络和主机网络配置。</p><ul><li>基本网络：包括了实现网络功能的基本软件和硬件。</li><li>集群网络：包括了集群资源间的网络连接(如主机、逻辑网络和虚拟机)。</li><li>主机网络配置：包括了主机（计算节点）所支持的网络配置。</li></ul><p>一个有良好设计的网络将会为用户提供一个高性能的网络，并可以顺利实现虚拟机的迁移。而一个没有经过良好设计的网络可能为系统的使用和维护带来许多问题(如网络响应速度太慢、虚拟机迁移和克隆失败等)。</p><h3 id="3-1-基本网络"><a href="#3-1-基本网络" class="headerlink" title="3.1. 基本网络"></a>3.1. 基本网络</h3><p>ovirt虚拟化平台通过使用以下网络元素为虚拟机、主机、虚拟（逻辑）网络提供网络服务：</p><ul><li>网卡（NIC）</li><li>网桥（Bridge）</li><li>网络绑定（Bond）</li><li>虚拟网卡（vNIC）</li><li>虚拟局域网（VLAN）</li></ul><p>网卡，网桥，虚拟网卡使得主机，虚拟机，本地网络，外部网络之间可以相互通信。而Bond与VLAN虽然是可选的网络元素，但它们可以增强网络的安全、性能及容灾能力。</p><h4 id="3-1-1-网络接口控制器（网卡）"><a href="#3-1-1-网络接口控制器（网卡）" class="headerlink" title="3.1.1. 网络接口控制器（网卡）"></a>3.1.1. 网络接口控制器（网卡）</h4><p>网络接口控制器(Network Interface Controller)，简写为NIC，通常被称为网卡，它是一个用于将计算机连接至网络的网络适配器。NIC工作在网络层和数据链路层来为所在的机器提供网络连接功能。在ovirt虚拟化环境中的主机都最少需要有一个NIC，但通常情况下主机都会有多个网卡。</p><p>一个物理网卡可以有多个虚拟网卡(vNIC)和它相连，而一个虚拟网卡可以看做是一个虚拟机的物理网卡。为了区分虚拟网卡和物理网卡，ovirt-engine会为每个虚拟网卡分配一个独立的MAC地址(在ovirt-engine可以配置MAC地址池)。</p><h4 id="3-1-2-网桥"><a href="#3-1-2-网桥" class="headerlink" title="3.1.2. 网桥"></a>3.1.2. 网桥</h4><blockquote><p>网桥与NAT的关系？</p></blockquote><p>网桥(bridge)是数据包交换网络中进行数据包转发的软件设备。通过使用网桥，多个网络接口设备可以共享同一个物理网卡的连接，而每个网络接口设备都会以独立的物理设备的形式出现在网络中。网桥会检查一个数据包的源地址来决定相关的目标地址，一旦获得了目标地址的信息，它会在一个表中添加这个地址以供以后使用。通过使用网桥，主机可以把网络数据重新定向到使用虚拟网卡的、相应的虚拟机上。</p><p>在ovirt虚拟化环境中，逻辑网络是通过网桥来实现的。一个IP地址会分配给网桥而不是主机本身的物理网络接口，这个IP地址不需要和连接到这个网桥上的虚拟机的网络处于同一个子网中。如果分配给网桥的IP地址和虚拟机处于同一个子网中，网桥所在的主机将可以被虚拟机直接访问，我们通常不推荐在主机上运行可以被虚拟机访问的网络服务。虚拟机通过它们的虚拟网卡连接到逻辑网络中，虚拟机上的每个虚拟网卡都可以通过DHCP或静态分配的方式来获得IP地址。如果有需要，网桥也可以连接到主机以外的系统。</p><p>网桥和以太网连接都可以设置自定义属性。VDSM会把网络定义和自定义属性传给设置网络的hook脚本。</p><h4 id="3-1-3-Bond"><a href="#3-1-3-Bond" class="headerlink" title="3.1.3. Bond"></a>3.1.3. Bond</h4><p>绑定（bond）是由多个网卡组合成的一个单一的、由软件定义的网络设备。因为一个绑定（bond）是由多个网卡组成的，因此它可以提供比单一网卡更高的网络传输速度，并提供了更好的网络容错功能（绑定只有在所有的网卡 都出现问题时才会停止工作）。绑定设备有一个限制：绑定必须由相同型号的网卡组成，同时有些绑定。</p><p>绑定设备的数据包传输算法是由绑定的模式所决定的，绑定模式共有7种(mode-0 ~ mode-6)，其中mode-1 ~ mode-4支持虚拟机网络(使用网桥)和非虚拟机网络(无网桥)；mode-0、mode-5、mode-6只支持非虚拟机网络(无网桥)。</p><p>ovirt虚拟化平台默认使用的是mode-4。绑定模式详细介绍请看<a href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html-single/technical_reference/#chap-Network">这里</a>。</p><h4 id="3-1-4-虚拟网卡"><a href="#3-1-4-虚拟网卡" class="headerlink" title="3.1.4. 虚拟网卡"></a>3.1.4. 虚拟网卡</h4><p>虚拟网卡是基于主机的物理网卡的虚拟网络接口。每一个主机可以有多个物理网卡，而每个物理网卡可以有多个虚拟网卡。</p><p>当我们为虚拟机添加一个虚拟网卡时，ovirt-engine会在虚拟机、虚拟网卡本身和虚拟网卡所基于的主机的物理网卡间创建一定的关联。当虚拟机第一次启动时，libvirt会为虚拟网卡分配一个PCI地址。这样，虚拟机就可以使用MAC地址和PCI地址(如eth0)指定虚拟网卡。</p><p>如果虚拟机是通过模板或快照创建的，分配MAC地址以及把这些MAC地址和PCI地址相关联的过程会有所不同。</p><ul><li>当模板或快照中已经包括了PCI地址时，通过这个模板或快照所创建的虚拟机上的虚拟网卡的顺序会基于这些PCI地址和MAC地址按顺序分配。</li><li>如果模板中没有包括PCI地址，基于这个模板所创建的虚拟机上的虚拟网卡会根据虚拟机网卡的名称来分配新的MAC地址。</li><li>如果快照中没有包括PCI地址，ovirt-engine会根据快照来为虚拟网卡分配新的MAC地址。</li></ul><p>创建后，虚拟网卡会被添加到网桥设备中。网桥将用来处理虚拟机和虚拟机网络的连接。</p><blockquote><p>在主机上执行<code>ip addr show</code>命令可以显示基于该主机物理网卡所创建网桥等信息，我们还可以用<code>brctl show</code>命令来显示网桥都包括哪些虚拟网卡。</p></blockquote><h4 id="3-1-5-网络标签（Network-Label）"><a href="#3-1-5-网络标签（Network-Label）" class="headerlink" title="3.1.5. 网络标签（Network Label）"></a>3.1.5. 网络标签（Network Label）</h4><blockquote><p>如何理解有用户角色的逻辑网络，它与网络标签的关系是什么？</p></blockquote><p>使用网络标签可以大大简化一些逻辑网络管理的工作，这些管理任务包括创建与管理逻辑网络，以及将这些逻辑网络与物理主机网络接口绑定等。</p><p>网络标签就是一个可读性强的纯文本，它的长度没有限制，但它只能包括大小写字母、下划线和分号，但不支持空格和其它特殊字符。它可以与逻辑网络或物理主机网络接口进行关联。</p><p>为逻辑网络或主机的物理网络接口加一个网络标签后，它们就可以和有相同网络标签的逻辑网络或主机的物理网络接口以下面的形式相关联:</p><h5 id="网络标签关联关系"><a href="#网络标签关联关系" class="headerlink" title="网络标签关联关系"></a>网络标签关联关系</h5><ul><li>当您为一个逻辑网络添加了一个网络标签后，这个逻辑网络将会被自动和有相同网络标签的主机物理网络接口相关联。</li><li>当您为一个主机的物理网络接口添加了一个网络标签后，具有这个网络标签的所有逻辑网络都会和这个主机的物理网络接口相关联。</li><li>修改已经被附加到一个逻辑网络或主机的物理网络接口的网络标签等同于：先删除了网络标签，然后再添加了一个新网络标签。附加了这个网络标签的逻辑网络和主机的物理网络接口之间的关联也会被更新。</li></ul><h5 id="网络标签和集群"><a href="#网络标签和集群" class="headerlink" title="网络标签和集群"></a>网络标签和集群</h5><ul><li>当一个有网络标签的逻辑网络被添加到一个集群中，它会被自动添加到在这个集群中的具有相同网络标签的主机物理网络接口上。 </li><li>当一个有网络标签的逻辑网从一个集群中删除后，在这个集群中的具有相同网络标签的主机物理网络接口与这个逻辑网络的关联会被自动取消。</li></ul><h5 id="网络标签和有用户角色的逻辑网络"><a href="#网络标签和有用户角色的逻辑网络" class="headerlink" title="网络标签和有用户角色的逻辑网络"></a>网络标签和有用户角色的逻辑网络</h5><ul><li>当一个有网络标签的逻辑网络被设为“显示网络”或“迁移网络”时，在主机物理网络接口中它的IP地址分配方式会被设置为DHCP。</li><li>当为一个角色网络(如“一个迁移网络”或“一个显示网络”)设置网络标签时，会在所有主机上产生大量部署这个网络的操作。这些大量的网络添加操作是通过使用DHCP实现的，而不是通过输入静态地址实现的。这将节省很多人工工作量。</li></ul><h3 id="3-2-集群网络"><a href="#3-2-集群网络" class="headerlink" title="3.2. 集群网络"></a>3.2. 集群网络</h3><p>集群层的网络对象包括：集群、逻辑网络。常见的集群内网络拓扑图如下：</p><p><img src="http://img.simiam.com/cluster-network-topo.png" alt="集群内的网络拓扑图"></p><p>一个数据中心就是由多个集群组成的一个逻辑组，而一个集群则是由多个主机组成的一个逻辑组。上图中“集群内的网络拓扑图” 展示了一个集群中所包括的项。</p><p>在一个集群中的所有主机都可以访问相同的存储域，同时它们也在集群这一层来关联逻辑网络。对于一个虚拟机逻辑网络来说，为了使虚拟机可以使用它，它必须通过ovirt-engine在集群中的所有主机上定义并配置，而对于其它类型的逻辑网络，它们只需要在使用这些网络的主机上定义。</p><p>ovirt-engine中的数据中心支持多主机网络配置。当一个网络设置更新后，这个更新后的配置信息会自动应用到这个数据中心中所有分配了这个网络的主机上。</p><h4 id="3-2-1-逻辑网络"><a href="#3-2-1-逻辑网络" class="headerlink" title="3.2.1. 逻辑网络"></a>3.2.1. 逻辑网络</h4><p>逻辑网络使得ovirt虚拟化环境可以根据网络数据类型对不同网络进行隔离。例如，在安装ovirt-engine时默认创建的ovirtmgmt网络则作为处理ovirt-engine和主机(VDSM)间的管理通信网络。一般情况下，具有类似要求和使用情况的多个网络通信可以组成一个逻辑网络。系统管理员通常会创建一个存储网络和一个显示网络来把这两种网络流量分离来，从而提高系统性能，以及便于故障排除。<br>逻辑网络的类型包括: </p><ul><li>用来处理虚拟机网络流量的逻辑网络 </li><li>不处理虚拟机网络流量的逻辑网络</li><li>可选的逻辑网络</li><li>必需的逻辑网络 </li></ul><p>所有逻辑网络都可以设置为“必需的”或“可选的”，二者选一。</p><p>逻辑网络在数据中心一级被定义，并被添加到主机上。为了使一个“必需的”逻辑网络可以正常工作，它需要被添加到相应集群中的所有主机上。</p><p>ovirt虚拟化环境中的每个虚拟机逻辑网络都必须由一个主机上的一个网桥设备支持。当为一个集群定义了一个新的虚拟机逻辑网络后，在这个集群的所有主机上都需要创建一个匹配的网桥设备，这样，这个新的虚拟机逻辑网络才可以被虚拟机使用。ovirt-engine会自动为虚拟机逻辑网络创建所需要的网桥设备。<br>ovirt-engine为虚拟机逻辑网络所创建的网桥设备需要和主机上的一个网络接口关联。如果和网桥相关联的主机网络接口已经被其它网络所使用，则新加入的网络接口将同样可以共享那些已经连接到主机网络接口中的网络。当虚拟机被创建并被添加到一个特定的逻辑网中时，它们的虚拟网卡会被添加到那个逻辑网所在的网桥中。这样，虚拟机就可以和连接到相同网桥中的其它设备进行网络通信。</p><p>不处理虚拟机网络流量的逻辑网络会和主机的网卡直接进行关联。</p><p>典型的逻辑网络拓扑如下图：</p><p><img src="http://img.simiam.com/cluster-logical-network-ovirtmgmt.png" alt="典型的逻辑网络拓扑图"></p><h5 id="Required网络"><a href="#Required网络" class="headerlink" title="Required网络"></a>Required网络</h5><p>一个“Required”网络就是一个逻辑网络，它对一个集群中的所有主机都有效。当一个主机上的“Required”网络无法工作时，在它上面运行的虚拟机会被迁移到另外一个主机上，而具体的迁移过程取决于所选择的调度策略。这一点对于运行关键任务服务的虚拟机非常重要，其所依赖的逻辑网络必须设置为“Required”。</p><blockquote><p>请注意，当创建一个逻辑网络创建并加入到集群后，网络类型默认为：“Required”。</p></blockquote><h5 id="Optional网络"><a href="#Optional网络" class="headerlink" title="Optional网络"></a>Optional网络</h5><p>除了“Required”网络外，剩下的就是“Optional”网络。Optional网络可以只在需要它的主机上有效。有或没有可选的网络不会影响到一个主机的“Operational”状态。当一个Optional网络无法工作时，使用它的虚拟机不会被迁移到另一个主机上。</p><h5 id="虚拟机网络-VM-network"><a href="#虚拟机网络-VM-network" class="headerlink" title="虚拟机网络(VM network)"></a>虚拟机网络(VM network)</h5><p>虚拟机网络是那些只处理虚拟机网络流量的逻辑网络。虚拟机网络可以是Required，也可以是Optional。使用一个Optional虚拟机网络的虚拟机只会在带有这个网络的主机上启动。</p><h5 id="端口镜像-port-mirroring"><a href="#端口镜像-port-mirroring" class="headerlink" title="端口镜像(port mirroring)"></a>端口镜像(port mirroring)</h5><p>端口镜像会把指定逻辑网络和主机上的第3层网络流量复制到一个虚拟机的虚拟网络接口上。这样，通过这个虚拟机就可以进行网络纠错、网络优化、网络入侵检测以及对在同一个主机和逻辑网络中运行的虚拟机进行监控。</p><p>端口镜像只复制一个主机和一个逻辑网络内部的网络数据，它不会增加这个主机以外的网络流量。但是，启用了端口镜像功能的主机会比其它主机消耗更多CPU和内存资源。</p><p>端口镜像可以通过逻辑网络的vNIC配置集被启用或禁用，但它具有以下的限制: </p><ul><li>不支持对在配置集中启用了端口镜像功能的vNIC进行“热插”。</li><li>当vNIC配置集被附加到一个虚拟机时，端口镜像功能就无法改变。</li></ul><p>鉴于以上限制，我们经常使用一个额外的专用的vNIC配置集，然后在其上启用端口镜像功能。</p><h3 id="3-3-主机网络配置"><a href="#3-3-主机网络配置" class="headerlink" title="3.3. 主机网络配置"></a>3.3. 主机网络配置</h3><p>主机上常见网络配置类型包括：</p><ul><li>网桥和网卡配置。 </li><li>网桥、VLAN和网卡配置。 </li><li>网桥、网络绑定和VLAN配置。 </li><li>多网桥、多VLAN和网卡配置。</li></ul><h4 id="网桥配置"><a href="#网桥配置" class="headerlink" title="网桥配置"></a>网桥配置</h4><p>在ovirt虚拟化环境中最简单的配置为“网桥 + 网卡”的配置，如下图。它通过网桥将一个或多个虚拟机连接至主机的物理网卡。</p><p><img src="http://img.simiam.com/host-config-bridge.png" alt="网桥与网卡配置"></p><p>这种配置的一个实例就是安装ovirt-engine时自动创建的ovirtmgmt网桥。在安装的过程中，ovirt-engine在主机上安装 VDSM，VDSM的安装过程中会创建ovirtmgmt网桥。ovirtmgmt网桥可以获得主机的IP地址来实现主机的管理网络功能。</p><h4 id="VLAN配置"><a href="#VLAN配置" class="headerlink" title="VLAN配置"></a>VLAN配置</h4><p>下图展示了基于VLAN的另一种可选配置：</p><p><img src="http://img.simiam.com/host-config-bridge-vlan.png" alt="基于VLAN的网桥与网卡配置"></p><p>通过使用VLAN为这个网络中的数据传输提供了一个安全的通道。另外，使用多个VLAN还可以实现把多个网桥连接到一个网卡的功能。</p><h4 id="网桥与Bond配置"><a href="#网桥与Bond配置" class="headerlink" title="网桥与Bond配置"></a>网桥与Bond配置</h4><p>下图所显示的配置中包括一个网络Bond，多个主机网卡通过Bond和同一个网桥和网络进行连接。</p><p><img src="http://img.simiam.com/host-config-bridge-bond.png" alt="基于Bond的网桥与网卡配置"></p><p>通过Bond创建了一个逻辑连接来把两个(或更多)物理网卡（NIC）连接起来。这种配置可以提供网卡容错、增加网络带宽等特性，具体取决于所配置的bond-mode。</p><h4 id="多网桥、多VLAN与单网卡配置"><a href="#多网桥、多VLAN与单网卡配置" class="headerlink" title="多网桥、多VLAN与单网卡配置"></a>多网桥、多VLAN与单网卡配置</h4><p>下图所显示的配置把一个网卡连接到两个VLAN（这需要网络交换机的配合，相应的上联口需要配置为trunk模式）。主机使用两个独立的vNIC来分别处理两个VLAN网络数据，而每个VLAN会通过vNIC连接到不同的网桥中。在此基础上，每个网桥可以被多个虚拟机使用。</p><p><img src="http://img.simiam.com/host-config-bridge-multi-vlan.png" alt="多网桥+多VLAN+单网卡配置"></p><h4 id="多网桥、多VLAN与单Bond配置"><a href="#多网桥、多VLAN与单Bond配置" class="headerlink" title="多网桥、多VLAN与单Bond配置"></a>多网桥、多VLAN与单Bond配置</h4><p>下图所显示的使用多个网卡组成一个Bond设备来连接到多个VLAN的配置视图。</p><p><img src="http://img.simiam.com/host-config-bridge-vlan-bond.png" alt="多网桥+多VLAN+单Bond配置"></p><p>这个配置中的VLAN通过Bond设备和网卡进行连接。每个VLAN连接到不同的网桥，每个网桥可以连接一个或多个虚拟机。</p><h2 id="4-电源管理"><a href="#4-电源管理" class="headerlink" title="4. 电源管理"></a>4. 电源管理</h2><h3 id="4-1-电源管理和隔离介绍"><a href="#4-1-电源管理和隔离介绍" class="headerlink" title="4.1. 电源管理和隔离介绍"></a>4.1. 电源管理和隔离介绍</h3><p>当设置了电源管理和隔离(fence)功能后，ovirt虚拟化环境将会提供更好的灵活性和稳定性。电源管理功能将可以使ovirt-engine控制主机的电源操作，其中最重要的一点是可以在主机出现故障时重新启动主机。</p><p>隔离功能主要用于把出现故障的主机从ovirt虚拟化环境中分离出来，从而使整个虚拟化环境正常运行。当被隔离的主机的故障被排除后，它可以重新返回正常工作的状态，并被重新加入到原来的虚拟环境中。</p><p>电源管理和隔离功能需要使用独立于操作系统的专用硬件来实现。ovirt-engine使用电源管理设备的IP地址或主机名来访问它。在ovirt虚拟化环境中，电源管理设备和隔离设备是相同的。</p><h3 id="4-2-在ovirt虚拟化环境中使用代理进行电源管理"><a href="#4-2-在ovirt虚拟化环境中使用代理进行电源管理" class="headerlink" title="4.2. 在ovirt虚拟化环境中使用代理进行电源管理"></a>4.2. 在ovirt虚拟化环境中使用代理进行电源管理</h3><p>ovirt-engine不直接和隔离设备进行通讯，它使用一个代理来向主机的电源管理设备发送电源管理命令。ovirt-engine需要使用VDSM来操作电源管理设备，因此环境中还需要另外一个主机作为隔离代理。</p><p>我们可以选择: </p><ul><li>需要隔离功能的主机所在的同一个集群中的任何主机。 </li><li>需要隔离功能的主机所在的同一个数据中心中的任何主机。</li></ul><p>隔离代理主机的状态有两种：Up和Maintenance。 </p><h3 id="4-3-电源管理"><a href="#4-3-电源管理" class="headerlink" title="4.3. 电源管理"></a>4.3. 电源管理</h3><p>ovirt-engine可以重启那些处于“无法正常工作(non-operational)”或“无响应(non-responsive)”状态的主机；或为省电关闭那些有低利用率的主机，但这些操作需要电源管理设备被正确配置。 </p><p>ovirt虚拟化环境支持以下电源管理设备:</p><ul><li>American Power Conversion(apc)。</li><li>Bladecenter。</li><li>Cisco Unified Computing System(cisco_ucs)。</li><li>Dell Remote Access Card 5(drac5)。</li><li>Dell Remote Access Card 7(drac7)。</li><li>Electronic Power Switch(eps)。</li><li>HP BladeSystem(hpblade)。</li><li>Integrated Lights Out(ilo、ilo2、ilo3、ilo4)。 </li><li>Intelligent Platform Management Interface(ipmilan)。 </li><li>Remote Supervisor Adapter(rsa)。</li><li>Fujitsu-Siemens RSB (rsb)</li><li>Western Telematic, Inc(wti)。</li></ul><blockquote><p>apc隔离代理不支持APC 5.x电源管理设备，我们需要使用apc_snmp隔离代理。</p></blockquote><p>ovirt-engine使用隔离代理(fence agent)来和电源管理设备进行交流，系统管理员可以使用ovirt-engine配置电源管理的隔离代理(使用电源管理设备支持的参数)。对于简单的配置项可以通过系统提供的图形用户界面进行，而特殊的配置选项(只适用于特定隔离设备的选项)也可以通过这个界面被输入，但系统不会对它们进行任何处理，而直接把这些配置选项传递给隔离设备。</p><p>所有电源管理设备所支持的配置操作包括:</p><ul><li>Status：检查主机的状态。</li><li>Start：启动主机。</li><li>Stop：关闭主机。</li><li>Restart：重启主机(实际上是通过执行 stop、wait、status、start、wait、status 操作实现的)。</li></ul><p>作为一个最佳的实践规则，我们需要在初始化配置完成后马上测试电源管理功能，并定期对运行环境中的电源管理功能进行测试。</p><p>一个稳定的系统需要在环境中的所有主机上正确地配置电源管理设备。在出现问题的主机上，ovirt-engine可以使用隔离代理跳过操作系统来直接和主机上的电源管理设备直接进行交流，并通过重启主机来把有问题的主机从虚拟化环境中隔离。如果被隔离的主机上有运行着开启高可用特性的虚拟机，ovirt-engine可以安全地把这些高可用性虚拟机迁移到其它主机上；如果被隔离的主机是SPM，ovirt-engine可以把SPM角色分配给其它主机。</p><h3 id="4-4-隔离"><a href="#4-4-隔离" class="headerlink" title="4.4. 隔离"></a>4.4. 隔离</h3><p>在ovirt虚拟化环境中，隔离操作(fencing)就是由ovirt-engine通过使用隔离代理发起的、由电源管理设备负责执行的主机重启操作。隔离操作可以使集群对意料外的主机故障做出相应的响应；或根据预先设定的规则实现省电、负载均衡、虚拟机可用性策略等功能。</p><p>隔离功能可以保证SPM角色只属于一个正常工作的主机。如果被隔离的主机是SPM，这个SPM角色会被系统收回并分配给另外一台正常工作的主机。因为拥有SPM角色的主机是唯一一个可以修改数据域结构元数据的主机，所以如果作为SPM的主机没有配置隔离功能，当它出现故障时，环境中的所有需要修改数据域元数据的操作(如创建和销毁虚拟磁盘、进行快照、扩展逻辑卷等)都将无法进行。</p><p>当一个主机处于“无响应”状态时，在它上面运行的所有虚拟机也会处于“无响应”状态，而虚拟机对虚拟磁盘镜像操作所留下的“锁定”记录仍然会保留在主机上。这时，如果没有使用隔离功能，而直接在其它主机上重启那些无响应的虚拟机，并且对虚拟机有写操作权限时，虚拟机原来的磁盘镜像中的数据可能会被破坏。</p><p>使用隔离功能可以避免这个问题的出现。当主机被重启后，以前的”锁定“记录会被释放。ovirt-engine会使用一个隔离代理来确认出现问题的主机是否已经被重启。当ovirt-engine收到了主机已经重启成功的确认后，就可以在其它主机上重启这些虚拟机（它们之前运行在出现问题被隔离的主机上），而不会造成数据的破坏。隔离是实现高可用性虚拟机的基础，没有这个功能，高可用性虚拟机将无法在其它主机上运行。</p><p>当一个主机无响应时，ovirt-engine会等待30秒，然后再决定是否进行其它操作，这可以避免因为主机的临时性错误所可能引起的不必要的隔离操作。当等待超时后，主机仍然没有响应，ovirt-engine就会自动启动隔离操作。ovirt-engine使用电源管理设备的隔离代理来停止主机的运行；在确认主机已经停止后，再次启动主机，并确认主机已经被成功启动。当主机启动完成后，它会尝试重新加入到原来的集群中。如果主机的故障在启动后已被解决，它的状态会变为Up，并可以继续正常运行虚拟机。</p><h3 id="4-5-Soft-Fencing主机"><a href="#4-5-Soft-Fencing主机" class="headerlink" title="4.5. Soft-Fencing主机"></a>4.5. Soft-Fencing主机</h3><p>有些时候，一个主机会因为无法预见的问题造成它处于无响应状态。此时尽管VDSM对所做出的请求无法响应，但依赖于VDSM的虚拟机仍然可以被访问。在这种情况下，重新启动VDSM就可能解决这个问题。</p><p>“SSH Soft Fencing”是ovirt-engine试图通过SSH在一个没有响应的主机上重启VDSM的过程。如果ovirt-engine无法通过SSH重启VDSM，而且配置了外部的隔离代理，则隔离操作将由外部的隔离代理进行处理。</p><p>要使用soft-fencing over SSH功能，主机必须配置并启用了隔离，一个有效的代理主机(数据中心中的另外一个主机，它的状态是UP)必须存在。当ovirt-engine和主机的连接出现超时情况时，会发生以下事件：</p><ul><li>在网络出现第一次失败时，主机的状态变为”connecting”。</li><li>然后ovirt-engine会尝试向VDSM询问状态（尝试3次），或根据主机的负载等待一段时间，这个等待的时间是通过以下公式计算的:</li></ul><blockquote><p>TimeoutToResetVdsInSeconds(默认值是 60 秒)+ [DelayResetPerVmInSeconds(默认值是 0.5 秒)]*(在主机上运行的虚拟机的数量)+ [DelayResetForSpmInSeconds(默认值是 20 秒)] * 1(如果主机是 SPM)或 0(如果主机不是 SPM)。<br>为了留给VDSM尽量多的超时等待时间，ovirt-engine会选择以上两个操作所需的最长时间。</p></blockquote><ul><li>如果过了最大的等待时间后主机还没有响应，ovirt-engine会通过SSH在目标主机上执行<code>vdsm restart</code>命令。</li><li>如果<code>vdsm restart</code>命令无法执行或执行失败，主机的状态将会变为NonResponsive，如果配置了电源管理，外部的隔离代理将会进行相应的硬件隔离操作。</li></ul><blockquote><p>Soft-fencing over SSH可以在没有配置电源管理的主机上运行。这和通用的硬件隔离(fencing)有所不同：常见的硬件隔离只能在配置了电源管理的主机上运行。</p></blockquote><h3 id="4-6-使用多个电源管理隔离代理"><a href="#4-6-使用多个电源管理隔离代理" class="headerlink" title="4.6. 使用多个电源管理隔离代理"></a>4.6. 使用多个电源管理隔离代理</h3><p>单一的隔离代理都会被看做为“主要的”代理。“次要的”隔离代理只有在有第二个代理存在时才有效，而多个代理可以是同一个类型，也可以是不同的类型。</p><p>如果一个主机上只有一个隔离代理，当这个代理出现问题时，主机在被手动重启前将会一直出于“无响应”的状态，而在它上面运行的虚拟机也将处于停止的状态。只有当主机被人工隔离后，这些虚拟机才会被迁移到另外的主机上运行。而如果一个主机上使用了多个隔离代理，当一个代理失败时，其它的代理就可以被使用，这样就可以提高隔离功能的稳定性。</p><p>当在主机上定义了两个代理时，这两个代理可以配置为并行(concurrent)或顺序(sequential)：</p><ul><li>并行(Concurrent)：要停止主机，主代理和从代理都需要响应ovirt-engine的Stop命令；要启动主机，只需要一个代理响应Start命令。</li><li>顺序(Sequential)：要停止或启动一个主机，主代理会优先启用，如果主代理失效，则从代理才会启用。</li></ul><h2 id="5-负载均衡、调度和迁移"><a href="#5-负载均衡、调度和迁移" class="headerlink" title="5. 负载均衡、调度和迁移"></a>5. 负载均衡、调度和迁移</h2><blockquote><p>与调度相关的源码都在：<code>&lt;ovirt-engine源码库根目录&gt;/backend/manager/modules/bll/src/main/java/org/ovirt/engine/core/bll/scheduling</code>这个包下面。</p></blockquote><p>一个单独主机所具有的硬件资源总是有限的，同时这些硬件资源也会出现故障。要解决这些问题，我们可以把多个主机组成一个集群来，这样就可以在不同的主机间共享资源。ovirt虚拟化环境使用负载均衡策略、调度和迁移机制来协调主机资源，这样就可以应对各种资源需求的变化。ovirt-engine可以保证一个集群中的所有虚拟机不会都运行在同一个主机上；另外，如果集群中出现某个主机的利用率非常低的话，ovirt-engine还会把这个主机上面的所有虚拟机迁移到其它主机上，从而可以关闭这个低利用率的主机来达到省电节能的目的。</p><p>当发生以下三个事件时，系统会检查环境中的可用资源：</p><ul><li>启动虚拟机：系统会检查环境中的主机资源，并决定在哪个主机上运行这个虚拟机。</li><li>迁移虚拟机：系统会检查环境中的主机资源，并决定把虚拟机迁移到哪个主机上。</li><li>间隔一定时间：系统会定期检查环境中的主机资源，并决定每个主机是否符合预先设定的集群负载均衡策略。</li></ul><p>当有效资源出现变化时，ovirt-engine会根据集群的负载均衡策略来调度虚拟机迁移操作。下面会对负载均衡策略、调度和虚拟机迁移做详细的介绍。</p><h3 id="5-1-负载均衡策略"><a href="#5-1-负载均衡策略" class="headerlink" title="5.1. 负载均衡策略"></a>5.1. 负载均衡策略</h3><p>负载均衡策略是针对集群设置的。集群由一个或多个可以带有不同硬件参数和可用内存的主机组成，ovirt-engine会根据集群的负载均衡策略来决定在集群中的哪个主机上运行虚拟机。另外，负载均衡策略还指定了ovirt-engine会在什么情况下把过高利用率主机上的虚拟机迁移到其它主机。<br>数据中心的每个集群每隔1分钟会进行一次负载均衡处理。它会根据系统管理员预先为集群设定的负载均衡策略来决定哪些主机处于过度利用的状态；哪些主机的资源没有被充分利用；哪些主机仍有足够的资源用来运行从其它主机上迁移过来的虚拟机。负载均衡策略选项包括：VM_Evenly_Distributed、Evenly_Distributed、Power_Saving、None、Cluster_Maintenance。</p><h4 id="5-1-1-负载均衡策略：虚拟机均匀分布（VM-Evenly-Distributed）"><a href="#5-1-1-负载均衡策略：虚拟机均匀分布（VM-Evenly-Distributed）" class="headerlink" title="5.1.1. 负载均衡策略：虚拟机均匀分布（VM_Evenly_Distributed）"></a>5.1.1. 负载均衡策略：虚拟机均匀分布（VM_Evenly_Distributed）</h4><p>使用这个策略的集群会把需要运行的虚拟机根据数量平均运行在集群中的每个主机上。</p><p>系统管理员需要设置每个主机上最多可运行多少台虚拟机，如果某个主机上所运行的虚拟机数量超过了这个最大值，这个主机就被识别为过载(overload)。另外，系统管理员还需要设置一个参数来指定最高利用率主机上所运行的虚拟机数量和最低利用率主机上所运行的虚拟机数量间的最大差值。</p><p>以上的2个值决定了“虚拟机迁移阈值(threshold)”的范围。当集群中的每个主机上所运行的虚拟机数据都在这个阈值范围内时，系统认为集群处于“负载均衡”的状态。</p><p>除此之外，因为作为SPM的主机通常需要有较低的虚拟机负载，因此管理员还可以设置在SPM主机上能预留的虚拟机资源的数量，这个值决定了SPM主机可以比其它主机少运行多少个虚拟机。 </p><p>当集群中的某个主机上所运行的虚拟机数量超过了配置的最大值（单机可运行的最大虚拟机数量），并且集群中有至少一个主机所运行的虚拟机数量低于“虚拟机迁移阈值”的下限时，这个主机上的一个虚拟机就会被迁移到有最低利用率的主机上。如果迁移一个虚拟机后集群还没有处于“负载均衡”状态，系统会重复以上过程来迁移另外一个虚拟机，直到这个集群达到了“负载均衡”状态。</p><h4 id="5-1-2-负载均衡策略：均匀分布（Evenly-Distributed）"><a href="#5-1-2-负载均衡策略：均匀分布（Evenly-Distributed）" class="headerlink" title="5.1.2. 负载均衡策略：均匀分布（Evenly_Distributed）"></a>5.1.2. 负载均衡策略：均匀分布（Evenly_Distributed）</h4><p><img src="http://img.simiam.com/load-balance-policy-evenly-distributed.png" alt="Evenly_Distributed"></p><p>Evenly_Distributed这个策略是指：ovirt-engine通过选择CPU的负载最低或可用内存量最大的主机来运行一个新的虚拟机的策略。具体选择哪个指标（CPU负载或内存可用量）及指标的值，则由该策略的配置参数决定。</p><p>另外系统还可以设置一个时间值参数，这个参数的意思是说集群中的主机的最大CPU负载或最低内存可用量能够持续的最大时间值。如果主机CPU或内存最在负载持续时间超过这个阈值，则ovirt-engine将发起虚拟迁移任务，这个主机上的一个虚拟机会被迁移到集群中的CPU或内存利用率最低的一个主机上。如果迁移完成后，原来的主机的CPU和内存利用率仍然高于所限定的值，则重复以上步骤迁移它上面的另外一台主机，直到主机的CPU和内存利用率降到所限制的范围之内。<strong>主机资源检测任务一分钟执行一次。</strong></p><p>Evenly_Distributed策略与VM_Evenly_Distributed策略的区别是：前者基于CPU或内存利用率作为迁移的触发参考条件，而后者则以运行在主机上的虚拟机数量作为迁移的触发参考条件。</p><h4 id="5-1-3-负载均衡策略：节能（Power-Saving）"><a href="#5-1-3-负载均衡策略：节能（Power-Saving）" class="headerlink" title="5.1.3. 负载均衡策略：节能（Power_Saving）"></a>5.1.3. 负载均衡策略：节能（Power_Saving）</h4><p><img src="http://img.simiam.com/load-balance-policy-power-saving.png" alt="Power_Saving"></p><p>这个策略会把新虚拟机运行在CPU和内存利用率最低的主机上。</p><p>系统管理员可以设置一个“最大服务级别”值，这个值代表了集群中的主机所允许的最大CPU和内存利用率，如果主机的CPU和内存利用率超过了这个值，整个环境的性能就会下降。</p><p>系统管理员还可以设置一个“最低服务级别”值，它代表了在主机的 CPU和内存利用率低于这个值时，从用电的角度来讲,继续运行这个主机将会被判断为是不符合“经济效益”的。</p><p>另外，系统管理员还需要为“最大服务级别”和“最低服务级别”设置一个时间值，它指定了主机的CPU和内存利用率低于“最低服务级别”值(或高于“最大服务级别”值)多长时间后，ovirt-engine才会对主机采取行动来解决这个不符合“经济效益”的问题。</p><p>当一个主机的CPU和内存利用率高于“最大服务级别”值，并且处于这个状态的时间超过了所设定的时间值时，这个主机上的一个虚拟机会被迁移到集群中的CPU和内存利用率最低的一个主机上。如果迁移完成后，原来主机的CPU和内存利用率仍然高于所限定的值，则重复以上步骤迁移它上面的另外一台主机，直到主机的CPU和内存利用率降到所限制的范围之内。</p><p>当一个主机的CPU和内存利用率低于“最低服务级别”值，并且处于这个状态的时间超过了所设定的时间值时，这个主机上的所有虚拟机会在“最大服务级别”条件许可的情况下迁移到集群中的其它主机上。然后，ovirt-engine会自动关闭这台主机。如果系统在以后的某个时间需要更多的主机资源时，这个被关闭的主机会被重新启动(配合电源管理实现)。</p><h4 id="5-1-4-负载均衡策略：None"><a href="#5-1-4-负载均衡策略：None" class="headerlink" title="5.1.4. 负载均衡策略：None"></a>5.1.4. 负载均衡策略：None</h4><p>如果没有选择任何负载均衡策略，新的虚拟机会在集群中的一个有可用内存，而且CPU利用率最低的主机上运行。其中的CPU利用率是通过一个算法对虚拟CPU的数量和CPU使用情况进行计算后得出的。如果选择使用这个选项，系统只有在要运行新虚拟机时才进行主机选择。另外，在主机负载增加时，系统也不会自动迁移虚拟机。</p><p>如果需要进行虚拟机迁移，系统管理员需要决定虚拟机要被迁移到哪台主机。另外，还可以使用固定 (pinning）功能把虚拟机和某个主机相关联。使用固定功能可以防止虚拟机被自动迁移到其它主机。对于需要消耗大量硬件资源的环境，手工迁移是最好的选择。</p><h4 id="5-1-5-负载均衡策略：Cluster-Maintenance"><a href="#5-1-5-负载均衡策略：Cluster-Maintenance" class="headerlink" title="5.1.5. 负载均衡策略：Cluster_Maintenance"></a>5.1.5. 负载均衡策略：Cluster_Maintenance</h4><p>这个策略会限制集群内的一些活动（任务）。在这种策略下：</p><ul><li>除了启用HA特性的虚拟机外，将不会在该集群中的任意一台主机上启动虚拟机。（即：用户可以创建具有HA特性的虚拟机并人为启动该虚拟机）</li><li>当主机异常时，具有HA特性的虚拟机将会重启，同时也能够迁移原来运行在该主机上的虚拟机。</li></ul><h3 id="5-2-高可用性虚拟机资源预留"><a href="#5-2-高可用性虚拟机资源预留" class="headerlink" title="5.2. 高可用性虚拟机资源预留"></a>5.2. 高可用性虚拟机资源预留</h3><p><img src="http://img.simiam.com/ovirt-cluster-ha-reservation.png" alt="功能示意图"></p><p>具有高可用性(HA)虚拟机资源预留策略可以使ovirt-engine监控集群资源的使用情况，从而可以保证在需要的时候为高可以性虚拟机提供有效的资源。ovirt-engine可以把虚拟机标识为“高可用性”，在需要的时候，这些虚拟机可以在其它主机上重启。在高可用性虚拟机资源预留功能被启用时，ovirt-engine会为高可用性虚拟机预留一些资源，以防在主机故障的情况下，这些高可用虚拟机需要进行迁移时，能保证集群中有足够的资源来完成迁移操作。</p><h3 id="5-3-调度机制"><a href="#5-3-调度机制" class="headerlink" title="5.3. 调度机制"></a>5.3. 调度机制</h3><p>在ovirt虚拟化环境中，调度(scheduling)是指ovirt-engine在集群中选择一个主机作为新虚拟机或将要迁移的虚拟机的目标主机（宿主机）的过程。</p><p>作为一个可以运行新虚拟机或从其它主机上迁移来的虚拟机的主机，它需要有足够的空闲内存和CPU资源来运行这些虚拟机。需要注意的是虚拟机是无法在CPU过载的主机上启动的。默认情况下，主机的CPU利用率在5分钟内都维持在80%以上的话，该主机就会被标识为CPU过载。<code>5分钟与80%</code>这两个参数是可以在管理界面上进行修改的。如果有多个主机都满足这个要求，系统会根据集群负载均衡策略来选择一个主机。例如，如果使用“Evenly_Distributed”策略，ovirt-engine会选择有最低CPU利用率的主机。如果使用“Power_Saving”策略，在“最大服务级别”和“最低服务级别”范围内的、CPU利用率最低的主机会被选择。另外，SPM的状态也会影响主机的选择过程。一个非SPM主机比SPM主机有更大的概率被选中。例如，如果集群中有SPM主机和非SPM主机，第一个需要在集群中运行的虚拟机会在非SPM主机上运行。</p><h3 id="5-4-迁移"><a href="#5-4-迁移" class="headerlink" title="5.4. 迁移"></a>5.4. 迁移</h3><p>ovirt-engine使用迁移来实现集群的负载均衡策略，当集群中的主机负载处于一定状态时(超过最大值或低于最小值)，虚拟机迁移操作就会被执行，从而可以保证主机负载满足集群的负载均衡策略。另外，虚拟机迁移操作还可以被设置为当主机被隔离(fence)或被设置为维护模式时自动进行。当需要进行迁移时，ovirt-engine会首先迁移CPU利用率最低的虚拟机(CPU利用率是一个百分比值，在计算这个值时不会考虑内存和I/O的使用情况，除非I/O操作会影响到CPU利用率)。当有多个虚拟机的CPU利用率相同时，ovirt-engine将根据SQL查询结果的列表顺序来决定第一个被迁移的虚拟机。</p><p>在默认情况下，虚拟机迁移有以下限制:</p><ul><li>每个虚拟机迁移的网络带宽被限制在52MBps(megabyte每秒) </li><li>迁移有超时限制，超时的计算方法是：虚拟机内存的大小(以GB为单位)乘以64秒。 </li><li>如果迁移进程无任何响应（无任何进展）的时间达超过240秒，迁移也将终止。 </li><li>允许同时进行迁移的虚拟机数量被限制为：每个主机上的CPU内核数量，但最多不能超过2个。</li></ul><h2 id="6-虚拟机快照、模板与虚拟机池"><a href="#6-虚拟机快照、模板与虚拟机池" class="headerlink" title="6. 虚拟机快照、模板与虚拟机池"></a>6. 虚拟机快照、模板与虚拟机池</h2><h3 id="6-1-虚拟机快照"><a href="#6-1-虚拟机快照" class="headerlink" title="6.1. 虚拟机快照"></a>6.1. 虚拟机快照</h3><p>快照就是一个存储功能，它允许管理员为一个虚拟机的操作系统、应用程序和数据在特定时间创建一个恢复点。快照会把虚拟机当前的磁盘镜像保存为一个COW卷，并可以在以后把虚拟机恢复到虚拟机创建快照时的状态。当快照创建完成后，一个新的COW层会在当前层上被创建，快照创建后的所有写操作都会在新的COW层上执行。</p><p>虚拟机的硬盘镜像实际上是由一个或多个卷组成的，而从虚拟机的角度来看，这些卷以一个单一的磁盘镜像形式呈现。<br>“COW卷”和“COW层”是同一个概念，它们可以被相互替代使用，但“层”更贴近于快照的本质。通过快照，管理员可以随时抛弃那些在创建快照后所做的变更，这和许多程序所提供的<code>Undo</code>操作类似。</p><p>快照包括 3 个主要操作:</p><ul><li>创建:为一个虚拟机创建一个快照。 </li><li>预览:预览一个快照，决定是否把系统恢复到创建这个快照时的状态。 </li><li>删除:删除一个不再需要的恢复点(快照)。</li></ul><h4 id="6-1-1-实时快照"><a href="#6-1-1-实时快照" class="headerlink" title="6.1.1. 实时快照"></a>6.1.1. 实时快照</h4><p>其它未正进行克隆或迁移操作的虚拟机都可以执行快照操作，此时的虚拟机的状态可以是运行、暂停或停止状态。</p><p>当对一个虚拟机进行实时快照时，ovirt-engine会要求SPM主机创建一个新的卷来给虚拟机使用。当新卷创建好后，ovirt-engine调用VDSM来和运行该虚拟机的主机上的libvirt和qemu进行交互，要求后续对虚拟机的写操作都新卷上进行。如果虚拟机可以在新卷上进行写操作，则认为快照已经成功完成，虚拟机将不再在旧的卷中写数据。如果虚拟机无法在新卷上进行写操作，则认为快照操作失败，新的卷会被删除。</p><p>在虚拟机快照开始后，直到快照完成前，虚拟机需要对当前卷和新创建的卷都进行访问，因此这两个卷都需要允许进行读和写操作。</p><p>安装了带有静止(quiescing)功能的guest代理的虚拟机可以保证文件系统在不同快照间的一致性。已经创建的Red Hat Enterprise Linux虚拟机可以安装qemu-guest-agent，这样就可以在进行快照前启用静止功能。</p><p>如果在进行快照时，虚拟机有支持静止功能的guest代理，VDSM会使用libvirt和代理进行交互来准备快照。 在实际进行快照前，没有完成的写操作会被完成，然后文件系统会被”冻结”。当快照操作完成后，libvirt会把对虚拟机的写操作切换到新的卷上，文件系统被“解冻”，对磁盘的写操作会被恢复。</p><p>所有的实时快照都会尝试使用静止功能。如果虚拟机因为没有安装支持静止功能的guest代理而造成快照失败，实时快照会重新运行，但不会使用<code>use-quiescing</code>标志（即不会再尝试使用quiescing特性）。当一个使用了静止功能的文件系统的虚拟机使用快照恢复到以前状态时，虚拟机在启动时不会对文件系统进行检查。如果被恢复的虚拟机上没有使用静止功能，在使用快照恢复系统后，启动虚拟机时就需要对文件系统进行检查。</p><h4 id="6-1-2-创建快照"><a href="#6-1-2-创建快照" class="headerlink" title="6.1.2. 创建快照"></a>6.1.2. 创建快照</h4><p>在ovirt虚拟化环境中，第一次为一个虚拟机创建快照和以后为这个虚拟机创建后续快照的过程不同。虚拟机的第一个快照会保留镜像格式(QCOW2或RAW)，它把当前存在的卷作为一个基础镜像（母镜像）。后续的快照只是一个附加的COW层，它只记录当前系统和前一个快照中的变化。<br>在ovirt虚拟化环境中，一个虚拟机通常使用RAW磁盘镜像(除非在创建时使用了“精简(thin)”镜像，或用户指定使用QCOW2格式)。下图所示，创建的快照会包括虚拟磁盘的镜像，它将作为后续快照的基本镜像。</p><p><img src="http://img.simiam.com/vm-snapshot-create-init.png" alt="第一次为VM创建快照"></p><p>在第一个快照创建以后再创建的快照将只创建一个新的COW卷，这个卷包括了当前系统和前一个快照间的变化。每个新的COW层在开始时都只包括COW元数据，而后续使用和操作虚拟机所产生的变化数据会被添加到这个新的COW层中。如果虚拟机需要修改前一个COW层的数据时，相应的数据会从前一层中读出，并把变化的数据写到新的COW层中。虚拟机在定位数据时会以从最新到最老的顺序在各个COW中查找。</p><p><img src="http://img.simiam.com/vm-snapshot-create-post.png" alt="非第一次为VM创建快照"></p><h4 id="6-1-2-预览快照"><a href="#6-1-2-预览快照" class="headerlink" title="6.1.2. 预览快照"></a>6.1.2. 预览快照</h4><p>系统管理员可以通过预览以前创建的所有快照来决定把虚拟机恢复到什么状态。</p><p>管理员可以在一台虚拟机的所有快照列表中选择一个快照来查看它的内容。如下图“预览快照” 所示，每个快照都被保存为一个COW卷，当它被预览时，这个快照会被复制到一个新的预览层上。虚拟机将会和预览层进行交流，而不是直接访问实际的快照。</p><p>在管理员预览快照后，可以使用这个快照来把虚拟机恢复到快照创建时的状态。如果管理员使用快照进行恢复系统后，虚拟机将会被关联到预览层。</p><p>在快照预览完成后，管理员可以选择<code>Undo</code>来删除在预览过程中创建的预览层。这时虽然预览层会被删除，原来保存快照的层还会保留。</p><p><img src="http://img.simiam.com/vm-snapshot-preview.png" alt="快照预览"></p><h4 id="6-1-3-删除快照"><a href="#6-1-3-删除快照" class="headerlink" title="6.1.3. 删除快照"></a>6.1.3. 删除快照</h4><p>当快照不再需要时，您可以删除它们。删除快照后，您将无法把虚拟机恢复到这些快照所包括的时间点上。删除快照并不一定会获得更多的可用存储空间，而这些快照的数据也不一定会被实际删除。例如，您的虚拟机有5个快照，如果您删除了第3个快照，第3个快照中的数据可能仍然会存在在系统中，因为第4和第5个快照可能会需要这些数据（只有第3个快照中已变更的数据才会被删除，已变更的数据存在于第4个快照或第5个快照）。一般情况下，删除快照通常可以提高虚拟机的性能。</p><p><img src="http://img.simiam.com/vm-snapshot-delete.png" alt="快照删除"></p><p>快照删除会被作为一个异步的块任务处理，VDSM会为虚拟机在恢复文件中维护一个操作记录，从而使此任务可以被跟踪，即使在进行操作期间VDSM被重启或虚拟机被关闭时任务也可以被跟踪。当操作开始后，正被删除的快照将不能被预览，或作为一个恢复点(即使删除操作失败或被中断)。</p><p>活跃的层（可读可写的COW层）被合并到它的上一层的这一个操作可被分为两个阶段：</p><ul><li>数据被从活跃层复制到它的上一层，对磁盘的写操作被同时镜像到活跃层和它的上一层。</li><li>当镜像中的数据被合并到它的上一层快照中，VDSM把镜像链进行同步后，删除操作就被认为已经完成了。</li></ul><h3 id="6-2-虚拟机模板"><a href="#6-2-虚拟机模板" class="headerlink" title="6.2. 虚拟机模板"></a>6.2. 虚拟机模板</h3><p>ovirt虚拟化环境为管理员提供了两种便捷的虚拟机创建工具：模板 (template)和虚拟机池(pool)。管理员可以通过使用模板来快速创建虚拟机。这个新虚拟机会基于一个已经存在的、并己经被配置好的虚拟机来创建，从而省去了手工安装操作系统和配置系统的步骤。模板功能对于需要创建多个相似虚拟机的环境非常有用。例如，我们需要使用多个虚拟机作为web服务器。我们可以首先在一台虚拟机上安装操作系统、安装web服务器软件并配置系统。然后，基于这个已经配置好的虚拟机创建一个模板。当您需要创建更多虚拟机来作为web服务器时，就可以使用这个模板来创建它们。</p><p>要创建一个模板，管理员需要先创建一个虚拟机，在新虚拟机上安装所需的软件包并进行相关的配置。对于即将作为模板的虚拟机来讲，其上面安装与配置的软件、应用、服务是比较通用的，以它作为模板创建的虚拟机基本不需要做太多的配置变更。另外，管理员可以执行一个可选的(但推荐使用)的动作：泛化(generalization)。泛化是指删除那些只与特定系统相关的、在不同的系统上会使用不同值的信息，如系统的用户名、密钥、时区。泛化对定制的配置不会有影响。 Red Hat Enterprise Linux虚拟机使用<code>sys-unconfig</code>进行泛化；Windows虚拟机使用<code>Sysprep</code>进行泛化。</p><blockquote><p>sys-unconfig：请参考<a href="https://linux.die.net/man/8/sys-unconfig">https://linux.die.net/man/8/sys-unconfig</a><br>sys-prep：请参考<a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/sysprep--generalize--a-windows-installation">Sysprep</a></p></blockquote><p>当一个准备被用来作为模板的虚拟机配置完成后(如果需要，进行了泛化操作)，并被停止运行后，管理员就可以基于这个虚拟机创建一个模板。在模板创建的过程中，模板所用的虚拟磁盘镜像会被复制生成一个只读的镜像。这个只读的镜像就会作为所有基于这个模板所创建的虚拟机的母镜像。换个角度来说，模 板就是一个带有相关虚拟机硬件配置的、自定义的磁盘镜像。通过模板所创建的虚拟机的硬件配置可以再次修改。例如，基于配置了1GB内存的模板所创建的虚拟机的内存可以被配置为2GB。但是，母镜像本身不能被修改，这是因为对模板所做的修改将被影响到所有基于它所创建的全部虚拟机。</p><p>当一个模板被创建后，我们就可以使用它来创建多个虚拟机了。使用模板创建虚拟机有两种方式：精简(thin)模式和克隆(Clone)模式，ovirt-engine直接调用VDSM提供的两个不同的接口来实现。</p><ul><li>使用克隆模式所创建的虚拟机相当于母镜像完整的且可写的磁盘镜像备份。它的优点是所创建的虚拟机不再依赖模板(在模板不存在的情况下，仍然可以正常运行)，而它的缺点则是会使用更多的存储空间。</li><li>使用精简模式创建的虚拟机会使用模板中的只读磁盘镜像作为母镜像，同时要求该虚拟机镜像及其所依赖的模板母镜像都位于同一个存储域中。每个虚拟机都会有一个可写的磁盘空间来保存新增和修改的数据。因为所有基于这个模板所创建的虚拟机都共享模板的只读类型的母镜像，所以使用这个模式创建的虚拟机会节省存储空间。另外，因为共享的母磁盘镜像数据会被多次调用，所以它们会被缓存起来，这样就可以进一步提高网络传输效率。</li></ul><h4 id="6-3-虚拟机池"><a href="#6-3-虚拟机池" class="headerlink" title="6.3. 虚拟机池"></a>6.3. 虚拟机池</h4><p>虚拟机池就是一组基于特定模板创建的虚拟机，这些虚拟机可以快速地提供给用户使用。对虚拟机池中的虚拟机的使用权限是在虚拟机池一级来设置的。如果一个用户有对某个虚拟机池的使用权限时，这个用户就有权限使用这个虚拟机池中的任何虚拟机。因为用户每次从虚拟机池中获得的虚拟机可能并不是同一台虚拟机，所以虚拟机池并不适用于用户需要在虚拟机上保存数据的情况。虚拟机池适用于用户把数据保存在中央存储设备中的情况；或不需要存储新数据的情况。当虚拟机池创建完成后，组成这个虚拟机池的虚拟机会被创建，并处于“关闭”状态。当用户需要虚拟机时，虚拟机就会被启动。</p><p>虚拟机池可以快速地为用户提供相同的虚拟机(一般是虚拟桌面系统)。当一个有权限使用虚拟机池中的虚拟机的用户请求使用虚拟机时，用户的请求会被放置在一个“请求队列”中，系统会根据用户所提交的请求在“请求队列”中的位置来为用户分配一个可用的虚拟机。</p><p>当前的ovirt-engine版本（&gt;=4.2）中，虚拟机池支持有状态与无状态两种类型。</p><ul><li><p>有状态的虚拟机池：它的有状态并不是指池中的虚拟机是与某一个具体用户有关联关系，而是指用户A对虚拟机1所做的操作数据将会保存，当用户B向池中申请虚拟机时，ovirt-engine是可能会将用户A曾经使用过的虚拟机1分配给用户B的，此时用户B将会看到用户A在虚拟机1上的操作结果。很少会使用这种有状态的虚拟机池。</p></li><li><p>无状态的虚拟机池：虚拟机池中的虚拟机不具有数据持久性，这意味着每次用户使用虚拟机池中的虚拟机时，这个虚拟机都处于它的基本状态，而用户上次使用虚拟机时对虚拟机所做的更改不会被保留。这类虚拟机池适用于用户的数据被存储在一个中央存储的情况。</p></li></ul><p>虚拟机池是通过模板创建的。池中的每个虚拟机都共享一个只读磁盘镜像，并使用一个临时的可写镜像用于保存虚拟机操作过程中可能需要持久化的数据。无状态的虚拟机池中的虚拟机和其它虚拟机不同，用户在使用它们时所产生的数据变化会在关闭虚拟机时被删除。这意味着虚拟机池所使用的存储较小(它只需要和模板相同的空间，再加上一些用来临时存储用户使用数据的存储空间)。使用虚拟机池来提供虚拟机比为用户提供单独虚拟机要节省更多的存储空间。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;oVirt虚拟化关键概念、组件与技术原理&quot;&gt;&lt;a href=&quot;#oVirt虚拟化关键概念、组件与技术原理&quot; class=&quot;headerlink&quot; title=&quot;oVirt虚拟化关键概念、组件与技术原理&quot;&gt;&lt;/a&gt;oVirt虚拟化关键概念、组件与技术原理&lt;/h1&gt;&lt;h4 id=&quot;云管理平台组-陈志安&quot;&gt;&lt;a href=&quot;#云管理平台组-陈志安&quot; class=&quot;headerlink&quot; title=&quot;云管理平台组-陈志安&quot;&gt;&lt;/a&gt;云管理平台组-陈志安&lt;/h4&gt;&lt;hr&gt;
&lt;h2 id=&quot;1-介绍&quot;&gt;&lt;a href=&quot;#1-介绍&quot; class=&quot;headerlink&quot; title=&quot;1. 介绍&quot;&gt;&lt;/a&gt;1. 介绍&lt;/h2&gt;&lt;h3 id=&quot;1-1-ovirt-engine&quot;&gt;&lt;a href=&quot;#1-1-ovirt-engine&quot; class=&quot;headerlink&quot; title=&quot;1.1. ovirt-engine&quot;&gt;&lt;/a&gt;1.1. ovirt-engine&lt;/h3&gt;&lt;p&gt;ovirt-engine为虚拟化环境提供了一个集中管理的平台，用户可以根据具体的需求选择使用不同的方式来访问ovirt-engine。&lt;/p&gt;
&lt;p&gt;ovirt-engine架构图如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.simiam.com/ovirt-engine-infra.png&quot; alt=&quot;ovirt-engine架构图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;应用服务器（ovirt-Wildfly）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Wildfly是一个JavaEE应用服务器，但是需要注意的是部署ovirt-engine所需要的wildfly是特殊定制过的，因此您不能将其它应用部署在这个为ovirt-engine专门定制的wildfly上，为了便于与通用版本区分开来，本文档后续将定制版本统称为ovirt-wildfly。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用户门户（User Portal）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;桌面系统虚拟化为用户提供了一个近似于物理PC的桌面系统。用户可以使用网络浏览器来访问用户门户，并通过用户门户来访问分配给他们的虚拟桌面资源（SPICE/VNC）。系统管理员需要为每个用户设定他们可能访问的资源及相关权限。User Portal的用户有两种类型：标准用户、高级用户。标准用户可以启动、停止和使用分配给他们的虚拟桌面（无法编辑虚拟机配置），而高级用户则还可以执行一些额外的管理任务（如创建、删除、编辑虚拟机，管理虚拟磁盘和网络接口等）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;管理门户（Admin Portal）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;管理门户是ovirt-engine的一个图形管理界面。管理员可以通过该管理界面来监控、创建并维护整个ovirt虚拟环境中的所有资源（计算、网络、存储）。通过管理门户可执行如下操作：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;创建和管理虚拟基础架构（网络、存储域）&lt;/li&gt;
&lt;li&gt;创建和管理虚拟机&lt;/li&gt;
&lt;li&gt;创建和管理逻辑项（数据中心、集群）&lt;/li&gt;
&lt;li&gt;安装和管理计算节点（虚拟主机）&lt;/li&gt;
&lt;li&gt;用户权限管理&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;详细的使用文档请查阅&lt;a href=&quot;https://www.ovirt.org/documentation/admin-guide/administration-guide/&quot;&gt;官方文档&lt;/a&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="分布式" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
    <category term="ovirt" scheme="http://cloudnoter.com/tags/ovirt/"/>
    
    <category term="engine" scheme="http://cloudnoter.com/tags/engine/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>oVirt持续集成方案分析</title>
    <link href="http://cloudnoter.com/2018/07/11/oVirt%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%96%B9%E6%A1%88%E5%88%86%E6%9E%90/"/>
    <id>http://cloudnoter.com/2018/07/11/oVirt%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%96%B9%E6%A1%88%E5%88%86%E6%9E%90/</id>
    <published>2018-07-10T16:21:08.000Z</published>
    <updated>2018-10-31T03:39:15.037Z</updated>
    
    <content type="html"><![CDATA[<h1 id="oVirt持续集成方案分析"><a href="#oVirt持续集成方案分析" class="headerlink" title="oVirt持续集成方案分析"></a>oVirt持续集成方案分析</h1><h4 id="云管理平台组-陈志安"><a href="#云管理平台组-陈志安" class="headerlink" title="云管理平台组-陈志安"></a>云管理平台组-陈志安</h4><hr><h2 id="1-STDCI"><a href="#1-STDCI" class="headerlink" title="1. STDCI"></a>1. STDCI</h2><p>oVirt项目定义了一套标准规范，通过这套标准，一个源码工程就可以一种通用的方式定义其应该如何被构建、测试、部署与发行，而这个定义规则是独立于开发该源码工程所使用的编程语言及工具，本质上讲它是由oVirt制定的适用于<code>CI/CD(持续集成/持续部署)</code>的<code>DSL(Domain Specific Language)</code>，这套规范简称为<code>STDCI</code>。</p><p>CI团队可以基于这套标准创建像<code>mock_runner</code>这一类通用的构建、测试、部署与发行工具，这些工具以统一的方式来处理所有的ovirt工程。</p><p>oVirt项目的持续集成系统（CI系统）就是使用这套标准以自动化的方式执行该项目下各个工程的构建、测试、部署、发行进程。</p><blockquote><p>该规范的实现请参考：<a href="https://github.com/oVirt/jenkins/tree/master/scripts"><code>https://github.com/oVirt/jenkins/tree/master/scripts</code></a></p></blockquote><h3 id="1-1-Stage"><a href="#1-1-Stage" class="headerlink" title="1.1. Stage"></a>1.1. Stage</h3><p><code>STDCI</code>中的一个核心概念是“stage”，State是指作用在变更过的源码上的各种操作，它代表了源码从开发人员初始创建到成为正式发布产品整个生命周期的各个阶段。在每个特定的stage会执行一系列与该stage相关的各种操作（命令），这些操作命令是由每个具体工程定义。</p><p>当前STDCI定义了如下几个常用的stage：</p><ul><li>build-artifacts：该阶段定义了如何从源码构建出用户可使用的归档文件，比如RPM包或Docker镜像之类的文件。</li><li>build-artifacts-manual：该阶段主要定义了如何从tar格式的源码包进行项目构建，一般在人工处理的方式进行正式版本发布时会涉及到该阶段，比较少用。</li><li>check-patch：这个阶段定义了当代码发生变更时如何进行代码质量、功能或回归验证。一般是用户在Github等平台上发起PR请求会触发与该阶段关联的操作。</li><li>check-merged：这个阶段定义了当代码发生变更时如何进行代码质量、功能或回归验证。一般是分支合并操作后会触发与该阶段关联的操作。</li><li>poll-upstream-sources：有时项目会依赖的上游或外部项目或库，该阶段主要定义了上游或外部依赖项目的更新操作。</li></ul><span id="more"></span><h3 id="1-2-创建符合STDCI规范的项目"><a href="#1-2-创建符合STDCI规范的项目" class="headerlink" title="1.2. 创建符合STDCI规范的项目"></a>1.2. 创建符合STDCI规范的项目</h3><ul><li>STDCI配置文件，该文件必须存放在工程根目录下，该配置文件的格式规范及用法请参考链接：<a href="http://ovirt-infra-docs.readthedocs.io/en/latest/CI/STDCI-Configuration/index.html">STDCI配置文件使用说明</a>。</li><li>工程根目录下必须有一个名为<code>automation</code>的目录，该目录存放着每个<code>stage</code>需要执行的脚本文件。</li></ul><p>STDCI配置文件名可以有如何几种：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stdci<span class="selector-class">.yaml</span>, automation<span class="selector-class">.yaml</span>, seaci<span class="selector-class">.yaml</span>, ovirtci<span class="selector-class">.yaml</span></span><br><span class="line">stdci<span class="selector-class">.yml</span>, automation<span class="selector-class">.yml</span>, seaci<span class="selector-class">.yml</span>, ovirtci<span class="selector-class">.yml</span></span><br><span class="line"><span class="selector-class">.stdci</span><span class="selector-class">.yaml</span>, <span class="selector-class">.automation</span><span class="selector-class">.yaml</span>, <span class="selector-class">.seaci</span><span class="selector-class">.yaml</span>, <span class="selector-class">.ovirtci</span><span class="selector-class">.yaml</span></span><br><span class="line"><span class="selector-class">.stdci</span><span class="selector-class">.yml</span>, <span class="selector-class">.automation</span><span class="selector-class">.yml</span>, <span class="selector-class">.seaci</span><span class="selector-class">.yml</span>, <span class="selector-class">.ovirtci</span>.yml</span><br></pre></td></tr></table></figure><p>默认情况下，在进行工程构建与测试时，STDCI引擎将从工程根目录下依次搜索配置文件，然后在每个特定的stage根据配置文件中设置的规则执行<code>automation</code>目录下的相应脚本。</p><h3 id="1-3-基于STDCI进行项目构建与测试"><a href="#1-3-基于STDCI进行项目构建与测试" class="headerlink" title="1.3. 基于STDCI进行项目构建与测试"></a>1.3. 基于STDCI进行项目构建与测试</h3><p>目前有两种方式构建与测试符合STDCI规范的工程：</p><ul><li>使用<code>mock_runner.sh</code>在本地执行，请参考：<a href="http://ovirt-infra-docs.readthedocs.io/en/latest/CI/Using_mock_runner/index.html"><code>mock-runner.sh使用说明</code></a>。</li><li>通过CI系统自动执行构建、测试、部署、发行。</li></ul><blockquote><p>本文不深入讲解STDCI的使用说明，您可直接参考：<a href="http://ovirt-infra-docs.readthedocs.io/en/latest/CI/Build_and_test_standards/index.html">STDCI介绍文档</a></p></blockquote><h2 id="2-DevOps平台"><a href="#2-DevOps平台" class="headerlink" title="2. DevOps平台"></a>2. DevOps平台</h2><h3 id="全局流程图"><a href="#全局流程图" class="headerlink" title="全局流程图"></a>全局流程图</h3><p><img src="http://img.simiam.com/ovirt-devops.png" alt="ovirt-devops全局流程图"></p><blockquote><p>Jenkins持续集成系统有一个核心概念：任务（也称为Job），我们通常所说的搭建Jenkins持续集成环境其实就是创建一系列的任务并指定触发任务执行的条件（事件），在某一指定的事件被Jenkins系统捕获后，它将执行相应的任务，这一过程就是一次集成。</p></blockquote><p>oVirt项目基于Jenkins搭建其CI/CD平台（后面简称DevOps平台），整个DevOps平台由以下几个部分组成：</p><ul><li>基础环境搭建自动化：基于foreman与puppet搭建Jenkins环境，详见项目：<a href="https://github.com/oVirt/infra-puppet">Infra-Puppet</a>。</li><li>Jenkins任务管理自动化：基于JJB（Jenkins Job Builder）实现构建任务管理脚本化、版本化、自动化，让Jenkins管理Jenkins（听上去是不是很神奇）。详见项目：<a href="https://github.com/oVirt/jenkins">oVirt-jenkins</a>。</li><li>自动化持续集成：所有符合STDCI标准的工程都被纳入到以Jenkins环境，包括上面的<code>Infra-Puppet, oVirt-jenkins</code>项目；持续集成主要包括构建、测试、部署、发行四个阶段，其中“部署”主要是指部署测试环境，“发行”是指将生成的RPM等归档文件上传至版本发行系统。</li><li>集成测试套件：这里主要是指OST（Ovirt-System-Test），它提供了一系列的测试套件，包括但不限于基础功能测试套件、性能测试套件等，详见项目：<a href="https://github.com/oVirt/ovirt-system-tests">ovirt-system-test</a>。</li></ul><p>oVirt开源项目下的所有子项目都是符合STDCI标准，所有项目的持续集成任务都是自动化生成的，但任务的触发有多种：</p><ul><li>人工触发（在Jenkins Web UI上操作）</li><li>基于Github的webhook等机制下事件驱动，如push事件，merge事件，pull-request事件。</li><li>定时执行，如每天晚上12点执行。</li></ul><h3 id="2-1-Jenkins-Job管理自动化"><a href="#2-1-Jenkins-Job管理自动化" class="headerlink" title="2.1. Jenkins-Job管理自动化"></a>2.1. Jenkins-Job管理自动化</h3><p>Jenkins-Job管理是指通过UI或JJB的方式在Jenkins上创建、更新、删除任务；而Jenkins-Job管理自动化是指借助JJB自动创建、更新、删除任务，而不需要在Jenkins WebUI上人工操作。</p><blockquote><p>实现原理也相对简单：因为Jenkins-Job定义了一系列持续集成任务，因此也可以再增加一个特殊的任务，这个任务就是JenkinsJobDeploy，一旦该任务被执行，它就会从Jenkins-Job定义Git仓库下载最新的任务定义脚本并更新Jenkins系统上的任务。</p></blockquote><h4 id="2-1-1-Jenkins任务初始化流程"><a href="#2-1-1-Jenkins任务初始化流程" class="headerlink" title="2.1.1. Jenkins任务初始化流程"></a>2.1.1. Jenkins任务初始化流程</h4><p><img src="http://img.simiam.com/jenkins-job-init.png" alt="Jenkins任务初始化流程"></p><h4 id="2-1-2-Jenkins任务管理自动化流程"><a href="#2-1-2-Jenkins任务管理自动化流程" class="headerlink" title="2.1.2. Jenkins任务管理自动化流程"></a>2.1.2. Jenkins任务管理自动化流程</h4><p><img src="http://img.simiam.com/jenkins-job-mgmt.png" alt="Jenkins任务管理自动化流程"></p><h3 id="2-2-ovirt持续集成"><a href="#2-2-ovirt持续集成" class="headerlink" title="2.2. ovirt持续集成"></a>2.2. ovirt持续集成</h3><p>oVirt每个子项目的持续集成流程并无特殊之处，都根据Jenkins上的任务配置步骤依次执行相关脚本：编译、单元测试、构建、部署测试环境、系统测试、发行。</p><p><strong>需要强调的是</strong>：这些持续集成相关的脚本都是通过JJB生成的，且这些脚本最终是由STDCI引擎串联调度完成一次集成过程，而开发人员只需要编写STDCI每个阶段(stage)需要执行的脚本。</p><h3 id="2-3-涉及到技术"><a href="#2-3-涉及到技术" class="headerlink" title="2.3. 涉及到技术"></a>2.3. 涉及到技术</h3><h4 id="2-3-1-Python"><a href="#2-3-1-Python" class="headerlink" title="2.3.1. Python"></a>2.3.1. Python</h4><p>Python是oVirt持续集成方案的主力开发语言，核心的STDCI控制引擎、OST系统测试框架、与ansible相关的自动化部署脚本、Jenkins Job Builder都是用Python编写。</p><h4 id="2-3-2-Groovy"><a href="#2-3-2-Groovy" class="headerlink" title="2.3.2. Groovy"></a>2.3.2. Groovy</h4><p>Groovy是基于JVM的脚本语言，像Gradle这样的构建工具便是用Groovy开发的，它也可以同Java互操作，同时它也经常被用于实现代码自动生成这类功能。而Jenkins持续集成平台则使用Groovy来编写<code>pipeline</code>脚本。</p><h4 id="2-3-3-Foreman"><a href="#2-3-3-Foreman" class="headerlink" title="2.3.3. Foreman"></a>2.3.3. Foreman</h4><p>在介绍Foreman之前，我们先介绍下<code>[Bare Metal Provisioning]</code>这个术语（英语不好，暂且翻译为“裸机供应”）。所谓<code>Bare Metal Provisioning</code>是指为一台服务器（物理机或虚拟机）安装指定的操作系统的过程。通常情况下，有两种办法为服务器安装操作系统：</p><ul><li>使用DVD等存储媒介人工一台一台安装</li><li>使用软件工具自动化的批量安装，<code>Foreman</code>就是这样的软件工具，类似的还有<code>Razor, Cobbler, RackHD</code>。</li></ul><p>当然Foreman除了“裸机供应”能力外，它还有提供了其它服务，如与<code>Puppet, Chef</code>配合实现自动化配置与管理，它还提供了一个可视化的管理平台。更详细的信息还请直接访问<a href="https://www.theforeman.org/">官网</a>。</p><blockquote><p>Foreman是用Ruby语言开发的。</p></blockquote><h4 id="2-3-4-Puppet"><a href="#2-3-4-Puppet" class="headerlink" title="2.3.4. Puppet"></a>2.3.4. Puppet</h4><p><a href="https://puppet.com/">Puppet</a>是开源的系统配置管理工具，基于C/S的部署架构。是一个为实现数据中心自动化管理而设计的配置管理软件，它使用跨平台语言规范，管理配置文件、用户、软件包、系统服务等。Puppet开源项目创建之初主要是为了解决配置管理自动化的相关问题，该项目目前存在两种形态：</p><ul><li>Open Source Puppet：仍然是提供配置管理自动化方案，其通常是与Foreman配合完成数据中心服务器从OS安装到网络配置、应用配置等一系列自动化配置管理操作。</li><li>Puppet Enterprise：收费版本，其不需要借助Foreman等第三方服务就可完成服务器OS安装配置管理，即提供了一站式的解决方案。</li></ul><blockquote><p>Puppet也是用Ruby语言开发的。</p></blockquote><h4 id="2-3-5-Ansiable"><a href="#2-3-5-Ansiable" class="headerlink" title="2.3.5. Ansiable"></a>2.3.5. Ansiable</h4><p><a href="https://www.ansible.com/">Ansilbe</a>是一个部署一群远程主机的工具。远程的主机可以是远程虚拟机或物理机， 也可以是本地主机。</p><blockquote><p>Ansible与Open Source Puppet一样，不具备“裸机供应”能力，其也需要与Foreman或<a href="https://github.com/sergevs/ansible-os-autoinstall">ansible-os-autoinstall</a>等工具配合使用。</p></blockquote><p>Ansible最初是作为自动化工具（如PupPET和Chef）的轻量级替代而开发的；但是它是用Python编写的（而不是Ruby），并且采用了一个基于SSH的无代理的架构（即不是采用Puppet的C/S架构，在被管理节点上不需要安装任何特殊软件）。</p><p>Ansilbe通过SSH协议实现远程节点和管理节点之间的通信，但是SSH必须配置为公钥认证登录方式，而非密码认证。理论上说，只要管理员通过ssh登录到一台远程主机上能做的操作，Ansible都可以做到。包括：</p><ul><li>拷贝文件</li><li>安装软件包</li><li>启动服务</li><li>……</li></ul><p>总得来说，Ansible有如下特点：</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</span><br><span class="line"><span class="number">2</span>、默认使用SSH协议对设备进行管理；</span><br><span class="line"><span class="number">3</span>、有大量常规运维操作模块，可实现日常绝大部分操作。</span><br><span class="line"><span class="number">4</span>、配置简单、功能强大、扩展性强；</span><br><span class="line"><span class="number">5</span>、支持API及自定义模块，可通过Python轻松扩展；</span><br><span class="line"><span class="number">6</span>、通过Playbooks来定制强大的配置、状态管理；</span><br><span class="line"><span class="number">7</span>、轻量级，无需在客户端安装<span class="built_in">agent</span>，更新时，只需在操作机上进行一次更新即可；</span><br><span class="line"><span class="number">8</span>、提供一个功能强大、操作性强的Web管理界面和REST API接口——AWX平台。</span><br></pre></td></tr></table></figure><blockquote><p>Ansible是用Python开发的，它目前已被Redhat收购，是自动化运维工具中认可度最高的。oVirt的很多自动化部署子项目都是用Ansible开发的。</p></blockquote><h4 id="2-3-6-Lago"><a href="#2-3-6-Lago" class="headerlink" title="2.3.6. Lago"></a>2.3.6. Lago</h4><p>Lago是一个虚拟测试环境框架，它可在服务器或普通PC上为各种测试用例构建虚拟环境。oVirt-System-Test项目使用Lago框架来搭建测试环境。具体可参考<a href="http://lago.readthedocs.io/en/stable/">官方文档</a>或<a href="https://github.com/lago-project/lago">Github库</a>。</p><blockquote><p>Lago使用Python开发</p></blockquote><h4 id="2-3-7-JJB"><a href="#2-3-7-JJB" class="headerlink" title="2.3.7. JJB"></a>2.3.7. JJB</h4><p>JJB全称为Jenkins Job Builder，它是由openstack-infra团队开发的，项目地址：<a href="https://github.com/openstack-infra/jenkins-job-builder">Jenkins Job Builder Github</a>，详细信息请直接参考<a href="https://docs.openstack.org/infra/jenkins-job-builder/">文档</a>。</p><blockquote><p>JJB使用Python开发</p></blockquote><h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><p>oVirt的持续集成方案也是目前IaaS开源领域的主流方案，从基础设施、编译构建、测试、部署等几个方面都实现了自动化。其中值得我们借鉴的地方有：</p><ul><li>制定了一套统一的持续集成标准规范，并基于它实现了STDCI引擎：oVirt下的所有子项目都严格遵守该规范</li><li>Jenkins平台上维护的任务管理也实现自动化</li><li>提供了一系列可自动化的系统（集成）测试套件，可以大大提升集成测试、回归测试效率</li></ul><p>为了实现自动化水平，整个方案的涉及的技术栈也比较多，这也带来了一定的学习成本。至少在自动化配置管理方面可以统一使用<code>Ansible</code>。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="http://ovirt-infra-docs.readthedocs.io/en/latest/CI/Build_and_test_standards/index.html">oVirt STDCI文档</a></li><li><a href="http://ovirt-system-tests.readthedocs.io/en/latest/index.html">OST（oVirt System Test）文档</a></li><li><a href="https://docs.openstack.org/infra/jenkins-job-builder/">Jenkins Job Builder文档</a></li><li><a href="https://github.com/openstack-infra/jenkins-job-builder">Jenkins Job Builder源码</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;oVirt持续集成方案分析&quot;&gt;&lt;a href=&quot;#oVirt持续集成方案分析&quot; class=&quot;headerlink&quot; title=&quot;oVirt持续集成方案分析&quot;&gt;&lt;/a&gt;oVirt持续集成方案分析&lt;/h1&gt;&lt;h4 id=&quot;云管理平台组-陈志安&quot;&gt;&lt;a href=&quot;#云管理平台组-陈志安&quot; class=&quot;headerlink&quot; title=&quot;云管理平台组-陈志安&quot;&gt;&lt;/a&gt;云管理平台组-陈志安&lt;/h4&gt;&lt;hr&gt;
&lt;h2 id=&quot;1-STDCI&quot;&gt;&lt;a href=&quot;#1-STDCI&quot; class=&quot;headerlink&quot; title=&quot;1. STDCI&quot;&gt;&lt;/a&gt;1. STDCI&lt;/h2&gt;&lt;p&gt;oVirt项目定义了一套标准规范，通过这套标准，一个源码工程就可以一种通用的方式定义其应该如何被构建、测试、部署与发行，而这个定义规则是独立于开发该源码工程所使用的编程语言及工具，本质上讲它是由oVirt制定的适用于&lt;code&gt;CI/CD(持续集成/持续部署)&lt;/code&gt;的&lt;code&gt;DSL(Domain Specific Language)&lt;/code&gt;，这套规范简称为&lt;code&gt;STDCI&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;CI团队可以基于这套标准创建像&lt;code&gt;mock_runner&lt;/code&gt;这一类通用的构建、测试、部署与发行工具，这些工具以统一的方式来处理所有的ovirt工程。&lt;/p&gt;
&lt;p&gt;oVirt项目的持续集成系统（CI系统）就是使用这套标准以自动化的方式执行该项目下各个工程的构建、测试、部署、发行进程。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;该规范的实现请参考：&lt;a href=&quot;https://github.com/oVirt/jenkins/tree/master/scripts&quot;&gt;&lt;code&gt;https://github.com/oVirt/jenkins/tree/master/scripts&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;1-1-Stage&quot;&gt;&lt;a href=&quot;#1-1-Stage&quot; class=&quot;headerlink&quot; title=&quot;1.1. Stage&quot;&gt;&lt;/a&gt;1.1. Stage&lt;/h3&gt;&lt;p&gt;&lt;code&gt;STDCI&lt;/code&gt;中的一个核心概念是“stage”，State是指作用在变更过的源码上的各种操作，它代表了源码从开发人员初始创建到成为正式发布产品整个生命周期的各个阶段。在每个特定的stage会执行一系列与该stage相关的各种操作（命令），这些操作命令是由每个具体工程定义。&lt;/p&gt;
&lt;p&gt;当前STDCI定义了如下几个常用的stage：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;build-artifacts：该阶段定义了如何从源码构建出用户可使用的归档文件，比如RPM包或Docker镜像之类的文件。&lt;/li&gt;
&lt;li&gt;build-artifacts-manual：该阶段主要定义了如何从tar格式的源码包进行项目构建，一般在人工处理的方式进行正式版本发布时会涉及到该阶段，比较少用。&lt;/li&gt;
&lt;li&gt;check-patch：这个阶段定义了当代码发生变更时如何进行代码质量、功能或回归验证。一般是用户在Github等平台上发起PR请求会触发与该阶段关联的操作。&lt;/li&gt;
&lt;li&gt;check-merged：这个阶段定义了当代码发生变更时如何进行代码质量、功能或回归验证。一般是分支合并操作后会触发与该阶段关联的操作。&lt;/li&gt;
&lt;li&gt;poll-upstream-sources：有时项目会依赖的上游或外部项目或库，该阶段主要定义了上游或外部依赖项目的更新操作。&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="分布式" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
    <category term="ovirt" scheme="http://cloudnoter.com/tags/ovirt/"/>
    
    <category term="engine" scheme="http://cloudnoter.com/tags/engine/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ovirt-engine开发环境搭建指南</title>
    <link href="http://cloudnoter.com/2018/07/10/ovirt-engine%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%8C%87%E5%8D%97/"/>
    <id>http://cloudnoter.com/2018/07/10/ovirt-engine%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%8C%87%E5%8D%97/</id>
    <published>2018-07-10T15:04:48.000Z</published>
    <updated>2018-10-31T03:39:34.857Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ovirt-engine开发环境搭建指南"><a href="#ovirt-engine开发环境搭建指南" class="headerlink" title="ovirt-engine开发环境搭建指南"></a>ovirt-engine开发环境搭建指南</h1><h4 id="云管理平台组-陈志安"><a href="#云管理平台组-陈志安" class="headerlink" title="云管理平台组-陈志安"></a>云管理平台组-陈志安</h4><hr><h1 id="中文"><a href="#中文" class="headerlink" title="中文"></a>中文</h1><hr><blockquote><p>提示：为了能比较顺畅的阅读本文档，您需要具体基本的docker基础知识及常用命令的使用。如果您尚未听说过docker，则请先通过<a href="https://docs.docker.com/">docker官方文档</a>学习必要的知识。</p></blockquote><h2 id="重要说明：在windwos下存在以下需要注意的细节"><a href="#重要说明：在windwos下存在以下需要注意的细节" class="headerlink" title="重要说明：在windwos下存在以下需要注意的细节"></a>重要说明：在windwos下存在以下需要注意的细节</h2><ul><li>在docker中创建的一些特殊文件，在外部主机上无法马上删除，需要重启外部主机，详见<a href="https://forums.docker.com/t/how-to-delete-files-on-host-created-by-container/20830/3">这里</a></li><li>如果将docker中的目录通过<code>volumn</code>参数映射至windows本地目录时，docker中的链接文件在windows的文件系统下是无法生效的，详见<a href="https://github.com/docker/for-win/issues/109">这里</a></li></ul><h1 id="1-快速入门"><a href="#1-快速入门" class="headerlink" title="1. 快速入门"></a>1. 快速入门</h1><p>制作本镜像的主要目的：快速创建并启动一个近似于本地的ovirt-engine容器，它可以为有需要的开发人员（特别是基于windows平台）提供近似于本地的开发、测试、调试环境。</p><h2 id="1-1-先决条件"><a href="#1-1-先决条件" class="headerlink" title="1.1. 先决条件"></a>1.1. 先决条件</h2><ul><li>安装Docker运行环境，docker分企业版与社区版，我们只需要社区版即可，具体可参考<a href="https://docs.docker.com/install/linux/docker-ce/centos/">Docker官网文档</a>。</li></ul><blockquote><p>由于Windwos系统的特殊性，建议在Windows-10专业版或企业版（64位）系统上安装<a href="https://docs.docker.com/docker-for-windows/install/">Docker for windows</a>（直接基于Windows Hyper-V）;<br>而之前的Windows版本则需要使用<a href="https://docs.docker.com/toolbox/toolbox_install_windows/">Docker Toolbox on Windows</a>（需要借助Oracle Virtual Box）。</p></blockquote><p><strong>在Windwos上激活Hyper-V意味着无法同时运行Virtual Box与VMWare workstation等其他虚拟化平台</strong></p><h2 id="1-2-构建ovirt-engine镜像"><a href="#1-2-构建ovirt-engine镜像" class="headerlink" title="1.2. 构建ovirt-engine镜像"></a>1.2. 构建ovirt-engine镜像</h2><blockquote><p>如果您想自己定制一个新镜像，您才需要使用本节介绍的内容。正常情况下，您可以忽略本节内容。</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 假设工作目录为：~<span class="regexp">/workspace/</span>Dockerfiles，要创建的镜像名为：simiam/ovirt-engine-dev</span><br><span class="line">cd ~<span class="regexp">/workspace/</span>Dockerfiles/ovirt-engine</span><br><span class="line">docker build -t simiam<span class="regexp">/ovirt-engine-dev ./</span>latest</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="1-3-创建ovirt-engine-dev容器"><a href="#1-3-创建ovirt-engine-dev容器" class="headerlink" title="1.3. 创建ovirt-engine-dev容器"></a>1.3. 创建ovirt-engine-dev容器</h2><blockquote><p>想快速搭建一个ovirt-engine开发调试环境的话，从这一节开始看起。</p></blockquote><p>基于<code>simiam/ovirt-engine-dev</code>镜像创建一个名为<code>ovirt-engine-dev</code>的容器，容器的主机名为<code>ovirt-engine-dev</code>。</p><ul><li>删除容器：如果之前有创建过同名的容器，则需要先停止并删除容器</li></ul><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="meta">Stop</span> <span class="meta">and</span> <span class="meta">remove</span> <span class="string">&#x27;ovirt-engine-dev&#x27;</span> docker container <span class="meta">IF</span> necessary.</span><br><span class="line">docker <span class="meta">stop</span> ovirt-engine-dev <span class="variable">&amp;&amp;</span> docker rm ovirt-engine-dev</span><br></pre></td></tr></table></figure><ul><li>创建容器：当前提供的母镜像要求容器的主机名必需为：<code>ovirt-engine-dev</code>，后续会提供可配置的环境变量</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 以下命令的&#x27;\&#x27;符号只在linux或macos环境下生效，windows下需要遵循相应bat脚本语法，如果不懂建议写成一行</span></span><br><span class="line"><span class="comment"># 2. 与路径有关的参数值不能包含空格</span></span><br><span class="line">docker run -d -i -t --name ovirt-engine-dev -h ovirt-engine-dev --privileged \</span><br><span class="line">-v <span class="regexp">/env/</span>.m2<span class="regexp">/:/</span>env<span class="regexp">/.m2 -v ~/</span>env<span class="regexp">/ovirt-engine:/</span>env<span class="regexp">/workspace -v /</span>env<span class="regexp">/ovirt-engine-deploy:/</span>env/deploy \</span><br><span class="line">-p <span class="number">10022</span>:<span class="number">22</span> -p <span class="number">5432</span>:<span class="number">5432</span> -p <span class="number">8080</span>:<span class="number">8080</span> -p <span class="number">8787</span>:<span class="number">8787</span> -p <span class="number">8443</span>:<span class="number">8443</span> /</span><br><span class="line">simiam<span class="regexp">/ovirt-engine-dev /u</span>sr<span class="regexp">/sbin/i</span>nit</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>再次强调一下：</p><blockquote><p>在windows环境下，不能将/env/deploy目录映射至windows本地，即不需要<code>-v /env/ovirt-engine-deploy:/env/deploy</code>这一部分。</p></blockquote><p>参数详细说明如下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker run -d -i -t        <span class="comment"># 通用参数，参考官网</span></span><br><span class="line">--name ovirt-engine-dev    <span class="comment"># 容器名</span></span><br><span class="line">-h ovirt-engine-dev        <span class="comment"># 容器中OS系统的hostname，如果使用默认的部署环境，则主机名必须为:ovirt-engine-dev</span></span><br><span class="line">--privileged               <span class="comment"># 配合/usr/sbin/init参数，以开启特权模式（使systemctl可用）</span></span><br><span class="line">-v <span class="regexp">/env/</span>.m2<span class="regexp">/:/</span>env/.m2      <span class="comment"># maven本地仓库映射关系</span></span><br><span class="line">-v ~<span class="regexp">/env/</span>ovirt-engine:<span class="regexp">/env/</span>workspace       <span class="comment"># 源码工程根目录映射关系，前者代表宿主机目录，即本地目录（下同）</span></span><br><span class="line">-v <span class="regexp">/env/</span>ovirt-engine-deploy:<span class="regexp">/env/</span>deploy    <span class="comment"># 打包部署根目录映射关系 --------》》》》在windows环境下，不能将/env/deploy目录映射至windows本地</span></span><br><span class="line">-p <span class="number">10022</span>:<span class="number">22</span>                <span class="comment"># SSH端口映射关系，10022为宿主机端口</span></span><br><span class="line">-p <span class="number">5432</span>:<span class="number">5432</span>               <span class="comment"># Postgres数据库端口映射关系 </span></span><br><span class="line">-p <span class="number">8080</span>:<span class="number">8080</span>               <span class="comment"># ovirt-engine webadmin HTTP服务端口映射关系</span></span><br><span class="line">-p <span class="number">8787</span>:<span class="number">8787</span>               <span class="comment"># 远程调试端口映射关系 </span></span><br><span class="line">-p <span class="number">8443</span>:<span class="number">8443</span>               <span class="comment"># ovirt-engine webadmin HTTPS服务端口映射关系（目录不可用）</span></span><br><span class="line">simiam/ovirt-engine-dev    <span class="comment"># 镜像名</span></span><br><span class="line"><span class="regexp">/usr/</span>sbin/init             <span class="comment"># 容器启动时需要执行命令，与privileged配合使用</span></span><br></pre></td></tr></table></figure><ul><li>端口映射相关信息</li></ul><table><thead><tr><th>服务名</th><th>容器内部端口</th><th>宿主机端口</th></tr></thead><tbody><tr><td>SSH</td><td>22</td><td>10022</td></tr><tr><td>Postgresql</td><td>5432</td><td>5432</td></tr><tr><td>HTTP</td><td>8080</td><td>8080</td></tr><tr><td>HTTPS</td><td>8443</td><td>8443</td></tr><tr><td>远程调试</td><td>8787</td><td>8787</td></tr></tbody></table><blockquote><p>容器内部端口目前是固定的，不支持根据环境变量来动态配置；宿主机端口则可根据个人喜好来配置。</p></blockquote><h2 id="1-4-ovirt-engine-dev容器生命周期管理"><a href="#1-4-ovirt-engine-dev容器生命周期管理" class="headerlink" title="1.4. ovirt-engine-dev容器生命周期管理"></a>1.4. ovirt-engine-dev容器生命周期管理</h2><ul><li>停止容器：<code>docker stop ovirt-engine-dev</code></li><li>启动容器：<code>docker start ovirt-engine-dev</code></li><li>重启容器：<code>docker restart ovirt-engine-dev</code></li></ul><h2 id="1-5-启动容器中的ovirt-engine服务"><a href="#1-5-启动容器中的ovirt-engine服务" class="headerlink" title="1.5. 启动容器中的ovirt-engine服务"></a>1.5. 启动容器中的ovirt-engine服务</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it -u ssh_ovirt ovirt-engine-dev <span class="regexp">/env/</span>start-engine-service.sh</span><br></pre></td></tr></table></figure><h2 id="1-6-使用ovirt-engine"><a href="#1-6-使用ovirt-engine" class="headerlink" title="1.6. 使用ovirt-engine"></a>1.6. 使用ovirt-engine</h2><h5 id="容器操作系统用户与密码："><a href="#容器操作系统用户与密码：" class="headerlink" title="容器操作系统用户与密码："></a>容器操作系统用户与密码：</h5><ul><li>root:engine</li><li>ssh_ovirt:ssh_ovirt</li></ul><h5 id="Postgresql数据库相关信息"><a href="#Postgresql数据库相关信息" class="headerlink" title="Postgresql数据库相关信息"></a>Postgresql数据库相关信息</h5><ul><li>数据库名：engine</li><li>数据库端口：5432</li><li>engine用户的密码：engine</li><li>postgres用户的密码：postgres</li></ul><h5 id="访问地址虚拟化管理平台系统：http-localhost-8080，用户名密码：admin-engine"><a href="#访问地址虚拟化管理平台系统：http-localhost-8080，用户名密码：admin-engine" class="headerlink" title="访问地址虚拟化管理平台系统：http://localhost:8080，用户名密码：admin/engine"></a>访问地址虚拟化管理平台系统：<a href="http://localhost:8080，用户名密码：admin/engine">http://localhost:8080，用户名密码：admin/engine</a></h5><h5 id="登录ovirt-engine所在的OS，有2种方式"><a href="#登录ovirt-engine所在的OS，有2种方式" class="headerlink" title="登录ovirt-engine所在的OS，有2种方式"></a>登录ovirt-engine所在的OS，有2种方式</h5><ul><li>使用SSH：<code>ssh -p &lt;映射端口号&gt; ssh_ovirt@localhost</code>，其中映射端口号为1.3节创建容器实例命令<code>docker run ...</code>中与容器内<code>22</code>号端口映射的<code>宿主机</code>端口号，如示例中的<code>10022</code>；SSH用户<code>ssh_ovirt</code>的密码：<code>ssh_ovirt</code>，<code>root</code>用户的密码：<code>engine</code>。 – <strong>推荐</strong></li><li>使用docker命令：<code>docker exec -it &lt;容器名&gt; /bin/bash</code></li></ul><h2 id="1-7-ovirt-engine部署目录介绍"><a href="#1-7-ovirt-engine部署目录介绍" class="headerlink" title="1.7. ovirt-engine部署目录介绍"></a>1.7. ovirt-engine部署目录介绍</h2><p>ovirt-engine平台部署在wildfly(jboss)服务器上，但其并不是采用wildfly官方所描述的标准部署方式及部署结构，其使用一套自己的部署目录结构，如下：</p><p><img src="http://img.simiam.com/engine-deploy-dir-tree.png" alt="Dir-Tree"></p><p>这些目录与<code>wildfly</code>环境的关联关系</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-Djboss.home.dir=<span class="regexp">/usr/</span>share/ovirt-engine-wildfly </span><br><span class="line">-Djboss.server.base.dir=<span class="regexp">/env/</span>ovirt-engine-deploy<span class="regexp">/share/</span>ovirt-engine </span><br><span class="line">-Djboss.server.data.dir=<span class="regexp">/env/</span>ovirt-engine-deploy<span class="regexp">/var/</span>lib/ovirt-engine </span><br><span class="line">-Djboss.server.log.dir=<span class="regexp">/env/</span>ovirt-engine-deploy<span class="regexp">/var/</span>log/ovirt-engine </span><br><span class="line">-Djboss.server.config.dir=<span class="regexp">/env/</span>ovirt-engine-deploy<span class="regexp">/var/</span>lib<span class="regexp">/ovirt-engine/</span>jboss_runtime/config </span><br><span class="line">-Djboss.server.temp.dir=<span class="regexp">/env/</span>ovirt-engine-deploy<span class="regexp">/var/</span>lib<span class="regexp">/ovirt-engine/</span>jboss_runtime/tmp </span><br><span class="line">-Djboss.controller.temp.dir=<span class="regexp">/env/</span>ovirt-engine-deploy<span class="regexp">/var/</span>lib<span class="regexp">/ovirt-engine/</span>jboss_runtime/tmp</span><br></pre></td></tr></table></figure><h1 id="2-ovirt-engine本地开发调试环境搭建"><a href="#2-ovirt-engine本地开发调试环境搭建" class="headerlink" title="2. ovirt-engine本地开发调试环境搭建"></a>2. ovirt-engine本地开发调试环境搭建</h1><blockquote><p>工作目录统一用<code>$WORK_DIR</code>表示</p></blockquote><p>经过第1章节的介绍，相信您已经可以在本地使用ovirt-engine平台。本章节将介绍如何基于ovirt-engine容器进行本地开发与调试。</p><p>从零开始搭建ovirt-engine环境到部署成功（可以访问web）共包括4个步骤：编译 -&gt; 打包(部署) -&gt; 初始化 -&gt; 启动，各个步骤使用的命令如下：</p><ul><li>编译 + 打包(部署)：在源码根目录下执行<code>make clean install-dev PREFIX=/env/deploy BUILD_UT=0 DEV_EXTRA_BUILD_FLAGS=&quot;-Dgwt.compiler.localWorkers=1 -Djava.net.preferIPv4Stack=true&quot;</code>，就可以生成类似1.7节介绍的部署目录结构及相关内容。</li><li>初始化：<code>/env/deploy/bin/engine-setup</code>，初始化内容主要是配置ovirt-engine系统主要参数，执行数据库创建脚本等</li><li>启动：<code>/env/deploy/share/ovirt-engine/services/ovirt-engine/ovirt-engine.py start</code>，该命令是用来启动<code>wildfly(jboss)</code>服务器，从而启动ovirt-engine管理平台。</li></ul><p><strong>注意：以上三个命令都需要在docker容器内执行。</strong><br>其中，编译webadmin阶段会消耗大量内存，建议宿主机内存至少为8G（推荐12G）。</p><h2 id="2-1-准备源码及开发环境"><a href="#2-1-准备源码及开发环境" class="headerlink" title="2.1. 准备源码及开发环境"></a>2.1. 准备源码及开发环境</h2><ul><li>从ovirt-engine的github源码仓库获取一份源码至本地工作目录：<code>git clone https://github.com/ovirt/ovirt-engine.git</code></li><li>使用您熟悉的IDE将ovirt-engine项目导入您的IDE中</li></ul><h2 id="2-2-ovirt-engine源码构建"><a href="#2-2-ovirt-engine源码构建" class="headerlink" title="2.2. ovirt-engine源码构建"></a>2.2. ovirt-engine源码构建</h2><ul><li>ovirt-engine项目核心源码使用maven作为构建工具，因此可以使用<code>mvn clean install</code>构建出相应的war，ear等部署文件。</li></ul><blockquote><p>这一步是我们日常开发过程中经常使用到的：<br>一般情况下我们需要将生成的相关部署文件通过jboss-cli或jboss-web重新部署，或直接将变更文件覆盖部署目录下的相应文件并重启服务。</p></blockquote><h2 id="2-3-ovirt-engine打包-部署"><a href="#2-3-ovirt-engine打包-部署" class="headerlink" title="2.3. ovirt-engine打包(部署)"></a>2.3. ovirt-engine打包(部署)</h2><p>在2.2节中使用的<code>mvn clean install</code>只能在工程的<code>target</code>目录下产生相关的jar，war,ear等文件，并不会生成目录结构及其下的相关内容。</p><p>为了完成部署需要在docker环境下使用<code>make install-dev ...</code>命令进行一次完整的构建、部署。</p><p>因为这一步耗时比较长，因为基于<code>simiam/ovirt-engine-dev</code>镜像创建的容器已经事先替您执行了一次打包部署，所以一般情况下您不需要执行这一步操作，除非发生了以下几种情况：</p><ul><li>打包、部署、安装相关的代码变更</li><li>您想定制ovirt-engine：修改部署根目录、修改默认的环境变更等</li></ul><p>如果没有出现诸如文件结构变更或数据库表结构等元数据变更的情况，就没有必要重新部署。只需要重新执行<code>make install-dev &lt;args&gt;</code>命令进行文件刷新（覆盖）即可。<br>如果数据库表结构等发生的变更，则需要重新执行<code>engine-setup</code>命令以更新数据库表结构。</p><p>为了避免一些莫名其妙的问题，在进行重新部署时（代码有重大变更）需要删除<code>$&#123;PREFIX&#125;</code>所代表的目录，然后再构建、安装部署。</p><p><code>$&#123;PREFIX&#125;/bin/engine-cleanup</code>也是一个不错的环境清理工具。当部署目录的内容变更量比较少的时候，可以使用这个工具进行环境清理。</p><blockquote><p>切记：以上操作均需要停止服务，再操作，最后重启engine服务</p></blockquote><h2 id="2-4-ovirt-engine初始化"><a href="#2-4-ovirt-engine初始化" class="headerlink" title="2.4. ovirt-engine初始化"></a>2.4. ovirt-engine初始化</h2><p>初始化内容主要是配置ovirt-engine系统主要参数，执行数据库创建脚本等。因此如果你想重新构建数据库、修改配置参数等，则可以执行初始化命令。</p><h1 id="3-其它"><a href="#3-其它" class="headerlink" title="3. 其它"></a>3. 其它</h1><h2 id="3-1-ovirt-engine容器创建参数介绍"><a href="#3-1-ovirt-engine容器创建参数介绍" class="headerlink" title="3.1. ovirt-engine容器创建参数介绍"></a>3.1. ovirt-engine容器创建参数介绍</h2><p>本节将详细介绍创建一个ovirt-engine容器实例所指定的各参数。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -i -t        <span class="comment"># 通用参数，参考官网</span></span><br><span class="line">--name ovirt-engine-dev    <span class="comment"># 容器名</span></span><br><span class="line">-h ovirt-engine-dev        <span class="comment"># 容器中OS系统的hostname，如果使用默认的部署环境，则主机名必须为:ovirt-engine-dev</span></span><br><span class="line">--privileged               <span class="comment"># 配合/usr/sbin/init参数，以开启特权模式（使systemctl可用）</span></span><br><span class="line">-v <span class="regexp">/env/</span>.m2<span class="regexp">/:/</span>env/.m2      <span class="comment"># maven本地仓库映射关系</span></span><br><span class="line">-v ~<span class="regexp">/env/</span>ovirt-engine:<span class="regexp">/env/</span>workspace       <span class="comment"># 源码工程根目录映射关系，前者代表宿主机目录，即本地目录（下同）</span></span><br><span class="line">-v <span class="regexp">/env/</span>ovirt-engine-deploy:<span class="regexp">/env/</span>deploy    <span class="comment"># 打包部署根目录映射关系</span></span><br><span class="line">-p <span class="number">10022</span>:<span class="number">22</span>                <span class="comment"># SSH端口映射关系，10022为宿主机端口</span></span><br><span class="line">-p <span class="number">5432</span>:<span class="number">5432</span>               <span class="comment"># Postgres数据库端口映射关系 </span></span><br><span class="line">-p <span class="number">8080</span>:<span class="number">8080</span>               <span class="comment"># ovirt-engine webadmin HTTP服务端口映射关系</span></span><br><span class="line">-p <span class="number">8787</span>:<span class="number">8787</span>               <span class="comment"># 远程调试端口映射关系 </span></span><br><span class="line">-p <span class="number">8443</span>:<span class="number">8443</span>               <span class="comment"># ovirt-engine webadmin HTTPS服务端口映射关系（目录不可用）</span></span><br><span class="line">simiam/ovirt-engine-dev    <span class="comment"># 镜像名</span></span><br><span class="line"><span class="regexp">/usr/</span>sbin/init             <span class="comment"># 容器启动时需要执行命令，与privileged配合使用</span></span><br></pre></td></tr></table></figure><h2 id="3-2-可用的快捷脚本模板"><a href="#3-2-可用的快捷脚本模板" class="headerlink" title="3.2. 可用的快捷脚本模板"></a>3.2. 可用的快捷脚本模板</h2><ul><li>init-engine-environment.sh  –&gt; 使用默认的部署版本创建名为ovirt-engine-dev容器</li><li>start-engine-service.sh  –&gt; 启动ovirt-engine服务</li></ul><h2 id="3-3-远程调试"><a href="#3-3-远程调试" class="headerlink" title="3.3. 远程调试"></a>3.3. 远程调试</h2><p>如果您使用默认提供的部署环境，则可以容器已开放了<code>8787</code>远程调试端口，您通过宿主机的映射端口便可进行远程调试。</p><hr><h1 id="English"><a href="#English" class="headerlink" title="English"></a>English</h1><hr><h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>Just install the Docker CE that fit for your OS.</p><blockquote><p>In order install <a href="https://docs.docker.com/docker-for-windows/install/">Docker for windows</a>（Based Windows Hyper-V）, it requires Microsoft Windows 10 Professional or Enterprise 64-bit.<br>For previous versions get <a href="https://docs.docker.com/toolbox/toolbox_install_windows/">Docker Toolbox on Windows</a>（Based Oracle Virtual Box）.</p></blockquote><h2 id="Build-docker-ovirt-engine"><a href="#Build-docker-ovirt-engine" class="headerlink" title="Build docker-ovirt-engine"></a>Build docker-ovirt-engine</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &lt;repository_root_dir&gt;</span><br><span class="line">docker build -t simiam<span class="regexp">/ovirt-engine-dev ./</span>latest</span><br></pre></td></tr></table></figure><h2 id="Create-ovirt-engine-dev-docker-container"><a href="#Create-ovirt-engine-dev-docker-container" class="headerlink" title="Create ovirt-engine-dev docker container"></a>Create ovirt-engine-dev docker container</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Stop and remove &#x27;ovirt-engine-dev&#x27; docker container IF necessary.</span></span><br><span class="line">docker stop ovirt-engine-dev &amp;&amp; docker rm ovirt-engine-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># The container&#x27;s hostname MUST BE &#x27;ovirt-engine-dev&#x27;</span></span><br><span class="line">docker run -d -i -t --name ovirt-engine-dev -h ovirt-engine-dev --privileged \</span><br><span class="line">-v <span class="regexp">/env/</span>.m2<span class="regexp">/:/</span>env<span class="regexp">/.m2 -v ~/</span>workspace<span class="regexp">/cloudos/</span>ovirt<span class="regexp">/ovirt-engine:/</span>env<span class="regexp">/workspace -v /</span>env<span class="regexp">/ovirt-engine-deploy:/</span>env/deploy \</span><br><span class="line">-p <span class="number">10022</span>:<span class="number">22</span> -p <span class="number">5432</span>:<span class="number">5432</span> -p <span class="number">8080</span>:<span class="number">8080</span> -p <span class="number">8787</span>:<span class="number">8787</span> -p <span class="number">8443</span>:<span class="number">8443</span> /</span><br><span class="line">simiam<span class="regexp">/ovirt-engine-dev /u</span>sr<span class="regexp">/sbin/i</span>nit</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Startup-exist-‘ovirt-engine-dev’-docker-container-and-ovirt-engine-service"><a href="#Startup-exist-‘ovirt-engine-dev’-docker-container-and-ovirt-engine-service" class="headerlink" title="Startup exist ‘ovirt-engine-dev’ docker container and ovirt-engine service"></a>Startup exist ‘ovirt-engine-dev’ docker container and ovirt-engine service</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">start</span> ovirt-engine-dev</span><br><span class="line"></span><br><span class="line">docker exec -<span class="keyword">it</span> -u ssh_ovirt ovirt-engine-dev /env/<span class="built_in">start</span>-engine-service.sh</span><br></pre></td></tr></table></figure><h2 id="Default-user-informations"><a href="#Default-user-informations" class="headerlink" title="Default user informations"></a>Default user informations</h2><ul><li>ovirt-engine-webadmin: admin/engine</li><li>local-postgresql-db-port-user-password: engine-5432-engine-engine</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ovirt-engine开发环境搭建指南&quot;&gt;&lt;a href=&quot;#ovirt-engine开发环境搭建指南&quot; class=&quot;headerlink&quot; title=&quot;ovirt-engine开发环境搭建指南&quot;&gt;&lt;/a&gt;ovirt-engine开发环境搭建指南&lt;/h1&gt;&lt;h4 id=&quot;云管理平台组-陈志安&quot;&gt;&lt;a href=&quot;#云管理平台组-陈志安&quot; class=&quot;headerlink&quot; title=&quot;云管理平台组-陈志安&quot;&gt;&lt;/a&gt;云管理平台组-陈志安&lt;/h4&gt;&lt;hr&gt;
&lt;h1 id=&quot;中文&quot;&gt;&lt;a href=&quot;#中文&quot; class=&quot;headerlink&quot; title=&quot;中文&quot;&gt;&lt;/a&gt;中文&lt;/h1&gt;&lt;hr&gt;
&lt;blockquote&gt;
&lt;p&gt;提示：为了能比较顺畅的阅读本文档，您需要具体基本的docker基础知识及常用命令的使用。如果您尚未听说过docker，则请先通过&lt;a href=&quot;https://docs.docker.com/&quot;&gt;docker官方文档&lt;/a&gt;学习必要的知识。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;重要说明：在windwos下存在以下需要注意的细节&quot;&gt;&lt;a href=&quot;#重要说明：在windwos下存在以下需要注意的细节&quot; class=&quot;headerlink&quot; title=&quot;重要说明：在windwos下存在以下需要注意的细节&quot;&gt;&lt;/a&gt;重要说明：在windwos下存在以下需要注意的细节&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;在docker中创建的一些特殊文件，在外部主机上无法马上删除，需要重启外部主机，详见&lt;a href=&quot;https://forums.docker.com/t/how-to-delete-files-on-host-created-by-container/20830/3&quot;&gt;这里&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如果将docker中的目录通过&lt;code&gt;volumn&lt;/code&gt;参数映射至windows本地目录时，docker中的链接文件在windows的文件系统下是无法生效的，详见&lt;a href=&quot;https://github.com/docker/for-win/issues/109&quot;&gt;这里&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;1-快速入门&quot;&gt;&lt;a href=&quot;#1-快速入门&quot; class=&quot;headerlink&quot; title=&quot;1. 快速入门&quot;&gt;&lt;/a&gt;1. 快速入门&lt;/h1&gt;&lt;p&gt;制作本镜像的主要目的：快速创建并启动一个近似于本地的ovirt-engine容器，它可以为有需要的开发人员（特别是基于windows平台）提供近似于本地的开发、测试、调试环境。&lt;/p&gt;
&lt;h2 id=&quot;1-1-先决条件&quot;&gt;&lt;a href=&quot;#1-1-先决条件&quot; class=&quot;headerlink&quot; title=&quot;1.1. 先决条件&quot;&gt;&lt;/a&gt;1.1. 先决条件&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;安装Docker运行环境，docker分企业版与社区版，我们只需要社区版即可，具体可参考&lt;a href=&quot;https://docs.docker.com/install/linux/docker-ce/centos/&quot;&gt;Docker官网文档&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;由于Windwos系统的特殊性，建议在Windows-10专业版或企业版（64位）系统上安装&lt;a href=&quot;https://docs.docker.com/docker-for-windows/install/&quot;&gt;Docker for windows&lt;/a&gt;（直接基于Windows Hyper-V）;&lt;br&gt;而之前的Windows版本则需要使用&lt;a href=&quot;https://docs.docker.com/toolbox/toolbox_install_windows/&quot;&gt;Docker Toolbox on Windows&lt;/a&gt;（需要借助Oracle Virtual Box）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;在Windwos上激活Hyper-V意味着无法同时运行Virtual Box与VMWare workstation等其他虚拟化平台&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-2-构建ovirt-engine镜像&quot;&gt;&lt;a href=&quot;#1-2-构建ovirt-engine镜像&quot; class=&quot;headerlink&quot; title=&quot;1.2. 构建ovirt-engine镜像&quot;&gt;&lt;/a&gt;1.2. 构建ovirt-engine镜像&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;如果您想自己定制一个新镜像，您才需要使用本节介绍的内容。正常情况下，您可以忽略本节内容。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 假设工作目录为：~&lt;span class=&quot;regexp&quot;&gt;/workspace/&lt;/span&gt;Dockerfiles，要创建的镜像名为：simiam/ovirt-engine-dev&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cd ~&lt;span class=&quot;regexp&quot;&gt;/workspace/&lt;/span&gt;Dockerfiles/ovirt-engine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker build -t simiam&lt;span class=&quot;regexp&quot;&gt;/ovirt-engine-dev ./&lt;/span&gt;latest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="分布式" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
    <category term="ovirt" scheme="http://cloudnoter.com/tags/ovirt/"/>
    
    <category term="engine" scheme="http://cloudnoter.com/tags/engine/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ovirt-engine水平扩展可行性分析</title>
    <link href="http://cloudnoter.com/2018/06/04/ovirt-engine%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%E5%8F%AF%E8%A1%8C%E6%80%A7%E5%88%86%E6%9E%90/"/>
    <id>http://cloudnoter.com/2018/06/04/ovirt-engine%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%E5%8F%AF%E8%A1%8C%E6%80%A7%E5%88%86%E6%9E%90/</id>
    <published>2018-06-03T22:44:40.000Z</published>
    <updated>2018-06-03T14:49:48.307Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-基础概念"><a href="#1-基础概念" class="headerlink" title="1. 基础概念"></a>1. 基础概念</h2><p>本文先简单介绍下与分布式系统相关的几个概念。</p><h3 id="1-1-分布式锁"><a href="#1-1-分布式锁" class="headerlink" title="1.1. 分布式锁"></a>1.1. 分布式锁</h3><p>所谓分布式锁是指在一个分布式集群中，同一个方法在同一时间只能被一台机器上的一个线程执行，也就是所谓的分布式互斥。就像单机系统上的多线程程序需要用操作系统锁或数据库锁来互斥对共享资源的访问一样，分布式程序也需要通过分布式锁来互斥对共享资源的访问。分布式锁是保障数据一致性的手段之一。<br>一般情况下，我们可以使用数据库、Redis或者ZooKeeper来做分布式锁服务。不管怎么样，分布式的锁服务需要有以下几个特点：<br>1）安全性：在任意时刻，只有一个客户端可以获得锁（排他性）<br>2）避免死锁：客户端最终一定可以获得锁，即使锁住某个资源的客户端在释放锁之前崩溃或网络不可达<br>3）容错性：只要锁服务集群中的大部分节点存活，客户端就可以进行加锁解锁的操作</p><p>即分布式锁服务在实现上一般关注如下三个问题：<br>1）锁获取机制：超时释放导致多方获取同一把锁问题（CAS机制）<br>2）锁释放机制：正常释放、超时释放<br>3）客户端如何知道锁被释放：客户端不断重试、服务端主动通知</p><h3 id="1-2-数据一致性"><a href="#1-2-数据一致性" class="headerlink" title="1.2. 数据一致性"></a>1.2. 数据一致性</h3><p>说起数据一致性，简单说有三种类型：<br>1）Weak（弱一致性）：当你写入一个新值后，读操作在数据副本上可能读出来，也可能读不出来。比如：某些cache系统，网络游戏其它玩家的数据和你没什么关系。<br>2）Eventually（最终一致性）：当你写入一个新值后，有可能读不出来，但在某个时间窗口之后保证最终能读出来。比如：DNS，电子邮件、Amazon S3，Google搜索引擎这样的系统。<br>3）Strong（强一致性）：新的数据一旦写入，在任意副本任意时刻都能读到新值。比如：文件系统，RDBMS，Azure Table都是强一致性的。</p><p>从这三种一致型的模型上来说，我们可以看到，Weak和Eventually一般来说是异步冗余的，而Strong一般来说是同步冗余的，异步的通常意味着更好的性能，但也意味着更复杂的状态控制。同步意味着简单，但也意味着性能下降。</p><span id="more"></span><h3 id="1-3-分布式事务与数据一致性"><a href="#1-3-分布式事务与数据一致性" class="headerlink" title="1.3. 分布式事务与数据一致性"></a>1.3. 分布式事务与数据一致性</h3><blockquote><p>单纯讲理论比较枯燥，本节我们会结合例子来描述。</p></blockquote><p>让我们用最经典的Use Case：“A帐号向B帐号汇钱”来说明一下，熟悉RDBMS事务的都知道从帐号A到帐号B需要6个操作：</p><p>1）从A帐号中把余额读出来。<br>2）对A帐号做减法操作。<br>3）把结果写回A帐号中。<br>4）从B帐号中把余额读出来。<br>5）对B帐号做加法操作。<br>6）把结果写回B帐号中。</p><p>为了数据的一致性，这6件事，要么都成功做完，要么都不成功，而且这个操作的过程中，对A、B帐号的其它访问必需锁死，所谓锁死就是要排除其它的读写操作，不然会有脏数据的问题，这就是分布式事务。</p><p>目前业界用于实现分布式事务的方案有：<br>1）2PC（两阶段提交）：可以数据强一致性，但存在性能问题、协调过程中TimeOut问题（协调者可用性问题）<br>2）3PC（三阶段提交）：其核心理念是：在询问的时候并不锁定资源，除非所有人都同意了，才开始锁资源。<br>3）事务补偿机制：并行处理一个事务的多个阶段，然后根据不同阶段的执行结果进行相应的业务调整（也称事务补偿），其通常是基于工作流引擎来实现，只保证数据最终一致性，可实现高性能。如电商的秒杀功能经常这么设计：下单成功与订单确认机制。</p><blockquote><p>可进一步学习数据库事务ACID属性的变种：BASE（Basic Availability 基本可用，Soft state 软状态，Eventual Consistency 最终一致性）以及基于BASE的事务补偿。</p></blockquote><h4 id="扩展阅读（加深理解）"><a href="#扩展阅读（加深理解）" class="headerlink" title="扩展阅读（加深理解）"></a>扩展阅读（加深理解）</h4><p>当我们在生产线上用一台服务器来提供数据服务的时候，会遇到如下的两个问题：<br>1）一台服务器的性能不足以提供足够的能力服务于所有的网络请求。<br>2）我们总是害怕我们的这台服务器停机，造成服务不可用或是数据丢失。</p><p>于是我们不得不对我们的服务器进行扩展，加入更多的机器来分担性能上的问题，以及来解决单点故障问题。 通常，我们会通过两种手段来扩展我们的数据服务：<br>1）数据分区：就是把数据分块放在不同的服务器上。<br>2）数据镜像：让所有的服务器都有相同的数据，提供相当的服务。</p><p>对于第一种情况，我们无法解决数据丢失的问题，单台服务器出问题时，会有部分数据丢失。所以，数据服务的高可用性只能通过第二种方法来完成——数据的冗余存储（一般工业界认为比较安全的备份数应该是3份）。 但是，加入更多的机器，会让我们的数据服务变得很复杂，尤其是跨服务器的事务处理，也就是跨服务器的数据一致性。这个是一个很难的问题。 </p><p>那么，我们在加入了更多的机器后，这个事情会变得复杂起来：<br>1）在<strong>数据分区</strong>的方案中：如果A帐号和B帐号的数据不在同一台服务器上怎么办？我们需要一个跨机器的事务处理。也就是说，如果A的扣钱成功了，但B的加钱不成功，我们还要把A的操作给回滚回去。<br>2）在<strong>数据镜像</strong>的方案中：A帐号和B帐号间的汇款是可以在一台机器上完成的，但是别忘了我们有多台机器存在A帐号和B帐号的副本。如果对A帐号的汇钱有两个并发操作（要汇给B和C），这两个操作发生在不同的两台服务器上怎么办？也就是说，在数据镜像中，在不同的服务器上对同一个数据的写操作怎么保证其一致性，保证数据不冲突？此时<strong>分布式锁</strong>也许就可以派上用场了。</p><p>对于分布式系统，除了上面的可用性、数据一致性，我们还要考虑性能的因素，如果不考虑性能的话，事务得到保证并不困难，系统慢一点就行了。除了考虑性能外，我们还要考虑可用性，也就是说，一台机器没了，数据不丢失，服务可由别的机器继续提供。 于是，我们需要重点考虑下面的这么几个情况：</p><p>1）容灾：数据不丢、结点的Failover<br>2）数据的一致性：事务处理（锁）<br>3）性能：吞吐量 、 响应时间</p><p>前面说过，当出现某个节点的数据丢失时可以从副本读到，数据副本是分布式系统解决数据丢失异常的唯一手段。为简单起见，我们只讨论在**数据冗余(数据镜像)**方案下考虑数据的一致性和性能的问题。简单说来：</p><p>1）要想让数据有高可用性，就得写多份数据。<br>2）写多份的问题会导致数据一致性的问题。<br>3）数据一致性的问题又会引发性能问题</p><blockquote><p>我们似乎看到了分布式场景下的CAP理论的影子（有兴趣的自行深入研究，这里不再展开）。</p></blockquote><h3 id="1-4-服务的状态"><a href="#1-4-服务的状态" class="headerlink" title="1.4. 服务的状态"></a>1.4. 服务的状态</h3><p>所谓“状态”，是指程序运行中的一些数据或是程序运行上下文。比如用户每一次请求在服务端所保留下来的数据（记录），像用户登录时的Session，我们需要使用这个Session来判断这个请求的合法性；还有一个业务流程中需要让多个服务组合起来形成一个业务逻辑的运行上下文Context，这些都是状态。</p><h4 id="无状态的服务（Stateless）"><a href="#无状态的服务（Stateless）" class="headerlink" title="无状态的服务（Stateless）"></a>无状态的服务（Stateless）</h4><p>一直以来，无状态的服务被当成分布式服务设计的最佳实践和铁律。因为无状态的服务对于扩展性和运维实在是太方便了，没有状态的服务可以随意地增加和减少节点，可以随意的搬迁，而且可以大幅度降低代码的复杂度。</p><p>但是现实世界是一定会有状态的，这些状态可能表现在如下几个方面：</p><ul><li>程序调用的结果。</li><li>服务组合下的上下文。</li><li>服务的配置。</li></ul><p>为了做出无状态的服务，我们通常需要把状态保存到一个第三方的地方，比如Redis，ZooKeeper/Etcd这样的高可用存储中。从另一角度讲，为了实现无状态服务会导致应用服务依赖于第三方有状态的存储服务，同时也增加了网络开销，会增加服务的响应时间。</p><h4 id="有状态的服务（Stateful）"><a href="#有状态的服务（Stateful）" class="headerlink" title="有状态的服务（Stateful）"></a>有状态的服务（Stateful）</h4><p>在互联网领域，有状态的服务看上去比较“反动”。因为无状态服务需要把状态存放在第三方存储上，这样便增加了网络开销，为了减少网络开销有时就引入本地数据缓存，此时如果未引入Sticky Session机制，用户的每次请求并不一定会路由至同一台机器，结果将导致所有机器上都会创建相同的数据缓存，这也算是一种资源浪费。而如果引入了Sticky Session机制便可解决该资源浪费问题。</p><p>所谓Sticky Session，就是对于客户端传来的请求，都能保证其落在同一台机器上，相当是数据分片。这样我们完全不需要考虑数据会被加载到不同的节点，这样的架构模型就变简单了。通过一致性哈希便可以实现Sticky Session，但只是简单的使用一致性哈希会导致负载与数据不均匀（哈希环平衡又是另一个话题了，本文不深入讨论，有需要的请求参考<a href="https://zhuanlan.zhihu.com/p/25874641?utm_source=itdadao&utm_medium=referral">这里</a>）。</p><h3 id="1-5-水平扩展"><a href="#1-5-水平扩展" class="headerlink" title="1.5. 水平扩展"></a>1.5. 水平扩展</h3><p>水平扩展也叫横向扩展，是指为分布式应用集群添加一个新的服务节点来提升该分布式应用的处理能力。一般是在单机节点性能已无法进一步优化的情况下才会进一步考虑水平扩展。</p><p>一个可水平扩展的应用系统，其架构设计一般都要考虑以下几点：</p><ul><li>服务的状态（分布式状态复制 或 集中缓存服务）</li><li>分布式环境下的线程安全机制（分布式锁 或 一致性哈希）</li><li>数据一致性（分布式事务 ）</li></ul><h2 id="2-engine水平扩展关键问题（现状）"><a href="#2-engine水平扩展关键问题（现状）" class="headerlink" title="2. engine水平扩展关键问题（现状）"></a>2. engine水平扩展关键问题（现状）</h2><p>1）使用本地锁：当前Engine代码中大量使用JDK提供的锁机制来保证对同一个VDSM的并发请求，最典型的就是<code>InMemoryLockManager</code>提供的锁操作，其需要扩展成支持分布式锁。</p><blockquote><p>VDSM是否支持并发请求？</p></blockquote><p>2）有状态服务及认证会话：Engine中使用的EJB、部分服务实例（如<code>ResourceManager</code>）是有状态的服务。</p><p>3）定时计划任务：Engine中的定时任务也需要调整，否则会导致每个engine节点在启动后都执行相同的计划任务。</p><p>4）数据库：数据库服务目前未提供HA服务（这部分可独立考虑，个人认为不需要在本方案中考虑）</p><p>5）配置文件：配置文件也需要在集群成员间同步，目前版本的engine也不支持。</p><h2 id="3-备选方案"><a href="#3-备选方案" class="headerlink" title="3. 备选方案"></a>3. 备选方案</h2><h3 id="3-1-本地锁问题"><a href="#3-1-本地锁问题" class="headerlink" title="3.1. 本地锁问题"></a>3.1. 本地锁问题</h3><p>为了在分布式环境下实现VM等资源互斥访问需求，有两种方案：<br>1）基于一致性哈希来保证每次请求都落在同一个engine节点<br>2）引入分布式锁：Redis、ZooKeeper或基于infinispan自行实现</p><p>方案1：实现起来相对简单，只需要在每个engine中实现hash redirect模块，但若出现节点数量变更重建hash环的过程中仍然无法保证资源互斥问题。</p><p>方案2：性能会有所损失，同时改造量比较大，需要找出现有代码中所有本地锁并调整为分布式锁；</p><p>由于我们云管平台的使用场景并非像互联网产品会频繁的变更engine节点，因此重建hash环的概率相当低，同时VDSM本身也有并发保护机制，因此优先考虑使用方案1，后续随着对engine代码的深入研究再进一步考虑方案2。</p><h3 id="3-2-服务状态问题"><a href="#3-2-服务状态问题" class="headerlink" title="3.2. 服务状态问题"></a>3.2. 服务状态问题</h3><p>同样的两种方案：<br>1）基于一致性哈希来保证每次请求都落在同一个engine节点<br>2）分布式缓存</p><p>方案1：与3.1节的需求不同，节点宕机导致哈希环重建会导致缓存数据迁移或丢失，该方案容错性太差，因此不能够用它来保障业务。（我们引入一致性哈希只是为了实现资源互斥而已，这点要搞清楚。）</p><p>方案2：由于engine是运行在wildfly服务器中，而wildfly原生提供了分布式缓存服务<code>infinispan</code>，同时其对Session复制也提供了现成的支持，在技术上不存在障碍。主要还是工作量问题，即需要识别出各个有状态的服务如<code>ResourceManager</code>，没有其他捷径。</p><h3 id="3-3-定时计划任务"><a href="#3-3-定时计划任务" class="headerlink" title="3.3. 定时计划任务"></a>3.3. 定时计划任务</h3><p>由于engine的计划任务是基于quartz，而quartz是支持分布式场景的，因此这部分也不存在技术问题。</p><h3 id="3-4-配置文件"><a href="#3-4-配置文件" class="headerlink" title="3.4. 配置文件"></a>3.4. 配置文件</h3><p>可选择的方案：<br>1）使用基础平台提供的文件同步方案<br>2）基于ZooKeeper或Etcd开源方案实现文件同步（该方法对部署有要求，最少是三个节点）</p><p>优先使用方案1，如果基础平台未提供则采用方案2。</p><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>总得来说，ovirt-engine的水平扩展方案在技术上是可行的且不存在技术障碍，主要还是源码分析的工作量问题。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://blog.csdn.net/cloudresearch/article/details/23127985">分布式基础通信协议</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1-基础概念&quot;&gt;&lt;a href=&quot;#1-基础概念&quot; class=&quot;headerlink&quot; title=&quot;1. 基础概念&quot;&gt;&lt;/a&gt;1. 基础概念&lt;/h2&gt;&lt;p&gt;本文先简单介绍下与分布式系统相关的几个概念。&lt;/p&gt;
&lt;h3 id=&quot;1-1-分布式锁&quot;&gt;&lt;a href=&quot;#1-1-分布式锁&quot; class=&quot;headerlink&quot; title=&quot;1.1. 分布式锁&quot;&gt;&lt;/a&gt;1.1. 分布式锁&lt;/h3&gt;&lt;p&gt;所谓分布式锁是指在一个分布式集群中，同一个方法在同一时间只能被一台机器上的一个线程执行，也就是所谓的分布式互斥。就像单机系统上的多线程程序需要用操作系统锁或数据库锁来互斥对共享资源的访问一样，分布式程序也需要通过分布式锁来互斥对共享资源的访问。分布式锁是保障数据一致性的手段之一。&lt;br&gt;一般情况下，我们可以使用数据库、Redis或者ZooKeeper来做分布式锁服务。不管怎么样，分布式的锁服务需要有以下几个特点：&lt;br&gt;1）安全性：在任意时刻，只有一个客户端可以获得锁（排他性）&lt;br&gt;2）避免死锁：客户端最终一定可以获得锁，即使锁住某个资源的客户端在释放锁之前崩溃或网络不可达&lt;br&gt;3）容错性：只要锁服务集群中的大部分节点存活，客户端就可以进行加锁解锁的操作&lt;/p&gt;
&lt;p&gt;即分布式锁服务在实现上一般关注如下三个问题：&lt;br&gt;1）锁获取机制：超时释放导致多方获取同一把锁问题（CAS机制）&lt;br&gt;2）锁释放机制：正常释放、超时释放&lt;br&gt;3）客户端如何知道锁被释放：客户端不断重试、服务端主动通知&lt;/p&gt;
&lt;h3 id=&quot;1-2-数据一致性&quot;&gt;&lt;a href=&quot;#1-2-数据一致性&quot; class=&quot;headerlink&quot; title=&quot;1.2. 数据一致性&quot;&gt;&lt;/a&gt;1.2. 数据一致性&lt;/h3&gt;&lt;p&gt;说起数据一致性，简单说有三种类型：&lt;br&gt;1）Weak（弱一致性）：当你写入一个新值后，读操作在数据副本上可能读出来，也可能读不出来。比如：某些cache系统，网络游戏其它玩家的数据和你没什么关系。&lt;br&gt;2）Eventually（最终一致性）：当你写入一个新值后，有可能读不出来，但在某个时间窗口之后保证最终能读出来。比如：DNS，电子邮件、Amazon S3，Google搜索引擎这样的系统。&lt;br&gt;3）Strong（强一致性）：新的数据一旦写入，在任意副本任意时刻都能读到新值。比如：文件系统，RDBMS，Azure Table都是强一致性的。&lt;/p&gt;
&lt;p&gt;从这三种一致型的模型上来说，我们可以看到，Weak和Eventually一般来说是异步冗余的，而Strong一般来说是同步冗余的，异步的通常意味着更好的性能，但也意味着更复杂的状态控制。同步意味着简单，但也意味着性能下降。&lt;/p&gt;</summary>
    
    
    
    <category term="分布式" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
    <category term="ovirt" scheme="http://cloudnoter.com/tags/ovirt/"/>
    
    <category term="engine" scheme="http://cloudnoter.com/tags/engine/"/>
    
    <category term="虚拟化" scheme="http://cloudnoter.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>《代码整洁之道》学习笔记</title>
    <link href="http://cloudnoter.com/2018/02/28/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://cloudnoter.com/2018/02/28/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2018-02-27T22:56:45.000Z</published>
    <updated>2018-03-19T17:54:42.050Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-What"><a href="#1-What" class="headerlink" title="1. What?"></a>1. What?</h2><p>正如Jack Reecves所发表的《源码就是设计》：源码就是最好软件设计文档，而其他非代码性的文档只是源码的辅助。本文并非为了讨论编程与软件设计的关系，只想借以说明源码的重要性。</p><p>简单讲，整洁代码行云流水如同阅读精美好文，代码能够尽可能的自解释；具体讲，整洁代码具备如下特性：</p><ul><li>变量、函数、类、包、模块命名合理有意义</li><li>代码结构（格式）清晰</li><li>必要的合理的注释信息：代码能自解释只是理想，该注释的地方还是免不了</li><li>合理的异常处理机制</li><li>有效的日志信息</li><li>遵循面向对象设计原则</li></ul><span id="more"></span><h2 id="2-How"><a href="#2-How" class="headerlink" title="2. How?"></a>2. How?</h2><p>我们写文章都是先构思再下笔，但一般不可能一气呵成。都是先出初稿再调整、使用精美词句慢慢打磨。写代码同写文章一样，也是一个不断调整修饰的过程（修改名称、分解函数、消除重复等操作不断重复）。只要你有一颗写出整洁代码的初心。</p><h3 id="2-1-有意义的命名"><a href="#2-1-有意义的命名" class="headerlink" title="2.1. 有意义的命名"></a>2.1. 有意义的命名</h3><ul><li>名副其实，必免误导：在给变量、函数等取个合适名字其实是很花时间的事，对于已有的变量等，如果想到更合适的名字则请记得马上换掉，必免误导其他开发人员。</li><li>遵守编码规范中的命名相关部分。</li></ul><h3 id="2-2-清晰的代码结构"><a href="#2-2-清晰的代码结构" class="headerlink" title="2.2. 清晰的代码结构"></a>2.2. 清晰的代码结构</h3><ul><li>问题分解、模块职责划分</li><li>编码前需要有最基本的设计思路，不管是何种设计粒度（系统、模块、类），其核心骨架、流程都必须成竹于胸。</li><li>函数尽量精简，精简的函数不代表行数就一定是很少；只要保证一个函数只做一件事，这里的“一件事“比较抽象，不同人有不同的解读；我的区分原则为：有利于函数复用与阅读。</li><li>函数参数越少越好，这样能省很多测试用例；参数尽量只用于输入，通过返回值进行函数结果输出，参数尽量不同时承载输入与输出信息（多线程开发时除外）</li><li>函数要么做查询操作，要么做设置操作，不要同时都做。</li></ul><h3 id="2-3-注释"><a href="#2-3-注释" class="headerlink" title="2.3. 注释"></a>2.3. 注释</h3><h4 id="2-3-1-合理的注释"><a href="#2-3-1-合理的注释" class="headerlink" title="2.3.1. 合理的注释"></a>2.3.1. 合理的注释</h4><ul><li>注释是为了弥补代码无力表达程序意图时的一个有效补充。</li><li>代码能自我表达固然是撸码的最高境界，但现实总是残酷的，当有段代码你发现需要写注释时，你需要先反省下是否代码写得太差以致于无法自解释。注释并不能美化糟糕的代码。</li><li>需要明白注释是有维护成本的，如果不及时更新就容易引起混乱</li><li>外部服务接口/API都需要提供必要的注释信息，有一定的维护成本，但一定不能省。</li><li>潜在的坑也需要注释以警告其他开发人员，最常见的是FIXME、为了解决出现线程不安全问题的代码逻辑（不写清楚无经验的同事可能会乱改而引入BUG，如SimpleDateFormat）</li></ul><h4 id="2-3-2-不好的注释"><a href="#2-3-2-不好的注释" class="headerlink" title="2.3.2. 不好的注释"></a>2.3.2. 不好的注释</h4><ul><li>个人觉得JavaBean的Getter/Setter方法是不需要注释的</li><li>对代码的修改不需要写一些日志式的注释、不写废话式注释</li><li>能用函数名或变量名自解释的，尽量不写注释</li><li>不需要在控制语句的花括号结尾加代表语句结束的注释，类似<code>&#125; // while</code></li><li>也不需要写一大段的注释，如果出现这种情况，肯定是功能函数拆解不合理导致。</li></ul><h3 id="2-4-格式"><a href="#2-4-格式" class="headerlink" title="2.4. 格式"></a>2.4. 格式</h3><ul><li>遵行编码规范中的格式部分</li><li>合理使用空行</li><li>联系紧密的代码尽量靠在一起</li><li>一个团队使用同一套格式规则</li></ul><h3 id="2-5-对象与数据结构"><a href="#2-5-对象与数据结构" class="headerlink" title="2.5. 对象与数据结构"></a>2.5. 对象与数据结构</h3><ul><li>认真对待抽象，不是简单的写个接口，加几个方法就算是抽象</li><li>对像隐藏数据，暴露操作；数据结构暴露数据，不提供操作函数</li><li>DTO，DDD中的充血模型，类JavaBean的失血模型，个人项目中我更倾向于使用充血模型，所以书中所谓的混杂我是不太同意的。</li></ul><h3 id="2-6-错误处理"><a href="#2-6-错误处理" class="headerlink" title="2.6. 错误处理"></a>2.6. 错误处理</h3><ul><li>面向对象设计中，严格实行快速抛异常原则，而不是返回错误代码，而不应该吃掉异常。</li><li>对于尽量不抛出Checked类型的异常这一说法，个人持保留态度</li><li>对于外部复杂的异常层次结构可做必要的封装以减少重复代码</li><li>尽量不使用null作为返回值、参数等，因为null可能引起歧义</li></ul><h3 id="2-7-对第三方库的处理方式"><a href="#2-7-对第三方库的处理方式" class="headerlink" title="2.7. 对第三方库的处理方式"></a>2.7. 对第三方库的处理方式</h3><ul><li>建议对第三方接口进行包装，便于后续适配多个提供方</li><li>团队协作中，如果依赖的其他子系统的接口未定义，但我们已明确我方的需求，我们可以先定义接口并提供一个Mock类，这样可以保证我们的模块稳定性及可测试性</li><li>如果依赖的第三方接口在本系统中使用得比较多，也建议统一再包装一层以适应外部接口变化</li><li>包装的目的是屏蔽外部不确定性、增加鲁棒性</li></ul><h3 id="2-8-类与系统的设计"><a href="#2-8-类与系统的设计" class="headerlink" title="2.8. 类与系统的设计"></a>2.8. 类与系统的设计</h3><ul><li>遵循面向对象设计原则</li></ul><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1-What&quot;&gt;&lt;a href=&quot;#1-What&quot; class=&quot;headerlink&quot; title=&quot;1. What?&quot;&gt;&lt;/a&gt;1. What?&lt;/h2&gt;&lt;p&gt;正如Jack Reecves所发表的《源码就是设计》：源码就是最好软件设计文档，而其他非代码性的文档只是源码的辅助。本文并非为了讨论编程与软件设计的关系，只想借以说明源码的重要性。&lt;/p&gt;
&lt;p&gt;简单讲，整洁代码行云流水如同阅读精美好文，代码能够尽可能的自解释；具体讲，整洁代码具备如下特性：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;变量、函数、类、包、模块命名合理有意义&lt;/li&gt;
&lt;li&gt;代码结构（格式）清晰&lt;/li&gt;
&lt;li&gt;必要的合理的注释信息：代码能自解释只是理想，该注释的地方还是免不了&lt;/li&gt;
&lt;li&gt;合理的异常处理机制&lt;/li&gt;
&lt;li&gt;有效的日志信息&lt;/li&gt;
&lt;li&gt;遵循面向对象设计原则&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="读书" scheme="http://cloudnoter.com/categories/%E8%AF%BB%E4%B9%A6/"/>
    
    
    <category term="CleanCode" scheme="http://cloudnoter.com/tags/CleanCode/"/>
    
  </entry>
  
  <entry>
    <title>基于Spring的动态多数据源组件使用文档</title>
    <link href="http://cloudnoter.com/2017/09/11/%E5%9F%BA%E4%BA%8ESpring%E7%9A%84%E5%8A%A8%E6%80%81%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E7%BB%84%E4%BB%B6%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/"/>
    <id>http://cloudnoter.com/2017/09/11/%E5%9F%BA%E4%BA%8ESpring%E7%9A%84%E5%8A%A8%E6%80%81%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E7%BB%84%E4%BB%B6%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/</id>
    <published>2017-09-10T23:35:26.000Z</published>
    <updated>2017-10-13T07:25:45.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目源码"><a href="#项目源码" class="headerlink" title="项目源码"></a>项目源码</h2><p><a href="https://github.com/monkeychen/xspring">https://github.com/monkeychen/xspring</a></p><blockquote><p>xspring是个组件集，后续会不断增加新的通用组件，本文所介绍的动态多数据源组件位于xspring项目的xspring-data模块中，其maven坐标如下(尚未上传至maven中央库)：</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xspring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xspring-data<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h2><ul><li>无须定义繁琐的配置信息，使用方只需要提供基本的JDBC连接参数即可</li><li>与spring框架无缝集成</li><li>默认使用Druid数据库连接池，但支持自定义扩展（可以使用其他数据库连接池）</li></ul><h2 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h2><p>本框架是在spring框架提供的各种特性的基础上进行开发的，具体如下：</p><ul><li>抽象的数据源路由类：<code>AbstractRoutingDataSource</code></li><li>基于AOP及注解实现数据源动态切换</li></ul><h3 id="xspring-core组件"><a href="#xspring-core组件" class="headerlink" title="xspring-core组件"></a>xspring-core组件</h3><p>core组件是所有其他组件的基础，其提供了通用的事件总线、日志管理等功能。其中<code>XspringApplication</code>是整个框架的启动类，通过调用这个启动类的startup静态方法，并提供您打上<code>@org.springframework.context.annotation.Configuration</code>注解的启动类来启动您的应用。</p><blockquote><p>框架启动时按如下顺序加载配置文件</p><ul><li>file:./config/env.properties</li><li>classpath:/config/env.properties</li><li>file:./config/xspring.properties</li><li>file:./xspring.properties</li><li>classpath:./config/xspring.properties</li><li>classpath:./xspring.properties</li></ul></blockquote><p>上述配置文件中<code>env.properties</code>文件中的属性信息支持热加载（即每隔指定时间框架都会读取该文件并更新至SystemProperties），相关源码请参考类<code>EnvironmentInitializer</code>.</p><p>基于Xspring框架的应用启动示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ImportResource(&quot;classpath:/config/customized-beans.xml&quot;)</span>   <span class="comment">// 可以通过ImportResource方式加载定义在XML中的bean信息。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DemoService demoService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        applicationContext = XspringApplication.startup(DemoApplication.class, args);</span><br><span class="line">        demoService = applicationContext.getBean(<span class="string">&quot;demoService&quot;</span>, DemoService.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>XspringApplication</code>类的<code>startup</code>方法会创建<code>XspringApplication</code>实例并调用其<code>run</code>方法：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">startup</span><span class="params">(Class&lt;?&gt; annotatedClass, <span class="keyword">String</span>[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">XspringApplication</span>().<span class="built_in">run</span>(annotatedClass, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>run</code>方法中，框架会通过SPI方式加载其他组件提供的标注有<code>@Configuration</code>注解的<code>org.xspring.core.extension.ModuleConfiguration</code>接口实现类，从而启动其他组件。</p><p>SPI声明统一存放在各个组件的<code>classpath:/META-INF/spring.factories</code>文件中，整个加载过程源码如下：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public ConfigurableApplicationContext run(Class&lt;?&gt; annotatedClass, String<span class="literal">[]</span> args) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;The input arguments is:&#123;&#125;, &#123;&#125;&quot;</span>, annotatedClass, args);</span><br><span class="line">    AnnotationConfigApplicationContext context = null;</span><br><span class="line">    <span class="comment">// Load other configurations in spring.factories file</span></span><br><span class="line">    ClassLoader classLoader = <span class="module-access"><span class="module"><span class="identifier">ClassUtils</span>.</span></span>get<span class="constructor">DefaultClassLoader()</span>;</span><br><span class="line">    List&lt;String&gt; factoryNames = <span class="module-access"><span class="module"><span class="identifier">SpringFactoriesLoader</span>.</span></span>load<span class="constructor">FactoryNames(ModuleConfiguration.<span class="params">class</span>, <span class="params">classLoader</span>)</span>;</span><br><span class="line">    List&lt;Class&gt; moduleConfigClasses = <span class="module-access"><span class="module"><span class="identifier">Lists</span>.</span></span><span class="keyword">new</span><span class="constructor">ArrayList()</span>;</span><br><span class="line">    moduleConfigClasses.add(<span class="module-access"><span class="module"><span class="identifier">XspringConfiguration</span>.</span></span><span class="keyword">class</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">CollectionUtils</span>.</span></span>is<span class="constructor">NotEmpty(<span class="params">factoryNames</span>)</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String factoryName : factoryNames) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class factoryClass = <span class="module-access"><span class="module"><span class="identifier">ClassUtils</span>.</span></span><span class="keyword">for</span><span class="constructor">Name(<span class="params">factoryName</span>, <span class="params">classLoader</span>)</span>;</span><br><span class="line">                moduleConfigClasses.add(factoryClass);</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Can not find the matched class[&#123;&#125;] in classpath!&quot;</span>, factoryName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (annotatedClass != null) &#123;</span><br><span class="line">        moduleConfigClasses.add(annotatedClass);</span><br><span class="line">    &#125;</span><br><span class="line">    Class<span class="literal">[]</span> configurations = moduleConfigClasses.<span class="keyword">to</span><span class="constructor">Array(<span class="params">new</span> Class[<span class="params">moduleConfigClasses</span>.<span class="params">size</span>()</span>]);</span><br><span class="line">    context = <span class="keyword">new</span> <span class="constructor">AnnotationConfigApplicationContext(<span class="params">configurations</span>)</span>;</span><br><span class="line">    context.start<span class="literal">()</span>;</span><br><span class="line">    return context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>xspring-core组件还提供了一个基于Google Guava库的事件总线模型，有兴趣的朋友可直接参考<code>org.xspring.core.eventbus</code>包下的相关源码。</p></blockquote><span id="more"></span><h3 id="xspring-data组件"><a href="#xspring-data组件" class="headerlink" title="xspring-data组件"></a>xspring-data组件</h3><p>xspring-data组件的模块定义（启动）类为：<code>XspringDataConfiguration</code>，其会通过<code>@Import(DataSourceInitializer.class)</code>方式加载动态数据源初始化配置类。<code>DataSourceInitializer</code>也是一个<code>@Configurable</code>注解类，其通过<code>@Bean</code>的方式定义了<code>datasource</code>这个动态数据源。</p><p>在动态数据源bean创建过程中，组件会通过SPI方式加载<code>DataSourceFactory</code>这个接口的实现类来获取具体的数据库连接池提供方，框架默认提供了<code>DruidDataSourceFactory</code>。<br>您也可以自己提供数据库连接池的实现类（同样定义在各个组件的<code>classpath:/META-INF/spring.factories</code>文件中），并通过添加<code>org.springframework.core.annotation.Order</code>注解来指定加载优先级。</p><p><code>DataSourceInitializer</code>会从属性文件<code>datasource.properties</code>中加载JDBC配置信息，然后通过<code>DataSourceFactory</code>实现类创建相关的数据库连接池（真正的数据源）实例。<br><code>datasource.properties</code>文件加载位置如下（先后顺序）：</p><blockquote><ul><li>file:./config/datasource.properties</li><li>classpath:/config/datasource.properties</li></ul></blockquote><p>框架默认提供的Druid数据库连接池所使用的<code>datasource.properties</code>文件内容大致如下（不同的数据库连接池提供方则会有所差别）：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据源个数</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.max</span>=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认数据源编号</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.default</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个数据源</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.name</span>=ds_mysql</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.driverClassName</span>=com.mysql.jdbc.Driver</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.url</span>=jdbc:mysql://localhost:<span class="number">3306</span>/mooc?useUnicode=<span class="literal">true</span>&amp;characterEncoding=UTF8</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.username</span>=root</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.password</span>=*****</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.initialSize</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.minPoolSize</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.maxPoolSize</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.maxWait</span>=<span class="number">60000</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.1.poolFilters</span>=stat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二个数据源</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.name</span>=ds_postgresql</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.driverClassName</span>=org.postgresql.Driver</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.url</span>=jdbc:postgresql://localhost:<span class="number">5432</span>/blog</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.username</span>=postgres</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.password</span>=*****</span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.initialSize</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.minPoolSize</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.maxPoolSize</span>=<span class="number">10</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.maxWait</span>=<span class="number">60000</span></span><br><span class="line"><span class="attr">xspring.datasource.jdbc.2.poolFilters</span>=stat</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：xspring-data组件的动态多数据源目前只支持相同数据库连接池提供方，即只会使用order值最小的<code>DataSourceFactory</code>实现类来创建真正的数据源对象。</strong></p></blockquote><p>源码如下：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public DataSource data<span class="constructor">Source()</span> &#123;</span><br><span class="line">        <span class="comment">// 加载DataSourceFactory实现类列表，返回的实例已根据@order注解进行升序排序</span></span><br><span class="line">        ClassLoader classLoader = <span class="module-access"><span class="module"><span class="identifier">ClassUtils</span>.</span></span>get<span class="constructor">DefaultClassLoader()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过SPI方式加载DataSourceFactory这个接口的实现类来获取具体的数据库连接池提供方，框架默认提供了DruidDataSourceFactory。</span></span><br><span class="line">        List&lt;DataSourceFactory&gt; dataSourceFactories = <span class="module-access"><span class="module"><span class="identifier">SpringFactoriesLoader</span>.</span></span>load<span class="constructor">Factories(DataSourceFactory.<span class="params">class</span>, <span class="params">classLoader</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">CollectionUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">dataSourceFactories</span>)</span>) &#123;</span><br><span class="line">            throw <span class="keyword">new</span> <span class="constructor">BeanCreationException(<span class="string">&quot;Not found any DataSourceFactory implementer in class path!&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DataSourceFactory dataSourceFactory = dataSourceFactories.get(<span class="number">0</span>);</span><br><span class="line">        Map&lt;String, DataSource&gt; dataSourceMap = dataSourceFactory.load<span class="constructor">OriginalDataSources(<span class="params">environment</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">CollectionUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">dataSourceMap</span>)</span>) &#123;</span><br><span class="line">            throw <span class="keyword">new</span> <span class="constructor">BeanCreationException(<span class="string">&quot;Fail to load any original DataSource instance!&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSourceMap = <span class="module-access"><span class="module"><span class="identifier">Maps</span>.</span></span><span class="keyword">new</span><span class="constructor">HashMap()</span>;</span><br><span class="line">        dataSourceMap.<span class="keyword">for</span><span class="constructor">Each((<span class="params">name</span>, <span class="params">dataSource</span>)</span> -&gt; &#123;</span><br><span class="line">            beanFactory.register<span class="constructor">Singleton(<span class="params">name</span>, <span class="params">dataSource</span>)</span>; <span class="comment">// 将具体的DataSource实例注册进ApplicationContext</span></span><br><span class="line">            targetDataSourceMap.put(name, dataSource);</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">DynamicDataSourceContextHolder</span>.</span></span>add<span class="constructor">DataSourceId(<span class="params">name</span>)</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        DataSource defaultDataSource = dataSourceFactory.get<span class="constructor">DefaultDataSource(<span class="params">environment</span>)</span>;</span><br><span class="line"></span><br><span class="line">        DynamicDataSource dataSource = <span class="keyword">new</span> <span class="constructor">DynamicDataSource()</span>;</span><br><span class="line">        dataSource.set<span class="constructor">TargetDataSources(<span class="params">targetDataSourceMap</span>)</span>;</span><br><span class="line">        dataSource.set<span class="constructor">DefaultTargetDataSource(<span class="params">defaultDataSource</span>)</span>;</span><br><span class="line">        return dataSource;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>使用示例见单元测试类：<code>DynamicDataSourceTest, DemoServiceImpl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DemoServiceImpl源码：</span></span><br><span class="line"><span class="meta">@Component(&quot;demoService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@TargetDataSource(&quot;ds_mysql&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printClassroomList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List list = jdbcTemplate.queryForList(<span class="string">&quot;SELECT * FROM classroom&quot;</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@TargetDataSource(&quot;ds_postgresql&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List list = jdbcTemplate.queryForList(<span class="string">&quot;SELECT * FROM t_user&quot;</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DynamicDataSourceTest源码（启动配置类）：</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ImportResource(&quot;classpath:/config/xspring-context-test.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DemoService demoService;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        applicationContext = XspringApplication.startup(DynamicDataSourceTest.class, <span class="keyword">null</span>);</span><br><span class="line">        demoService = applicationContext.getBean(<span class="string">&quot;demoService&quot;</span>, DemoService.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDynamicDataSource</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        demoService.printClassroomList();</span><br><span class="line">        demoService.printUserList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>自定义的XML配置文件<code>xspring-context-test.xml</code>内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.3.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.xspring&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="关键类图"><a href="#关键类图" class="headerlink" title="关键类图"></a>关键类图</h2><p>待补充</p><h2 id="参考资料-SpringBoot配置文件加载顺序及属性优先级"><a href="#参考资料-SpringBoot配置文件加载顺序及属性优先级" class="headerlink" title="参考资料:SpringBoot配置文件加载顺序及属性优先级"></a>参考资料:SpringBoot配置文件加载顺序及属性优先级</h2><p>参考：<a href="http://www.importnew.com/17673.html">http://www.importnew.com/17673.html</a><br><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#resources">https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#resources</a></p><p><code>file:./config/ -&gt; file:./ -&gt; classpath:/config/ -&gt; classpath:/</code></p><p>如果各个目录下都有相同的配置文件（如<code>application.properties</code>），则都会被加载进来（即不互斥），但如果多个jar包的相同路径下都存在一样的配置文件，则只会加载第一个匹配的文件（具体由classloader的加载顺序决定）；如果每个文件中都包含相同的key，则最左边文件中的key具有最高的优先级，从源码注释也可证明这一点：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigFileApplicationListener中的描述：</span></span><br><span class="line"><span class="comment">// Note the order is from least to most specific (last one wins)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="built_in">String</span> DEFAULT_SEARCH_LOCATIONS = <span class="string">&quot;classpath:/,classpath:/config/,file:./,file:./config/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConfigFileApplicationListener.Loader类获取配置文件加载位置：</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; <span class="function"><span class="title">getSearchLocations</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; locations = <span class="keyword">new</span> LinkedHashSet&lt;<span class="built_in">String</span>&gt;();</span><br><span class="line"><span class="comment">// User-configured settings take precedence, so we do them first</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.environment.containsProperty(CONFIG_LOCATION_PROPERTY)) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">String</span> path : asResolvedSet(</span><br><span class="line"><span class="built_in">this</span>.environment.getProperty(CONFIG_LOCATION_PROPERTY), <span class="literal">null</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!path.contains(<span class="string">&quot;$&quot;</span>)) &#123;</span><br><span class="line">path = StringUtils.cleanPath(path);</span><br><span class="line"><span class="keyword">if</span> (!ResourceUtils.isUrl(path)) &#123;</span><br><span class="line">path = ResourceUtils.FILE_URL_PREFIX + path;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">locations.add(path);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">locations.addAll(</span><br><span class="line">asResolvedSet(ConfigFileApplicationListener.this.searchLocations,</span><br><span class="line">DEFAULT_SEARCH_LOCATIONS));</span><br><span class="line"><span class="keyword">return</span> locations;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;项目源码&quot;&gt;&lt;a href=&quot;#项目源码&quot; class=&quot;headerlink&quot; title=&quot;项目源码&quot;&gt;&lt;/a&gt;项目源码&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/monkeychen/xspring&quot;&gt;https://github.com/monkeychen/xspring&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;xspring是个组件集，后续会不断增加新的通用组件，本文所介绍的动态多数据源组件位于xspring项目的xspring-data模块中，其maven坐标如下(尚未上传至maven中央库)：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.xspring&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;xspring-data&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;0.0.1-SNAPSHOT&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;设计目标&quot;&gt;&lt;a href=&quot;#设计目标&quot; class=&quot;headerlink&quot; title=&quot;设计目标&quot;&gt;&lt;/a&gt;设计目标&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;无须定义繁琐的配置信息，使用方只需要提供基本的JDBC连接参数即可&lt;/li&gt;
&lt;li&gt;与spring框架无缝集成&lt;/li&gt;
&lt;li&gt;默认使用Druid数据库连接池，但支持自定义扩展（可以使用其他数据库连接池）&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;技术原理&quot;&gt;&lt;a href=&quot;#技术原理&quot; class=&quot;headerlink&quot; title=&quot;技术原理&quot;&gt;&lt;/a&gt;技术原理&lt;/h2&gt;&lt;p&gt;本框架是在spring框架提供的各种特性的基础上进行开发的，具体如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;抽象的数据源路由类：&lt;code&gt;AbstractRoutingDataSource&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;基于AOP及注解实现数据源动态切换&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;xspring-core组件&quot;&gt;&lt;a href=&quot;#xspring-core组件&quot; class=&quot;headerlink&quot; title=&quot;xspring-core组件&quot;&gt;&lt;/a&gt;xspring-core组件&lt;/h3&gt;&lt;p&gt;core组件是所有其他组件的基础，其提供了通用的事件总线、日志管理等功能。其中&lt;code&gt;XspringApplication&lt;/code&gt;是整个框架的启动类，通过调用这个启动类的startup静态方法，并提供您打上&lt;code&gt;@org.springframework.context.annotation.Configuration&lt;/code&gt;注解的启动类来启动您的应用。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;框架启动时按如下顺序加载配置文件&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;file:./config/env.properties&lt;/li&gt;
&lt;li&gt;classpath:/config/env.properties&lt;/li&gt;
&lt;li&gt;file:./config/xspring.properties&lt;/li&gt;
&lt;li&gt;file:./xspring.properties&lt;/li&gt;
&lt;li&gt;classpath:./config/xspring.properties&lt;/li&gt;
&lt;li&gt;classpath:./xspring.properties&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;上述配置文件中&lt;code&gt;env.properties&lt;/code&gt;文件中的属性信息支持热加载（即每隔指定时间框架都会读取该文件并更新至SystemProperties），相关源码请参考类&lt;code&gt;EnvironmentInitializer&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;基于Xspring框架的应用启动示例代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Configuration&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@ImportResource(&amp;quot;classpath:/config/customized-beans.xml&amp;quot;)&lt;/span&gt;   &lt;span class=&quot;comment&quot;&gt;// 可以通过ImportResource方式加载定义在XML中的bean信息。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DemoApplication&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; ApplicationContext applicationContext;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; DemoService demoService;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        applicationContext = XspringApplication.startup(DemoApplication.class, args);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        demoService = applicationContext.getBean(&lt;span class=&quot;string&quot;&gt;&amp;quot;demoService&amp;quot;&lt;/span&gt;, DemoService.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code&gt;XspringApplication&lt;/code&gt;类的&lt;code&gt;startup&lt;/code&gt;方法会创建&lt;code&gt;XspringApplication&lt;/code&gt;实例并调用其&lt;code&gt;run&lt;/code&gt;方法：&lt;/p&gt;
&lt;figure class=&quot;highlight arduino&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; ConfigurableApplicationContext &lt;span class=&quot;title&quot;&gt;startup&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Class&amp;lt;?&amp;gt; annotatedClass, &lt;span class=&quot;keyword&quot;&gt;String&lt;/span&gt;[] args)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;XspringApplication&lt;/span&gt;().&lt;span class=&quot;built_in&quot;&gt;run&lt;/span&gt;(annotatedClass, args);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;在&lt;code&gt;run&lt;/code&gt;方法中，框架会通过SPI方式加载其他组件提供的标注有&lt;code&gt;@Configuration&lt;/code&gt;注解的&lt;code&gt;org.xspring.core.extension.ModuleConfiguration&lt;/code&gt;接口实现类，从而启动其他组件。&lt;/p&gt;
&lt;p&gt;SPI声明统一存放在各个组件的&lt;code&gt;classpath:/META-INF/spring.factories&lt;/code&gt;文件中，整个加载过程源码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight reasonml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public ConfigurableApplicationContext run(Class&amp;lt;?&amp;gt; annotatedClass, String&lt;span class=&quot;literal&quot;&gt;[]&lt;/span&gt; args) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    logger.debug(&lt;span class=&quot;string&quot;&gt;&amp;quot;The input arguments is:&amp;#123;&amp;#125;, &amp;#123;&amp;#125;&amp;quot;&lt;/span&gt;, annotatedClass, args);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    AnnotationConfigApplicationContext context = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Load other configurations in spring.factories file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ClassLoader classLoader = &lt;span class=&quot;module-access&quot;&gt;&lt;span class=&quot;module&quot;&gt;&lt;span class=&quot;identifier&quot;&gt;ClassUtils&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;get&lt;span class=&quot;constructor&quot;&gt;DefaultClassLoader()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;String&amp;gt; factoryNames = &lt;span class=&quot;module-access&quot;&gt;&lt;span class=&quot;module&quot;&gt;&lt;span class=&quot;identifier&quot;&gt;SpringFactoriesLoader&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;load&lt;span class=&quot;constructor&quot;&gt;FactoryNames(ModuleConfiguration.&lt;span class=&quot;params&quot;&gt;class&lt;/span&gt;, &lt;span class=&quot;params&quot;&gt;classLoader&lt;/span&gt;)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;Class&amp;gt; moduleConfigClasses = &lt;span class=&quot;module-access&quot;&gt;&lt;span class=&quot;module&quot;&gt;&lt;span class=&quot;identifier&quot;&gt;Lists&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;constructor&quot;&gt;ArrayList()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    moduleConfigClasses.add(&lt;span class=&quot;module-access&quot;&gt;&lt;span class=&quot;module&quot;&gt;&lt;span class=&quot;identifier&quot;&gt;XspringConfiguration&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;module-access&quot;&gt;&lt;span class=&quot;module&quot;&gt;&lt;span class=&quot;identifier&quot;&gt;CollectionUtils&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;is&lt;span class=&quot;constructor&quot;&gt;NotEmpty(&lt;span class=&quot;params&quot;&gt;factoryNames&lt;/span&gt;)&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (String factoryName : factoryNames) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Class factoryClass = &lt;span class=&quot;module-access&quot;&gt;&lt;span class=&quot;module&quot;&gt;&lt;span class=&quot;identifier&quot;&gt;ClassUtils&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;constructor&quot;&gt;Name(&lt;span class=&quot;params&quot;&gt;factoryName&lt;/span&gt;, &lt;span class=&quot;params&quot;&gt;classLoader&lt;/span&gt;)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                moduleConfigClasses.add(factoryClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; catch (ClassNotFoundException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                logger.warn(&lt;span class=&quot;string&quot;&gt;&amp;quot;Can not find the matched class[&amp;#123;&amp;#125;] in classpath!&amp;quot;&lt;/span&gt;, factoryName);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (annotatedClass != null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        moduleConfigClasses.add(annotatedClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Class&lt;span class=&quot;literal&quot;&gt;[]&lt;/span&gt; configurations = moduleConfigClasses.&lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;constructor&quot;&gt;Array(&lt;span class=&quot;params&quot;&gt;new&lt;/span&gt; Class[&lt;span class=&quot;params&quot;&gt;moduleConfigClasses&lt;/span&gt;.&lt;span class=&quot;params&quot;&gt;size&lt;/span&gt;()&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    context = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;constructor&quot;&gt;AnnotationConfigApplicationContext(&lt;span class=&quot;params&quot;&gt;configurations&lt;/span&gt;)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    context.start&lt;span class=&quot;literal&quot;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return context;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;xspring-core组件还提供了一个基于Google Guava库的事件总线模型，有兴趣的朋友可直接参考&lt;code&gt;org.xspring.core.eventbus&lt;/code&gt;包下的相关源码。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Java" scheme="http://cloudnoter.com/categories/Java/"/>
    
    
    <category term="Spring" scheme="http://cloudnoter.com/tags/Spring/"/>
    
    <category term="SpringBoot" scheme="http://cloudnoter.com/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>《推荐系统实践》笔记--好的推荐系统</title>
    <link href="http://cloudnoter.com/2017/05/16/%E3%80%8A%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E8%B7%B5%E3%80%8B%E7%AC%94%E8%AE%B0-%E5%A5%BD%E7%9A%84%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/"/>
    <id>http://cloudnoter.com/2017/05/16/%E3%80%8A%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E8%B7%B5%E3%80%8B%E7%AC%94%E8%AE%B0-%E5%A5%BD%E7%9A%84%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/</id>
    <published>2017-05-15T21:50:34.000Z</published>
    <updated>2017-05-15T14:33:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是推荐系统"><a href="#什么是推荐系统" class="headerlink" title="什么是推荐系统"></a>什么是推荐系统</h2><p>建立用户与物品之间的联系：在用户没有明确目的的情况下帮助他们发现感兴趣的物品；为物品找到可能对它们感兴趣的用户。</p><h2 id="个性化推荐系统的应用"><a href="#个性化推荐系统的应用" class="headerlink" title="个性化推荐系统的应用"></a>个性化推荐系统的应用</h2><p>个性化推荐的成功应用需要两个条件：</p><blockquote><ul><li>存在信息过载</li><li>用户大部分时候没有特别明确的需求</li></ul></blockquote><ol><li>电子商务：Amazon、阿里</li><li>电影和视频网站：Netflix、Youtube</li><li>个性化音乐网络电台：Pandora、Last.fm、豆瓣电台<ul><li>个性化音乐推荐的特点<ul><li> 物品空间大（相对书与电影而言）</li><li> 消费每首歌的代价很小</li><li> 物品种类丰富</li><li> 听一首歌耗时很少</li><li> 物品重用率很高（每首歌用户会听很多遍）</li><li> 用户充满激情</li><li> 上下文相关</li><li> 次序很重要</li><li> 很多播放列表资源</li><li> 不需要用户全神贯注</li><li> 高度社会化</li></ul></li></ul></li><li>社交网络：Facebook、twitter、weixin、weibo</li><li>个性化阅读：GoogleReader、Flipboard、Zite、Digg</li><li>基于位置的服务（LBS）</li><li>个性化邮件</li><li>个性化广告<ul><li>个性化广告投放技术分三种<ul><li>上下文广告：如google的Adsense</li><li>搜索广告</li><li>个性化展示广告：如雅虎</li></ul></li></ul></li></ol><blockquote><p>延伸阅读：</p><ul><li>Pandora研究人员<a href="http://www.slideshare.net/plamere/music-recommendation-and-discovery">关于音乐个性化推荐的演讲PPT</a></li><li>搜索雅虎公司发表的与个性化广告有关的论文</li></ul></blockquote><span id="more"></span><h2 id="推荐系统评测"><a href="#推荐系统评测" class="headerlink" title="推荐系统评测"></a>推荐系统评测</h2><p>一个完整的推荐系统的参与者：用户、物品提供者、提供推荐系统的网站。在评测一个推荐算法时，需要同时考虑三方的利益，一个好的推荐系统是能够令三方共赢的系统。好的推荐系统不但能够准确预测用户的行为，而且能够扩展用户的视野，帮助用户发现那些他们可能会感兴趣，但却不那么容易发现的东西。同时，推荐系统不要能够帮助商家将那些被埋没在长尾中的好商品介绍给可能会对它们感兴趣的用户。</p><h3 id="推荐系统实验方法"><a href="#推荐系统实验方法" class="headerlink" title="推荐系统实验方法"></a>推荐系统实验方法</h3><ol><li>离线实验</li><li>用户调查</li><li>在线实验</li></ol><p>一般来说，一个新的推荐算法最终上线，需要完成上面所说的三个实验：</p><ul><li>首先，需要通过离线实验证明它在很多离线指标上优于现有的算法。</li><li>然后，需要通过用户调查确定它的用户满意度不低于现有算法。</li><li>最后，通过在线的AB测试确定它在我们关心的指标上优于现有的算法。</li></ul><h3 id="评测指标"><a href="#评测指标" class="headerlink" title="评测指标"></a>评测指标</h3><ol><li><p>用户满意度</p></li><li><p>预测准确度：最重要的离线评测指标，根据离线推荐算法的不同研究方向，有相应更具体的预测准确度指标。</p><ul><li>评分预测：预测用户对物品评分的行为称为评分预测。评分预测的预测准确率一般通过均方根误差（RMSE）、平均绝对误差（MAE）计算。<br>$$RMSE=\sqrt{\frac{\sum_{u,i \in T}(r_{ui} - \hat{r}_{ui})^2}{|T|}}$$<br>$$MAE=\frac{\sum_{u,i \in T}|r_{ui} - \hat{r}_{ui}|}{|T|}$$</li><li>TopN推荐：网站在提供推荐服务时，一般是给用户一个个性化的推荐列表，这种推荐称为TopN推荐。TopN推荐的预测准确率一般通过<code>准确率(precision)/召回率(recall)</code>度量。<br>$$Recall=\frac{\sum_{u \in U}|R(u) \cap T(u)|}{\sum_{u \in U}|T(u)|}$$<br>$$Precision=\frac{\sum_{u \in U}|R(u) \cap T(u)|}{\sum_{u \in U}|R(u)|}$$</li></ul></li><li><p>覆盖率：描述一个推荐系统对物品长尾的发掘能力。覆盖率有不同的定义，最简单的定义为推荐系统能够推荐出来的物品占总物品集合的比例。<br>$$Coverage=\frac{|\bigcup_{u \in U}R(u)|}{|I|}$$<br>上面的定义过于粗略，在信息论与经济学中有两个著名的指标可以用来定义覆盖率，第一个是信息熵：<br>$$H=-\sum_{i=1}^{n}p(i)\log_{2}p(i)$$这里的p(i)是物品i的流行度除以所有商品流行度之和。第二个指标是基尼系数(Gini Index)：<br>$$G=\frac{1}{n - 1} \sum_{j=1}^{n}(2j - n - 1)p(i_j)$$这里$i_j$是按照物品流行度p()从小到大排序的物品列表中第j个物品。</p></li><li><p>多样性：<br>用户u的推荐列表的多样性的计算公式：<br>$$Diversity(R(u))=1 - \frac{\sum_{i,j \in R(u), i \neq j}s(i,j)}{\frac{1}{2}|R(u)|(|R(u)| - 1)}$$<br>推荐系统的整体多样性的计算公式：<br>$$Diversity=\frac{1}{|U|}\sum_{u \in U}Diversity(R(u))$$</p></li><li><p>新颖性</p></li><li><p>惊喜度</p></li><li><p>信任度</p></li><li><p>实时性</p></li><li><p>健壮性</p></li><li><p>商业目标</p></li></ol><p>获取各种评测指标的途径如下表：</p><table><thead><tr><th align="center">-</th><th align="center">离线实验</th><th align="center">问卷调查</th><th align="center">在线实验</th></tr></thead><tbody><tr><td align="center">用户满意度</td><td align="center">N</td><td align="center">Y</td><td align="center">O</td></tr><tr><td align="center">预测准确度</td><td align="center">Y</td><td align="center">Y</td><td align="center">N</td></tr><tr><td align="center">覆盖率</td><td align="center">Y</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td align="center">多样性</td><td align="center">O</td><td align="center">Y</td><td align="center">O</td></tr><tr><td align="center">新颖性</td><td align="center">O</td><td align="center">Y</td><td align="center">O</td></tr><tr><td align="center">惊喜度</td><td align="center">N</td><td align="center">Y</td><td align="center">N</td></tr></tbody></table><h3 id="评测维度"><a href="#评测维度" class="headerlink" title="评测维度"></a>评测维度</h3><p>比如一个推荐算法虽然整体上性能不好，但可能在某种特定场景下性能比较好，而增加评测维度的目的就是为了知道一个算法在什么情况下性能最好。这样可以为融合不同推荐算法取得最好的整体性能带来参考。</p><ul><li>用户维度：主要包括用户的人口统计学信息、活跃度以及是不是新用户等。</li><li>物品维度：包括物品的属性信息、流行度、平均分以及是不是新加入的物品等。</li><li>时间维度：包括季节，是工作日还是周末，是白天还是晚上等。</li></ul><p>在推荐系统评测报告中包含不同维度下的系统评测指标，就能帮助我们全面地了解推荐系统性能，力争在弱势算法中找优点，优势算法中找缺点。</p><h2 id="进一步阅读"><a href="#进一步阅读" class="headerlink" title="进一步阅读"></a>进一步阅读</h2><ol><li>O’scar Celma的博士论文：<a href="http://mtg.upf.edu/static/media/PhD_ocelma.pdf">Music Recommendation and Discovery in the Long Tail</a></li><li>ACM的推荐系统会议在2011年有一个专门的研讨会<a href="http://ir.ii.uam.es/divers2011">讨论推荐的多样性与新颖性</a></li><li>惊喜度相关论文：<a href="http://www.cs.ucl.ac.uk/fileadmin/UCL-CS/research/Research_Notes/RN_11_21.pdf">Auralist: Introducing Serendipity into Music Recommendation</a>，<a href="https://philpapers.org/rec/MURMFE">Metrics for evaluating the serendipity of recommendation lists</a>，<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.464.8494&rep=rep1&type=pdf">Evaluating Recommender Systems by Coverage and Serendipity</a></li><li>关于<a href="https://wenku.baidu.com/view/fc422cf40242a8956bece479.html?re=view">推荐系统健壮性的教程</a></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;什么是推荐系统&quot;&gt;&lt;a href=&quot;#什么是推荐系统&quot; class=&quot;headerlink&quot; title=&quot;什么是推荐系统&quot;&gt;&lt;/a&gt;什么是推荐系统&lt;/h2&gt;&lt;p&gt;建立用户与物品之间的联系：在用户没有明确目的的情况下帮助他们发现感兴趣的物品；为物品找到可能对它们感兴趣的用户。&lt;/p&gt;
&lt;h2 id=&quot;个性化推荐系统的应用&quot;&gt;&lt;a href=&quot;#个性化推荐系统的应用&quot; class=&quot;headerlink&quot; title=&quot;个性化推荐系统的应用&quot;&gt;&lt;/a&gt;个性化推荐系统的应用&lt;/h2&gt;&lt;p&gt;个性化推荐的成功应用需要两个条件：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;存在信息过载&lt;/li&gt;
&lt;li&gt;用户大部分时候没有特别明确的需求&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;电子商务：Amazon、阿里&lt;/li&gt;
&lt;li&gt;电影和视频网站：Netflix、Youtube&lt;/li&gt;
&lt;li&gt;个性化音乐网络电台：Pandora、Last.fm、豆瓣电台&lt;ul&gt;
&lt;li&gt;个性化音乐推荐的特点&lt;ul&gt;
&lt;li&gt; 物品空间大（相对书与电影而言）&lt;/li&gt;
&lt;li&gt; 消费每首歌的代价很小&lt;/li&gt;
&lt;li&gt; 物品种类丰富&lt;/li&gt;
&lt;li&gt; 听一首歌耗时很少&lt;/li&gt;
&lt;li&gt; 物品重用率很高（每首歌用户会听很多遍）&lt;/li&gt;
&lt;li&gt; 用户充满激情&lt;/li&gt;
&lt;li&gt; 上下文相关&lt;/li&gt;
&lt;li&gt; 次序很重要&lt;/li&gt;
&lt;li&gt; 很多播放列表资源&lt;/li&gt;
&lt;li&gt; 不需要用户全神贯注&lt;/li&gt;
&lt;li&gt; 高度社会化&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;社交网络：Facebook、twitter、weixin、weibo&lt;/li&gt;
&lt;li&gt;个性化阅读：GoogleReader、Flipboard、Zite、Digg&lt;/li&gt;
&lt;li&gt;基于位置的服务（LBS）&lt;/li&gt;
&lt;li&gt;个性化邮件&lt;/li&gt;
&lt;li&gt;个性化广告&lt;ul&gt;
&lt;li&gt;个性化广告投放技术分三种&lt;ul&gt;
&lt;li&gt;上下文广告：如google的Adsense&lt;/li&gt;
&lt;li&gt;搜索广告&lt;/li&gt;
&lt;li&gt;个性化展示广告：如雅虎&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;延伸阅读：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pandora研究人员&lt;a href=&quot;http://www.slideshare.net/plamere/music-recommendation-and-discovery&quot;&gt;关于音乐个性化推荐的演讲PPT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;搜索雅虎公司发表的与个性化广告有关的论文&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="读书" scheme="http://cloudnoter.com/categories/%E8%AF%BB%E4%B9%A6/"/>
    
    
    <category term="推荐系统" scheme="http://cloudnoter.com/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper Administrator&#39;s Guide中文版</title>
    <link href="http://cloudnoter.com/2017/05/08/ZooKeeper-Administrator-s-Guide%E4%B8%AD%E6%96%87%E7%89%88/"/>
    <id>http://cloudnoter.com/2017/05/08/ZooKeeper-Administrator-s-Guide%E4%B8%AD%E6%96%87%E7%89%88/</id>
    <published>2017-05-07T19:03:24.000Z</published>
    <updated>2017-05-13T15:28:29.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>本文档主要介绍ZooKeeper部署及日常管理</p></blockquote><h2 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h2><p>本章节包含与ZooKeeper部署有关的内容，具体来说包含下面三部分内容：</p><ul><li><a href="#1.1">系统软硬件需求</a></li><li><a href="#1.2">集群部署（安装）</a></li><li><a href="#1.3">单机开发环境部署（安装）</a></li></ul><p>前两部分主要介绍如何在数据中心等生产环境上安装部署ZooKeeper，第三部分则介绍如何在非生产环境上（如为了评估、测试、开发等目的）安装部署ZooKeeper。</p><h3 id="系统软硬件需求"><a href="#系统软硬件需求" class="headerlink" title="系统软硬件需求"></a>系统软硬件需求<span id="1.1"></span></h3><h4 id="支持的OS平台"><a href="#支持的OS平台" class="headerlink" title="支持的OS平台"></a>支持的OS平台</h4><p>ZooKeeper框架由多个组件组成，有的组件支持全部平台，而还有一些组件只支持部分平台，详细支持情况如下：</p><ul><li><strong>Client：</strong>它是一个<code>Java</code>客户端连接库，上层应用系统通过它连接至ZooKeeper集群。</li><li><strong>Server：</strong>它是运行在ZooKeeper集群节点上的一个<code>Java</code>后台服务程序。</li><li><strong>Native Client：</strong>它是一个用<code>C</code>语言实现的客户端连接库，其与<code>Java</code>客户端库一样，上层应用（非<code>Java</code>实现）通过它连接至ZooKeeper集群。</li><li><strong>Contrib：</strong>它是指多个可选的扩展组件。</li></ul><table><thead><tr><th align="left">操作系统</th><th align="center">Client</th><th align="center">Server</th><th align="center">Native Client</th><th align="center">Contrib</th></tr></thead><tbody><tr><td align="left">GNU/Linux</td><td align="center">D + P</td><td align="center">D + P</td><td align="center">D + P</td><td align="center">D + P</td></tr><tr><td align="left">Solaris</td><td align="center">D + P</td><td align="center">D + P</td><td align="center">/</td><td align="center">/</td></tr><tr><td align="left">FreeBSD</td><td align="center">D + P</td><td align="center">D + P</td><td align="center">/</td><td align="center">/</td></tr><tr><td align="left">Windows</td><td align="center">D + P</td><td align="center">D + P</td><td align="center">/</td><td align="center">/</td></tr><tr><td align="left">Mac OS X</td><td align="center">D</td><td align="center">D</td><td align="center">/</td><td align="center">/</td></tr></tbody></table><span id="more"></span><blockquote><p><strong>D：支持开发环境， P：支持生成环境， /：不支持任何环境</strong></p></blockquote><p>上表中未显式注明支持的组件在相应平台上可能不能正常运行。虽然ZooKeeper社区会尽量修复在未支持平台上发现的BUG，但并无法保证会修复全部BUG。</p><h4 id="软件要求"><a href="#软件要求" class="headerlink" title="软件要求"></a>软件要求</h4><p>ZooKeeper需要运行在JDK6或以上版本中。若ZooKeeper以集群模式部署，则推荐的节点数至少为3，同时建议部署在独立的服务器上。在Yahoo!，ZooKeeper通常部署在运行RHEL系统的服务器上（服务器配置：双核CPU、2G内存、80G容量IDE硬盘）。</p><h3 id="集群部署（安装）"><a href="#集群部署（安装）" class="headerlink" title="集群部署（安装）"></a>集群部署（安装）<span id="1.2"></span></h3><p>为了保证ZooKeeper服务的可靠性，您应该以集群模式部署ZooKeeper服务。只要半数以上的集群节点在线，服务将是可用的。因为ZooKeeper需要半数以上节点同意才能选举出Leader，所以建议ZooKeeper集群的节点数为奇数个。举个例子，对于有四个节点的集群只能应付一个节点宕机的异常，如果有两个节点宕机，则剩下两个节点未达到法定的半数以上选票，ZooKeeper服务将变为不可用。而如果集群有五个节点，则集群就可以应付二个节点宕机的异常。</p><blockquote><p><strong>提示：</strong><br>正如<a href="https://zookeeper.apache.org/doc/r3.4.10/zookeeperStarted.html">《ZooKeeper快速入门》</a>文档中所提到的，至少需要三个节点的ZooKeeper集群才具备容灾特性，因此我们强烈建议集群节点数为奇数。<br>通常情况下，生产环境下，集群节点数只需要三个。但如果为了在服务维护场景下也保证最大的可靠性，您也许会部署五个节点的集群。原因很简单，如果集群节点为三个，当你对其中一个节点进行维护操作，将很有可能因维护操作导致集群异常。而如果集群节点为5个，那你可以直接将维护节点下线，此时集群仍然可正常提供服务（就算四个节点中的任意一个突然宕机）。<br>您的冗余措施应该包括生产环境的各个方面。如果你部署三个节点的ZooKeeper集群，但你却将这三个节点都连接至同一个网络交换机，那么当交换机宕掉时，你的集群服务也一样是不可用的。</p></blockquote><p>关于如何配置服务器使其成为集群中的一个成员节点的详细步骤如下（每个节点的操作类似）：</p><ul><li>1.安装JDK，你可以使用本地包管理系统安装，也可以从JDK官网<a href="http://java.sun.com/javase/downloads/index.jsp">下载</a></li><li>2.设置Java堆相关参数，这对于避免内存swap来说非常重要。因为频繁的swap将严重降低ZooKeeper集群的性能。您可以通过使用压力负载测试来决定一个合适的值，确保该值刚好低于触发swap的阈值。保守的做法是：当节点拥有4G的内存，则设置-xmx=3G。</li><li>3.安装ZooKeeper，您可以从<a href="http://zookeeper.apache.org/releases.html">官网</a>下载：<a href="http://zookeeper.apache.org/releases.html">http://zookeeper.apache.org/releases.html</a></li><li>4.创建一个配置文件，这个文件可以随便命名，您可以先使用如下设置参数：</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tickTime</span>=<span class="number">2000</span></span><br><span class="line"><span class="attribute">dataDir</span>=/var/lib/zookeeper/</span><br><span class="line"><span class="attribute">clientPort</span>=<span class="number">2181</span></span><br><span class="line"><span class="attribute">initLimit</span>=<span class="number">5</span></span><br><span class="line"><span class="attribute">syncLimit</span>=<span class="number">2</span></span><br><span class="line"><span class="attribute">server</span>.<span class="number">1</span>=zoo<span class="number">1</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line"><span class="attribute">server</span>.<span class="number">2</span>=zoo<span class="number">2</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line"><span class="attribute">server</span>.<span class="number">3</span>=zoo<span class="number">3</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br></pre></td></tr></table></figure><blockquote><p>您可以在<a href="#2.10">配置参数</a>章节中找到上面这些参数及其他参数的解释说明。这里简要说一下：集群中的每个节点都需要知道集群中其它节点成员的连接信息。通过上述配置文件中格式为<code>server.id=host:port:port</code>的若干行配置信息您就可以实现这个目标。<code>host</code>与<code>port</code>意思很简单明了，不多作说明。而<code>server.$&#123;id&#125;</code>代表节点ID，你需要为每个节点创建一个名为<code>myid</code>的文件，该文件存放于参数<code>dataDir</code>所指向的目录下。</p></blockquote><ul><li>5.<code>myid</code>文件的内容只有一行，其值为配置参数<code>server.$&#123;id&#125;</code>中<code>$&#123;id&#125;</code>的实际值。即服务器1对应的<code>myid</code>文件的内容为1，这个值在集群中必须保证其唯一性，同时必须处于[1, 255]之间。</li><li>6.如果你已经创建好配置文件（如zoo.cfg），你就可以启动ZooKeeper服务：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ java -cp zookeeper<span class="selector-class">.jar</span>:lib/slf4j-api-<span class="number">1.6</span>.<span class="number">1</span><span class="selector-class">.jar</span>:lib/</span><br><span class="line">slf4j-log4j12-<span class="number">1.6</span>.<span class="number">1</span><span class="selector-class">.jar</span>:lib/log4j-<span class="number">1.2</span>.<span class="number">15</span><span class="selector-class">.jar</span>:conf \</span><br><span class="line">org<span class="selector-class">.apache</span><span class="selector-class">.zookeeper</span><span class="selector-class">.server</span><span class="selector-class">.quorum</span><span class="selector-class">.QuorumPeerMain</span> zoo.cfg</span><br></pre></td></tr></table></figure><blockquote><p>QuorumPeerMain启动一个ZooKeeper服务，JMX管理bean也同时被注册，通过这些JMX管理bean，你就可以在JMX管理控制台上对ZooKeeper服务进行监控管理。ZooKeeper的<a href="https://zookeeper.apache.org/doc/r3.4.10/zookeeperJMX.html">JMX文档</a>有更详细的介绍信息。同时，你也可以在<code>$ZOOKEEPER_HOME/bin</code>目录下找到ZooKeeper的启动脚本<code>zkServer.sh</code>。</p></blockquote><ul><li>7.接下来你就可以连接至ZooKeeper节点来测试部署是否成功。<br>在<code>Java</code>环境下，你可以运行下面的命令连接至已启动的ZooKeeper服务节点并执行一些简单的操作</li></ul><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/zkCli.sh -<span class="keyword">server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">2181</span></span><br></pre></td></tr></table></figure><h3 id="单机开发环境部署介绍"><a href="#单机开发环境部署介绍" class="headerlink" title="单机开发环境部署介绍"></a>单机开发环境部署介绍<span id="1.3"></span></h3><p>如果你想部署ZooKeeper以便于开发测试，那你可以使用单机部署模式。然后安装Java或C客户端连接库，同时在配置文件中将服务器信息与开发机绑定。<br>具体安装部署步骤也集群部署模式类似，唯一不同的是zoo.cfg配置文件更简单一些。你可以从<a href="https://zookeeper.apache.org/doc/r3.4.10/zookeeperStarted.html">《ZooKeeper快速入门》</a>文档中的相关章节获取详细的操作步骤。<br>关于安装客户端连接库的相关信息，你可以从<a href="https://zookeeper.apache.org/doc/r3.4.10/zookeeperProgrammers.html">ZooKeeper Programmer’s Guide</a>文件的Bindings章节中获取。</p><h2 id="维护管理"><a href="#维护管理" class="headerlink" title="维护管理"></a>维护管理</h2><p>这部分包含ZooKeeper运行与维护相关的信息，其包含如下几个主题：</p><ul><li><a href="#2.1">ZooKeeper集群部署规划</a></li><li><a href="#2.2">Provisioning</a></li><li><a href="#2.3">ZooKeeper的强项与使用限制</a></li><li><a href="#2.4">管理</a></li><li><a href="#2.5">维护</a></li><li><a href="#2.6">Supervision</a></li><li><a href="#2.7">Monitoring</a></li><li><a href="#2.8">日志</a></li><li><a href="#2.9">疑难解答</a></li><li><a href="#2.10">配置参数（高级配置）</a></li><li><a href="#2.11">ZooKeeper命令: 4字符命令</a></li><li><a href="#2.12">数据文件管理</a></li><li><a href="#2.13">避免踩坑</a></li><li><a href="#2.14">最佳实践</a></li></ul><h3 id="ZooKeeper集群部署规划"><a href="#ZooKeeper集群部署规划" class="headerlink" title="ZooKeeper集群部署规划"></a>ZooKeeper集群部署规划<span id="2.1"></span></h3><p>ZooKeeper可靠性依赖于两个基本的假设：</p><ul><li>一个集群中只会有少数服务器会出错，这里的出错是指宕机或网络异常而使得服务与集群中的多数服务器失去联系。</li><li>已部署的机器可以正常运行，所谓正常运行是指所有代码可以正确的执行，有适当且一致的工作时钟、存储、网络。</li></ul><p>为了最大可能的保证上述两个前提假设能够成立，这里有几个点需要考虑。一些是关于跨服务器（节点之间）需求的，而另一些是关于集群中每个节点服务器的考虑。</p><h4 id="跨机器要求"><a href="#跨机器要求" class="headerlink" title="跨机器要求"></a>跨机器要求</h4><p>为了启用ZooKeeper服务，集群中半数以上的节点需要能够相互通信。为了创建一个可以支撑F个节点异常的集群，你需要部署2xF+1个节点。即一个包含三个节点的集群可以应对一个节点异常的情况，一个包含五个节点的集群则可以应对二个节点异常的情况，依此类推。需要注意的是，一个包含六个节点的集群也只能应对二个节点失败的情况，因为三个节点并未超过半数。因此，ZooKeeper集群中的节点数通常为奇数。</p><p>为了实现最大限度的容灾能力，你应该尽力使集群节点发生异常时不影响其它节点（即保持节点部署上尽可能的独立）。举个例子，当大部分的机器共享同一个交换机，若这个交换机挂了将使关联的服务都下线。共享电源电路、冷却系统等也是同样的道理（有同样的单点问题）。</p><h4 id="单机要求"><a href="#单机要求" class="headerlink" title="单机要求"></a>单机要求</h4><p>如果ZooKeeper服务需要与其它应用竞争存储、CPU、网络、内存等资源时，其性能将显著下降。机器必须为ZooKeeper服务提供持久化保障，因为ZooKeeper需要先使用存储设备来保存变更日志，然后才允许变更操作提交。如果你想确保ZooKeeper操作不会因存储而挂起，那你应该意识到这个依赖关系并重视起来。这里有几个事情可以最小化这类问题所带来的消极影响。</p><ul><li>ZooKeeper的事务日志必须存储在专用的设备上（一个专用分区是不够的）ZooKeeper以串行的方式写入日志。如果与其它进程共享日志存储设备将导致磁盘寻址与IO竞争，这最终将导致几秒的时延。</li><li>不要将Zookeeper放置在可能引起swap的环境。为了保证Zookeeper的实时性，它几乎不允许swap。因此，请确保分配给ZooKeeper的最大堆内存大小不能大于ZooKeeper可用的真实的内存大小。关于这一点的更多信息，请参数后续章节 <a href="#2.13">Things to Avoid</a>。</li></ul><h3 id="Provisioning"><a href="#Provisioning" class="headerlink" title="Provisioning"></a><span id="2.2"></span>Provisioning</h3><p>无</p><h3 id="ZooKeeper的优势与局限"><a href="#ZooKeeper的优势与局限" class="headerlink" title="ZooKeeper的优势与局限"></a><span id="2.3"></span>ZooKeeper的优势与局限</h3><p>无</p><h3 id="管理"><a href="#管理" class="headerlink" title="管理"></a><span id="2.4"></span>管理</h3><p>无</p><h3 id="维护"><a href="#维护" class="headerlink" title="维护"></a><span id="2.5"></span>维护</h3><p>ZooKeeper的长期维护需求几乎没有，然而你仍然需要注意如下几件事情：</p><h4 id="持续的数据目录清理"><a href="#持续的数据目录清理" class="headerlink" title="持续的数据目录清理"></a>持续的数据目录清理</h4><p>ZooKeeper的数据目录包含集群上特殊存储结点znode数据的持久化拷贝文件。文件中包含快照与事务日志文件。znode上数据的变更将同时会被追加至事务日志中。当这些日志不断增长时，所有znode的当前状态的快照文件将被写回文件系统。这个快照将取代之前的日志。</p><p>ZooKeeper服务器默认情况下不会移除旧的快照与日志文件，删除快照与日志这项工作是管理员的责任。因为每个服务环境是不一样的，所以管理这些快照与文件的需求也是不同一。<code>PurgeTxnLog</code>工具实现了一个简单的保留策略，管理员可以使用这个工具，<a href="https://zookeeper.apache.org/doc/r3.4.10/api/index.html">API docs</a> 中包含有详细的使用说明。<br>下面的例子的作用为：保留最近<code>&lt;count&gt;</code>个快照及相关的日志，其它的快照及相关日志则删除。<code> &lt;count&gt;</code>的值通常要大于3（虽然不是必须的，但提供3个备份时将极大降低日志损坏的可能性）。您可以在ZooKeeper服务器上运行<code>cron</code>脚本来每天清除过期日志。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ java -cp zookeeper<span class="selector-class">.jar</span>:lib/slf4j-api-<span class="number">1.6</span>.<span class="number">1</span><span class="selector-class">.jar</span>:lib/slf4j-log4j12-<span class="number">1.6</span>.<span class="number">1</span><span class="selector-class">.jar</span>:lib/</span><br><span class="line">log4j-<span class="number">1.2</span>.<span class="number">15</span><span class="selector-class">.jar</span>:conf org<span class="selector-class">.apache</span><span class="selector-class">.zookeeper</span><span class="selector-class">.server</span><span class="selector-class">.PurgeTxnLog</span> &lt;dataDir&gt; &lt;snapDir&gt; -n &lt;count&gt;</span><br></pre></td></tr></table></figure><p>在V3.4.0版本中引入的自动清除快照及相关事务日志的特性可以通过配置参数<code>autopurge.snapRetainCount</code> 与 <code>autopurge.purgeInterval</code>来启用。更多的使用见后续的<a href="#2.10">配置参数（高级配置）</a>章节。</p><h4 id="调试日志清理-log4j"><a href="#调试日志清理-log4j" class="headerlink" title="调试日志清理 (log4j)"></a>调试日志清理 (log4j)</h4><p>通过本文档的<a href="#2.8">日志</a>章节可知，ZooKeeper将使用Log4j内置的日志滚动覆盖功能最多生成N个日志文件。Log4j的配置示例可在发行版本tar包的<code>conf/log4j.properties</code>文件中找到。</p><h3 id="Supervision"><a href="#Supervision" class="headerlink" title="Supervision"></a><span id="2.6"></span>Supervision</h3><p>你需要一个监督进程来管理ZooKeeper服务进程（本质上为一个Java进程）。ZooKeeper服务具有“快速失败”的特性，即只要服务发生不可恢复的错误，则ZK进程直接退出。因为ZK集群是高可用的，所有集群中的一个ZK服务虽然异常退出了，但整个集群仍然是可用的，仍然可对外提供服务。同时由于集群可以自行恢复特性，一旦此前异常退出的服务器重启后，它将自动重新加入集群中而不需要任何的人工干预。</p><p>因此，我们就需要一个类似<code>daemontools或SMF</code>的工具来管理ZK服务，确保进程异常退出后可以自动被重启并快速重新加入集群。</p><h3 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a><span id="2.7"></span>Monitoring</h3><p>ZK服务可以使用如下两种方式进行监控：</p><ul><li>ZK提供的4个字母的命令工具</li><li>JMX（详见ZK官网提供的JMX相关文档）</li></ul><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a><span id="2.8"></span>日志</h3><p>ZK使用V1.2版本的Log4j作为其日志组件。ZK默认的日志配置文件位于发行版本的conf目录下。Log4j需要<code>log4j.properties</code>文件，这个文件要么位于ZK运行时所在的目录，要么位于classpath目录。</p><p>更多的信息见 <a href="http://logging.apache.org/log4j/1.2/manual.html#defaultInit">Log4j Default Initialization Procedure</a> 。</p><h3 id="疑难解答"><a href="#疑难解答" class="headerlink" title="疑难解答"></a><span id="2.9"></span>疑难解答</h3><p><strong>文件损坏导致服务器无法启动问题</strong><br>ZK服务器可能会因无法正常读取数据导致启动失败。出现这个问题可能是因为ZK服务器上的事务日志文件损坏了。你可以从ZK的log4j日志中看到一些与ZK数据加载相关的<code>IOException</code>异常。在这种情况下，首先确保集群中的其他服务器能正常工作。可以使用<code>stat</code>命令查看它们是否处于健康状态。当你已经确认集群中其它服务器都在运行中，你可以进一步清理异常中断的服务器上的数据库：删除<code>$data_dir/version-2</code>目录与<code>$data_log_dir/version-2</code>目录下的内容，然后重启服务即可。</p><h3 id="配置参数（高级配置）"><a href="#配置参数（高级配置）" class="headerlink" title="配置参数（高级配置）"></a><span id="2.10"></span>配置参数（高级配置）</h3><p>ZooKeeper的行为是由其配置文件<code>$ZK_HOME\conf\zoo.cfg</code>来控制的。由于这个配置文件是设计好的，因此当ZK集群中每个成员的部署结构（磁盘路径等）都一样时，这个配置文件可以被所有成员共用。如果成员服务器使用不同的配置文件，一定要注意保证各个服务器的配置文件的服务器列表信息是匹配的。</p><h4 id="最简（小）配置"><a href="#最简（小）配置" class="headerlink" title="最简（小）配置"></a>最简（小）配置</h4><p>下面是部署一个ZK集群时，配置文件必须要设置的参数信息（最简配置）：<br><strong>clientPort</strong><br>客户端连接监听端口，即客户端发起连接请求时，都会尝试连接至ZK服务器的该端口。<br><strong>dataDir</strong><br>ZK内存数据库快照的保存位置，除非另有规定，否则事务日志也会保存至该位置。</p><blockquote><p>一定要注意事务日志的存储位置。一个专用的事务日志设备是保证高性能的关键。如果将事务日志存放于IO比较频繁的设备将产生不利的性能效果。</p></blockquote><p><strong>tickTime</strong></p><p>计时时间片长度（单位：毫秒），它是ZK中所有与时间有关参数的基本时间单元（即当某参数的值为X，则其语义可这样理解：某参数的值为tickTime的X倍）。它通常用于日常的心跳发送周期、超时时间等。<br>比如，当<code>tickTime=2000,minSessionTimeout=2</code>，<br>则会话超时的最小值为：<code>tickTime*minSessionTimeout=4000ms</code>。</p><h4 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h4><p>本节所介绍的配置参数是可选的。你可以使用它们进一步调整ZK集群的行为。有些参数也可以通过形如<code>zookeeper.keyword</code>之类的Java系统属性的方式来配置。下面的参数详细介绍中有标明哪些参数可以通过Java系统属性方式配置。</p><p><strong>dataLogDir</strong></p><p>这个选项会让机器将事务日志直接写到dataLogDir所指定的位置，而不再是默认的dataDir。这将允许使用专用的日志设备，同时可有效避免快照操作与日志操作所带来的IO竞争。</p><blockquote><p>使用专用的日志设备将极大的影响系统吞吐量与系统时延。强烈推荐使用专用的日志设备，并将dataLogDir指向该专用设备的一个目录，然后也要确保dataDir参数所指向的目录未指向专用的日志设备。</p></blockquote><p><strong>globalOutstandingLimit</strong><br>(Java系统属性: zookeeper.globalOutstandingLimit)</p><p>客户端提交的请求数通过会比ZK的处理速度快，特别是存在大量客户端连接的情况。为了防止因队列中的请求数多过导致ZK运行过程中出现内存溢出问题，ZK将控制客户端的请求数，这样将可以保证系统请求数不会多于<code>globalOutstandingLimit</code>参数所指定的值，系统默认值为1000。</p><p><strong>preAllocSize</strong><br>(Java系统属性: zookeeper.preAllocSize)</p><p>To avoid seeks ZooKeeper allocates space in the transaction log file in blocks of preAllocSize kilobytes. The default block size is 64M. One reason for changing the size of the blocks is to reduce the block size if snapshots are taken more often. (Also, see snapCount).</p><p><strong>snapCount</strong><br>(Java系统属性: zookeeper.snapCount)</p><p>ZK将事务写入事务日志文件中。当<code>snapCount</code>个事务被写入日志文件后，ZK将创建一个快照，然后一个新的事务日志文件会被创建。该参数的默认值为:100000。</p><p><strong>maxClientCnxns</strong></p><p>限制同一个客户端连接（通过IP标识唯一性）至一个ZK集群节点的并发连接数（Socket级别）。这个参数主要是用来防止某些类型的DoS攻击，包括<code>file-descriptor exhaustion</code>。该参数默认值为60，如果设置为0则意味着关闭并发控制限制功能。</p><p><strong>clientPortAddress</strong></p><p><strong>V3.3.0引入</strong>: 客户端连接监听地址（IPv4,IPv6,主机名）， 这个参数是可选的。默认情况下，所有连接至<code>clientPort</code>参数指定端口号的连接都会被接受，不管这些连接是来自于哪个网络接口。</p><p><strong>minSessionTimeout</strong></p><p><strong>V3.3.0引入</strong>: 最小会话超时时间（毫秒），在会话期间服务器将允许来自客户端的协商。该参数默认值为2倍的tickTime。</p><p><strong>maxSessionTimeout</strong></p><p><strong>V3.3.0引入</strong>: 最小会话超时时间（毫秒），在会话期间服务器将允许来自客户端的协商。该参数默认值为20倍的tickTime。</p><p><strong>fsync.warningthresholdms</strong><br>(Java系统属性: zookeeper.fsync.warningthresholdms)</p><p><strong>V3.3.4引入</strong>: 当事务日志(WAL)中的<code>fsync</code>操作时间超过该参数所设置的值时，一个告警信息将被输出到log4j日志中。该参数默认值为1000毫秒，该值只能通过系统属性的方式设置。</p><p><strong>autopurge.snapRetainCount</strong></p><p><strong>V3.4.0引入</strong>: 当启用该参数时，ZK将仅保留dataDir与dataLogDir目录下最近的快照及事务日志数据，保留的数量由该参数设置值决定；然后清除其它过期数据。默认值为3，最小值为3。</p><p><strong>autopurge.purgeInterval</strong></p><p><strong>V3.4.0引入</strong>: 以小时为单位的时间间隔，即每隔N小时将触发一次快照及事务日志清理任务。设置一个正数（大于等于1）即可启用自动清理功能，默认值为0。</p><p><strong>syncEnabled</strong><br>(Java系统属性: zookeeper.observer.syncEnabled)</p><p><strong>V3.4.6, V3.5.0引入</strong>: 集群中角色为observer的成员实时的将事务日志与快照数据写回磁盘，就好像它们是业务的参与者一样。这将减少这些成员的重启恢复时间。如果将这个参数设置为<code>false</code>，将禁用这个特性。默认为<code>true</code>。</p><p><strong>与集群有关的参数选项</strong><br>本节所介绍的参数选项主要用于服务器集群中，也就是说当部署一个集群时可以使用这些参数。</p><p><strong>electionAlg</strong></p><p>配置集群使用的选举算法。0值代表基于UDP的版本，1值代表基于UDP的无认证的快速Leader选举版本，2值代表基于UDP的有认证的快速Leader选举版本，3值代表基于TCP快速Leader选举版本。算法3为默认值。</p><blockquote><p>0，1，2三个leader选举的实现方案现已被废弃。我们计划在下一个版本中移除，也就是说后续只有<code>FastLeaderElection</code>可用。</p></blockquote><p><strong>initLimit</strong></p><p>允许集群中follower节点连接及同步数据至leader节点的时间耗时（以tickTime为单位）。如果由ZK管理的数据量比较大，则可以按需增加这个值。</p><p><strong>leaderServes</strong><br>(Java系统属性: zookeeper.leaderServes)</p><p>配置集群中的leader节点是否接受客户端连接，默认为<code>yes</code>。Leader节点主要负责协调集群节点之间数据的更新。对于与协调更新有关的吞吐量远高于客户端的读请求的吞吐量，则leader节点可设置为不接受客户端的连接请求，而专注于协调集群节点间的数据更新。默认值为<code>yes</code>意味着leader节点默认情况下将会接受客户端的连接请求。</p><blockquote><p>当集群超过3个以上的节点时，推荐打开这个开关。</p></blockquote><p><strong>server.x=[hostname]:nnnnn[:nnnnn]</strong></p><p>ZK集群由多个服务器节点组成。当服务器节点启动时，ZK到$data_dir目录下找到<code>myid</code>文件，并根据里面内容确定其身份编号及连接端口信息。<code>myid</code>文件中包含当前服务器节点的编号（以ASCII格式呈现），这个编号与上述配置参数<code>server.x</code>中的<code>x</code>匹配的则为当前服务器节点的IP与监听端口。</p><p>配置参数中的服务器列表信息必须与ZK集群服务器节点的一一匹配。</p><p>配置参数中有两个端口号，第一个端口用于follower节点与leader节点间的通信，第二个端口用于集群leader选举。只有<code>electionAlg</code>参数值为非0值时，选举用的端口号（第二个）才是必须的。若<code>electionAlg</code>参数值为0值时，则第二个端口号是非必要的。如果你想在单机上测试多个服务器，则可以使用不同的端口号。</p><p><strong>syncLimit</strong></p><p>允许集群follower节点与leader节点进行数据同步的总耗时（以tickTime为单位）。如果follower的数据与leader的数据由于同步不及时导致差异太大，则这些follower节点将被移出集群。</p><p><strong>group.x=nnnnn[:nnnnn]</strong></p><p>Enables a hierarchical quorum construction.”x”是组编号，而”=”右边则是用”:”分隔的服务器编号。每组的服务器成员编号不能有交集，同时所有组的节点成员的并集刚好是集群的所有成员。</p><p> 你可在<a href="http://zookeeper.apache.org/doc/r3.4.10/zookeeperHierarchicalQuorums.html">这里</a>找到使用的例子。</p><p><strong>weight.x=nnnnn</strong></p><p>与”group”参数搭配使用。它为集群中的每个成员提供一个权值，这个权值在进行进行法定人数选举投票时会用到。There are a few parts of ZooKeeper that require voting such as leader election and the atomic broadcast protocol. By default the weight of server is 1. If the configuration defines groups, but not weights, then a value of 1 will be assigned to all servers.</p><p>你可在<a href="http://zookeeper.apache.org/doc/r3.4.10/zookeeperHierarchicalQuorums.html">这里</a>找到使用的例子。</p><p><strong>cnxTimeout</strong><br>(Java系统属性: zookeeper.cnxTimeout)</p><p>为leader选举通知消息而打开的连接设置一个超时时间。只有<code>electionAlg</code>值为3时这个参数才有用。默认值为5秒。</p><p><strong>4lw.commands.whitelist</strong><br>(Java系统属性: zookeeper.4lw.commands.whitelist)</p><p><strong>V3.4.10引入</strong>: 这个属性包含了一系统用逗号分隔的由4个字符组成的命令列表。它之所以被引入是为了提供更灵活的粒度控制机制来决定哪些ZK命令可以执行。因此借助这个参数，用于可以根据需要来关闭某些命令。默认情况下，若未指定该参数，则除了<code>wchp</code>与<code>wchc</code>以外的命令都可以执行。如果配置了该参数，则只有参数中列出的命令可以执行（被连接的客户端调用执行）。</p><p>下面是一个只启用了<code>stat,ruok,conf,isro</code>命令的配置：<br><code>4lw.commands.whitelist=stat, ruok, conf, isro</code></p><p>用户也可以使用通配符来进行配置，如：<br><code>4lw.commands.whitelist=*</code></p><p><strong>认证与授权参数选项</strong><br>本节介绍的内容主要是用于配置认证/授权相关功能的。</p><p><strong>zookeeper.DigestAuthenticationProvider.superDigest</strong><br>(Java系统属性: zookeeper.DigestAuthenticationProvider.superDigest)，只能通过Java系统属性方式配置。</p><p>该特性默认是禁用的</p><p><strong>V3.2版引入</strong>: Enables a ZooKeeper ensemble administrator to access the znode hierarchy as a “super” user. In particular no ACL checking occurs for a user authenticated as super.</p><p>org.apache.zookeeper.server.auth.DigestAuthenticationProvider can be used to generate the superDigest, call it with one parameter of <code>super:&lt;password&gt;</code>. Provide the generated <code>super:&lt;data&gt;</code> as the system property value when starting each server of the ensemble.</p><p>When authenticating to a ZooKeeper server (from a ZooKeeper client) pass a scheme of “digest” and authdata of <code>super:&lt;password&gt;</code>. Note that digest auth passes the authdata in plaintext to the server, it would be prudent to use this authentication method only on localhost (not over the network) or over an encrypted connection.</p><h3 id="ZK命令：4字符命令"><a href="#ZK命令：4字符命令" class="headerlink" title="ZK命令：4字符命令"></a><span id="2.11"></span>ZK命令：4字符命令</h3><p>ZooKeeper可以响应一个小规模的命令集。命令集中的每个命令由4个字母组成。<br>你可以通过nc或telnet向ZooKeeper服务器的客户端监听端口发送命令。其中有三个命令是比较令人感兴趣的：<code>stat</code>会输出与服务器、已连接的客户端相关的基本信息；<code>srvr</code>与<code>cons</code>会输出服务器与各个连接的进一步的详细信息。</p><blockquote><p><strong>conf</strong><br>V3.3.0版引入: 打印ZooKeeper配置的详细信息。<br><strong>cons</strong><br>V3.3.0版引入: 列出所有连接至本服务器的客户端连接/会话的详细信息。包括收发数据包数量、会话ID、操作时延（响应时间）、上一次执行的操作等信息。<br><strong>crst</strong><br>V3.3.0版引入: 重置所有连接/会话的统计数据。<br><strong>dump</strong><br>Lists the outstanding sessions and ephemeral nodes. This only works on the leader.<br><strong>envi</strong><br>打印ZK服务环境信息。<br><strong>ruok</strong><br>测试ZK服务器是否处于正常运行状态。若服务器正常运行，则会返回imok响应；反之则压根不会返回任何响应信息。<br><code>imok</code>响应并不意味着该服务器已经加入ZK法定成员中，而仅代表服务器处于活动状态且与某个特定的客户端口建立了绑定关系。你可以使用<code>stat</code>命令查看该服务器是否加入法定投票成员及客户端连接等详细状态信息。<br><strong>srst</strong><br>重置服务器统计数据。<br><strong>srvr</strong><br>V3.3.0版引入: 列出服务器的完整的详细信息。<br><strong>stat</strong><br>列出服务器及已连接至该服务器的客户端的简要信息。<br><strong>wchs</strong><br>V3.3.0版引入: 列出watch该服务器的客户端的简要信息。<br><strong>wchc</strong><br>V3.3.0版引入: 从session视角列出watch该服务器的客户端的详细信息。该命令将输出session(connection)所watch的路径的相关信息。有一点要注意下，执行这个命令的性能损耗与watch的数量有关，请谨慎使用。<br><strong>wchp</strong><br>V3.3.0版引入: 从path视角列出watch该path的相关客户端session。有一点要注意下，执行这个命令的性能损耗与watch的数量有关，请谨慎使用。<br><strong>mntr</strong><br>V3.4.0版引入: 输出可用于监控集群健康状态的参数列表。</p></blockquote><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo mntr | nc localhost <span class="number">2185</span></span><br><span class="line">zk_version <span class="number">3.4</span><span class="number">.0</span></span><br><span class="line">zk_avg_latency <span class="number">0</span></span><br><span class="line">zk_max_latency <span class="number">0</span></span><br><span class="line">zk_min_latency <span class="number">0</span></span><br><span class="line">zk_packets_received <span class="number">70</span></span><br><span class="line">zk_packets_sent <span class="number">69</span></span><br><span class="line">zk_outstanding_requests <span class="number">0</span></span><br><span class="line">zk_server_state leader</span><br><span class="line">zk_znode_count <span class="number">4</span></span><br><span class="line">zk_watch_count <span class="number">0</span></span><br><span class="line">zk_ephemerals_count <span class="number">0</span></span><br><span class="line">zk_approximate_data_size <span class="number">27</span></span><br><span class="line">zk_followers <span class="number">4</span> - <span class="keyword">only</span> exposed <span class="keyword">by</span> the Leader</span><br><span class="line">zk_synced_followers <span class="number">4</span> - <span class="keyword">only</span> exposed <span class="keyword">by</span> the Leader</span><br><span class="line">zk_pending_syncs <span class="number">0</span> - <span class="keyword">only</span> exposed <span class="keyword">by</span> the Leader</span><br><span class="line">zk_open_file_descriptor_count <span class="number">23</span> - <span class="keyword">only</span> available <span class="keyword">on</span> Unix platforms</span><br><span class="line">zk_max_file_descriptor_count <span class="number">1024</span> - <span class="keyword">only</span> available <span class="keyword">on</span> Unix platforms</span><br></pre></td></tr></table></figure><p>The output is compatible with java properties format and the content may change over time (new keys added). Your scripts should expect changes.<br>ATTENTION: Some of the keys are platform specific and some of the keys are only<br>exported by the Leader. The output contains multiple lines with the following format:<br><code>key \t value</code></p><p>Here’s an example of the ruok command:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> ruok | nc 127.0.0.1 5111</span></span><br><span class="line">imok</span><br></pre></td></tr></table></figure><h3 id="数据文件管理"><a href="#数据文件管理" class="headerlink" title="数据文件管理"></a><span id="2.12"></span>数据文件管理</h3><p>ZK将其业务数据保存在数据目录，将其事务日志保存在事务日志目录。默认情况下数据目录与事务日志目录是相同的。服务器可以（应该）将事务日志目录与数据目录分开存储。如果将事务日志存储在专用的日志设备上，则吞吐量上升的同时，时延还会下降。</p><h4 id="数据目录"><a href="#数据目录" class="headerlink" title="数据目录"></a>数据目录</h4><p>这个目录下包含两个文件:</p><ul><li>myid - 包含一个单独的以ASCII形式存储的整数值，这个值代表其所在服务器的ID。</li><li><code>snapshot.&lt;zxid&gt;</code> - 这个文件保存有数据树结构的模糊快照。</li></ul><p>每个ZooKeeper服务器都有一个唯一标识ID，这个ID用于两个地方：<code>myid</code>文件与配置文件。位于数据目录下的<code>myid</code>文件用于标识ZK服务器。配置文件<code>zoo.cfg</code>中列出了集群节点间相互通信的配置信息（IP或主机名、监听端口等），每行配置信息通过Server ID来标识。当ZooKeeper服务实例启动时，其会从<code>myid</code>文件中获取它的标识ID，然后再从配置文件<code>zoo.cfg</code>中读取匹配该ID的服务器配置信息，根据配置信息启动相关端口的监听服务。</p><p>The snapshot files stored in the data directory are fuzzy snapshots in the sense that during the time the ZooKeeper server is taking the snapshot, updates are occurring to the data tree. The suffix of the snapshot file names is the zxid, the ZooKeeper transaction id, of the last committed transaction at the start of the snapshot. Thus, the snapshot includes a subset of the updates to the data tree that occurred while the snapshot was in process. The snapshot, then, may not correspond to any data tree that actually existed, and for this reason we refer to it as a fuzzy snapshot. Still, ZooKeeper can recover using this snapshot because it takes advantage of the idempotent nature of its updates. By replaying the transaction log against fuzzy snapshots ZooKeeper gets the state of the system at the end of the log.</p><h4 id="日志目录"><a href="#日志目录" class="headerlink" title="日志目录"></a>日志目录</h4><p>日志目录包含ZK的事务日志。当任何更新生效前，ZK会确保代表该更新的事务会被写入稳定的存储中。每创建一次快照，会创建一个新的事务日志文件，该日志文件名的后缀为第一个写入该文件的事务日志的zxid。</p><h4 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h4><p>单机模式与集群模式下的快照与日志文件的格式是一样的，因此你可以从集群复制模式环境中获取相关快照及日志文件到单机开发环境中进行问题排查。</p><p>通过使用旧的日志及快照文件，你可以分析ZK服务器以前的状态甚至可以恢复至该旧状态。<code>LogFormatter</code>类允许管理员分析一个日志中的相关事务。</p><p>ZK负责快照及日志的创建，但其不会删除这些文件。数据及日志文件的保留策略由外部应用实现。服务器自身只需要最近一次的模糊快照以及从开始创建该快照以来的事务日志文件即可。可以查看“<a href="#2.5">维护</a>”章节来查看更详细的与保留策略相关的配置信息。</p><blockquote><p>存储在这些文件中的数据是未加密的。在存储敏感数据的场景下，有必要采取一定的措施来阻止未授权访问请求。这些预防措施都不属于ZK的功能范围，因此相关配置信息也是独立的，本文档不多做介绍。</p></blockquote><h3 id="避免踩坑"><a href="#避免踩坑" class="headerlink" title="避免踩坑"></a><span id="2.13"></span>避免踩坑</h3><p>下面是几个在配置ZK服务时经常碰到的问题及解决办法：</p><p><strong>服务器列表数据不一致</strong><br>The list of ZooKeeper servers used by the clients must match the list of ZooKeeper servers that each ZooKeeper server has. Things work okay if the client list is a subset of the real list, but things will really act strange if clients have a list of ZooKeeper servers that are in different ZooKeeper clusters. Also, the server lists in each Zookeeper server configuration file should be consistent with one another.</p><p><strong>incorrect placement of transasction log</strong><br>The most performance critical part of ZooKeeper is the transaction log. ZooKeeper syncs transactions to media before it returns a response. A dedicated transaction log device is key to consistent good performance. Putting the log on a busy device will adversely effect performance. If you only have one storage device, put trace files on NFS and increase the snapshotCount; it doesn’t eliminate the problem, but it should mitigate it.</p><p><strong>Java堆大小配置不正确</strong><br>You should take special care to set your Java max heap size correctly. In particular, you should not create a situation in which ZooKeeper swaps to disk. The disk is death to ZooKeeper. Everything is ordered, so if processing one request swaps the disk, all other queued requests will probably do the same. the disk. DON’T SWAP.</p><p>Be conservative in your estimates: if you have 4G of RAM, do not set the Java max heap size to 6G or even 4G. For example, it is more likely you would use a 3G heap for a 4G machine, as the operating system and the cache also need memory. The best and only recommend practice for estimating the heap size your system needs is to run load tests, and then make sure you are well below the usage limit that would cause the system to swap.</p><p><strong>暴露在公网</strong><br>一个ZK集群应该部署在一个可靠的计算环境中，因此推荐部署在防火墙后面。</p><h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a><span id="2.14"></span>最佳实践</h3><p>For best results, take note of the following list of good Zookeeper practices: For multi-tennant installations see the section detailing ZooKeeper “chroot” support, this canbe very useful when deploying many applications/services interfacing to a single ZooKeeper cluster.</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;本文档主要介绍ZooKeeper部署及日常管理&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;安装部署&quot;&gt;&lt;a href=&quot;#安装部署&quot; class=&quot;headerlink&quot; title=&quot;安装部署&quot;&gt;&lt;/a&gt;安装部署&lt;/h2&gt;&lt;p&gt;本章节包含与ZooKeeper部署有关的内容，具体来说包含下面三部分内容：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1.1&quot;&gt;系统软硬件需求&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#1.2&quot;&gt;集群部署（安装）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#1.3&quot;&gt;单机开发环境部署（安装）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;前两部分主要介绍如何在数据中心等生产环境上安装部署ZooKeeper，第三部分则介绍如何在非生产环境上（如为了评估、测试、开发等目的）安装部署ZooKeeper。&lt;/p&gt;
&lt;h3 id=&quot;系统软硬件需求&quot;&gt;&lt;a href=&quot;#系统软硬件需求&quot; class=&quot;headerlink&quot; title=&quot;系统软硬件需求&quot;&gt;&lt;/a&gt;系统软硬件需求&lt;span id=&quot;1.1&quot;&gt;&lt;/span&gt;&lt;/h3&gt;&lt;h4 id=&quot;支持的OS平台&quot;&gt;&lt;a href=&quot;#支持的OS平台&quot; class=&quot;headerlink&quot; title=&quot;支持的OS平台&quot;&gt;&lt;/a&gt;支持的OS平台&lt;/h4&gt;&lt;p&gt;ZooKeeper框架由多个组件组成，有的组件支持全部平台，而还有一些组件只支持部分平台，详细支持情况如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Client：&lt;/strong&gt;它是一个&lt;code&gt;Java&lt;/code&gt;客户端连接库，上层应用系统通过它连接至ZooKeeper集群。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Server：&lt;/strong&gt;它是运行在ZooKeeper集群节点上的一个&lt;code&gt;Java&lt;/code&gt;后台服务程序。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Native Client：&lt;/strong&gt;它是一个用&lt;code&gt;C&lt;/code&gt;语言实现的客户端连接库，其与&lt;code&gt;Java&lt;/code&gt;客户端库一样，上层应用（非&lt;code&gt;Java&lt;/code&gt;实现）通过它连接至ZooKeeper集群。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Contrib：&lt;/strong&gt;它是指多个可选的扩展组件。&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;left&quot;&gt;操作系统&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Client&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Server&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Native Client&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Contrib&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td align=&quot;left&quot;&gt;GNU/Linux&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;left&quot;&gt;Solaris&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;left&quot;&gt;FreeBSD&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;left&quot;&gt;Windows&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D + P&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;left&quot;&gt;Mac OS X&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;D&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;/&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;</summary>
    
    
    
    <category term="Translation" scheme="http://cloudnoter.com/categories/Translation/"/>
    
    
    <category term="ZooKeeper" scheme="http://cloudnoter.com/tags/ZooKeeper/"/>
    
  </entry>
  
  <entry>
    <title>JVM方法区(PermGen)内存快速飙升问题</title>
    <link href="http://cloudnoter.com/2017/05/07/JVM%E6%96%B9%E6%B3%95%E5%8C%BA-PermGen-%E5%86%85%E5%AD%98%E5%BF%AB%E9%80%9F%E9%A3%99%E5%8D%87%E9%97%AE%E9%A2%98/"/>
    <id>http://cloudnoter.com/2017/05/07/JVM%E6%96%B9%E6%B3%95%E5%8C%BA-PermGen-%E5%86%85%E5%AD%98%E5%BF%AB%E9%80%9F%E9%A3%99%E5%8D%87%E9%97%AE%E9%A2%98/</id>
    <published>2017-05-07T07:01:22.000Z</published>
    <updated>2017-05-07T13:48:21.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>自从平台升级到3.0后，应用的JVM变得非常不稳定，主要体现为以下三个问题：</p><ol><li>内存泄漏：2G的JVM，2天就崩。</li><li>方法区内存持续飙升，最终导致频繁的触发FullGC</li><li>class load频繁导致CPU有30%的资源浪费</li></ol><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="问题1解决思路："><a href="#问题1解决思路：" class="headerlink" title="问题1解决思路："></a><strong>问题1解决思路</strong>：</h3><p>问题1相对好解决，先用jmap将堆快照dump出来，用mat分析了下，根据GC-ROOT找到引用路径即可，泄漏原因为：平台自研JPA组件的SQLQuery在实现lazy load时，由于CGLib使用不当(在向当前线程注册回调方法拦截器时，在使用完之后未及时注销)导致的查询结果缓存被线程池中的线程引用，在线程池容量开得比较大时最终将导致OOM异常。</p><span id="more"></span><h3 id="问题2-3解决思路："><a href="#问题2-3解决思路：" class="headerlink" title="问题2,3解决思路："></a><strong>问题2,3解决思路</strong>：</h3><p>以前从没碰到这种情况，方法区的内存大小在应用启动后应该是处于一个相对稳定的状态（因为大部分类在启动时就已经加载完了，就算使用CGLib动态生成代理类也应该是有一个上限，最多就是全部类的一倍），但问题2明显不属于这种情况，不管开多大的内存给方法区（通过<code>-X:MaxPermSize=xxxM</code>设置大小），应用总能在几分钟内持续升到最高值并触发FullGC，GC结束后，方法区占用内存降至接近0M（此处就发生的<code>class unload</code>），然后又进入新一轮的飙升周期（此处就发生<code>class loader</code>）。</p><p>刚开始以为仍然是JPA组件使用CGLib不当的问题，认为是为了实现<code>lazy load</code>及权限控制时使用了过多的动态代理（每个<code>Action,Model,Service</code>都被创建为动态代理，更不合理的时每个model的get方法都使用<code>ProxyMethodInterceptor</code>，问当事人原因，其答复说为了<code>lazy load</code>，但其实只有关联字段，集合字段才有必要<code>lazy load</code>）。基于此做了修改，但测试结果还是没解决问题：因为JPA中并不是每次都创建一个新的proxy，而是根据class做了缓存的，因此只能另找办法。</p><p>既然是方法区的问题，那是否可以将方法区的内容dump出来呢？于是查看了下<code>jmap</code>参数，其中的有<code>-permstat</code>可以用：<code>jmap -permstat &lt;pid&gt; </code><br>结果如下（截取）</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">25007</span> intern Strings occupying <span class="number">2799672</span> bytes.  </span><br><span class="line"><span class="attribute">class_loader</span> classesbytes parent_loaderalive? type  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="section">&lt;bootstrap&gt;</span> <span class="attribute">262415108248</span>  null  live &lt;internal&gt;  </span><br><span class="line"><span class="attribute">0x000000076f045910</span> <span class="number">38758792</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span>  </span><br><span class="line"><span class="attribute">0x000000076f942f10</span> <span class="number">38758792</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span>  </span><br><span class="line"><span class="attribute">0x00000007d00e9ba0</span> <span class="number">40816816</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span>  </span><br><span class="line"><span class="attribute">0x00000007dd170c08</span> <span class="number">40816816</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span>  </span><br><span class="line"><span class="attribute">0x000000079e2f0070</span> <span class="number">40816816</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span>  </span><br><span class="line"><span class="attribute">0x00000007cd6b1140</span> <span class="number">13112</span>  null  dead sun/reflect/DelegatingClassLoader@<span class="number">0</span>x<span class="number">0000000740067648</span>  </span><br><span class="line"><span class="attribute">0x000000076fb5d130</span> <span class="number">38758792</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span>  </span><br><span class="line"><span class="attribute">0x000000076fbe47c0</span> <span class="number">38758792</span> <span class="number">0</span>x<span class="number">00000007617</span>d<span class="number">4</span>f<span class="number">70</span>dead com/atomikos/util/ClassLoadingHelper$<span class="number">1</span>@<span class="number">0</span>x<span class="number">0000000741</span>cb<span class="number">86</span>e<span class="number">8</span></span><br></pre></td></tr></table></figure><p><code>com/atomikos/util/ClassLoadingHelper$1</code>：是一个匿名内部类（该类是一个加载器），通过这个内部类加载器作为JDK <code>Proxy.newProxyInstance()</code>方法的参数，而后者就会生产大量的以Proxy$为前缀的动态类，并且未做任何缓存。<br>atomikos大家应该都很清楚：JTA的一个实现，但是哪个组件调用了这个工具类呢？通过断点分析，原来是JPA又自己写了个什么数据库连接池，池中的每个连接都是<code>ProxyConnection</code>，而池又好像失效的，频繁的回收，创建…</p><blockquote><p>到目前为止，我一直没搞清楚为何要用代理类型的连接，这代理的作用从代码中也没看出个门道来，也不是为做监控。</p></blockquote><p>原因定位到了，解决办法就很简单了：直接用阿里的druid替换掉。测试结果证明前面的分析是正确的。</p><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;自从平台升级到3.0后，应用的JVM变得非常不稳定，主要体现为以下三个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;内存泄漏：2G的JVM，2天就崩。&lt;/li&gt;
&lt;li&gt;方法区内存持续飙升，最终导致频繁的触发FullGC&lt;/li&gt;
&lt;li&gt;class load频繁导致CPU有30%的资源浪费&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;解决方案&quot;&gt;&lt;a href=&quot;#解决方案&quot; class=&quot;headerlink&quot; title=&quot;解决方案&quot;&gt;&lt;/a&gt;解决方案&lt;/h2&gt;&lt;h3 id=&quot;问题1解决思路：&quot;&gt;&lt;a href=&quot;#问题1解决思路：&quot; class=&quot;headerlink&quot; title=&quot;问题1解决思路：&quot;&gt;&lt;/a&gt;&lt;strong&gt;问题1解决思路&lt;/strong&gt;：&lt;/h3&gt;&lt;p&gt;问题1相对好解决，先用jmap将堆快照dump出来，用mat分析了下，根据GC-ROOT找到引用路径即可，泄漏原因为：平台自研JPA组件的SQLQuery在实现lazy load时，由于CGLib使用不当(在向当前线程注册回调方法拦截器时，在使用完之后未及时注销)导致的查询结果缓存被线程池中的线程引用，在线程池容量开得比较大时最终将导致OOM异常。&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="http://cloudnoter.com/categories/Java/"/>
    
    
    <category term="Java" scheme="http://cloudnoter.com/tags/Java/"/>
    
    <category term="JVM" scheme="http://cloudnoter.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>HA专题--Pacemaker集群日常管理命令</title>
    <link href="http://cloudnoter.com/2017/04/29/HA%E4%B8%93%E9%A2%98-Pacemaker%E6%97%A5%E5%B8%B8%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/"/>
    <id>http://cloudnoter.com/2017/04/29/HA%E4%B8%93%E9%A2%98-Pacemaker%E6%97%A5%E5%B8%B8%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/</id>
    <published>2017-04-29T13:20:49.000Z</published>
    <updated>2017-05-07T13:48:39.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Pacemaker的管理工具主要有两种：crmsh、pcs(Pacemaker/Corosync configuration system)，本文将同时介绍这两种命令行工具。</p><blockquote><p>从CentOS6.4以后开始采用PCS替代crmsh来管理pacemaker集群（PCS专用于pacemaker+corosync的设置工具，其有CLI和web-based GUI界面）<br>文档来源于Pacemaker的<a href="https://github.com/ClusterLabs/pacemaker/blob/master/doc/pcs-crmsh-quick-ref.md">Github官网</a></p></blockquote><span id="more"></span><h1 id="通用操作"><a href="#通用操作" class="headerlink" title="通用操作"></a>通用操作</h1><h2 id="显示配置信息"><a href="#显示配置信息" class="headerlink" title="显示配置信息"></a>显示配置信息</h2><p>以XML格式显示</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh </span></span><br><span class="line">crm configure show <span class="keyword">xml</span></span><br><span class="line"><span class="title"># pcs</span> </span><br><span class="line">pcs cluster cib</span><br></pre></td></tr></table></figure><p>以非XML格式显示[To show a simplified (non-xml) syntax]</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">show</span></span><br><span class="line"><span class="keyword"></span><span class="comment"># pcs</span></span><br><span class="line">pcs <span class="built_in">config</span></span><br></pre></td></tr></table></figure><h2 id="显示集群当前状态"><a href="#显示集群当前状态" class="headerlink" title="显示集群当前状态"></a>显示集群当前状态</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm status</span><br><span class="line"><span class="meta">#pcs</span></span><br><span class="line">pcs status</span><br></pre></td></tr></table></figure><p>也可以这样：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">crm_mon</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="挂起节点（Node-standby）"><a href="#挂起节点（Node-standby）" class="headerlink" title="挂起节点（Node standby）"></a>挂起节点（Node standby）</h2><p>使节点进入Standby状态（Put node in standby）</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm <span class="keyword">node</span> <span class="title">standby</span> pcmk-<span class="number">1</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs cluster standby pcmk-<span class="number">1</span></span><br></pre></td></tr></table></figure><p>使节点从Standby状态恢复（Remove node from standby）</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm <span class="keyword">node</span> <span class="title">online</span> pcmk-<span class="number">1</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs cluster unstandby pcmk-<span class="number">1</span></span><br></pre></td></tr></table></figure><p>crm has the ability to set the status on reboot or forever.<br>pcs can apply the change to all the nodes.</p><h2 id="设置集群全局属性"><a href="#设置集群全局属性" class="headerlink" title="设置集群全局属性"></a>设置集群全局属性</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">property</span><span class="title"> </span><span class="attr">stonith-enabled=</span><span class="literal">false</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs <span class="keyword">property</span><span class="title"> </span>set <span class="attr">stonith-enabled=</span><span class="literal">false</span></span><br></pre></td></tr></table></figure><h1 id="集群资源处理操作"><a href="#集群资源处理操作" class="headerlink" title="集群资源处理操作"></a>集群资源处理操作</h1><h2 id="列出所有RA-Resource-Agent-的类别-classes"><a href="#列出所有RA-Resource-Agent-的类别-classes" class="headerlink" title="列出所有RA(Resource Agent)的类别:classes"></a>列出所有RA(Resource Agent)的类别:<code>classes</code></h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm ra classes</span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs resource standards</span><br></pre></td></tr></table></figure><h2 id="列出所有可用的RA"><a href="#列出所有可用的RA" class="headerlink" title="列出所有可用的RA"></a>列出所有可用的RA</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm ra list ocf</span><br><span class="line">crm ra list lsb</span><br><span class="line">crm ra list<span class="built_in"> service</span></span><br><span class="line"><span class="built_in"></span>crm ra list stonith</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span>agents ocf</span><br><span class="line">pcs<span class="built_in"> resource </span>agents lsb</span><br><span class="line">pcs<span class="built_in"> resource </span>agents<span class="built_in"> service</span></span><br><span class="line"><span class="built_in"></span>pcs<span class="built_in"> resource </span>agents stonith</span><br><span class="line">pcs<span class="built_in"> resource </span>agents</span><br></pre></td></tr></table></figure><p>您也可以通过<code>provider</code>进一步过滤：</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm ra list ocf pacemaker</span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs resource agents ocf:pacemaker</span><br></pre></td></tr></table></figure><h2 id="查询具体RA的描述信息"><a href="#查询具体RA的描述信息" class="headerlink" title="查询具体RA的描述信息"></a>查询具体RA的描述信息</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line"><span class="attribute">crm</span> ra meta IPaddr<span class="number">2</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line"><span class="attribute">pcs</span> resource describe IPaddr<span class="number">2</span></span><br></pre></td></tr></table></figure><p>Use any RA name (like IPaddr2) from the list displayed with the previous command<br>You can also use the full class:provider:RA format if multiple RAs with the same name are available :</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line"><span class="attribute">crm</span> ra meta ocf:heartbeat:IPaddr<span class="number">2</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line"><span class="attribute">pcs</span> resource describe ocf:heartbeat:IPaddr<span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure primitive ClusterIP ocf:heartbeat:IPaddr2 \</span><br><span class="line">       params <span class="attribute">ip</span>=192.168.122.120 <span class="attribute">cidr_netmask</span>=32 \</span><br><span class="line">       op monitor <span class="attribute">interval</span>=30s </span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span>create ClusterIP IPaddr2 <span class="attribute">ip</span>=192.168.0.120 <span class="attribute">cidr_netmask</span>=32</span><br></pre></td></tr></table></figure><p>The standard and provider (<code>ocf:heartbeat</code>) are determined automatically since <code>IPaddr2</code> is unique.<br>The monitor operation is automatically created based on the agent’s metadata.</p><h2 id="显示资源配置信息"><a href="#显示资源配置信息" class="headerlink" title="显示资源配置信息"></a>显示资源配置信息</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">show</span></span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs resource <span class="keyword">show</span></span><br></pre></td></tr></table></figure><p>crmsh also displays fencing resources.<br>The result can be filtered by supplying a resource name (IE <code>ClusterIP</code>):</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">show</span> ClusterIP</span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs resource <span class="keyword">show</span> ClusterIP</span><br></pre></td></tr></table></figure><p>crmsh also displays fencing resources. </p><h2 id="显示fencing资源"><a href="#显示fencing资源" class="headerlink" title="显示fencing资源"></a>显示fencing资源</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm resource <span class="keyword">show</span></span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs stonith <span class="keyword">show</span></span><br></pre></td></tr></table></figure><p>pcs treats STONITH devices separately.</p><h2 id="显示Stonith资源代码-RA-信息"><a href="#显示Stonith资源代码-RA-信息" class="headerlink" title="显示Stonith资源代码(RA)信息"></a>显示Stonith资源代码(RA)信息</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm ra meta stonith:fence_ipmilan</span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs stonith describe fence_ipmilan</span><br></pre></td></tr></table></figure><h2 id="启动资源"><a href="#启动资源" class="headerlink" title="启动资源"></a>启动资源</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm<span class="built_in"> resource </span>start ClusterIP</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span><span class="builtin-name">enable</span> ClusterIP</span><br></pre></td></tr></table></figure><h2 id="停止资源"><a href="#停止资源" class="headerlink" title="停止资源"></a>停止资源</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm<span class="built_in"> resource </span>stop ClusterIP</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span><span class="builtin-name">disable</span> ClusterIP</span><br></pre></td></tr></table></figure><h2 id="删除资源"><a href="#删除资源" class="headerlink" title="删除资源"></a>删除资源</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">delete</span> ClusterIP</span><br><span class="line"><span class="meta"># pcs</span></span><br><span class="line">pcs resource <span class="keyword">delete</span> ClusterIP</span><br></pre></td></tr></table></figure><h2 id="更新资源"><a href="#更新资源" class="headerlink" title="更新资源"></a>更新资源</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm<span class="built_in"> resource </span>param ClusterIP <span class="builtin-name">set</span> <span class="attribute">clusterip_hash</span>=sourceip</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span>update ClusterIP <span class="attribute">clusterip_hash</span>=sourceip</span><br></pre></td></tr></table></figure><p>crmsh also has an <code>edit</code> command which edits the simplified CIB syntax<br>(same commands as the command line) via a configurable text editor.</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="builtin-name">edit</span> ClusterIP</span><br></pre></td></tr></table></figure><p>Using the interactive shell mode of crmsh, multiple changes can be<br>edited and verified before committing to the live configuration.</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">node-01<span class="variable">$ </span>crm configure <span class="comment"># 进入crmsh上下文模式</span></span><br><span class="line">crm(live)configure<span class="variable">$ </span>edit</span><br><span class="line">crm(live)configure<span class="variable">$ </span>verify</span><br><span class="line">crm(live)configure<span class="variable">$ </span>commit</span><br></pre></td></tr></table></figure><h2 id="删除给定资源上的属性信息"><a href="#删除给定资源上的属性信息" class="headerlink" title="删除给定资源上的属性信息"></a>删除给定资源上的属性信息</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm<span class="built_in"> resource </span>param ClusterIP delete nic</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span>update ClusterIP <span class="attribute">ip</span>=192.168.0.98 nic=  </span><br></pre></td></tr></table></figure><h2 id="列出资源的默认属性信息"><a href="#列出资源的默认属性信息" class="headerlink" title="列出资源的默认属性信息"></a>列出资源的默认属性信息</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure show <span class="keyword">type</span>:<span class="keyword">rsc_defaults</span><span class="title"></span></span><br><span class="line"><span class="title"></span><span class="comment"># pcs</span></span><br><span class="line">pcs resource defaults</span><br></pre></td></tr></table></figure><h2 id="设置资源的默认属性信息"><a href="#设置资源的默认属性信息" class="headerlink" title="设置资源的默认属性信息"></a>设置资源的默认属性信息</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure rsc_defaults <span class="attribute">resource-stickiness</span>=100</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span>defaults <span class="attribute">resource-stickiness</span>=100</span><br></pre></td></tr></table></figure><h2 id="列出资源操作命令相关属性的默认值"><a href="#列出资源操作命令相关属性的默认值" class="headerlink" title="列出资源操作命令相关属性的默认值"></a>列出资源操作命令相关属性的默认值</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure show <span class="keyword">type</span>:<span class="keyword">op_defaults</span><span class="title"></span></span><br><span class="line"><span class="title"></span><span class="comment"># pcs</span></span><br><span class="line">pcs resource <span class="keyword">op</span> defaults</span><br></pre></td></tr></table></figure><h2 id="设置资源操作命令相关属性的默认值"><a href="#设置资源操作命令相关属性的默认值" class="headerlink" title="设置资源操作命令相关属性的默认值"></a>设置资源操作命令相关属性的默认值</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure op_defaults <span class="attribute">timeout</span>=240s</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs<span class="built_in"> resource </span>op defaults <span class="attribute">timeout</span>=240s</span><br></pre></td></tr></table></figure><h2 id="设置Colocation约束"><a href="#设置Colocation约束" class="headerlink" title="设置Colocation约束"></a>设置Colocation约束</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">colocation</span> <span class="title">website-with-ip</span> <span class="literal">INFINITY</span>: WebSite ClusterIP</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs constraint <span class="keyword">colocation</span> <span class="title">add</span> ClusterIP with WebSite <span class="literal">INFINITY</span></span><br></pre></td></tr></table></figure><p>With roles</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">colocation</span> <span class="title">another-ip-with-website</span> <span class="literal">inf</span>: AnotherIP WebSite:<span class="keyword">Master</span></span><br><span class="line"><span class="title"># pcs</span></span><br><span class="line">pcs constraint <span class="keyword">colocation</span> <span class="title">add</span> <span class="literal">Started</span> AnotherIP with <span class="keyword">Master</span> <span class="title">WebSite</span> <span class="literal">INFINITY</span></span><br></pre></td></tr></table></figure><h2 id="设置ordering约束"><a href="#设置ordering约束" class="headerlink" title="设置ordering约束"></a>设置ordering约束</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">order</span> <span class="title">apache-after-ip</span> mandatory: ClusterIP WebSite</span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs constraint <span class="keyword">order</span> <span class="title">ClusterIP</span> then WebSite</span><br></pre></td></tr></table></figure><p>With roles:</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">order</span> <span class="title">ip-after-website</span> Mandatory: WebSite:<span class="keyword">Master</span> <span class="title">AnotherIP</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs constraint <span class="keyword">order</span> <span class="title">promote</span> WebSite then <span class="literal">start</span> AnotherIP</span><br></pre></td></tr></table></figure><h2 id="设置preferred-location约束"><a href="#设置preferred-location约束" class="headerlink" title="设置preferred location约束"></a>设置preferred location约束</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">location</span> <span class="title">prefer-pcmk-1</span> WebSite <span class="number">50</span>: pcmk-<span class="number">1</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs constraint <span class="keyword">location</span> <span class="title">WebSite</span> prefers <span class="attr">pcmk-1=</span><span class="number">50</span></span><br></pre></td></tr></table></figure><p>With roles:</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh</span></span><br><span class="line">crm configure <span class="keyword">location</span> <span class="title">prefer-pcmk-1</span> WebSite <span class="keyword">rule</span> <span class="attr">role=</span><span class="keyword">Master</span> <span class="title">50</span>: \<span class="comment">#uname eq pcmk-1</span></span><br><span class="line"><span class="comment"># pcs</span></span><br><span class="line">pcs constraint <span class="keyword">location</span> <span class="title">WebSite</span> <span class="keyword">rule</span> <span class="attr">role=</span><span class="keyword">master</span> <span class="title">50</span> \<span class="comment">#uname eq pcmk-1</span></span><br></pre></td></tr></table></figure><h2 id="移动资源至指定节点（Move-resources）"><a href="#移动资源至指定节点（Move-resources）" class="headerlink" title="移动资源至指定节点（Move resources）"></a>移动资源至指定节点（Move resources）</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crm<span class="built_in"> resource </span>move WebSite pcmk-1</span><br><span class="line">pcs<span class="built_in"> resource </span>move WebSite pcmk-1</span><br><span class="line">    </span><br><span class="line">crm<span class="built_in"> resource </span>unmove WebSite</span><br><span class="line">pcs<span class="built_in"> resource </span>clear WebSite</span><br></pre></td></tr></table></figure><p>A resource can also be moved away from a given node:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">crm</span> resource ban Website pcmk-<span class="number">2</span></span><br><span class="line"><span class="attribute">pcs</span> resource ban Website pcmk-<span class="number">2</span></span><br></pre></td></tr></table></figure><p>Remember that moving a resource sets a stickyness to -INF to a given node until unmoved    </p><h2 id="Resource-tracing"><a href="#Resource-tracing" class="headerlink" title="Resource tracing"></a>Resource tracing</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crm resource <span class="keyword">trace</span> Website</span><br><span class="line"><span class="meta"># pcs不支持</span></span><br></pre></td></tr></table></figure><h2 id="清理指定资源的失败计数信息（Clear-fail-counts）"><a href="#清理指定资源的失败计数信息（Clear-fail-counts）" class="headerlink" title="清理指定资源的失败计数信息（Clear fail counts）"></a>清理指定资源的失败计数信息（Clear fail counts）</h2><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crm resource <span class="keyword">cleanup</span> Website</span><br><span class="line">pcs resource <span class="keyword">cleanup</span> Website</span><br></pre></td></tr></table></figure><h2 id="编辑Edit-fail-counts"><a href="#编辑Edit-fail-counts" class="headerlink" title="编辑Edit fail counts"></a>编辑Edit fail counts</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crm<span class="built_in"> resource </span>failcount Website show pcmk-1</span><br><span class="line">crm<span class="built_in"> resource </span>failcount Website <span class="builtin-name">set</span> pcmk-1 100</span><br><span class="line">    </span><br><span class="line"><span class="comment"># pcs不支持</span></span><br></pre></td></tr></table></figure><h2 id="Handling-configuration-elements-by-type"><a href="#Handling-configuration-elements-by-type" class="headerlink" title="Handling configuration elements by type"></a>Handling configuration elements by type</h2><p>pcs deals with constraints differently. These can be manipulated by the command above as well as the following and others</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 下面这行命令的list可以省略，使用<span class="keyword">full</span>选项是为了显示相关的id</span><br><span class="line">pcs <span class="keyword">constraint</span> list <span class="comment">--full </span></span><br><span class="line">pcs <span class="keyword">constraint</span> remove cli-ban-Website-<span class="keyword">on</span>-pcmk<span class="number">-1</span></span><br></pre></td></tr></table></figure><p>使用crmsh命令删除约束的方式与删除资源的命令一样<br>Removing a constraint in crmsh uses the same command as removing a resource.</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">crm</span> configure remove cli-ban-Website-<span class="literal">on</span>-pcmk-<span class="number">1</span></span><br></pre></td></tr></table></figure><p>The <code>show</code> and <code>edit</code> commands in crmsh can be used to manage<br>resources and constraints by type:</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crm configure show <span class="keyword">type</span>:<span class="keyword">primitive</span><span class="title"></span></span><br><span class="line"><span class="title">crm</span> configure edit <span class="keyword">type</span>:colocation</span><br></pre></td></tr></table></figure><h2 id="Create-a-clone"><a href="#Create-a-clone" class="headerlink" title="Create a clone"></a>Create a clone</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crm configure clone WebIP ClusterIP meta <span class="attribute">globally-unique</span>=<span class="literal">true</span> <span class="attribute">clone-max</span>=2 <span class="attribute">clone-node-max</span>=2</span><br><span class="line">pcs<span class="built_in"> resource </span>clone ClusterIP <span class="attribute">globally-unique</span>=<span class="literal">true</span> <span class="attribute">clone-max</span>=2 <span class="attribute">clone-node-max</span>=2</span><br></pre></td></tr></table></figure><h2 id="Create-a-master-slave-clone"><a href="#Create-a-master-slave-clone" class="headerlink" title="Create a master/slave clone"></a>Create a master/slave clone</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crm configure ms WebDataClone WebData \</span><br><span class="line">    meta <span class="attribute">master-max</span>=1 <span class="attribute">master-node-max</span>=1 \</span><br><span class="line">    <span class="attribute">clone-max</span>=2 <span class="attribute">clone-node-max</span>=1 <span class="attribute">notify</span>=<span class="literal">true</span></span><br><span class="line">pcs<span class="built_in"> resource </span>master WebDataClone WebData \</span><br><span class="line">    <span class="attribute">master-max</span>=1 <span class="attribute">master-node-max</span>=1 \</span><br><span class="line">    <span class="attribute">clone-max</span>=2 <span class="attribute">clone-node-max</span>=1 <span class="attribute">notify</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h1 id="其它操作"><a href="#其它操作" class="headerlink" title="其它操作"></a>其它操作</h1><h2 id="批量修改配置信息"><a href="#批量修改配置信息" class="headerlink" title="批量修改配置信息"></a>批量修改配置信息</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crmsh通过crm命令进入crmsh上下文模式，直接对CIB文档结构进行操作，最后再一次性commit</span></span><br><span class="line">crmsh # crm</span><br><span class="line">crmsh # cib new drbd_cfg</span><br><span class="line">crmsh # configure primitive WebData ocf:linbit:drbd params <span class="attribute">drbd_resource</span>=wwwdata \</span><br><span class="line">        op monitor <span class="attribute">interval</span>=60s</span><br><span class="line">crmsh # configure ms WebDataClone WebData meta <span class="attribute">master-max</span>=1 <span class="attribute">master-node-max</span>=1 \</span><br><span class="line">        <span class="attribute">clone-max</span>=2 <span class="attribute">clone-node-max</span>=1 <span class="attribute">notify</span>=<span class="literal">true</span></span><br><span class="line">crmsh # cib commit drbd_cfg</span><br><span class="line">crmsh # quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs则先基于本地文件方式批量设置CIB参数，然后再通过push操作使配置生效</span></span><br><span class="line">pcs   # pcs cluster cib drbd_cfg</span><br><span class="line">pcs   # pcs -f drbd_cfg<span class="built_in"> resource </span>create WebData ocf:linbit:drbd <span class="attribute">drbd_resource</span>=wwwdata \</span><br><span class="line">        op monitor <span class="attribute">interval</span>=60s</span><br><span class="line">pcs   # pcs -f drbd_cfg<span class="built_in"> resource </span>master WebDataClone WebData <span class="attribute">master-max</span>=1 <span class="attribute">master-node-max</span>=1 \</span><br><span class="line">        <span class="attribute">clone-max</span>=2 <span class="attribute">clone-node-max</span>=1 <span class="attribute">notify</span>=<span class="literal">true</span></span><br><span class="line">pcs   # pcs cluster push cib drbd_cfg</span><br></pre></td></tr></table></figure><h2 id="创建模板（Template-creation）"><a href="#创建模板（Template-creation）" class="headerlink" title="创建模板（Template creation）"></a>创建模板（Template creation）</h2><p>Create a resource template based on a list of primitives of the same<br>type</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crm configure assist <span class="keyword">template</span> ClusterIP AdminIP</span><br></pre></td></tr></table></figure><h2 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h2><p>Display information about recent cluster events</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crmsh # crm <span class="keyword">history</span></span><br><span class="line">crmsh # peinputs</span><br><span class="line">crmsh # transition <span class="keyword">pe</span>-<span class="built_in">input</span>-<span class="number">10</span></span><br><span class="line">crmsh # transition <span class="built_in">log</span> <span class="keyword">pe</span>-<span class="built_in">input</span>-<span class="number">10</span></span><br></pre></td></tr></table></figure><h2 id="Configuration-scripts"><a href="#Configuration-scripts" class="headerlink" title="Configuration scripts"></a>Configuration scripts</h2><p>Create and apply multiple-step cluster configurations including<br>configuration of cluster resources</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crmsh # crm<span class="built_in"> script </span>show apache</span><br><span class="line">crmsh # crm<span class="built_in"> script </span><span class="builtin-name">run</span> apache \</span><br><span class="line">    <span class="attribute">id</span>=WebSite \</span><br><span class="line">    <span class="attribute">install</span>=<span class="literal">true</span> \</span><br><span class="line">    virtual-ip:<span class="attribute">ip</span>=192.168.0.15 \</span><br><span class="line">    database:<span class="attribute">id</span>=WebData \</span><br><span class="line">    database:<span class="attribute">install</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h1&gt;&lt;p&gt;Pacemaker的管理工具主要有两种：crmsh、pcs(Pacemaker/Corosync configuration system)，本文将同时介绍这两种命令行工具。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;从CentOS6.4以后开始采用PCS替代crmsh来管理pacemaker集群（PCS专用于pacemaker+corosync的设置工具，其有CLI和web-based GUI界面）&lt;br&gt;文档来源于Pacemaker的&lt;a href=&quot;https://github.com/ClusterLabs/pacemaker/blob/master/doc/pcs-crmsh-quick-ref.md&quot;&gt;Github官网&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="HA" scheme="http://cloudnoter.com/categories/HA/"/>
    
    
    <category term="HA" scheme="http://cloudnoter.com/tags/HA/"/>
    
    <category term="Pacemaker" scheme="http://cloudnoter.com/tags/Pacemaker/"/>
    
    <category term="crmsh" scheme="http://cloudnoter.com/tags/crmsh/"/>
    
    <category term="pcs" scheme="http://cloudnoter.com/tags/pcs/"/>
    
  </entry>
  
  <entry>
    <title>Java小问题汇总</title>
    <link href="http://cloudnoter.com/2016/11/09/Java%E5%B0%8F%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"/>
    <id>http://cloudnoter.com/2016/11/09/Java%E5%B0%8F%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/</id>
    <published>2016-11-08T22:09:00.000Z</published>
    <updated>2019-06-24T11:46:57.436Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-MySQL5-7下的JSON字段中文乱码问题"><a href="#1-MySQL5-7下的JSON字段中文乱码问题" class="headerlink" title="1. MySQL5.7下的JSON字段中文乱码问题"></a>1. MySQL5.7下的JSON字段中文乱码问题</h2><p>中文乱码问题在Java Web开发中经常碰到，大部分原因是后端与前端的编码不一致造成的（如tomcat的默认编码为ISO-8859-1，而前端为GBK），解决办法也简单，只需要加一个<code>CharsetEncodingFilter</code>就行。但本文要讲的不是这一类总是，而是纯粹的后端问题。</p><h3 id="1-1-环境准备"><a href="#1-1-环境准备" class="headerlink" title="1.1 环境准备"></a>1.1 环境准备</h3><blockquote><p>假设MySQL的默认CharSet为UTF-8，应用及部署环境也为UTF-8</p></blockquote><ul><li>创建包含JSON字段的数据库表</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> &quot;ipms_device_feature&quot; (</span><br><span class="line">  &quot;ID&quot; <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  &quot;DEVICE_SERIAL_NUMBER&quot; <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;设备SN&#x27;</span>,</span><br><span class="line">  &quot;DEVICE_IP&quot; <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;设备IP&#x27;</span>,</span><br><span class="line">  &quot;FEATURES&quot; <span class="type">json</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;设备巡检指标集&#x27;</span>,</span><br><span class="line">  &quot;UPDATETIME&quot; <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (&quot;ID&quot;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><span id="more"></span><ul><li>运行如下脚本查看字段详细信息</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> fields <span class="keyword">from</span> ipms_device_feature</span><br></pre></td></tr></table></figure><p>结果如下：<br><img src="http://oaivivmzx.bkt.clouddn.com/mysql_json.jpg" alt="mysql_json"></p><blockquote><p>上图中<code>features</code>这个字段的<code>Collation</code>列为<code>Null</code></p></blockquote><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 使用如下SQL时，JDBC在解析返回的数据（包含中文）时会出现乱码</span></span><br><span class="line"><span class="keyword">select</span> features <span class="keyword">from</span> ipms_device_feature </span><br></pre></td></tr></table></figure><ul><li>解决办法</li></ul><p>第一步：使用MySQL提供的json_unquote方法</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">select</span> json_u<span class="meta">nquote(</span>features) <span class="meta">as</span> features <span class="meta">from</span> ipms_device_feature</span><br></pre></td></tr></table></figure><p>第二步：在Java中调用上面的SQL时，将会返回一个<code>byte</code>数组，因此只需要通过<code>String</code>提供的方法进行转码就行。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Map&gt; rows = em.<span class="built_in">createNamedQuery</span>(<span class="string">&quot;XXX&quot;</span>).<span class="built_in">list</span>();</span><br><span class="line"><span class="keyword">for</span>(Map row : rows) &#123;</span><br><span class="line"><span class="keyword">byte</span>[] bytes = (<span class="keyword">byte</span>[]) row.<span class="built_in">get</span>(<span class="string">&quot;features&quot;</span>);</span><br><span class="line"><span class="keyword">String</span> features = <span class="keyword">new</span> <span class="built_in"><span class="keyword">String</span></span>(bytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的话，Java变更<code>features</code>就是正常的中文，就可以直接回传给前端页面了。</p><h2 id="2-几个容易踩的坑"><a href="#2-几个容易踩的坑" class="headerlink" title="2. 几个容易踩的坑"></a>2. 几个容易踩的坑</h2><h3 id="2-1-Integer对象之间比较的坑"><a href="#2-1-Integer对象之间比较的坑" class="headerlink" title="2.1. Integer对象之间比较的坑"></a>2.1. <code>Integer</code>对象之间比较的坑</h3><p>对于<code>Integer var=?</code>在<code>-128</code>至<code>127</code>之间的赋值，<code>Integer</code> 对象是在<code>IntegerCache.cache</code>产生，会复用已有对象，这个区间内的<code>Integer</code>值可以直接使用==进行判断，但是这个区间之外的所有数据，都会在堆上产生，并不会复用已有对象。因此建议<code>Integer</code>对象在比较时应使用<code>equals</code>方法。</p><h3 id="2-2-ArrayList的subList-方法返回值的坑"><a href="#2-2-ArrayList的subList-方法返回值的坑" class="headerlink" title="2.2. ArrayList的subList()方法返回值的坑"></a>2.2. <code>ArrayList</code>的<code>subList()</code>方法返回值的坑</h3><p><code>ArrayList</code>的<code>subList</code>方法返回的结果不可强转成<code>ArrayList</code>，否则会抛出<code>ClassCastException</code>异常：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java.util.RandomAccessSubList </span>cannot <span class="keyword">be </span>cast to <span class="keyword">java.util.ArrayList;</span></span><br></pre></td></tr></table></figure><p>因为<code>subList</code>方法返回的是<code>ArrayList</code>的内部类<code>SubList</code>，并不是<code>ArrayList</code>，而是<code>ArrayList</code>的一个视图，对于内部类<code>SubList</code>的所有操作最终会反映到原列表上。</p><h3 id="2-3-Arrays-asList-方法返回值的坑"><a href="#2-3-Arrays-asList-方法返回值的坑" class="headerlink" title="2.3. Arrays.asList()方法返回值的坑"></a>2.3. <code>Arrays.asList()</code>方法返回值的坑</h3><p>使用工具类<code>Arrays.asList()</code>把数组转换成集合时，不能使用其修改集合相关的方法，它的 <code>add/remove/clear</code>方法会抛出<code>UnsupportedOperationException</code>异常。因为<code>asList</code>方法的返回对象是一个<code>Arrays</code>内部类，并没有实现集合的修改方法。<code>Arrays.asList</code>体现的是适配器模式，只是转换接口，后台的数据仍是数组。</p> <figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">String</span>[] <span class="built_in">str</span> = <span class="keyword">new</span> <span class="keyword">String</span>[] &#123; <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span> &#125;;</span><br><span class="line">List list = Arrays.asList(<span class="built_in">str</span>);</span><br><span class="line">list.<span class="built_in">add</span>(<span class="string">&quot;c&quot;</span>); <span class="comment">// 运行时异常。</span></span><br><span class="line"><span class="built_in">str</span>[<span class="number">0</span>]= <span class="string">&quot;gujin&quot;</span>; <span class="comment">// 则list.get(0)也会随之修改。</span></span><br></pre></td></tr></table></figure><h2 id="3-新版Eclipse-Neon运行Junit报NPE"><a href="#3-新版Eclipse-Neon运行Junit报NPE" class="headerlink" title="3. 新版Eclipse Neon运行Junit报NPE"></a>3. 新版Eclipse Neon运行Junit报NPE</h2><ul><li><strong>问题描述</strong>：在Eclipse中创建单元测试用例（项目依赖的版本为junit-4.4）时，报如下错误</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.NullPointerException</span></span><br><span class="line">at org<span class="selector-class">.eclipse</span><span class="selector-class">.jdt</span><span class="selector-class">.internal</span><span class="selector-class">.junit4</span><span class="selector-class">.runner</span><span class="selector-class">.SubForestFilter</span><span class="selector-class">.shouldRun</span>(SubForestFilter<span class="selector-class">.java</span>:<span class="number">81</span>)</span><br><span class="line">at org<span class="selector-class">.junit</span><span class="selector-class">.internal</span><span class="selector-class">.runners</span><span class="selector-class">.JUnit4ClassRunner</span><span class="selector-class">.filter</span>(JUnit4ClassRunner<span class="selector-class">.java</span>:<span class="number">110</span>)</span><br><span class="line">at org<span class="selector-class">.junit</span><span class="selector-class">.runner</span><span class="selector-class">.manipulation</span><span class="selector-class">.Filter</span><span class="selector-class">.apply</span>(Filter<span class="selector-class">.java</span>:<span class="number">47</span>)</span><br><span class="line">at org<span class="selector-class">.junit</span><span class="selector-class">.internal</span><span class="selector-class">.requests</span><span class="selector-class">.FilterRequest</span><span class="selector-class">.getRunner</span>(FilterRequest<span class="selector-class">.java</span>:<span class="number">34</span>)</span><br><span class="line">at org<span class="selector-class">.eclipse</span><span class="selector-class">.jdt</span><span class="selector-class">.internal</span><span class="selector-class">.junit4</span><span class="selector-class">.runner</span><span class="selector-class">.JUnit4TestLoader</span><span class="selector-class">.createFilteredTest</span>(JUnit4TestLoader<span class="selector-class">.java</span>:<span class="number">77</span>)</span><br><span class="line">at org<span class="selector-class">.eclipse</span><span class="selector-class">.jdt</span><span class="selector-class">.internal</span><span class="selector-class">.junit4</span><span class="selector-class">.runner</span><span class="selector-class">.JUnit4TestLoader</span><span class="selector-class">.createTest</span>(JUnit4TestLoader<span class="selector-class">.java</span>:<span class="number">68</span>)</span><br><span class="line">at org<span class="selector-class">.eclipse</span><span class="selector-class">.jdt</span><span class="selector-class">.internal</span><span class="selector-class">.junit4</span><span class="selector-class">.runner</span><span class="selector-class">.JUnit4TestLoader</span><span class="selector-class">.loadTests</span>(JUnit4TestLoader<span class="selector-class">.java</span>:<span class="number">43</span>)</span><br><span class="line">at org<span class="selector-class">.eclipse</span><span class="selector-class">.jdt</span><span class="selector-class">.internal</span><span class="selector-class">.junit</span><span class="selector-class">.runner</span><span class="selector-class">.RemoteTestRunner</span><span class="selector-class">.runTests</span>(RemoteTestRunner<span class="selector-class">.java</span>:<span class="number">444</span>)</span><br><span class="line">at org<span class="selector-class">.eclipse</span><span class="selector-class">.jdt</span><span class="selector-class">.internal</span><span class="selector-class">.junit</span><span class="selector-class">.runner</span><span class="selector-class">.RemoteTestRunner</span><span class="selector-class">.runTests</span>(RemoteTestRunner<span class="selector-class">.java</span>:<span class="number">678</span>)</span><br></pre></td></tr></table></figure><ul><li><p><strong>原因分析</strong>：新版Eclipse在启动单元测试用例时调用的是JUnit新版本的方法，即Eclipse已不支持junit4.9以下的版本。</p></li><li><p><strong>解决办法</strong>：升级JUnit依赖版本即可</p></li></ul><h2 id="Windows下修改tomcat配置"><a href="#Windows下修改tomcat配置" class="headerlink" title="Windows下修改tomcat配置"></a>Windows下修改tomcat配置</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 将tomcat安装成window后台服务：</span></span><br><span class="line">service.bat install tomcat8-cza</span><br><span class="line"></span><br><span class="line"><span class="meta"># 卸载服务</span></span><br><span class="line">service.bat remove tomcat8-cza</span><br><span class="line"></span><br><span class="line"><span class="meta"># 配置JVM内存参数</span></span><br><span class="line">cd &lt;tomcat_home&gt;/bin</span><br><span class="line">tomcat8w.exe <span class="comment">//MS/tomcat8-cza</span></span><br><span class="line"><span class="meta"># 在桌面右下角可以看到tomcat8w.exe的服务管理图标，点击“配置”，选择“java”标签，即可修改JVM参数。</span></span><br></pre></td></tr></table></figure><h2 id="获取echarts地图中各地区的经纬度信息"><a href="#获取echarts地图中各地区的经纬度信息" class="headerlink" title="获取echarts地图中各地区的经纬度信息"></a>获取echarts地图中各地区的经纬度信息</h2><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echarts.getMap(<span class="string">&#x27;福州&#x27;</span>).geoJson.features.forEach(<span class="keyword">function</span>(<span class="type">item</span>)&#123;console.log(<span class="string">&#x27;&quot;&#x27;</span> + <span class="type">item</span>.properties<span class="built_in">.name</span> + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot;: [&quot;</span> + <span class="type">item</span>.properties.cp + <span class="string">&quot;],&quot;</span>)&#125;);</span><br></pre></td></tr></table></figure><h2 id="待续…"><a href="#待续…" class="headerlink" title="待续…"></a>待续…</h2><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1-MySQL5-7下的JSON字段中文乱码问题&quot;&gt;&lt;a href=&quot;#1-MySQL5-7下的JSON字段中文乱码问题&quot; class=&quot;headerlink&quot; title=&quot;1. MySQL5.7下的JSON字段中文乱码问题&quot;&gt;&lt;/a&gt;1. MySQL5.7下的JSON字段中文乱码问题&lt;/h2&gt;&lt;p&gt;中文乱码问题在Java Web开发中经常碰到，大部分原因是后端与前端的编码不一致造成的（如tomcat的默认编码为ISO-8859-1，而前端为GBK），解决办法也简单，只需要加一个&lt;code&gt;CharsetEncodingFilter&lt;/code&gt;就行。但本文要讲的不是这一类总是，而是纯粹的后端问题。&lt;/p&gt;
&lt;h3 id=&quot;1-1-环境准备&quot;&gt;&lt;a href=&quot;#1-1-环境准备&quot; class=&quot;headerlink&quot; title=&quot;1.1 环境准备&quot;&gt;&lt;/a&gt;1.1 环境准备&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;假设MySQL的默认CharSet为UTF-8，应用及部署环境也为UTF-8&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;创建包含JSON字段的数据库表&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight pgsql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;TABLE&lt;/span&gt; &amp;quot;ipms_device_feature&amp;quot; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;quot;ID&amp;quot; &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt; AUTO_INCREMENT,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;quot;DEVICE_SERIAL_NUMBER&amp;quot; &lt;span class=&quot;type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;设备SN&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;quot;DEVICE_IP&amp;quot; &lt;span class=&quot;type&quot;&gt;varchar&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;设备IP&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;quot;FEATURES&amp;quot; &lt;span class=&quot;type&quot;&gt;json&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;设备巡检指标集&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;quot;UPDATETIME&amp;quot; &lt;span class=&quot;type&quot;&gt;timestamp&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;CURRENT_TIMESTAMP&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;CURRENT_TIMESTAMP&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;COMMENT&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#x27;更新时间&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;PRIMARY KEY&lt;/span&gt; (&amp;quot;ID&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java" scheme="http://cloudnoter.com/categories/Java/"/>
    
    
    <category term="Java" scheme="http://cloudnoter.com/tags/Java/"/>
    
    <category term="MySQL" scheme="http://cloudnoter.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Composer学习笔记</title>
    <link href="http://cloudnoter.com/2016/09/01/Composer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://cloudnoter.com/2016/09/01/Composer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2016-09-01T00:01:12.000Z</published>
    <updated>2017-04-29T06:13:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>#Composer学习笔记</p><h2 id="一、安装-MacOS"><a href="#一、安装-MacOS" class="headerlink" title="一、安装(MacOS)"></a>一、安装(MacOS)</h2><blockquote><p>系统要求：PHP5.3.2+以上版本<br>学习参考：<a href="https://getcomposer.org/doc/">Composer官方文档</a></p></blockquote><p>Composer安装分两种：</p><h3 id="1-局部安装"><a href="#1-局部安装" class="headerlink" title="1.局部安装"></a>1.局部安装</h3><p>将<code>composer.phar</code>文件内嵌于PHP应用目录下，命令如下：</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&quot;copy(&#x27;</span>https:<span class="comment">//getcomposer.org/installer&#x27;, &#x27;composer-setup.php&#x27;);&quot;</span></span><br><span class="line">php -r <span class="string">&quot;if (hash_file(&#x27;</span>SHA384&#x27;, <span class="string">&#x27;composer-setup.php&#x27;</span>) === <span class="string">&#x27;e115a8dc7871f15d853148a7fbac7da27d6c0030b848d9b3dc09e2a0388afed865e6a3d6b3c0fad45c48e2b5fc1196ae&#x27;</span>) &#123; echo <span class="string">&#x27;Installer verified&#x27;</span>; &#125; <span class="keyword">else</span> &#123; echo <span class="string">&#x27;Installer corrupt&#x27;</span>; unlink(<span class="string">&#x27;composer-setup.php&#x27;</span>); &#125; echo PHP_EOL;<span class="string">&quot;</span></span><br><span class="line"><span class="string">php composer-setup.php</span></span><br><span class="line"><span class="string">php -r &quot;</span>unlink(<span class="string">&#x27;composer-setup.php&#x27;</span>);<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>以上命令分别做如下几件事件：</p><ul><li>下载安装器</li><li>校验</li><li>执行安装</li><li>删除安装器</li></ul></blockquote><p>安装完成后，会在当前工作目录下生成可执行文件：<code>composer.phar</code>，你可以通过如下方式使用（运行）composer来进行项目的依赖管理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php composer.phar &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"><span class="comment"># command指install等composer命令</span></span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="2-全局安装"><a href="#2-全局安装" class="headerlink" title="2.全局安装"></a>2.全局安装</h3><p>将可执行二进制文件放在系统PATH路径下，命令如下：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 假设局部安装中生成的composer.phar文件在当前目录下</span><br><span class="line"># <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>目录是一个现成的PATH目录，</span><br><span class="line"># 你也可以将可执行文件放置于其他PATH目录下</span><br><span class="line">mv composer.phar <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>composer</span><br></pre></td></tr></table></figure><p>通过这种方式，你就可以直接按如下方式来使用composer：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">composer &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"><span class="comment"># command指install等composer命令</span></span><br></pre></td></tr></table></figure><h2 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h2><h3 id="1-composer-json文件"><a href="#1-composer-json文件" class="headerlink" title="1. composer.json文件"></a>1. composer.json文件</h3><p>每个基于Composer的项目都需要包含<code>composer.json</code>文件，该文件用于声明项目所依赖的第三方库，其为JSON文件，格式类似：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       <span class="attr">&quot;require&quot;</span>: &#123;</span><br><span class="line">       <span class="attr">&quot;monolog/monolog&quot;</span>: <span class="string">&quot;1.2.*&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>require属性是用于声明依赖信息的地方。</p></blockquote><p>当运行<code>composer install</code>安装依赖时，Composer会将依赖库下载到项目根目录的<code>vendor</code>目录下。如monolog依赖安装后，其存放在<code>vendor\monolog\monolog</code>目录下。</p><h3 id="2-composer-lock文件"><a href="#2-composer-lock文件" class="headerlink" title="2. composer.lock文件"></a>2. composer.lock文件</h3><p>当执行如下命令安装依赖后，Composer将会在项目目录下创建<code>composer.lock</code>文件。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">install</span></span><br></pre></td></tr></table></figure><blockquote><p>Composer将把安装时确切的版本号列表写入<code>composer.lock</code>文件。这将锁定改项目的特定版本。<br>后续再次运行<code>composer install</code>时，Composer将先检查目录下是否有<code>composer.lock</code>，若有则直接忽略<code>composer.json</code>，而使用<code>composer.lock</code>中的确切的版本信息。团队成员可以共享该lock文件以解决版本不一致问题。<br>当依赖版本有升级时，若想更新依赖至最新版本可以运行如下命令</p></blockquote><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全部更新</span></span><br><span class="line">composer <span class="keyword">update</span></span><br><span class="line"><span class="comment"># 只更新某个依赖库</span></span><br><span class="line">composer <span class="keyword">update</span> monolog/monolog [...]</span><br></pre></td></tr></table></figure><h3 id="3-自动加载"><a href="#3-自动加载" class="headerlink" title="3. 自动加载"></a>3. 自动加载</h3><p>对于库的自动加载信息，Composer 生成了一个<code>vendor/autoload.php</code>文件。通过引入这个文件，就实现了自动加载功能。</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br></pre></td></tr></table></figure><p>通过自动加载功能我们可以很容易的使用第三方代码。例如：项目依赖monolog，我们就可以像这样开始使用这个类库，并且他们将被自动加载。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$log</span> = <span class="keyword">new</span> Monolog\Logger(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line"><span class="variable">$log</span>-&gt;pushHandler(<span class="keyword">new</span> Monolog\Handler\StreamHandler(<span class="string">&#x27;app.log&#x27;</span>, Monolog\Logger::WARNING));</span><br><span class="line"></span><br><span class="line"><span class="variable">$log</span>-&gt;addWarning(<span class="string">&#x27;Foo&#x27;</span>);</span><br></pre></td></tr></table></figure><p>当然，我们也可以在<code>composer.json</code>的<code>autoload</code>字段中增加自己的<code>autoloader</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;autoload&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;psr-4&quot;</span>: &#123;<span class="attr">&quot;Acme\\&quot;</span>: <span class="string">&quot;src/&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Composer将注册一个<code>PSR-4 autoloader</code>到<code>Acme</code>命名空间。</p><p>你可以定义一个从命名空间到目录的映射。此时src会在你项目的根目录，与<code>vendor</code>文件夹同级。例如<code>src/Foo.php</code>文件应该包含<code>Acme\Foo</code>类。</p><p>添加<code>autoload</code>字段后，你应该再次运行<code>install</code>命令来生成 <code>vendor/autoload.php</code>文件。</p><p>引用这个文件也将返回<code>autoloader</code>的实例，你可以将包含调用的返回值存储在变量中，并添加更多的命名空间。这对于在一个测试套件中自动加载类文件是非常有用的，例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span> = <span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="variable">$loader</span>-&gt;add(<span class="string">&#x27;Acme\\Test\\&#x27;</span>, <span class="keyword">__DIR__</span>);</span><br></pre></td></tr></table></figure><h2 id="三、库"><a href="#三、库" class="headerlink" title="三、库"></a>三、库</h2><p>不重复造轮子，这是大伙天天喊的，因为社区已经为大伙提供了很多可直接引用的轮子，这些轮子的学名就叫“库”。如果你觉得自己的项目可以帮到别人，你可以选择将其打包成库，并大告天下。你只要按如下步骤操作就行：</p><ol><li>为项目的composer.json添加name属性 [必需]</li><li>发布至git等版本管理系统或<a href="https://packagist.org/">packagist</a></li></ol><blockquote><ul><li>composer.json中还有一个<code>version</code>属性，但一般不建议设置，因为composer会根据tag标签自行推算版本号，如果项目代码为master，则版本会被推算为<code>dev-master</code></li><li>packagist可理解为一个公共的组件仓库，类似maven中央库</li><li>对于未发布至packagist库的组件，引用方需要指定<code>repositories</code></li></ul></blockquote><p>比如，假如我们将项目发布至<a href="https://github.com/monkeychen/simiam">Github</a>下，项目的<code>composer.json</code>如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;simiam/composer-demo&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;require&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;monolog/monolog&quot;</span>: <span class="string">&quot;1.0.*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，我们的另一个项目blog需要引用上面发布的<code>simiam/composer-demo</code>组件，则blog项目的<code>composer.json</code>内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;simiam/blog&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;repositories&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;vcs&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/monkeychen/simiam&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;require&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;simiam/composer-demo&quot;</span>: <span class="string">&quot;dev-master&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>因为我们发布的是master分支，所以<code>require</code>中依赖的版本号为<code>dev-master</code><br>如果组件已经发布至packagist的话，则不需要声明<code>repositories</code>，因为composer默认会从中央库中搜索。</p></blockquote><p>更详细的信息，可以参考<a href="https://getcomposer.org/doc/02-libraries.md">这里</a>。</p><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;#Composer学习笔记&lt;/p&gt;
&lt;h2 id=&quot;一、安装-MacOS&quot;&gt;&lt;a href=&quot;#一、安装-MacOS&quot; class=&quot;headerlink&quot; title=&quot;一、安装(MacOS)&quot;&gt;&lt;/a&gt;一、安装(MacOS)&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;系统要求：PHP5.3.2+以上版本&lt;br&gt;学习参考：&lt;a href=&quot;https://getcomposer.org/doc/&quot;&gt;Composer官方文档&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Composer安装分两种：&lt;/p&gt;
&lt;h3 id=&quot;1-局部安装&quot;&gt;&lt;a href=&quot;#1-局部安装&quot; class=&quot;headerlink&quot; title=&quot;1.局部安装&quot;&gt;&lt;/a&gt;1.局部安装&lt;/h3&gt;&lt;p&gt;将&lt;code&gt;composer.phar&lt;/code&gt;文件内嵌于PHP应用目录下，命令如下：&lt;/p&gt;
&lt;figure class=&quot;highlight scilab&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;php -r &lt;span class=&quot;string&quot;&gt;&amp;quot;copy(&amp;#x27;&lt;/span&gt;https:&lt;span class=&quot;comment&quot;&gt;//getcomposer.org/installer&amp;#x27;, &amp;#x27;composer-setup.php&amp;#x27;);&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php -r &lt;span class=&quot;string&quot;&gt;&amp;quot;if (hash_file(&amp;#x27;&lt;/span&gt;SHA384&amp;#x27;, &lt;span class=&quot;string&quot;&gt;&amp;#x27;composer-setup.php&amp;#x27;&lt;/span&gt;) === &lt;span class=&quot;string&quot;&gt;&amp;#x27;e115a8dc7871f15d853148a7fbac7da27d6c0030b848d9b3dc09e2a0388afed865e6a3d6b3c0fad45c48e2b5fc1196ae&amp;#x27;&lt;/span&gt;) &amp;#123; echo &lt;span class=&quot;string&quot;&gt;&amp;#x27;Installer verified&amp;#x27;&lt;/span&gt;; &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123; echo &lt;span class=&quot;string&quot;&gt;&amp;#x27;Installer corrupt&amp;#x27;&lt;/span&gt;; unlink(&lt;span class=&quot;string&quot;&gt;&amp;#x27;composer-setup.php&amp;#x27;&lt;/span&gt;); &amp;#125; echo PHP_EOL;&lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;php composer-setup.php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;php -r &amp;quot;&lt;/span&gt;unlink(&lt;span class=&quot;string&quot;&gt;&amp;#x27;composer-setup.php&amp;#x27;&lt;/span&gt;);&lt;span class=&quot;string&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;以上命令分别做如下几件事件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;下载安装器&lt;/li&gt;
&lt;li&gt;校验&lt;/li&gt;
&lt;li&gt;执行安装&lt;/li&gt;
&lt;li&gt;删除安装器&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;安装完成后，会在当前工作目录下生成可执行文件：&lt;code&gt;composer.phar&lt;/code&gt;，你可以通过如下方式使用（运行）composer来进行项目的依赖管理：&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;php composer.phar &amp;lt;&lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# command指install等composer命令&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Composer" scheme="http://cloudnoter.com/categories/Composer/"/>
    
    
    <category term="Composer" scheme="http://cloudnoter.com/tags/Composer/"/>
    
  </entry>
  
  <entry>
    <title>MAC下搭建Apache+PHP开发环境</title>
    <link href="http://cloudnoter.com/2016/07/02/MAC%E4%B8%8B%E6%90%AD%E5%BB%BAApache+PHP%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>http://cloudnoter.com/2016/07/02/MAC%E4%B8%8B%E6%90%AD%E5%BB%BAApache+PHP%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2016-07-01T23:18:57.000Z</published>
    <updated>2017-04-29T06:08:34.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>apache配置文件为：<code>/etc/apache2/httpd.conf</code></li><li>OSX下默认集成了apache与php；</li><li>Mac Apache 有2个默认的网站目录，一个是<code>/Library/WebServer/Documents/</code>，一个是用户目录下的Sites目录（推荐使用），默认未开启；</li><li>Apache 基本命令：</li></ul><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动<span class="symbol">:sudo</span> apachectl start</span><br><span class="line">停止<span class="symbol">:sudo</span> apachectl stop</span><br><span class="line">重启<span class="symbol">:sudo</span> apachectl restart</span><br></pre></td></tr></table></figure><h2 id="1-配置apache"><a href="#1-配置apache" class="headerlink" title="1. 配置apache"></a>1. 配置apache</h2><p>Step 1. 在用户目录下用Finder创建 Sites 文件夹；</p><p>Step 2. 在<code>/etc/apache2/users/</code>目录下添加 <code>username.conf</code>文件(username要替换成真正的用户名，下同)：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /etc/apache2/users  </span><br><span class="line">sudo <span class="keyword">vim</span> username.<span class="keyword">conf</span>  </span><br></pre></td></tr></table></figure><p>Step 3. 在<code>username.conf</code>文件中添加如下内容：<br>    <img src="/img/username_conf.png" alt="username.conf内容"></p><span id="more"></span><p>Step 4. 检查<code>username.conf</code>文件的权限是否正确，正确的应该为：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- <span class="number"> 1 </span>root  wheel <span class="number"> 126 </span>Mar<span class="number"> 23 </span>23:02 username.conf  </span><br></pre></td></tr></table></figure><p>如果不是，则需要修改权限，使用如下命令：  </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> chmod <span class="number">644</span> username.conf</span><br></pre></td></tr></table></figure><p>Step 5. 修改<code>httpd.conf</code>文件配置：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim <span class="regexp">/etc/</span>apache2/httpd.conf  </span><br></pre></td></tr></table></figure><p>在<code>httpd.conf</code>找到如下3行，并确保这3行的注释＃是被删除的  </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">LoadModule</span></span> authz_core_module libexec/apache<span class="number">2</span>/mod_authz_core.so</span><br><span class="line"><span class="attribute"><span class="nomarkup">LoadModule</span></span> authz_host_module libexec/apache<span class="number">2</span>/mod_authz_host.so</span><br><span class="line"><span class="attribute"><span class="nomarkup">LoadModule</span></span> userdir_module libexec/apache<span class="number">2</span>/mod_userdir.so</span><br></pre></td></tr></table></figure><p>接着启用用户目录配置，同为删除对应行的＃</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Include</span> <span class="regexp">/private/</span>etc<span class="regexp">/apache2/</span>extra/httpd-userdir.conf</span><br></pre></td></tr></table></figure><p>Step 6. 修改<code>httpd-userdir.conf</code>文件配置  </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim <span class="regexp">/etc/</span>apache2<span class="regexp">/extra/</span>httpd-userdir.conf</span><br></pre></td></tr></table></figure><p>取消如下行的＃</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Include</span> <span class="regexp">/private/</span>etc<span class="regexp">/apache2/u</span>sers<span class="comment">/*.conf</span></span><br></pre></td></tr></table></figure><p>Step 7. 重启Apache，并检查配置是否生效</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo apachectl restart</span></span><br></pre></td></tr></table></figure><p>在浏览器输入：<code>http://localhost/~username/</code>，看是否配置成功</p><p>Step 8. 让apache支持php脚本  </p><ul><li>修改 httpd.conf 文件配置</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim <span class="regexp">/etc/</span>apache2/httpd.conf</span><br></pre></td></tr></table></figure><ul><li>取消php库文件的＃注释</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">LoadModule</span></span> php<span class="number">5</span>_module libexec/apache<span class="number">2</span>/libphp<span class="number">5</span>.so</span><br></pre></td></tr></table></figure><ul><li>重启Apache</li></ul><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo apachectl restart</span></span><br></pre></td></tr></table></figure><ul><li>在Sites目录下创建index.php，内容如下：</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在浏览器里输入：<code>http://localhost/~username</code>   </li></ul><blockquote><p>如果能显示php环境信息，则说明php环境搭建成功  </p></blockquote><p>Step 9. 配置虚拟主机(vhost)</p><ul><li>将/etc/apache2/httpd.conf文件中如下内容的<code>#</code>去掉</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">Include</span> <span class="regexp">/private/</span>etc<span class="regexp">/apache2/</span>extra/httpd-vhosts.conf</span><br></pre></td></tr></table></figure><ul><li>修改/etc/apache2/extra/httpd-vhosts.conf:</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> admin@simiam.vhost.com</span><br><span class="line">    <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> <span class="string">&quot;/Users/chenzhian/workspace/php/website/public&quot;</span></span><br><span class="line">    <span class="attribute"><span class="nomarkup">ServerName</span></span> simiam.vhost.com</span><br><span class="line">    <span class="attribute">DirectoryIndex</span> main.php index.php index.html</span><br><span class="line">    <span class="section">&lt;Directory <span class="string">&quot;/Users/chenzhian/workspace/php/website/public&quot;</span>&gt;</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">Options</span></span> FollowSymLinks Multiviews</span><br><span class="line"><span class="attribute">MultiviewsMatch</span> Any</span><br><span class="line"><span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line"><span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Directory&gt;</span></span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="string">&quot;/private/var/log/apache2/simiam.vhost.com-error_log&quot;</span></span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="string">&quot;/private/var/log/apache2/simiam.vhost.com-access_log&quot;</span> common</span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> admin@<span class="number">100</span>.vhost.com</span><br><span class="line">    <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> <span class="string">&quot;/Users/chenzhian/workspace/php/website/100&quot;</span></span><br><span class="line">    <span class="attribute"><span class="nomarkup">ServerName</span></span> <span class="number">100</span>.vhost.com</span><br><span class="line">    <span class="attribute">DirectoryIndex</span> index.php index.html</span><br><span class="line">        <span class="section">&lt;Directory <span class="string">&quot;/Users/chenzhian/workspace/php/website/100&quot;</span>&gt;</span></span><br><span class="line">        <span class="attribute"><span class="nomarkup">Options</span></span> FollowSymLinks Multiviews</span><br><span class="line"><span class="attribute">MultiviewsMatch</span> Any</span><br><span class="line"><span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line"><span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="string">&quot;/private/var/log/apache2/100.vhost.com-error_log&quot;</span></span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="string">&quot;/private/var/log/apache2/100.vhost.com-access_log&quot;</span> common</span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-修改或创建php-ini"><a href="#2-修改或创建php-ini" class="headerlink" title="2. 修改或创建php.ini"></a>2. 修改或创建php.ini</h2><p>Step 1. 为了开启php的一些扩展功能，有必要对<code>php.ini</code>进行修改。OSX默认提供的php是没有<code>php.ini</code>文件的，因此我们需要自己创建一个。可以在<code>/etc/</code>目录下创建<code>php.ini</code></p><ul><li>/etc/目录下有提供php.ini.default模板</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp <span class="regexp">/etc/</span>php.ini.<span class="keyword">default</span> <span class="regexp">/etc/</span>php.ini</span><br></pre></td></tr></table></figure><ul><li><p>如果不知道php默认是到哪里找php.ini文件的话，则使用命令<code>php --ini</code>：</p></li><li><p>命令输出如下类似信息：  </p></li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Configuration <span class="keyword">File</span> (php.ini) Path: /etc</span><br><span class="line">Loaded Configuration <span class="keyword">File</span>:         <span class="regexp">/etc/</span>php.ini</span><br><span class="line">Scan <span class="keyword">for</span> additional .ini files in: <span class="regexp">/Library/</span>Server<span class="regexp">/Web/</span>Config/php</span><br><span class="line">Additional .ini files parsed:      (none)  </span><br></pre></td></tr></table></figure><p>Step 2. 在<code>php.ini</code>文件最后添加如下内容以启用xdebug扩展:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[xdebug]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zend_extension</span>=/usr/lib/php/extensions/<span class="literal">no</span>-debug-non-zts-<span class="number">20121212</span>/xdebug.so</span><br><span class="line"><span class="attr">xdebug.remote_autostart</span>=<span class="literal">on</span></span><br><span class="line"><span class="attr">xdebug.remote_enable</span>=<span class="literal">on</span></span><br><span class="line"><span class="attr">xdebug.remote_enable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">xdebug.remote_mode</span>=<span class="string">&quot;req&quot;</span></span><br><span class="line"><span class="attr">xdebug.remote_log</span>=<span class="string">&quot;/var/log/xdebug.log&quot;</span></span><br><span class="line"><span class="attr">xdebug.remote_host</span>=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">xdebug.remote_port</span>=<span class="number">9000</span></span><br><span class="line"><span class="attr">xdebug.remote_handler</span>=<span class="string">&quot;dbgp&quot;</span></span><br><span class="line"><span class="attr">xdebug.idekey</span>=<span class="string">&quot;PhpStorm&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>xdebug.remote_host的值建议设置为127.0.0.1，而不要设置为localhost（当开启调试模式时，可能会出现域名解析很慢的问题）</p></blockquote><h2 id="3-安装并配置PhpStorm"><a href="#3-安装并配置PhpStorm" class="headerlink" title="3. 安装并配置PhpStorm"></a>3. 安装并配置PhpStorm</h2><p>Step 1. 配置php解释器:直接在**<code>Preferences</code><strong>的</strong><code>Languages-&gt;PHP</code>**页面添加php命令路径:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>bin/php</span><br></pre></td></tr></table></figure><p>Step 2. 配置debug<br>    在**<code>PHP-&gt;Debug-&gt;DBGp</code>**中添加如下信息:</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IDE key:PhpStorm <span class="comment">(与php.ini中xdebug配置项xdebug.idekey一致)</span>  </span><br><span class="line">Host:localhost  <span class="comment">(apache服务地址)</span>  </span><br><span class="line">Port:<span class="number">80</span> <span class="comment">(apache服务端口)</span>  </span><br></pre></td></tr></table></figure><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;ul&gt;
&lt;li&gt;apache配置文件为：&lt;code&gt;/etc/apache2/httpd.conf&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;OSX下默认集成了apache与php；&lt;/li&gt;
&lt;li&gt;Mac Apache 有2个默认的网站目录，一个是&lt;code&gt;/Library/WebServer/Documents/&lt;/code&gt;，一个是用户目录下的Sites目录（推荐使用），默认未开启；&lt;/li&gt;
&lt;li&gt;Apache 基本命令：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight elixir&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;启动&lt;span class=&quot;symbol&quot;&gt;:sudo&lt;/span&gt; apachectl start&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;停止&lt;span class=&quot;symbol&quot;&gt;:sudo&lt;/span&gt; apachectl stop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;重启&lt;span class=&quot;symbol&quot;&gt;:sudo&lt;/span&gt; apachectl restart&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;1-配置apache&quot;&gt;&lt;a href=&quot;#1-配置apache&quot; class=&quot;headerlink&quot; title=&quot;1. 配置apache&quot;&gt;&lt;/a&gt;1. 配置apache&lt;/h2&gt;&lt;p&gt;Step 1. 在用户目录下用Finder创建 Sites 文件夹；&lt;/p&gt;
&lt;p&gt;Step 2. 在&lt;code&gt;/etc/apache2/users/&lt;/code&gt;目录下添加 &lt;code&gt;username.conf&lt;/code&gt;文件(username要替换成真正的用户名，下同)：&lt;/p&gt;
&lt;figure class=&quot;highlight vim&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;cd&lt;/span&gt; /etc/apache2/users  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo &lt;span class=&quot;keyword&quot;&gt;vim&lt;/span&gt; username.&lt;span class=&quot;keyword&quot;&gt;conf&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;Step 3. 在&lt;code&gt;username.conf&lt;/code&gt;文件中添加如下内容：&lt;br&gt;    &lt;img src=&quot;/img/username_conf.png&quot; alt=&quot;username.conf内容&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Php" scheme="http://cloudnoter.com/categories/Php/"/>
    
    
    <category term="php" scheme="http://cloudnoter.com/tags/php/"/>
    
    <category term="apache2" scheme="http://cloudnoter.com/tags/apache2/"/>
    
  </entry>
  
  <entry>
    <title>JNI引起的堆外内存泄漏问题分析</title>
    <link href="http://cloudnoter.com/2016/02/27/JNI%E5%BC%95%E8%B5%B7%E7%9A%84%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>http://cloudnoter.com/2016/02/27/JNI%E5%BC%95%E8%B5%B7%E7%9A%84%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</id>
    <published>2016-02-26T21:18:48.000Z</published>
    <updated>2017-04-29T06:07:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>客户现场的监控系统中有一个网络听诊器功能，其每隔1分钟会对全网设备进行ping操作，以此来尽可能快的发现设备及网络是否出现异常。暂且不说通过该功能来对设备及网络作健康检测是否靠谱。由于JAVA对于网络层以下的协议是无能为力的，而ping操作涉及ICMP与ARP协议，因此监控系统只能借助JNI机制来搞定。</p><h1 id="BUG现象"><a href="#BUG现象" class="headerlink" title="BUG现象"></a>BUG现象</h1><p>监控系统的java.exe进程每隔几个小时就异常退出</p><h1 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h1><ol><li>通过应用系统的日志看是否为业务相关的异常引起的 –》日志中并无任何异常信息</li><li>打开GC日志，并观察一段时间，看是否存在堆内存回收异常（泄漏或溢出） –》堆内存一切正常</li><li>此时忽然想起，java.exe进程异常退出应该会生成相关的hs_err<pid>.log文件，果然在应用目录下找到了一堆错误文件。该日志也叫crash日志。 </li><li>通过查看hs_err<pid>.log内容得知，原来是jni ping引入的dll调用异常导致java.exe进程异常中止了。<blockquote><p>PS：如果能早点想起步骤3，那就不用浪费步骤2的功夫了。</p></blockquote></li></ol><span id="more"></span><h1 id="JNI调用异常分析"><a href="#JNI调用异常分析" class="headerlink" title="JNI调用异常分析"></a>JNI调用异常分析</h1><p>JNI异常导致java进程中止的原因可能为</p><ul><li>JVM自己的BUG：谷歌了一把，网上描述的BUG中，现场的JDK版本都已经修复了。</li><li>JNI DLL的BUG：这个原因范围就大了，至此只能根据经验猜测可能的原因，然后一个一个排除了。</li></ul><p>由于linux环境下有这么一个机制：当内核检测到进程的物理内存不断增加至某一个值时，内核会直接将该进程kill掉。</p><blockquote><p>windows是否也有这样的机制呢？目前尚未查证，还请高手解答。</p></blockquote><p>在没有进一步证据的前提下，只能先猜测是否为进程物理内存出了问题，于是监测了下应用进程的物理内存损耗量，果然是缓慢递增的，但JVM堆内存仍然一切正常，由此大约知道是堆外内存使用上出了问题。</p><p>关于堆外内存的相关知识，可参考下面的文章：</p><ul><li><a href="http://lovestblog.cn/blog/2015/08/21/rssxmx/">进程物理内存远大于Xmx的问题分析</a></li><li><a href="http://lovestblog.cn/blog/2015/05/12/direct-buffer/">JVM源码分析之堆外内存完全解读</a></li></ul><blockquote><p>至此，可以知道该问题与JAVA没啥关系了，但为了彻底搞明白，我还是硬着头皮找来DLL的C源码，想看看是否可以用我helloworld级别的C水平把这个问题搞定。</p></blockquote><h1 id="堆外内存-泄漏、异常-分析"><a href="#堆外内存-泄漏、异常-分析" class="headerlink" title="堆外内存[泄漏、异常]分析"></a>堆外内存[泄漏、异常]分析</h1><p>分析C/C++应用的内存，大伙一般都会想到perftool，可惜windows环境下我始终编译不过。于是谷歌上再搜索一把”windows内存泄漏”，发现知乎上有<a href="https://www.zhihu.com/question/19647750">文章</a>推荐了一堆，但我要么下载不到，要么看不懂。最后是根据《<a href="http://www.cnblogs.com/skynet/archive/2011/02/20/1959162.html">C/C++内存泄漏及检测</a>》介绍的方法定位到是dll中有一段代码使用了缓存导致内存泄漏，当内存达到JVM中设置的MaxDirectMemorySize值时，dll就会出现内存访问异常错误，最终导致java.exe进程异常退出了。</p><blockquote><p>PS：在定位堆外内存异常相关问题时，为了快速重现问题，可以将MaxDirectMemorySize改小，MaxDirectMemorySize的默认值可认为与-Xmx设置的值一样（严格上不是，参见<a href="http://lovestblog.cn/blog/2015/05/12/direct-buffer/">JVM源码分析之堆外内存完全解读</a>）</p></blockquote><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>该问题并非通用性问题，写这篇文章主要是为了记录下当时解决该问题的整个定位过程，文中一些知识点可能表述有误，还请批评指正。</p><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;客户现场的监控系统中有一个网络听诊器功能，其每隔1分钟会对全网设备进行ping操作，以此来尽可能快的发现设备及网络是否出现异常。暂且不说通过该功能来对设备及网络作健康检测是否靠谱。由于JAVA对于网络层以下的协议是无能为力的，而ping操作涉及ICMP与ARP协议，因此监控系统只能借助JNI机制来搞定。&lt;/p&gt;
&lt;h1 id=&quot;BUG现象&quot;&gt;&lt;a href=&quot;#BUG现象&quot; class=&quot;headerlink&quot; title=&quot;BUG现象&quot;&gt;&lt;/a&gt;BUG现象&lt;/h1&gt;&lt;p&gt;监控系统的java.exe进程每隔几个小时就异常退出&lt;/p&gt;
&lt;h1 id=&quot;问题定位&quot;&gt;&lt;a href=&quot;#问题定位&quot; class=&quot;headerlink&quot; title=&quot;问题定位&quot;&gt;&lt;/a&gt;问题定位&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;通过应用系统的日志看是否为业务相关的异常引起的 –》日志中并无任何异常信息&lt;/li&gt;
&lt;li&gt;打开GC日志，并观察一段时间，看是否存在堆内存回收异常（泄漏或溢出） –》堆内存一切正常&lt;/li&gt;
&lt;li&gt;此时忽然想起，java.exe进程异常退出应该会生成相关的hs_err&lt;pid&gt;.log文件，果然在应用目录下找到了一堆错误文件。该日志也叫crash日志。 &lt;/li&gt;
&lt;li&gt;通过查看hs_err&lt;pid&gt;.log内容得知，原来是jni ping引入的dll调用异常导致java.exe进程异常中止了。&lt;blockquote&gt;
&lt;p&gt;PS：如果能早点想起步骤3，那就不用浪费步骤2的功夫了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Java" scheme="http://cloudnoter.com/categories/Java/"/>
    
    
    <category term="Java" scheme="http://cloudnoter.com/tags/Java/"/>
    
    <category term="JNI" scheme="http://cloudnoter.com/tags/JNI/"/>
    
  </entry>
  
  <entry>
    <title>Laravel 5.2中文文档：HTTP路由</title>
    <link href="http://cloudnoter.com/2016/01/21/Laravel-5-2%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3%EF%BC%9AHTTP%E8%B7%AF%E7%94%B1/"/>
    <id>http://cloudnoter.com/2016/01/21/Laravel-5-2%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3%EF%BC%9AHTTP%E8%B7%AF%E7%94%B1/</id>
    <published>2016-01-20T21:31:08.000Z</published>
    <updated>2017-05-07T13:38:03.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="基本路由"><a href="#基本路由" class="headerlink" title="基本路由"></a>基本路由</h1><p>所有的Laravel路由规则都定义在<code>app/Http/routes.php</code>文件中，Laravel框架在初始化时将自动加载该文件。Laravel中最基本的路由规则如下：</p><pre><code>Route::get(&#39;foo&#39;, function () &#123;    return &#39;Hello World&#39;;&#125;);</code></pre><p>其接受两个参数：匹配该路由的URI、路由处理闭包<code>Closure</code>；该闭包定义了具体的路由规则。</p><p><strong>默认路由文件</strong></p><p>默认情况下，<code>routes.php</code>中可以定义简单的路由，或者将这些路由定义在路由组中。路由组将利用<code>web</code>中间件为定义在其中的路由规则提供’会话状态’与<code>CSRF</code>保存等功能。</p><span id="more"></span><p>任何未放在路由组中的路由规则将无权访问会话，也无法享受web中间件提供的<code>CSRF</code>保护等特性，因此如果您定义的路由规则需要web中间件提供的这些特性时，你需要确保将这些路由规则放入路由组中；通过情况下，我们会将大部分的路由规则都放在路由组中。</p><pre><code>Route::group([&#39;middleware&#39; =&gt; [&#39;web&#39;]], function () &#123;    //&#125;);</code></pre><p><strong>Route类中可用的路由方法</strong></p><p>框架路由引擎允许你注册如下的路由规则来响应相应的HTTP请求动作：</p><pre><code>Route::get($uri, $callback);Route::post($uri, $callback);Route::put($uri, $callback);Route::patch($uri, $callback);Route::delete($uri, $callback);Route::options($uri, $callback);</code></pre><p>有时你需要注册一个路由规则来响应多个HTTP请求动作，因此你可以使用<code>Route</code>类的<code>match</code>方法来满足该需求。甚至你可以使用<code>Route</code>类的<code>any</code>方法来响应所有的HTTP请求动作。</p><pre><code>Route::match([&#39;get&#39;, &#39;post&#39;], &#39;/&#39;, function () &#123;    //&#125;);Route::any(&#39;foo&#39;, function () &#123;    //&#125;);</code></pre><h1 id="路由参数-占位符"><a href="#路由参数-占位符" class="headerlink" title="路由参数(占位符)"></a>路由参数(占位符)</h1><p>Laravel中路由规则配置中的URL中允许设置参数(占位符)，便于闭包或控制器方法提取与引用。Laravel的路由URL中参数占位符配置方式分两种：必选与可选。</p><blockquote><p>这种机制蛮适合开发符合RESTful规范的应用，这里有一篇由《黑客与画家》、《软件随想录》译者阮一峰写的介绍RESTful概念的文章： <a href="http://www.ruanyifeng.com/blog/2011/09/restful">理解RESTful架构</a></p></blockquote><p><strong>必选参数占位符</strong></p><p>所谓必选，即HTTP请求的URL中参数占位符的部分必需有具体的数据，否则该路由规则不会被匹配到。比如，你可能需要从请求URL中获取用户的ID时，你就可以定义如下的路由规则：</p><pre><code>Route::get(&#39;user/&#123;id&#125;&#39;, function ($id) &#123;    return &#39;User &#39;.$id;&#125;);// 当请求URL为http://somesite/user/2时，2将被提取出来并赋值给闭包函数中的变量id</code></pre><p>由上面的例子可知，路由参数占位符是由一对花括号来定义的。当然，我们也可以在URL中定义多个参数占位符，如下：</p><pre><code>Route::get(&#39;posts/&#123;post&#125;/comments/&#123;comment&#125;&#39;, function ($postId, $commentId) &#123;     //&#125;);</code></pre><blockquote><p>注意：路由参数占位符的定义需要符合PHP变量命名规范，如不能包含”-“符。</p></blockquote><p><strong>可选参数占位符</strong></p><p>如果想让路由参数占位符是可选的（有时请求URL中的占位符部分可能是空的），此时可以在占位符名称的后面加上一个问号”?”即可。</p><pre><code>Route::get(&#39;user/&#123;name?&#125;&#39;, function ($name = null) &#123;    return $name;&#125;);Route::get(&#39;user/&#123;name?&#125;&#39;, function ($name = &#39;John&#39;) &#123;    return $name;&#125;);</code></pre><blockquote><p>当URL参数占位符设置为可选时，后面的闭包函数的参数<strong>需要</strong>提供默认值。</p></blockquote><h1 id="命名路由"><a href="#命名路由" class="headerlink" title="命名路由"></a>命名路由</h1><p>命名路由将允许你方便的生成URL或重定向URL，这些生成的URL最终将匹配该路由规则。你可通过如下方式定义命名路由：</p><pre><code>Route::get(&#39;profile&#39;, [&#39;as&#39; =&gt; &#39;profile&#39;, function () &#123;    //&#125;]);</code></pre><p>闭包函数的第二个数组参数的元素键值需要指定为”as”，元素值即为路由规则名。当然，你也可以为控制器的方法来代替上面的闭包函数，如下：</p><pre><code>Route::get(&#39;profile&#39;, [    &#39;as&#39; =&gt; &#39;profile&#39;, &#39;uses&#39; =&gt; &#39;UserController@showProfile&#39;]);</code></pre><p>定义命名路由还有如下方式：</p><pre><code>Route::get(&#39;user/profile&#39;, &#39;UserController@showProfile&#39;)-&gt;name(&#39;profile&#39;);</code></pre><p>即先定义一个普通路由，然后再调用该路由规则实例的name方法。</p><p><strong>路由组与命名路由</strong></p><p>如果你正在使用路由规则组时，你可以在路由规则组定义的属性数组中添加一个key为”as”，值为某字符串的元素，该元素的值将作为该路由组中包含的路由名字的前缀。如下：</p><pre><code>Route::group([&#39;as&#39; =&gt; &#39;admin::&#39;], function () &#123;    Route::get(&#39;dashboard&#39;, [&#39;as&#39; =&gt; &#39;dashboard&#39;, function () &#123;        // Route named &quot;admin::dashboard&quot;    &#125;]);&#125;);</code></pre><p><strong>生成匹配命名路由的URL</strong></p><p>一旦你已经为某一路由起了相应的名字，那么你就可以通过全局函数<code>route</code>来生成相应的URL：</p><pre><code>// Generating URLs...$url = route(&#39;profile&#39;);// Generating Redirects...return redirect()-&gt;route(&#39;profile&#39;);</code></pre><p>如果命名路由规则的URL部分包含参数占位符，则你可以将参数值作为<code>route</code>函数的第二个数组参数的元素传入，框架将自动用该参数值代替占位符以生成相应的URL。</p><pre><code>Route::get(&#39;user/&#123;id&#125;/profile&#39;, [&#39;as&#39; =&gt; &#39;profile&#39;, function ($id) &#123;    //&#125;]);$url = route(&#39;profile&#39;, [&#39;id&#39; =&gt; 1]);</code></pre><h1 id="路由组"><a href="#路由组" class="headerlink" title="路由组"></a>路由组</h1><blockquote><p>转载请注明出处：<a href="http://cloudnoter.com/">cloudnoter.com</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;基本路由&quot;&gt;&lt;a href=&quot;#基本路由&quot; class=&quot;headerlink&quot; title=&quot;基本路由&quot;&gt;&lt;/a&gt;基本路由&lt;/h1&gt;&lt;p&gt;所有的Laravel路由规则都定义在&lt;code&gt;app/Http/routes.php&lt;/code&gt;文件中，Laravel框架在初始化时将自动加载该文件。Laravel中最基本的路由规则如下：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Route::get(&amp;#39;foo&amp;#39;, function () &amp;#123;
    return &amp;#39;Hello World&amp;#39;;
&amp;#125;);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;其接受两个参数：匹配该路由的URI、路由处理闭包&lt;code&gt;Closure&lt;/code&gt;；该闭包定义了具体的路由规则。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;默认路由文件&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;默认情况下，&lt;code&gt;routes.php&lt;/code&gt;中可以定义简单的路由，或者将这些路由定义在路由组中。路由组将利用&lt;code&gt;web&lt;/code&gt;中间件为定义在其中的路由规则提供’会话状态’与&lt;code&gt;CSRF&lt;/code&gt;保存等功能。&lt;/p&gt;</summary>
    
    
    
    <category term="Translation" scheme="http://cloudnoter.com/categories/Translation/"/>
    
    
    <category term="php" scheme="http://cloudnoter.com/tags/php/"/>
    
    <category term="laravel" scheme="http://cloudnoter.com/tags/laravel/"/>
    
  </entry>
  
</feed>
